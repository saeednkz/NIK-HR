<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم مدیریت منابع انسانی NikHR</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css"/>
    <script src="https://unpkg.com/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css">

    <!-- Persian Font -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css">
    
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f1f5f9;
        }
        .sidebar-item {
            transition: all 0.2s ease-in-out;
        }
        .sidebar-item.active, .sidebar-item:hover {
            background-color: #1e3a8a;
            color: white;
            transform: translateX(-4px);
        }
        .card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a8a29e; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #78716c; }
        
        .progress-bar { background-color: #e0e0e0; border-radius: 9999px; overflow: hidden; height: 0.75rem; }
        .progress-bar-fill { height: 100%; background-color: #3b82f6; border-radius: 9999px; transition: width 0.5s ease-in-out; }
        
        /* Loading Spinner */
        #loading-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        .spinner {
            width: 56px;
            height: 56px;
            border: 8px solid #f3f3f3;
            border-top: 8px solid #1d4ed8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Profile Tabs */
        .profile-tab {
            cursor: pointer;
            padding: 8px 16px;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .profile-tab.active {
            border-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .profile-tab-content {
            display: none;
        }
        .profile-tab-content.active {
            display: block;
        }
        /* Toast Notification */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            color: white;
            opacity: 0;
            transform: translateX(-100%);
            animation: slideIn 0.5s forwards, fadeOut 0.5s 4.5s forwards;
        }
        .toast.success { background-color: #22c55e; }
        .toast.error { background-color: #ef4444; }
        @keyframes slideIn {
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; transform: scale(0.9); }
        }
    </style>
</head>
<body class="bg-slate-100">

    <!-- Login Container -->
    <div id="login-container" class="hidden min-h-screen flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <div class="text-center">
                <i data-lucide="shield-check" class="mx-auto w-12 h-12 text-blue-800"></i>
                <h2 class="mt-4 text-2xl font-bold text-gray-900">ورود به سیستم NikHR</h2>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="text-sm font-medium text-gray-700">آدرس ایمیل</label>
                    <input id="email" name="email" type="email" autocomplete="email" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-gray-700">رمز عبور</label>
                    <input id="password" name="password" type="password" autocomplete="current-password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700">ورود</button>
            </form>
            <p class="text-sm text-center text-gray-600">
                حساب کاربری ندارید؟ <a href="#" id="show-signup" class="font-medium text-blue-600 hover:underline">ثبت نام کنید</a>
            </p>
        </div>
    </div>

    <!-- Signup Container -->
    <div id="signup-container" class="hidden min-h-screen flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <div class="text-center">
                 <i data-lucide="user-plus" class="mx-auto w-12 h-12 text-blue-800"></i>
                <h2 class="mt-4 text-2xl font-bold text-gray-900">ایجاد حساب کاربری جدید</h2>
            </div>
            <form id="signup-form" class="space-y-6">
                 <div>
                    <label for="signup-email" class="text-sm font-medium text-gray-700">آدرس ایمیل</label>
                    <input id="signup-email" name="email" type="email" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="signup-password" class="text-sm font-medium text-gray-700">رمز عبور</label>
                    <input id="signup-password" name="password" type="password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700">ثبت نام</button>
            </form>
            <p class="text-sm text-center text-gray-600">
                قبلا ثبت نام کرده‌اید؟ <a href="#" id="show-login" class="font-medium text-blue-600 hover:underline">وارد شوید</a>
            </p>
        </div>
    </div>


    <!-- This container is for the main dashboard view -->
    <div id="dashboard-container" class="hidden h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-blue-900 text-white w-64 space-y-6 py-7 px-2 fixed inset-y-0 right-0 transform translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-30 shadow-lg flex flex-col">
            <div>
                <a href="#dashboard" class="sidebar-logo text-white text-2xl font-extrabold px-4 flex items-center space-x-2 space-x-reverse">
                    <i data-lucide="shield-check"></i>
                    <span>NikHR</span>
                </a>
                <nav id="sidebar-nav" class="mt-6">
                    <a href="#dashboard" class="sidebar-item block py-2.5 px-4 rounded flex items-center space-x-2 space-x-reverse">
                        <i data-lucide="layout-dashboard"></i><span>داشبورد</span>
                    </a>
                    <a href="#talent" class="sidebar-item block py-2.5 px-4 rounded flex items-center space-x-2 space-x-reverse">
                        <i data-lucide="users"></i><span>استعدادها</span>
                    </a>
                    <a href="#organization" class="sidebar-item block py-2.5 px-4 rounded flex items-center space-x-2 space-x-reverse">
                        <i data-lucide="building-2"></i><span>سازمان</span>
                    </a>
                    <a href="#surveys" class="sidebar-item block py-2.5 px-4 rounded flex items-center space-x-2 space-x-reverse">
                        <i data-lucide="clipboard-list"></i><span>نظرسنجی‌ها</span>
                    </a>
                     <a href="#expenses" class="sidebar-item block py-2.5 px-4 rounded flex items-center space-x-2 space-x-reverse">
                        <i data-lucide="wallet"></i><span>ثبت هزینه‌ها</span>
                    </a>
                    <a href="#analytics" class="sidebar-item block py-2.5 px-4 rounded flex items-center space-x-2 space-x-reverse">
                        <i data-lucide="bar-chart-3"></i><span>تحلیل هوشمند</span>
                    </a>
                    <a href="#settings" id="settings-nav-link" class="sidebar-item block py-2.5 px-4 rounded flex items-center space-x-2 space-x-reverse">
                        <i data-lucide="settings"></i><span>تنظیمات</span>
                    </a>
                </nav>
            </div>
            <div class="mt-auto">
                 <a href="#" id="logout-btn" class="sidebar-item block py-2.5 px-4 rounded flex items-center space-x-2 space-x-reverse text-red-300 hover:bg-red-700 hover:text-white">
                    <i data-lucide="log-out"></i><span>خروج از سیستم</span>
                </a>
            </div>
        </aside>

        <!-- Main Content Wrapper -->
        <div class="flex-1 flex flex-col h-screen overflow-y-hidden">
            <!-- Mobile Header -->
            <header class="flex justify-between items-center p-4 bg-white shadow-md md:hidden">
                <a href="#dashboard" class="sidebar-logo text-blue-900 text-xl font-extrabold flex items-center space-x-2 space-x-reverse">
                    <i data-lucide="shield-check"></i>
                    <span>HR-Nik</span>
                </a>
                <button id="menu-btn" class="text-gray-600 z-40">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </header>
            
            <!-- Scrollable Main Content -->
            <main id="main-content" class="flex-1 p-6 sm:p-10 overflow-y-auto">
                <!-- Content will be loaded here by JavaScript -->
            </main>
        </div>
    </div>
    
    <!-- This container is for the public survey-taking view -->
    <div id="survey-taker-container" class="hidden">
        <!-- Public survey content will be injected here -->
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

    <!-- Main Modal for Profiles and Forms -->
    <div id="mainModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-4/5 max-w-6xl h-5/6 transform transition-all duration-300 scale-95 opacity-0">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="modalTitle" class="text-xl font-semibold text-gray-800">پروفایل</h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-800">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="modalContent" class="p-6 overflow-y-auto h-[calc(100%-65px)]">
                <!-- Modal content will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-sm p-6 transform transition-all duration-300 scale-95 opacity-0">
            <h3 id="confirmTitle" class="text-lg font-bold text-gray-800 mb-4">آیا مطمئن هستید؟</h3>
            <p id="confirmMessage" class="text-gray-600 mb-6">این عمل غیرقابل بازگشت است.</p>
            <div class="flex justify-end gap-4">
                <button id="confirmCancel" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300">انصراف</button>
                <button id="confirmAccept" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">تایید و حذف</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>
    
    <!-- Hidden input for image uploads -->
    <input type="file" id="image-upload-input" class="hidden" accept="image/*">


    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, onSnapshot, collection, 
            addDoc, getDocs, writeBatch, deleteDoc, updateDoc, query, serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // --- SURVEY TEMPLATES (EXPANDED) ---
   // --- SURVEY TEMPLATES (EXPANDED) ---
  // --- SURVEY TEMPLATES (EXPANDED & COMPLETE) ---
 	// --- SURVEY TEMPLATES (COMPREHENSIVE & STANDARD) ---
    const surveyTemplates = {
        // --- نظرسنجی مشارکت کارکنان (جامع) ---
        'engagement': {
            id: 'engagement',
            title: 'نظرسنجی جامع مشارکت کارکنان (Engagement)',
            description: 'سنجش عمیق سطح تعهد، انگیزه و رضایت شغلی بر اساس استانداردهای جهانی.',
            categories: {
                alignment: 'هم‌راستایی و اهداف',
                growth: 'رشد و توسعه',
                management: 'مدیریت و راهبری',
                recognition: 'قدردانی و ارزش‌گذاری',
                wellbeing: 'سلامت و تعادل کار و زندگی',
                culture: 'فرهنگ و تعلق سازمانی'
            },
            questions: [
                { id: 'eng_q1', category: 'alignment', text: 'من به وضوح می‌دانم که کار من چگونه به اهداف کلی شرکت کمک می‌کند.', type: 'rating_1_5' },
                { id: 'eng_q2', category: 'alignment', text: 'من به ماموریت و چشم‌انداز شرکت باور دارم.', type: 'rating_1_5' },
                { id: 'eng_q3', category: 'growth', text: 'در شغل فعلی‌ام فرصت‌های کافی برای یادگیری و رشد حرفه‌ای دارم.', type: 'rating_1_5' },
                { id: 'eng_q4', category: 'growth', text: 'شرکت در توسعه مهارت‌های من سرمایه‌گذاری می‌کند.', type: 'rating_1_5' },
                { id: 'eng_q5', category: 'management', text: 'مدیر مستقیم من به طور منظم بازخوردهای سازنده و مفیدی به من ارائه می‌دهد.', type: 'rating_1_5' },
                { id: 'eng_q6', category: 'management', text: 'من برای انجام کارم از استقلال و اختیار کافی برخوردارم.', type: 'rating_1_5' },
                { id: 'eng_q7', category: 'management', text: 'مدیر من به من به عنوان یک فرد اهمیت می‌دهد و حامی من است.', type: 'rating_1_5' },
                { id: 'eng_q8', category: 'recognition', text: 'وقتی کارم را به خوبی انجام می‌دهم، احساس می‌کنم از من قدردانی می‌شود.', type: 'rating_1_5' },
                { id: 'eng_q9', category: 'recognition', text: 'فرآیندهای ارزیابی و ترفیع در شرکت منصفانه هستند.', type: 'rating_1_5' },
                { id: 'eng_q10', category: 'culture', text: 'من احساس تعلق به تیم و سازمان خود دارم.', type: 'rating_1_5' },
                { id: 'eng_q11', category: 'culture', text: 'در محیط کار، نظرات و ایده‌های من شنیده و مورد احترام قرار می‌گیرند.', type: 'rating_1_5' },
                { id: 'eng_q12', category: 'wellbeing', text: 'حجم کاری من قابل مدیریت است و باعث فرسودگی شغلی‌ام نمی‌شود.', type: 'rating_1_5' },
                { id: 'eng_q13', category: 'wellbeing', text: 'من می‌توانم تعادل مناسبی بین کار و زندگی شخصی‌ام برقرار کنم.', type: 'rating_1_5' },
                { id: 'eng_q14', category: 'overall', text: 'با توجه به همه جوانب، این شرکت را به عنوان یک محیط کاری عالی به دیگران توصیه می‌کنم (eNPS).', type: 'rating_1_10' }, // eNPS standard is 1-10
                { id: 'eng_q15', category: 'overall', text: 'چه چیزی را در فرهنگ شرکت بیشتر از همه دوست دارید؟', type: 'open_text' },
                { id: 'eng_q16', category: 'overall', text: 'اگر می‌توانستید یک چیز را در شرکت تغییر دهید، آن چه بود؟', type: 'open_text' },
            ]
        },
        // --- نظرسنجی پالس هفتگی (بهبود یافته) ---
        'pulse': {
            id: 'pulse',
            title: 'نظرسنجی پالس هفتگی',
            description: 'یک نظرسنجی سریع برای سنجش نبض سازمان و حال و هوای کارکنان در هفته گذشته.',
            questions: [
                { id: 'pls_q1', text: 'در مقیاس ۱ تا ۵، از هفته کاری خود چقدر رضایت داشتید؟', type: 'rating_1_5' },
                { id: 'pls_q2', text: 'حجم کاری خود را در این هفته چگونه ارزیابی می‌کنید؟', type: 'choice', options: ['بسیار کم', 'کم', 'مناسب', 'زیاد', 'بسیار زیاد'] },
                { id: 'pls_q3', text: 'آیا در هفته گذشته بازخورد مفیدی دریافت کردید که به شما در کارتان کمک کند؟', type: 'yes_no' },
                { id: 'pls_q4', text: 'بزرگترین مانع یا چالشی که این هفته با آن روبرو بودید چه بود؟', type: 'open_text' },
                { id: 'pls_q5', text: 'یک اتفاق مثبت یا موفقیت از این هفته را نام ببرید.', type: 'open_text' },
            ]
        },
        // --- نظرسنجی تجربه جذب و آنبوردینگ (کامل) ---
        'onboarding': {
            id: 'onboarding',
            title: 'نظرسنجی تجربه جذب و آنبوردینگ',
            description: 'جمع‌آوری بازخورد از نیروهای جدید برای بهبود فرآیند ورود به سازمان.',
            questions: [
                { id: 'onb_q1', text: 'فرآیند مصاحبه و جذب چقدر شفاف، حرفه‌ای و محترمانه بود؟', type: 'rating_1_5' },
                { id: 'onb_q2', text: 'آیا شرح شغلی که مطالعه کردید، با وظایف واقعی شما مطابقت دارد؟', type: 'yes_no_somewhat' }, // A more nuanced choice
                { id: 'onb_q3', text: 'آیا قبل از روز اول، اطلاعات کافی در مورد شروع به کارتان دریافت کردید؟', type: 'yes_no' },
                { id: 'onb_q4', text: 'در هفته اول کاری، تمام ابزارها، نرم‌افزارها و دسترسی‌های لازم را در اختیار داشتید؟', type: 'yes_no' },
                { id: 'onb_q5', text: 'معرفی شما به تیم و همکاران چگونه بود و چقدر احساس راحتی کردید؟', type: 'rating_1_5' },
                { id: 'onb_q6', text: 'آیا شرح وظایف و انتظارات از شما در ماه اول کاری کاملاً روشن و شفاف بود؟', type: 'rating_1_5' },
                { id: 'onb_q7', text: 'آیا مدیرتان در هفته‌های اول به اندازه کافی برای شما وقت گذاشت؟', type: 'yes_no' },
                { id: 'onb_q8', text: 'چه پیشنهادی برای بهبود تجربه آنبوردینگ نیروهای جدید دارید؟', type: 'open_text' },
            ]
        },
        // --- نظرسنجی بازخورد ۳۶۰ درجه (استاندارد) ---
        'feedback_360': {
            id: 'feedback_360',
            title: 'نظرسنجی بازخورد ۳۶۰ درجه',
            description: 'ارائه بازخورد سازنده به همکاران برای کمک به رشد حرفه‌ای آن‌ها.',
            requiresTarget: true,
            questions: [
                { id: '360_q1', text: 'این همکار چقدر در ارتباطات خود (گفتاری و نوشتاری) شفاف، محترمانه و موثر است؟', type: 'rating_1_5' },
                { id: '360_q2', text: 'این همکار تا چه حد در کار تیمی مشارکت می‌کند، به دیگران کمک می‌کند و دانش خود را به اشتراک می‌گذارد؟', type: 'rating_1_5' },
                { id: '360_q3', text: 'این همکار در حل مسائل و رویارویی با چالش‌ها چقدر خلاق، کارآمد و مسئولیت‌پذیر است؟', type: 'rating_1_5' },
                { id: '360_q4', text: 'این همکار تا چه حد به اهداف و نتایج متعهد است و کارها را با کیفیت بالا به اتمام می‌رساند؟', type: 'rating_1_5' },
                { id: '360_q5', text: 'بزرگترین نقطه قوت این همکار که باید به آن ادامه دهد چیست؟', type: 'open_text' },
                { id: '360_q6', text: 'چه پیشنهاد مشخصی برای رشد و پیشرفت این همکار دارید؟ (چه کاری را باید شروع کند، متوقف کند یا ادامه دهد؟)', type: 'open_text' },
            ]
        },
        // --- نظرسنجی خروج از سازمان (کامل) ---
        'exit': {
            id: 'exit',
            title: 'نظرسنجی خروج از سازمان',
            description: 'درک دلایل ترک سازمان برای بهبود محیط کاری برای کارمندان آینده.',
            questions: [
                { id: 'ext_q1', text: 'لطفاً دلیل یا دلایل اصلی خود برای ترک سازمان را بیان کنید.', type: 'open_text' },
                { id: 'ext_q2', text: 'از تجربه کاری خود در این شرکت به طور کلی چقدر رضایت داشتید؟', type: 'rating_1_5' },
                { id: 'ext_q3', text: 'آیا احساس می‌کردید شغل شما از مهارت‌هایتان به خوبی استفاده می‌کند؟', type: 'rating_1_5' },
                { id: 'ext_q4', text: 'رابطه و کیفیت مدیریت مدیر مستقیم خود را چگونه ارزیابی می‌کنید؟', type: 'rating_1_5' },
                { id: 'ext_q5', text: 'آیا فرصت‌های کافی برای رشد و پیشرفت شغلی در اختیار شما قرار گرفت؟', type: 'rating_1_5' },
                { id: 'ext_q6', text: 'فرهنگ سازمانی شرکت را چگونه توصیف می‌کنید؟', type: 'open_text' },
                { id: 'ext_q7', text: 'آیا بسته حقوق و مزایای خود را منصفانه و رقابتی می‌دانستید؟', type: 'yes_no' },
                { id: 'ext_q8', text: 'آیا این شرکت را به عنوان یک محیط کاری به دیگران توصیه می‌کنید؟', type: 'yes_no' },
                { id: 'ext_q9', text: 'اگر می‌توانستید یک چیز را در شرکت تغییر دهید، آن چه بود؟', type: 'open_text' },
            ]
        }
    };


        // --- GLOBAL STATE & CONFIG ---
        const state = {
            employees: [],
            teams: [],
            reminders: [],
            surveyResponses: [],
            users: [],
            competencies: [],
            expenses: [],
            pettyCashCards: [],
             chargeHistory: [],
            dashboardMetrics: {},
            currentPage: 'dashboard',
             currentPageTalent: 1,
            currentUser: null,
        };
        let charts = {};
        
        // --- FIREBASE SETUP ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'hr-nik-prod';
        const firebaseConfig = {
            apiKey: "AIzaSyCCfPmxQy1uAKu0lPGSe3bc-P15iLYLHJo",
            authDomain: "nik-hr.firebaseapp.com",
            projectId: "nik-hr",
            storageBucket: "nik-hr.appspot.com",
            messagingSenderId: "731265316127",
            appId: "1:731265316127:web:6fda02cb2c7d4adfc92c2a"
        };

         let app, auth, db, storage;

        // --- AUTH & UI TOGGLING ---
        const showLoginPage = () => {
            document.getElementById('login-container').classList.remove('hidden');
            document.getElementById('signup-container').classList.add('hidden');
            document.getElementById('dashboard-container').classList.add('hidden');
            document.getElementById('loading-overlay').style.display = 'none';
        };

        const showSignupPage = () => {
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('signup-container').classList.remove('hidden');
            document.getElementById('dashboard-container').classList.add('hidden');
        };
        
        const showDashboard = () => {
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('signup-container').classList.add('hidden');
            document.getElementById('dashboard-container').classList.remove('hidden');
            document.getElementById('dashboard-container').classList.add('flex');
        };


        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                 storage = getStorage(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("User is logged in:", user.uid);
                        await fetchUserRole(user);
                        listenToData();
                    } else {
                        console.log("User is logged out.");
                        state.currentUser = null;
                        showLoginPage();
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('loading-overlay').innerHTML = `<p class="text-red-600 font-semibold">خطا در اتصال به پایگاه داده</p>`;
            }
        }

        async function fetchUserRole(user) {
            const userRef = doc(db, `artifacts/${appId}/public/data/users`, user.uid);
            const userSnap = await getDoc(userRef);

            if (userSnap.exists()) {
                state.currentUser = { uid: user.uid, email: user.email, ...userSnap.data() };
            } else {
                // This is a new user, check if they are the first user
                const usersCol = collection(db, `artifacts/${appId}/public/data/users`);
                const usersSnapshot = await getDocs(usersCol);
                const isFirstUser = usersSnapshot.empty;
                
                const newUserRole = isFirstUser ? 'admin' : 'viewer';
                const newUser = {
                    email: user.email,
                    role: newUserRole,
                    createdAt: serverTimestamp()
                };
                await setDoc(userRef, newUser);
                state.currentUser = { uid: user.uid, ...newUser };
                showToast(isFirstUser ? "ثبت نام موفق! شما ادمین سیستم هستید." : "ثبت نام موفق! به شما دسترسی مشاهده‌گر داده شد.");
            }
            console.log("Current user role:", state.currentUser.role);
        }
        
        // --- REAL-TIME DATA LISTENERS ---
        function listenToData() {
            const collectionsToListen = ['employees', 'teams', 'reminders', 'surveyResponses', 'users', 'competencies', 'expenses', 'pettyCashCards', 'chargeHistory'];
            let initialLoads = collectionsToListen.length;

            const onDataLoaded = () => {
                initialLoads--;
                if (initialLoads === 0) {
                    console.log("All initial data loaded.");
                     calculateAndApplyAnalytics();
                    showDashboard();
                    router(); 
                    document.getElementById('loading-overlay').style.display = 'none';
                }
            };

            collectionsToListen.forEach(colName => {
                const colRef = collection(db, `artifacts/${appId}/public/data/${colName}`);
                onSnapshot(colRef, (snapshot) => {
                    state[colName] = snapshot.docs.map(doc => ({ firestoreId: doc.id, ...doc.data() }));
                    
                    if (initialLoads > 0) {
                        onDataLoaded();
                    } else {
                        if (!window.location.hash.startsWith('#survey-taker')) {
                            renderPage(state.currentPage);
                        }
                    }
                }, (error) => {
                    console.error(`Error listening to ${colName}:`, error);
                    // For collections that might not exist initially, don't show a fatal error
                    if (['competencies', 'expenses', 'pettyCashCards'].includes(colName)) {
                        state[colName] = [];
                        if (initialLoads > 0) onDataLoaded();
                        return;
                    }
                    document.getElementById('loading-overlay').innerHTML = `<p class="text-red-600 font-semibold">خطا در دریافت داده‌ها</p>`;
                });
            });
        }

        // --- UTILITY & HELPER FUNCTIONS ---
        // --- تابع جدید برای تبدیل تاریخ به شمسی ---
        // --- تابع جدید برای تبدیل اعداد فارسی به انگلیسی ---
    const convertPersianNumbersToEnglish = (str) => {
        if (!str) return '';
        return str.toString()
            .replace(/۱/g, '1')
            .replace(/۲/g, '2')
            .replace(/۳/g, '3')
            .replace(/۴/g, '4')
            .replace(/۵/g, '5')
            .replace(/۶/g, '6')
            .replace(/۷/g, '7')
            .replace(/۸/g, '8')
            .replace(/۹/g, '9')
            .replace(/۰/g, '0');
    };
const toPersianDate = (dateInput) => {
    if (!dateInput) return 'نامشخص';
    try {
        let date;
        if (dateInput.toDate) { // Handle Firebase Timestamps
            date = dateInput.toDate();
        } else {
            date = new Date(dateInput);
        }

        // Check if the date is valid
        if (isNaN(date.getTime())) {
            return 'تاریخ نامعتبر';
        }

        const gYear = date.getFullYear();
        const gMonth = date.getMonth() + 1; // JS month is 0-indexed
        const gDay = date.getDate();

        const jalaaliDate = jalaali.toJalaali(gYear, gMonth, gDay);

        // Add leading zero to month and day if needed
        const jm = String(jalaaliDate.jm).padStart(2, '0');
        const jd = String(jalaaliDate.jd).padStart(2, '0');

        return `${jalaaliDate.jy}/${jm}/${jd}`;
    } catch (error) {
        console.error("Error converting date:", dateInput, error);
        return 'نامشخص';
    }
};
// --- تابع جدید برای تبدیل تاریخ شمسی ورودی به فرمت میلادی برای ذخیره ---
const persianToEnglishDate = (persianDateStr) => {
        if (!persianDateStr) return null;

        // ابتدا اعداد فارسی را به انگلیسی تبدیل می‌کنیم
        let englishDateStr = convertPersianNumbersToEnglish(persianDateStr);

        if (!isNaN(englishDateStr) && typeof englishDateStr !== 'string') {
            const date = new persianDate(parseInt(englishDateStr));
            englishDateStr = date.format('YYYY/MM/DD');
        }

        if (!/^\d{4}\/\d{2}\/\d{2}$/.test(englishDateStr)) {
            console.error("Invalid Persian date format. Expected YYYY/MM/DD, but got:", englishDateStr);
            return null;
        }
        try {
            const [jy, jm, jd] = englishDateStr.split('/').map(Number);
            const gregorian = jalaali.toGregorian(jy, jm, jd);
            return `${gregorian.gy}-${String(gregorian.gm).padStart(2, '0')}-${String(gregorian.gd).padStart(2, '0')}`;
        } catch (error) {
            console.error("Error converting Persian to Gregorian:", error);
            return null;
        }
    };

// --- تابع جدید برای فعال‌سازی تقویم شمسی روی یک فیلد ---
const activatePersianDatePicker = (elementId, initialValue = null) => {
    const input = document.getElementById(elementId);
    if (!input) return;

    // Change input type to text to allow custom format
    input.setAttribute('type', 'text');
    input.setAttribute('placeholder', 'مثال: 1403/05/28');
    input.setAttribute('autocomplete', 'off');

    if (initialValue) {
        input.value = toPersianDate(initialValue);
    }

    $(input).pDatepicker({
        format: 'YYYY/MM/DD',
        autoClose: true,
        initialValue: !!initialValue, // Set to true only if there is an initial value
        observer: true,
        calendar: {
            persian: {
                locale: 'fa'
            }
        },
        navigator: {
            enabled: true,
            scroll: {
                enabled: false
            }
        },
        timePicker: {
            enabled: false
        }
    });
};
        // --- تابع جدید برای ساخت دکمه‌های صفحه‌بندی ---
    const renderPagination = (containerId, currentPage, totalItems, itemsPerPage) => {
        const container = document.getElementById(containerId);
        if (!container) return;

        const totalPages = Math.ceil(totalItems / itemsPerPage);
        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        let paginationHtml = '<div class="flex items-center justify-center space-x-1 space-x-reverse">';
        
        // دکمه قبلی
        paginationHtml += `<button data-page="${currentPage - 1}" class="pagination-btn px-4 py-2 text-gray-500 bg-white rounded-md hover:bg-blue-500 hover:text-white" ${currentPage === 1 ? 'disabled' : ''}>قبلی</button>`;
        
        // دکمه‌های شماره صفحه
        for (let i = 1; i <= totalPages; i++) {
            const isActive = i === currentPage ? 'bg-blue-600 text-white' : 'bg-white text-gray-700';
            paginationHtml += `<button data-page="${i}" class="pagination-btn px-4 py-2 rounded-md hover:bg-blue-500 hover:text-white ${isActive}">${i}</button>`;
        }

        // دکمه بعدی
        paginationHtml += `<button data-page="${currentPage + 1}" class="pagination-btn px-4 py-2 text-gray-500 bg-white rounded-md hover:bg-blue-500 hover:text-white" ${currentPage === totalPages ? 'disabled' : ''}>بعدی</button>`;

        paginationHtml += '</div>';
        container.innerHTML = paginationHtml;
    };
        // --- تابع جدید برای تحلیل داده‌های نظرسنجی و اعمال نتایج ---
const calculateAndApplyAnalytics = () => {
        console.log("Running survey and risk analytics...");
        const engagementResponses = state.surveyResponses.filter(r => r.surveyId === 'engagement');
        
        // محاسبه امتیاز مشارکت برای هر کارمند
        const employeeScores = {};
        engagementResponses.forEach(res => {
            if (res.employeeId && res.employeeId !== 'anonymous') {
                if (!employeeScores[res.employeeId]) {
                    employeeScores[res.employeeId] = { totalScore: 0, questionCount: 0 };
                }
                Object.values(res.answers).forEach(ans => {
                    const score = parseInt(ans);
                    if (!isNaN(score)) {
                        employeeScores[res.employeeId].totalScore += score;
                        employeeScores[res.employeeId].questionCount++;
                    }
                });
            }
        });

        state.employees.forEach(emp => {
            if (employeeScores[emp.id]) {
                const data = employeeScores[emp.id];
                emp.engagementScore = Math.round(((data.totalScore / data.questionCount) / 5) * 100);
            } else {
                emp.engagementScore = null;
            }
        });

        // محاسبه امتیاز مشارکت برای هر تیم
        state.teams.forEach(team => {
            let teamTotalScore = 0;
            let teamQuestionCount = 0;
            team.memberIds?.forEach(memberId => {
                const memberData = employeeScores[memberId];
                if (memberData) {
                    teamTotalScore += memberData.totalScore;
                    teamQuestionCount += memberData.questionCount;
                }
            });
            team.engagementScore = teamQuestionCount > 0 ? Math.round(((teamTotalScore / teamQuestionCount) / 5) * 100) : null;
        });

        // محاسبه هوشمند ریسک خروج و ماتریس ۹ جعبه‌ای برای همه
        state.employees.forEach(emp => {
            emp.attritionRisk = calculateAttritionRisk(emp, state.teams);
            emp.nineBox = determineNineBoxCategory(emp); // <<-- این خط جدید است
        });

        console.log("Analytics applied to state.");
    };
        // --- تابع هوشمند برای محاسبه ریسک خروج بر اساس مدل امتیازبندی ---
    const calculateAttritionRisk = (employee, allTeams) => {
        let riskScore = 0;
        const reasons = [];

        // معیار ۱: امتیاز مشارکت (تا ۴۰ امتیاز)
        if (employee.engagementScore != null) {
            if (employee.engagementScore < 50) {
                riskScore += 40;
                reasons.push('مشارکت بسیار پایین');
            } else if (employee.engagementScore < 70) {
                riskScore += 20;
                reasons.push('مشارکت پایین');
            }
        } else {
            riskScore += 10; // امتياز منفی برای شرکت نکردن در نظرسنجی
            reasons.push('عدم مشارکت در نظرسنجی');
        }

        // معیار ۲: روند عملکرد (تا ۲۵ امتیاز)
        if (employee.performanceHistory && employee.performanceHistory.length >= 2) {
            const lastTwoReviews = employee.performanceHistory.slice(-2);
            const latestScore = lastTwoReviews[1].overallScore;
            const previousScore = lastTwoReviews[0].overallScore;
            if (previousScore - latestScore >= 1) {
                riskScore += 25;
                reasons.push('افت شدید عملکرد');
            } else if (previousScore - latestScore >= 0.5) {
                riskScore += 15;
                reasons.push('افت عملکرد');
            }
        }

        // معیار ۳: رکود شغلی (تا ۲۵ امتیاز)
        const isHighPerformer = (employee.performanceHistory && employee.performanceHistory.slice(-1)[0]?.overallScore > 4) || ['ستاره', 'مهره کلیدی'].includes(employee.nineBox);
        if (isHighPerformer && employee.careerPath && employee.careerPath.length > 0) {
            const lastMoveDate = new Date(employee.careerPath.slice(-1)[0].date);
            const monthsSinceLastMove = (new Date() - lastMoveDate) / (1000 * 60 * 60 * 24 * 30);
            if (monthsSinceLastMove > 24) { // بیشتر از ۲ سال بدون تغییر
                riskScore += 25;
                reasons.push('رکود شغلی (استعداد کلیدی)');
            }
        }

        // معیار ۴: سلامت تیم (تا ۱۰ امتیاز)
        const team = allTeams.find(t => t.memberIds?.includes(employee.id));
        if (team && team.engagementScore != null && team.engagementScore < 60) {
            riskScore += 10;
            reasons.push('عضو تیمی با مشارکت پایین');
        }

        return {
            score: Math.min(100, riskScore), // امتیاز نهایی بین ۰ تا ۱۰۰
            reasons: reasons.length > 0 ? reasons : ['ریسک پایین']
        };
    };
        // --- تابع جدید برای تعیین هوشمند جعبه در ماتریس ۹ جعبه‌ای ---
    const determineNineBoxCategory = (employee) => {
        // ۱. محاسبه امتیاز عملکرد (Performance)
        let performanceScore = 0;
        if (employee.performanceHistory && employee.performanceHistory.length > 0) {
            performanceScore = employee.performanceHistory.slice(-1)[0].overallScore;
        }

        let performanceCategory; // Low, Medium, High
        if (performanceScore >= 4.2) {
            performanceCategory = 'High';
        } else if (performanceScore >= 3.5) {
            performanceCategory = 'Medium';
        } else {
            performanceCategory = 'Low';
        }

        // ۲. محاسبه امتیاز پتانسیل (Potential) - ما از میانگین امتیاز شایستگی‌ها به عنوان یک شاخص استفاده می‌کنیم
        let potentialScore = 0;
        if (employee.competencies) {
            const scores = Object.values(employee.competencies);
            if (scores.length > 0) {
                potentialScore = scores.reduce((a, b) => a + b, 0) / scores.length;
            }
        }

        let potentialCategory; // Low, Medium, High
        if (potentialScore >= 4.2) {
            potentialCategory = 'High';
        } else if (potentialScore >= 3.5) {
            potentialCategory = 'Medium';
        } else {
            potentialCategory = 'Low';
        }

        // ۳. تخصیص جعبه بر اساس عملکرد و پتانسیل
        if (performanceCategory === 'High' && potentialCategory === 'High') return 'ستاره (Star)';
        if (performanceCategory === 'High' && potentialCategory === 'Medium') return 'استعداد کلیدی (Core Talent)';
        if (performanceCategory === 'High' && potentialCategory === 'Low') return 'مهره کلیدی (Key Player)';

        if (performanceCategory === 'Medium' && potentialCategory === 'High') return 'پتانسیل بالا (High Potential)';
        if (performanceCategory === 'Medium' && potentialCategory === 'Medium') return 'عملکرد قابل اتکا (Solid Performer)';
        if (performanceCategory === 'Medium' && potentialCategory === 'Low') return 'عملکرد متوسط (Average Performer)';

        if (performanceCategory === 'Low' && potentialCategory === 'High') return 'معما (Enigma/Puzzle)';
        if (performanceCategory === 'Low' && potentialCategory === 'Medium') return 'نیازمند بهبود (Needs Improvement)';
        if (performanceCategory === 'Low' && potentialCategory === 'Low') return 'ریسک (Risk)';
        
        return 'عملکرد قابل اتکا (Solid Performer)'; // مقدار پیش‌فرض
    };
        // --- تابع جدید برای تحلیل عمیق داده‌های یک تیم ---
    const analyzeTeamData = (team, members) => {
        const analysis = {};

        // ۱. تحلیل عمیق امتیاز مشارکت بر اساس دسته‌بندی
        const engagementByCategory = {};
        const engagementTemplate = surveyTemplates['engagement'];
        let memberResponseCount = 0;

        members.forEach(member => {
            const responses = state.surveyResponses.filter(r => r.employeeId === member.id && r.surveyId === 'engagement');
            if (responses.length > 0) {
                memberResponseCount++;
                responses.forEach(res => {
                    engagementTemplate.questions.forEach(q => {
                        if (q.type === 'rating_1_5' && res.answers[q.id]) {
                            const score = parseInt(res.answers[q.id]);
                            if (!engagementByCategory[q.category]) {
                                engagementByCategory[q.category] = { totalScore: 0, count: 0 };
                            }
                            engagementByCategory[q.category].totalScore += score;
                            engagementByCategory[q.category].count++;
                        }
                    });
                });
            }
        });

        analysis.engagementBreakdown = Object.entries(engagementByCategory).map(([category, data]) => ({
            name: engagementTemplate.categories[category] || category,
            score: Math.round(((data.totalScore / data.count) / 5) * 100)
        }));

        // ۲. شناسایی نقاط قوت کلیدی (Top Skills)
        const skillMap = new Map();
        members.forEach(member => {
            if (member.skills) {
                Object.entries(member.skills).forEach(([skill, level]) => {
                    if (level >= 4) { // فقط مهارت‌های سطح بالا را در نظر بگیر
                        skillMap.set(skill, (skillMap.get(skill) || 0) + 1);
                    }
                });
            }
        });
        analysis.topSkills = [...skillMap.entries()]
            .sort((a, b) => b[1] - a[1]) // مرتب‌سازی بر اساس تعداد تکرار
            .slice(0, 5) // ۵ مهارت برتر
            .map(item => item[0]);

        // ۳. شناسایی اعضای پرریسک
        analysis.highRiskMembers = members.filter(m => m.attritionRisk && m.attritionRisk.score > 70);

        return analysis;
    };
        
    
        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="ml-3"></i><span>${message}</span>`;
            container.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => toast.remove(), 5000);
        };
        
        const isAdmin = () => state.currentUser?.role === 'admin';
        const canEdit = () => state.currentUser?.role === 'admin' || state.currentUser?.role === 'editor';

        const calculateDashboardMetrics = () => {
            const totalEmployees = state.employees.length;
            if (totalEmployees === 0) {
                state.dashboardMetrics = {};
                return;
            }
            const activeEmployees = state.employees.filter(e => e.status === 'فعال');
            
            const retentionRate = totalEmployees > 0 ? ((activeEmployees.length / totalEmployees) * 100).toFixed(0) : 0;

            const totalTenureDays = activeEmployees.reduce((sum, emp) => {
                if (!emp.startDate) return sum;
                const start = new Date(emp.startDate);
                const now = new Date();
                return sum + Math.ceil(Math.abs(now - start) / (1000 * 60 * 60 * 24));
            }, 0);
            const averageTenureYears = activeEmployees.length > 0 ? (totalTenureDays / activeEmployees.length / 365).toFixed(1) : 0;
            
            const engagementResponses = state.surveyResponses.filter(r => r.surveyId === 'engagement');
            let totalScore = 0;
            let ratingCount = 0;
            engagementResponses.forEach(res => {
                Object.values(res.answers).forEach(ans => {
                    const score = parseInt(ans);
                    if (!isNaN(score)) {
                        totalScore += score;
                        ratingCount++;
                    }
                });
            });
            const engagementScore = ratingCount > 0 ? ((totalScore / ratingCount) / 5 * 100).toFixed(0) : 0;

            const mobileEmployees = state.employees.filter(e => e.careerPath && e.careerPath.length > 1).length;
            const internalMobilityRate = totalEmployees > 0 ? ((mobileEmployees / totalEmployees) * 100).toFixed(0) : 0;

            state.dashboardMetrics = {
                totalEmployees,
                retentionRate,
                averageTenure: averageTenureYears,
                engagementScore,
                internalMobilityRate,
                highImpactFlightRisk: activeEmployees.filter(e => e.attritionRisk?.score > 60).map(e => e.id),
                nineBoxDistribution: activeEmployees.reduce((acc, emp) => {
                    if (emp.nineBox) { acc[emp.nineBox] = (acc[emp.nineBox] || 0) + 1; }
                    return acc;
                }, {}),
                genderComposition: state.employees.reduce((acc, emp) => {
                    if (emp.gender) { acc[emp.gender] = (acc[emp.gender] || 0) + 1; }
                    return acc;
                }, {}),
                departmentDistribution: state.employees.reduce((acc, emp) => {
                    if (emp.department) { acc[emp.department] = (acc[emp.department] || 0) + 1; }
                    return acc;
                }, {}),
            };
        };

        // --- PAGE TEMPLATES & RENDERING ---
        const mainContent = document.getElementById('main-content');
        
        const pages = {
          dashboard: () => {
            calculateDashboardMetrics();
            const metrics = state.dashboardMetrics;
            if (Object.keys(metrics).length === 0) return `<div class="text-center p-10 bg-white rounded-lg shadow-md"><i data-lucide="inbox" class="mx-auto w-16 h-16 text-gray-400"></i><h2 class="mt-4 text-xl font-semibold text-gray-700">به NikHR خوش آمدید!</h2><p class="mt-2 text-gray-500">هنوز هیچ داده‌ای ثبت نشده است. برای شروع یک کارمند جدید اضافه کنید.</p><button onclick="window.location.hash='#talent'" class="mt-6 bg-blue-600 text-white py-2 px-5 rounded-md hover:bg-blue-700 transition">افزودن کارمند</button></div>`;
            
            // پیدا کردن کارمندان با ریسک بالا برای نمایش در داشبورد
            const highRiskEmployees = state.employees
                .filter(e => e.status === 'فعال' && e.attritionRisk && e.attritionRisk.score > 60)
                .sort((a, b) => b.attritionRisk.score - a.attritionRisk.score);

            const highRiskHtml = highRiskEmployees.length > 0 
                ? highRiskEmployees.map(emp => {
                    const reasonsHtml = emp.attritionRisk.reasons.map(reason => `<span class="bg-red-100 text-red-800 text-xs font-medium px-2 py-0.5 rounded-full">${reason}</span>`).join(' ');
                    return `<div class="bg-red-50 p-3 rounded-md">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 rounded-full mr-2 shrink-0 overflow-hidden bg-gray-200"><img src="${emp.avatar}" class="w-full h-full object-cover" alt="${emp.name}"></div>
                                        <div><p class="text-sm font-semibold text-red-800">${emp.name}</p></div>
                                    </div>
                                    <span class="text-lg font-bold text-red-600">${emp.attritionRisk.score}%</span>
                                </div>
                                <div class="mt-2 flex flex-wrap gap-1">${reasonsHtml}</div>
                            </div>`
                }).join('') 
                : '<p class="text-xs text-gray-500 text-center">موردی با ریسک بالا یافت نشد.</p>';

            return `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">داشبورد استراتژیک</h1>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="card bg-white p-6 rounded-lg shadow-md flex items-center">
                        <div class="bg-blue-100 p-3 rounded-full mr-4"><i data-lucide="users" class="text-blue-600"></i></div>
                        <div><p class="text-gray-500 text-sm">تعداد کل پرسنل</p><p class="text-2xl font-bold text-gray-800">${metrics.totalEmployees}</p></div>
                    </div>
                    <div class="card bg-white p-6 rounded-lg shadow-md flex items-center">
                        <div class="bg-green-100 p-3 rounded-full mr-4"><i data-lucide="trending-up" class="text-green-600"></i></div>
                        <div><p class="text-gray-500 text-sm">نرخ ماندگاری</p><p class="text-2xl font-bold text-gray-800">${metrics.retentionRate}%</p></div>
                    </div>
                    <div class="card bg-white p-6 rounded-lg shadow-md flex items-center">
                        <div class="bg-yellow-100 p-3 rounded-full mr-4"><i data-lucide="clock" class="text-yellow-600"></i></div>
                        <div><p class="text-gray-500 text-sm">میانگین سابقه (سال)</p><p class="text-2xl font-bold text-gray-800">${metrics.averageTenure}</p></div>
                    </div>
                     <div class="card bg-white p-6 rounded-lg shadow-md flex items-center">
                        <div class="bg-purple-100 p-3 rounded-full mr-4"><i data-lucide="recycle" class="text-purple-600"></i></div>
                        <div><p class="text-gray-500 text-sm">جابجایی داخلی</p><p class="text-2xl font-bold text-gray-800">${metrics.internalMobilityRate}%</p></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="card bg-white p-6 rounded-lg shadow-md lg:col-span-2">
                        <h3 class="font-semibold mb-4 flex items-center"><i data-lucide="bell" class="ml-2 text-indigo-600"></i>یادآور هوشمند</h3>
                        <div id="remindersList" class="space-y-4 mb-4 max-h-48 overflow-y-auto pr-2">${renderAllReminders()}</div>
                        ${canEdit() ? `<div class="border-t pt-4">
                            <p class="text-sm font-medium mb-2">افزودن یادآور دستی</p>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <input type="text" id="reminderText" placeholder="عنوان رویداد..." class="w-full p-2 border rounded-md text-sm">
                                <input type="text" id="reminderDate" class="p-2 border rounded-md text-sm">
                                <button id="addReminderBtn" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition text-sm">افزودن</button>
                            </div>
                        </div>` : ''}
                    </div>
                    <div class="space-y-6">
                        <div class="card bg-white p-6 rounded-lg shadow-md">
                            <p class="text-gray-500 text-sm flex items-center">امتیاز مشارکت کارکنان <i data-lucide="heart-pulse" class="mr-2 text-green-500"></i></p>
                            <div class="relative w-40 h-20 mx-auto mt-2">
                                <canvas id="engagementGaugeDashboard"></canvas>
                                <div class="absolute inset-0 flex items-center justify-center -bottom-4">
                                    <span class="text-3xl font-bold text-green-600">${metrics.engagementScore > 0 ? metrics.engagementScore + '%' : 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="card bg-white p-6 rounded-lg shadow-md">
                            <p class="text-gray-500 text-sm flex items-center">ریسک خروج استعدادهای کلیدی <i data-lucide="shield-alert" class="mr-2 text-red-500"></i></p>
                            <div class="mt-3 space-y-2">${highRiskHtml}</div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="card bg-white p-6 rounded-lg shadow-md"><h3 class="font-semibold mb-4">توزیع استعدادها</h3><div class="relative h-64"><canvas id="nineBoxChart"></canvas></div></div>
                    <div class="card bg-white p-6 rounded-lg shadow-md"><h3 class="font-semibold mb-4">توزیع دپارتمان‌ها</h3><div class="relative h-64"><canvas id="departmentDistributionChart"></canvas></div></div>
                    <div class="card bg-white p-6 rounded-lg shadow-md"><h3 class="font-semibold mb-4">ترکیب جنسیتی</h3><div class="relative h-64"><canvas id="genderCompositionChart"></canvas></div></div>
                </div>`;
        },
            talent: () => {
            if(state.employees.length === 0) return `<div class="text-center p-10 bg-white rounded-lg shadow-md"><i data-lucide="user-plus" class="mx-auto w-16 h-16 text-gray-400"></i><h2 class="mt-4 text-xl font-semibold text-gray-700">هنوز کارمندی ثبت نشده است</h2><p class="mt-2 text-gray-500">برای شروع، اولین کارمند سازمان را از طریق دکمه زیر اضافه کنید.</p>${canEdit() ? `<button id="add-employee-btn-empty" class="mt-6 bg-blue-600 text-white py-2 px-5 rounded-md hover:bg-blue-700 transition">افزودن کارمند جدید</button>` : ''}</div>`;
            return `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">مدیریت پرسنل</h1>
                    ${canEdit() ? `<button id="add-employee-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition flex items-center gap-2"><i data-lucide="plus"></i> افزودن کارمند جدید</button>`: ''}
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <div class="w-full md:w-1/2 lg:w-1/3 relative"><input type="text" id="searchInput" placeholder="جستجو..." class="w-full p-2 pr-10 border rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none"><i data-lucide="search" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i></div>
                        <div class="w-full md:w-auto flex flex-wrap gap-2"><select id="departmentFilter" class="p-2 border rounded-md"><option value="">همه دپارتمان‌ها</option>${[...new Set(state.employees.map(e => e.department))].filter(Boolean).map(d => `<option value="${d}">${d}</option>`).join('')}</select><select id="statusFilter" class="p-2 border rounded-md"><option value="">همه وضعیت‌ها</option><option value="فعال">فعال</option><option value="غیرفعال">غیرفعال</option></select></div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">تصویر</th>
                                    <th scope="col" class="px-6 py-3">نام</th>
                                    <th scope="col" class="px-6 py-3">کد پرسنلی</th>
                                    <th scope="col" class="px-6 py-3">دپارتمان</th>
                                    <th scope="col" class="px-6 py-3">وضعیت</th>
                                    <th scope="col" class="px-6 py-3">عملیات</th>
                                </tr>
                            </thead>
                            <tbody id="employeeTableBody"></tbody>
                        </table>
                    </div>
                    <div id="pagination-container" class="mt-6 flex justify-center"></div>
                </div>`
        },
           organization: () => {
            if (state.teams.length === 0) return `<div class="text-center p-10 bg-white rounded-lg shadow-md"><i data-lucide="users-2" class="mx-auto w-16 h-16 text-gray-400"></i><h2 class="mt-4 text-xl font-semibold text-gray-700">هنوز تیمی ثبت نشده است</h2><p class="mt-2 text-gray-500">برای شروع، اولین تیم سازمان را از طریق دکمه زیر اضافه کنید.</p>${canEdit() ? `<button id="add-team-btn-empty" class="mt-6 bg-blue-600 text-white py-2 px-5 rounded-md hover:bg-blue-700 transition">افزودن تیم جدید</button>` : ''}</div>`;
            return `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold text-gray-800">مدیریت تیم‌ها</h1>${canEdit() ? `<button id="add-team-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition flex items-center gap-2"><i data-lucide="plus"></i> افزودن تیم جدید</button>` : ''}</div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${state.teams.map(team => {
                const leader = state.employees.find(e => e.id === team.leaderId);
                return `
                <div class="card bg-white p-6 rounded-lg shadow-md flex flex-col">
                    <div class="flex items-center mb-4">
                        <img src="${team.avatar}" alt="${team.name}" class="w-16 h-16 rounded-full object-cover mr-4 border-2 border-blue-100">
                        <div>
                            <h3 class="text-xl font-bold text-blue-800">${team.name}</h3>
                            <p class="text-gray-600 text-sm"><strong>رهبر تیم:</strong> ${leader ? leader.name : 'نامشخص'}</p>
                        </div>
                    </div>
                    <p class="text-gray-700 mb-4 flex-grow"><strong>ماموریت:</strong> ${team.mission || ''}</p>
                    <div class="mb-4">
                        <p class="font-semibold mb-2">اعضای تیم:</p>
                        <div class="flex flex-wrap -space-x-2 space-x-reverse">${(team.memberIds || []).map(memberId => {
                            const member = state.employees.find(e => e.id === memberId);
                            return member ? `<div class="w-10 h-10 border-2 border-white rounded-full overflow-hidden shrink-0 bg-gray-200"><img class="w-full h-full object-cover" src="${member.avatar}" alt="${member.name}" title="${member.name}"></div>` : '';
                        }).join('')}</div>
                    </div>
                    <div class="flex gap-2 mt-auto">
                        <button class="view-team-profile-btn w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition" data-team-id="${team.firestoreId}">مشاهده</button>
                        ${canEdit() ? `<button class="edit-team-btn w-full bg-yellow-500 text-white py-2 px-4 rounded-md hover:bg-yellow-600 transition" data-team-id="${team.firestoreId}">ویرایش</button>` : ''}
                        ${isAdmin() ? `<button class="delete-team-btn w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 transition" data-team-id="${team.firestoreId}">حذف</button>` : ''}
                    </div>
                </div>`
            }).join('')}</div>`
        },
            surveys: () => `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">مدیریت نظرسنجی‌ها</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${Object.values(surveyTemplates).map(survey => `
                        <div class="card bg-white p-6 rounded-lg shadow-md flex flex-col">
                            <h3 class="text-xl font-bold text-blue-800 mb-2">${survey.title}</h3>
                            <p class="text-gray-600 mb-4 text-sm flex-grow">${survey.description}</p>
                            <button class="create-survey-link-btn mt-auto w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition" data-survey-id="${survey.id}">
                                <i data-lucide="link" class="inline-block ml-2"></i>ایجاد لینک
                            </button>
                        </div>
                    `).join('')}
                </div>
            `,
            analytics: () => `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">تحلیل هوشمند</h1>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Attrition Risk -->
                    <div class="card bg-white p-6 rounded-lg shadow-md">
                        <h3 class="font-semibold mb-4 flex items-center"><i data-lucide="shield-alert" class="ml-2 text-red-500"></i>نقاط داغ ریسک خروج</h3>
                        <div id="attrition-hotspot-list" class="space-y-3"></div>
                    </div>

                    <!-- Team Health -->
                    <div class="card bg-white p-6 rounded-lg shadow-md">
                        <h3 class="font-semibold mb-4 flex items-center"><i data-lucide="heart-pulse" class="ml-2 text-green-500"></i>وضعیت سلامت تیم‌ها</h3>
                        <div id="team-health-dashboard" class="space-y-3"></div>
                    </div>

                    <!-- 9-Box Grid -->
                    <div class="card bg-white p-6 rounded-lg shadow-md lg:col-span-2">
                        <h3 class="font-semibold mb-4">ماتریس استعداد ۹-جعبه‌ای</h3>
                        <div id="nine-box-grid-container" class="grid grid-cols-3 gap-2 text-center text-xs border-t-2 border-l-2 border-gray-400 mt-4"></div>
                    </div>
                    
                    <!-- Skill Gap Finder -->
                    <div class="card bg-white p-6 rounded-lg shadow-md lg:col-span-2">
                        <h3 class="font-semibold mb-4 flex items-center"><i data-lucide="file-search" class="ml-2 text-blue-500"></i>تحلیل شکاف مهارتی</h3>
                        <div class="flex flex-col sm:flex-row gap-2 items-center">
                            <select id="skill-team-select" class="p-2 border rounded-md w-full sm:w-1/3">
                                <option value="all">کل سازمان</option>
                                ${state.teams.map(t => `<option value="${t.firestoreId}">${t.name}</option>`).join('')}
                            </select>
                            <input type="text" id="skill-search-input" placeholder="مهارت مورد نظر را وارد کنید (مثلا: Python)" class="p-2 border rounded-md w-full sm:w-1/3">
                            <button id="find-skill-gap-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md w-full sm:w-auto">جستجو</button>
                        </div>
                        <div id="skill-gap-results" class="mt-4 p-4 bg-gray-50 rounded-md min-h-[5rem]">
                            <p class="text-sm text-gray-500">برای شروع، یک تیم و مهارت را انتخاب و روی دکمه جستجو کلیک کنید.</p>
                        </div>
                    </div>
                </div>
            `,
           settings: () => {
            if (!isAdmin()) {
                return `<div class="text-center p-10 bg-white rounded-lg shadow-md"><i data-lucide="lock" class="mx-auto w-16 h-16 text-red-500"></i><h2 class="mt-4 text-xl font-semibold text-gray-700">دسترسی غیر مجاز</h2><p class="mt-2 text-gray-500">شما برای مشاهده این صفحه دسترسی لازم را ندارید.</p></div>`;
            }
            const usersHtml = state.users.map(user => `
                <tr class="bg-white border-b">
                    <td class="px-6 py-4">${user.email}</td>
                    <td class="px-6 py-4">${toPersianDate(user.createdAt)}</td>
                    <td class="px-6 py-4">
                        <select data-uid="${user.firestoreId}" class="role-select p-2 border rounded-md bg-gray-50" ${user.firestoreId === state.currentUser.uid ? 'disabled' : ''}>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                            <option value="editor" ${user.role === 'editor' ? 'selected' : ''}>Editor</option>
                            <option value="viewer" ${user.role === 'viewer' ? 'selected' : ''}>Viewer</option>
                        </select>
                    </td>
                </tr>
            `).join('');

            const competenciesHtml = state.competencies.map(c => `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded-md">
                    <span>${c.name}</span>
                    <button class="delete-competency-btn text-red-500 hover:text-red-700" data-id="${c.firestoreId}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            `).join('');

            return `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">تنظیمات سیستم</h1>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card bg-white p-6 rounded-lg shadow-md">
                         <div class="flex justify-between items-center mb-4">
                             <h3 class="font-semibold">مدیریت کاربران</h3>
                             <button id="add-user-btn" class="bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700 transition text-sm flex items-center gap-1">
                                 <i data-lucide="plus" class="w-4 h-4"></i> افزودن
                             </button>
                         </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">ایمیل کاربر</th>
                                        <th scope="col" class="px-6 py-3">تاریخ عضویت</th>
                                        <th scope="col" class="px-6 py-3">سطح دسترسی</th>
                                    </tr>
                                </thead>
                                <tbody>${usersHtml}</tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card bg-white p-6 rounded-lg shadow-md">
                        <h3 class="font-semibold mb-4">مدیریت شایستگی‌های سازمان</h3>
                        <div id="competencies-list" class="space-y-2 mb-4">${competenciesHtml || '<p class="text-sm text-gray-500">هنوز شایستگی‌ای تعریف نشده است.</p>'}</div>
                        <form id="add-competency-form" class="flex gap-2">
                            <input type="text" id="new-competency-name" placeholder="نام شایستگی جدید..." class="w-full p-2 border rounded-md text-sm" required>
                            <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">افزودن</button>
                        </form>
                    </div>
                </div>
            `;
        },
expenses: () => {
            const cardsHtml = state.pettyCashCards.map(card => `
                <div class="card bg-white p-4 rounded-lg shadow-md">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-bold text-blue-800">${card.name}</p>
                            <p class="text-sm text-gray-600 font-mono">${(card.balance || 0).toLocaleString('fa-IR')} تومان</p>
                        </div>
                        <div class="flex items-center gap-2">
                             ${canEdit() ? `<button class="charge-card-btn text-green-600 hover:text-green-800" data-id="${card.firestoreId}" data-name="${card.name}" title="شارژ کارت"><i data-lucide="plus-circle"></i></button>` : ''}
                             ${isAdmin() ? `<button class="delete-card-btn text-red-500 hover:text-red-700" data-id="${card.firestoreId}" title="حذف کارت"><i data-lucide="trash-2"></i></button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            const expensesRows = state.expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).map(exp => `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-6 py-4">${toPersianDate(exp.date)}</td>
                    <td class="px-6 py-4">${exp.item}</td>
                    <td class="px-6 py-4">${state.pettyCashCards.find(c => c.firestoreId === exp.cardId)?.name || 'نامشخص'}</td>
                    <td class="px-6 py-4 font-mono">${exp.amount.toLocaleString('fa-IR')}</td>
                    <td class="px-6 py-4">
                        ${exp.invoiceUrl ? `<a href="${exp.invoiceUrl}" target="_blank" class="text-blue-600 hover:underline flex items-center gap-1"><i data-lucide="file-text" class="w-4 h-4"></i> مشاهده</a>` : '-'}
                    </td>
                     <td class="px-6 py-4">
                        ${canEdit() ? `<button class="delete-expense-btn text-red-600 hover:underline" data-id="${exp.firestoreId}"><i data-lucide="trash-2"></i></button>` : ''}
                    </td>
                </tr>
            `).join('');
            
            const chargeHistoryRows = state.chargeHistory.sort((a,b) => b.chargedAt?.toDate() - a.chargedAt?.toDate()).map(log => `
                 <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-6 py-4">${toPersianDate(log.chargedAt)}</td>
                    <td class="px-6 py-4">${log.cardName}</td>
                    <td class="px-6 py-4 font-mono text-green-600 font-semibold">+${log.amount.toLocaleString('fa-IR')}</td>
                    <td class="px-6 py-4 text-xs text-gray-500">${log.chargedBy}</td>
                    <td class="px-6 py-4">
                        ${canEdit() ? `<button class="delete-charge-log-btn text-red-600 hover:underline" data-id="${log.firestoreId}"><i data-lucide="trash-2"></i></button>` : ''}
                    </td>
                </tr>
            `).join('');
            
            const totalExpenses = state.expenses.reduce((sum, exp) => sum + exp.amount, 0);

            return `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">مدیریت هزینه‌ها</h1>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="lg:col-span-1 card bg-white p-6 rounded-lg shadow-md">
                        <h3 class="font-semibold mb-4">کارت‌های تنخواه</h3>
                        <div class="space-y-3 mb-4" id="cards-list">${cardsHtml || '<p class="text-sm text-gray-500">کارتی ثبت نشده است.</p>'}</div>
                        ${isAdmin() ? `<button id="add-card-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">افزودن کارت جدید</button>` : ''}
                    </div>
                    <div class="lg:col-span-2 card bg-white p-6 rounded-lg shadow-md">
                         <div class="flex justify-between items-center mb-4">
                            <h3 class="font-semibold">لیست هزینه‌ها</h3>
                            ${canEdit() ? `<button id="add-expense-btn" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">افزودن هزینه</button>` : ''}
                        </div>
                        <div class="overflow-x-auto max-h-96">
                            <table class="w-full text-sm text-right text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">تاریخ</th>
                                        <th scope="col" class="px-6 py-3">مورد</th>
                                        <th scope="col" class="px-6 py-3">کارت</th>
                                        <th scope="col" class="px-6 py-3">مبلغ (تومان)</th>
                                        <th scope="col" class="px-6 py-3">فاکتور</th>
                                        <th scope="col" class="px-6 py-3">عملیات</th>
                                    </tr>
                                </thead>
                                <tbody>${expensesRows || '<tr><td colspan="6" class="text-center p-4">هزینه‌ای ثبت نشده است.</td></tr>'}</tbody>
                                <tfoot class="bg-gray-100 font-semibold sticky bottom-0">
                                    <tr>
                                        <td colspan="3" class="px-6 py-3 text-left">جمع کل هزینه‌ها:</td>
                                        <td colspan="3" class="px-6 py-3 font-mono">${totalExpenses.toLocaleString('fa-IR')} تومان</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="card bg-white p-6 rounded-lg shadow-md">
                     <h3 class="font-semibold mb-4">تاریخچه شارژ کارت‌ها</h3>
                     <div class="overflow-x-auto max-h-80">
                         <table class="w-full text-sm text-right text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-6 py-3">تاریخ شارژ</th>
                                    <th scope="col" class="px-6 py-3">نام کارت</th>
                                    <th scope="col" class="px-6 py-3">مبلغ شارژ (تومان)</th>
                                    <th scope="col" class="px-6 py-3">کاربر</th>
                                    <th scope="col" class="px-6 py-3">عملیات</th>
                                </tr>
                            </thead>
                            <tbody>${chargeHistoryRows || '<tr><td colspan="5" class="text-center p-4">سابقه‌ای برای شارژ کارت‌ها وجود ندارد.</td></tr>'}</tbody>
                        </table>
                     </div>
                </div>
            `;
        },
        };

        // --- NAVIGATION & ROUTING ---
        const navigateTo = (pageName) => {
            state.currentPage = pageName;
            window.location.hash = pageName;
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.toggle('active', item.getAttribute('href') === `#${pageName}`);
            });
            renderPage(pageName);
        };

        const router = () => {
            const hash = window.location.hash;
            if (hash.startsWith('#survey-taker')) {
                const urlParams = new URLSearchParams(hash.split('?')[1]);
                const surveyId = urlParams.get('id');
                renderSurveyTakerPage(surveyId);
            } else {
                const pageName = hash.substring(1) || 'dashboard';
                navigateTo(pageName);
            }
        };

        const renderPage = (pageName) => {
            try {
                if (!state.currentUser) {
                    showLoginPage();
                    return;
                }
                
                document.getElementById('settings-nav-link').style.display = isAdmin() ? 'flex' : 'none';

                mainContent.innerHTML = pages[pageName]();
                
                if (pageName === 'dashboard') { renderDashboardCharts(); setupDashboardListeners(); }
                if (pageName === 'talent') { renderEmployeeTable(); setupTalentPageListeners(); }
                if (pageName === 'organization') { setupOrganizationPageListeners(); }
                if (pageName === 'surveys') { setupSurveysPageListeners(); }
                if (pageName === 'expenses') { setupExpensesPageListeners(); }
                if (pageName === 'analytics') { setupAnalyticsPage(); }
                if (pageName === 'settings') {
                    if(isAdmin()) {
                        setupSettingsPageListeners();
                    }
                }
                lucide.createIcons();
            } catch (error) {
                console.error("Failed to render page:", pageName, error);
                mainContent.innerHTML = `<div class="text-red-600 text-center p-8"><h1>خطا در نمایش صفحه</h1><p>${error.message}</p></div>`;
            }
        };

        // --- CHART RENDERING FUNCTIONS ---
        const destroyCharts = () => { Object.values(charts).forEach(chart => chart?.destroy()); charts = {}; };
        const renderDashboardCharts = () => {
            destroyCharts();
            const metrics = state.dashboardMetrics;
            if (Object.keys(metrics).length === 0) return;
            renderEngagementGauge('engagementGaugeDashboard', metrics.engagementScore);
            const genderCtx = document.getElementById('genderCompositionChart')?.getContext('2d');
            if (genderCtx && metrics.genderComposition) { charts.gender = new Chart(genderCtx, { type: 'doughnut', data: { labels: Object.keys(metrics.genderComposition), datasets: [{ data: Object.values(metrics.genderComposition), backgroundColor: ['rgb(59, 130, 246)', 'rgb(236, 72, 153)', 'rgb(107, 114, 128)'] }] }, options: { responsive: true, maintainAspectRatio: false } }); }
            const departmentCtx = document.getElementById('departmentDistributionChart')?.getContext('2d');
            if (departmentCtx) { charts.department = new Chart(departmentCtx, { type: 'bar', data: { labels: Object.keys(metrics.departmentDistribution), datasets: [{ label: 'تعداد', data: Object.values(metrics.departmentDistribution), backgroundColor: ['#f59e0b', '#8b5cf6', '#10b981', '#f43f5e', '#3b82f6'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); }
            const nineBoxCtx = document.getElementById('nineBoxChart')?.getContext('2d');
            if (nineBoxCtx && metrics.nineBoxDistribution) { charts.nineBox = new Chart(nineBoxCtx, { type: 'bar', data: { labels: Object.keys(metrics.nineBoxDistribution), datasets: [{ label: 'تعداد', data: Object.values(metrics.nineBoxDistribution), backgroundColor: ['#22c55e', '#3b82f6', '#14b8a6', '#6b7280', '#facc15'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); }
        };
        const renderEngagementGauge = (canvasId, score) => {
            const gaugeCtx = document.getElementById(canvasId)?.getContext('2d');
            if(gaugeCtx) { charts[canvasId] = new Chart(gaugeCtx, { type: 'doughnut', data: { datasets: [{ data: [score, 100 - score], backgroundColor: ['#22c55e', '#e5e7eb'], borderWidth: 0, circumference: 180, rotation: 270, }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } }, cutout: '70%' } }); }
        };
        const renderSkillRadarChart = (canvasId, skills) => {
            const skillCtx = document.getElementById(canvasId)?.getContext('2d');
            if (skillCtx) { if(charts[canvasId]) charts[canvasId].destroy(); charts[canvasId] = new Chart(skillCtx, { type: 'radar', data: { labels: Object.keys(skills), datasets: [{ label: 'سطح مهارت', data: Object.values(skills), fill: true, backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: 'rgb(59, 130, 246)' }] }, options: { scales: { r: { suggestedMin: 0, suggestedMax: 5, ticks: { stepSize: 1 } } } } }); }
        };

        // --- PAGE-SPECIFIC LOGIC ---
    const renderAllReminders = () => {
            const allReminders = [];
            const now = new Date();
            const oneDay = 1000 * 60 * 60 * 24;
            const reminderWindowDays = 30; // پنجره زمانی برای بیشتر یادآورها (۳۰ روز آینده)

            // 1. یادآورهای دستی از دیتابیس خوانده می‌شوند
            state.reminders.forEach(reminder => {
                allReminders.push({
                    date: new Date(reminder.date),
                    text: reminder.text,
                    icon: 'calendar-plus',
                    color: 'indigo'
                });
            });

            // 2. اسکن هوشمند پروفایل همه کارمندان برای رویدادهای خودکار
            state.employees.forEach(emp => {
                if (emp.status !== 'فعال') return; // فقط کارمندان فعال بررسی شوند

                // رویداد: اتمام قرارداد (در ۹۰ روز آینده)
                if (emp.contractEndDate) {
                    const endDate = new Date(emp.contractEndDate);
                    const daysUntilEnd = Math.round((endDate - now) / oneDay);
                    if (daysUntilEnd >= 0 && daysUntilEnd <= 90) {
                        allReminders.push({
                            date: endDate,
                            text: `تمدید قرارداد: ${emp.name}`,
                            subtext: `تاریخ اتمام: ${toPersianDate(endDate)}`,
                            icon: 'file-clock',
                            color: 'yellow'
                        });
                    }
                }

                // رویداد: سالروز تولد (در ۳ روز آینده) <<-- تغییر در این قسمت اعمال شد
                if (emp.personalInfo?.birthDate) {
                    const birthDate = new Date(emp.personalInfo.birthDate);
                    const nextBirthday = new Date(now.getFullYear(), birthDate.getMonth(), birthDate.getDate());
                    if (nextBirthday < now) { // اگر تاریخ تولد امسال گذشته بود، سال بعد را چک کن
                        nextBirthday.setFullYear(now.getFullYear() + 1);
                    }
                    const daysUntilBirthday = Math.round((nextBirthday - now) / oneDay);
                    if (daysUntilBirthday >= 0 && daysUntilBirthday <= 3) { // <<-- شرط به ۳ روز تغییر کرد
                         allReminders.push({
                            date: nextBirthday,
                            text: `تولد: ${emp.name}`,
                            subtext: `تاریخ تولد: ${toPersianDate(nextBirthday)}`,
                            icon: 'cake',
                            color: 'pink'
                        });
                    }
                }

                // رویداد: سالگرد استخدام (در ۳۰ روز آینده)
                if (emp.startDate) {
                    const startDate = new Date(emp.startDate);
                    const yearsOfWork = now.getFullYear() - startDate.getFullYear();
                    const nextAnniversary = new Date(now.getFullYear(), startDate.getMonth(), startDate.getDate());
                     if (nextAnniversary < now) { nextAnniversary.setFullYear(now.getFullYear() + 1); }
                    const daysUntilAnniversary = Math.round((nextAnniversary - now) / oneDay);
                    if (daysUntilAnniversary >= 0 && daysUntilAnniversary <= reminderWindowDays && yearsOfWork > 0) {
                        allReminders.push({
                            date: nextAnniversary,
                            text: `${yearsOfWork + 1}مین سالگرد استخدام: ${emp.name}`,
                            subtext: `تاریخ استخدام: ${toPersianDate(emp.startDate)}`,
                            icon: 'award',
                            color: 'blue'
                        });
                    }
                }
                
                // رویداد: پایان دوره آزمایشی (در ۳۰ روز آینده)
                if(emp.contractHistory && emp.contractHistory.length === 1) {
                    const firstContractDate = new Date(emp.contractHistory[0].startDate);
                    const probationEndDate = new Date(firstContractDate.setMonth(firstContractDate.getMonth() + 3));
                    const daysUntilProbationEnd = Math.round((probationEndDate - now) / oneDay);
                     if (daysUntilProbationEnd >= 0 && daysUntilProbationEnd <= reminderWindowDays) {
                         allReminders.push({
                            date: probationEndDate,
                            text: `پایان دوره آزمایشی: ${emp.name}`,
                            subtext: `تاریخ بررسی: ${toPersianDate(probationEndDate)}`,
                            icon: 'user-check',
                            color: 'teal'
                        });
                    }
                }

                // رویداد: ارزیابی عملکرد معوق
                if (emp.performanceHistory && emp.performanceHistory.length > 0) {
                    const lastReviewDate = new Date(emp.performanceHistory.slice(-1)[0].reviewDate);
                    const monthsSinceReview = (now - lastReviewDate) / (oneDay * 30.44);
                    if (monthsSinceReview > 6) {
                        allReminders.push({
                            date: new Date(now.getTime() + oneDay),
                            text: `ارزیابی عملکرد معوق: ${emp.name}`,
                            subtext: `آخرین ارزیابی: ${toPersianDate(lastReviewDate)}`,
                            icon: 'clipboard-x',
                            color: 'orange'
                        });
                    }
                }

                // رویداد: تبریک عملکرد فوق‌العاده
                if (emp.performanceHistory && emp.performanceHistory.length > 0) {
                    const lastReview = emp.performanceHistory.slice(-1)[0];
                    const daysSinceReview = (now - new Date(lastReview.reviewDate)) / oneDay;
                    if (lastReview.overallScore >= 4.8 && daysSinceReview <= 7) {
                         allReminders.push({
                            date: new Date(lastReview.reviewDate),
                            text: `تقدیر از عملکرد عالی: ${emp.name}`,
                            subtext: `امتیاز: ${lastReview.overallScore}/5`,
                            icon: 'sparkles',
                            color: 'amber'
                        });
                    }
                }
                
                // رویداد: پیگیری پس از تذکر انضباطی
                if (emp.disciplinaryHistory && emp.disciplinaryHistory.length > 0) {
                    const lastAction = emp.disciplinaryHistory.slice(-1)[0];
                    if (lastAction.type === 'تذکر') {
                        const actionDate = new Date(lastAction.date);
                        const followupDate = new Date(actionDate.setDate(actionDate.getDate() + 30));
                        const daysUntilFollowup = (followupDate - now) / oneDay;
                        if (daysUntilFollowup >= 0 && daysUntilFollowup <= reminderWindowDays) {
                            allReminders.push({
                                date: followupDate,
                                text: `پیگیری تذکر انضباطی: ${emp.name}`,
                                subtext: `تاریخ پیگیری: ${toPersianDate(followupDate)}`,
                                icon: 'message-square-plus',
                                color: 'gray'
                            });
                        }
                    }
                }
            });

            // مرتب‌سازی همه یادآورها بر اساس تاریخ
            allReminders.sort((a, b) => a.date - b.date);

            if (allReminders.length === 0) {
                return '<p class="text-sm text-gray-500 text-center">هیچ یادآوری فعالی وجود ندارد.</p>';
            }

            // تبدیل آبجکت‌های یادآور به کدهای HTML
            const colorClasses = {
                yellow: { bg: 'bg-yellow-50', text: 'text-yellow-600' },
                indigo: { bg: 'bg-indigo-50', text: 'text-indigo-600' },
                pink: { bg: 'bg-pink-50', text: 'text-pink-600' },
                blue: { bg: 'bg-blue-50', text: 'text-blue-600' },
                teal: { bg: 'bg-teal-50', text: 'text-teal-600' },
                orange: { bg: 'bg-orange-50', text: 'text-orange-600' },
                amber: { bg: 'bg-amber-50', text: 'text-amber-600' },
                gray: { bg: 'bg-gray-100', text: 'text-gray-600' }
            };

            return allReminders.map(r => {
                const colors = colorClasses[r.color] || colorClasses.indigo;
                return `<div class="flex items-start p-3 ${colors.bg} rounded-md">
                            <i data-lucide="${r.icon}" class="${colors.text} ml-3 mt-1 flex-shrink-0"></i>
                            <div>
                                <p class="font-medium">${r.text}</p>
                                <p class="text-sm text-gray-500">${r.subtext || `تاریخ: ${toPersianDate(r.date)}`}</p>
                            </div>
                        </div>`;
            }).join('');
        };
        const setupDashboardListeners = () => {
    // فعال کردن تقویم شمسی برای فیلد یادآور در داشبورد
    activatePersianDatePicker('reminderDate');

    document.getElementById('addReminderBtn')?.addEventListener('click', async () => {
        const textInput = document.getElementById('reminderText'); 
        const dateInput = document.getElementById('reminderDate');
        if (textInput.value && dateInput.value) { 
            try { 
                // تبدیل تاریخ شمسی به میلادی قبل از ذخیره
                const gregorianDate = persianToEnglishDate(dateInput.value);
                if (!gregorianDate) {
                    showToast("فرمت تاریخ شمسی صحیح نیست.", "error");
                    return;
                }
                await addDoc(collection(db, `artifacts/${appId}/public/data/reminders`), { text: textInput.value, date: gregorianDate }); 
                textInput.value = ''; 
                dateInput.value = ''; 
                showToast("یادآور با موفقیت اضافه شد."); 
            } catch (error) { 
                console.error("Error adding reminder:", error); 
                showToast("خطا در افزودن یادآور.", "error"); 
            } 
        }
    });
};
     const renderEmployeeTable = () => {
        const TALENT_PAGE_SIZE = 10; // <<-- تعداد آیتم در هر صفحه
        const searchInput = document.getElementById('searchInput')?.value.toLowerCase() || '';
        const departmentFilter = document.getElementById('departmentFilter')?.value || '';
        const statusFilter = document.getElementById('statusFilter')?.value || '';
        
        const filteredEmployees = state.employees.filter(emp =>
            (emp.name.toLowerCase().includes(searchInput) || emp.id.toLowerCase().includes(searchInput)) &&
            (!departmentFilter || emp.department === departmentFilter) &&
            (!statusFilter || emp.status === statusFilter)
        );

        // منطق جدید برای برش لیست بر اساس صفحه فعلی
        const startIndex = (state.currentPageTalent - 1) * TALENT_PAGE_SIZE;
        const endIndex = startIndex + TALENT_PAGE_SIZE;
        const paginatedEmployees = filteredEmployees.slice(startIndex, endIndex);
        
        const tableBody = document.getElementById('employeeTableBody');
        if (tableBody) {
            tableBody.innerHTML = paginatedEmployees.map(emp => `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <img src="${emp.avatar}" alt="${emp.name}" class="w-10 h-10 rounded-full object-cover">
                    </td>
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${emp.name}</td>
                    <td class="px-6 py-4">${emp.id}</td>
                    <td class="px-6 py-4">${emp.department || '-'}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${emp.status === 'فعال' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${emp.status}</span></td>
                    <td class="px-6 py-4 flex items-center gap-4">
                        <button class="view-employee-profile-btn text-blue-600 hover:underline" data-employee-id="${emp.firestoreId}">پروفایل</button>
                        ${canEdit() ? `<button class="edit-employee-btn text-yellow-600 hover:underline" data-employee-id="${emp.firestoreId}">ویرایش</button>` : ''}
                        ${isAdmin() ? `<button class="delete-employee-btn text-red-600 hover:underline" data-employee-id="${emp.firestoreId}">حذف</button>` : ''}
                    </td>
                </tr>`).join('');
        }

        // ساخت و نمایش دکمه‌های صفحه‌بندی
        renderPagination('pagination-container', state.currentPageTalent, filteredEmployees.length, TALENT_PAGE_SIZE);
    };
       const setupTalentPageListeners = () => {
        // ریست کردن صفحه به ۱ هنگام جستجو یا فیلتر
        const resetToFirstPage = () => {
            state.currentPageTalent = 1;
            renderEmployeeTable();
        };

        document.getElementById('searchInput')?.addEventListener('input', resetToFirstPage);
        document.getElementById('departmentFilter')?.addEventListener('change', resetToFirstPage);
        document.getElementById('statusFilter')?.addEventListener('change', resetToFirstPage);
        
        document.getElementById('add-employee-btn')?.addEventListener('click', () => showEmployeeForm());
        document.getElementById('add-employee-btn-empty')?.addEventListener('click', () => showEmployeeForm());

        const mainContentArea = document.getElementById('main-content');
        
        mainContentArea.addEventListener('click', (e) => {
            const viewEmpBtn = e.target.closest('.view-employee-profile-btn');
            const editEmpBtn = e.target.closest('.edit-employee-btn');
            const deleteEmpBtn = e.target.closest('.delete-employee-btn');
            const paginationBtn = e.target.closest('.pagination-btn');

            // منطق جدید برای دکمه‌های صفحه‌بندی
            if (paginationBtn && !paginationBtn.disabled) {
                state.currentPageTalent = Number(paginationBtn.dataset.page);
                renderEmployeeTable();
            }

            if (viewEmpBtn) {
                viewEmployeeProfile(viewEmpBtn.dataset.employeeId);
            } else if (editEmpBtn) {
                showEmployeeForm(editEmpBtn.dataset.employeeId);
            } else if (deleteEmpBtn) {
                showConfirmationModal("حذف کارمند", "آیا از حذف این کارمند مطمئن هستید؟", async () => {
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/employees`, deleteEmpBtn.dataset.employeeId));
                        showToast("کارمند با موفقیت حذف شد.");
                    } catch (error) {
                        console.error("Error deleting employee:", error);
                        showToast("خطا در حذف کارمند.", "error");
                    }
                });
            }
        });
    };
        const setupOrganizationPageListeners = () => {
            document.getElementById('add-team-btn')?.addEventListener('click', () => showTeamForm());
            document.getElementById('add-team-btn-empty')?.addEventListener('click', () => showTeamForm());
            
            const teamGrid = mainContent.querySelector('.grid');
            if(teamGrid) {
                teamGrid.addEventListener('click', (e) => {
                    const viewTeamBtn = e.target.closest('.view-team-profile-btn');
                    const editTeamBtn = e.target.closest('.edit-team-btn');
                    const deleteTeamBtn = e.target.closest('.delete-team-btn');

                    if (viewTeamBtn) viewTeamProfile(viewTeamBtn.dataset.teamId);
                    else if (editTeamBtn) showTeamForm(editTeamBtn.dataset.teamId);
                    else if (deleteTeamBtn) {
                        showConfirmationModal("حذف تیم", "آیا از حذف این تیم مطمئن هستید؟", async () => { 
                            try { 
                                await deleteDoc(doc(db, `artifacts/${appId}/public/data/teams`, deleteTeamBtn.dataset.teamId)); 
                                showToast("تیم با موفقیت حذف شد."); 
                            } catch (error) { 
                                console.error("Error deleting team:", error); 
                                showToast("خطا در حذف تیم.", "error"); 
                            } 
                        });
                    }
                });
            }
        };
        const setupSettingsPageListeners = () => {
            document.getElementById('add-user-btn')?.addEventListener('click', showAddUserForm);
            // Role management
            document.querySelectorAll('.role-select').forEach(select => {
                select.addEventListener('change', async (e) => {
                    const uid = e.target.dataset.uid;
                    const newRole = e.target.value;
                    const userRef = doc(db, `artifacts/${appId}/public/data/users`, uid);
                    try {
                        await updateDoc(userRef, { role: newRole });
                        showToast("نقش کاربر با موفقیت تغییر کرد.");
                    } catch (error) {
                        console.error("Error updating role:", error);
                        showToast("خطا در تغییر نقش کاربر.", "error");
                    }
                });
            });

            // Competency management
            const addCompetencyForm = document.getElementById('add-competency-form');
            if (addCompetencyForm) {
                addCompetencyForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const nameInput = document.getElementById('new-competency-name');
                    const competencyName = nameInput.value.trim();
                    if (competencyName) {
                        try {
                            await addDoc(collection(db, `artifacts/${appId}/public/data/competencies`), { name: competencyName });
                            showToast("شایستگی جدید اضافه شد.");
                            nameInput.value = '';
                        } catch (error) {
                            console.error("Error adding competency:", error);
                            showToast("خطا در افزودن شایستگی.", "error");
                        }
                    }
                });
            }

            document.getElementById('competencies-list')?.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-competency-btn');
                if (deleteBtn) {
                    const competencyId = deleteBtn.dataset.id;
                    showConfirmationModal('حذف شایستگی', 'آیا از حذف این شایستگی مطمئن هستید؟ این عمل بر پروفایل کارمندان تاثیر خواهد گذاشت.', async () => {
                        try {
                            await deleteDoc(doc(db, `artifacts/${appId}/public/data/competencies`, competencyId));
                            showToast("شایستگی با موفقیت حذف شد.");
                        } catch (error) {
                            console.error("Error deleting competency:", error);
                            showToast("خطا در حذف شایستگی.", "error");
                        }
                    });
                }
            });
        };
        const setupAnalyticsPage = () => {
            const renderAttritionHotspots = () => {
                const container = document.getElementById('attrition-hotspot-list');
                if (!container) return;
                const highRiskEmployees = state.employees.filter(emp => emp.attritionRisk && emp.attritionRisk.score > 50).sort((a, b) => b.attritionRisk.score - a.attritionRisk.score);
                if (highRiskEmployees.length === 0) { container.innerHTML = '<p class="text-sm text-gray-500">هیچ کارمندی با ریسک خروج بالا شناسایی نشد.</p>'; return; }
                container.innerHTML = highRiskEmployees.map(emp => `<div><div class="flex justify-between items-center mb-1 text-sm"><span class="font-medium text-gray-700">${emp.name}</span><span class="font-semibold text-red-600">${emp.attritionRisk.score}%</span></div><div class="progress-bar w-full bg-red-100"><div class="progress-bar-fill bg-red-500" style="width: ${emp.attritionRisk.score}%;"></div></div></div>`).join('');
            };

            const renderTeamHealth = () => {
                const container = document.getElementById('team-health-dashboard');
                if (!container) return;
                if (state.teams.length === 0) { container.innerHTML = '<p class="text-sm text-gray-500">تیمی برای نمایش وجود ندارد.</p>'; return; }
                container.innerHTML = state.teams.map(team => {
                    const metrics = team.healthMetrics || {};
                    const scores = Object.values(metrics);
                    const avgHealth = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
                    return `<div><div class="flex justify-between items-center mb-1 text-sm"><span class="font-medium text-gray-700">${team.name}</span><span class="font-semibold text-green-600">${Math.round(avgHealth)}%</span></div><div class="progress-bar w-full bg-green-100"><div class="progress-bar-fill bg-green-500" style="width: ${avgHealth}%;"></div></div></div>`;
                }).join('');
            };

            const renderNineBoxGrid = () => {
                const container = document.getElementById('nine-box-grid-container');
                if (!container) return;
                const gridMap = { 'معما': { row: 1, col: 1 }, 'عملکرد قابل اتکا': { row: 2, col: 1 }, 'مهره کلیدی': { row: 3, col: 1 }, 'پتانسیل بالا': { row: 2, col: 3 }, 'ستاره': { row: 3, col: 3 } };
                const grid = Array(3).fill(null).map(() => Array(3).fill(null).map(() => []));
                state.employees.forEach(emp => { const pos = gridMap[emp.nineBox]; if (pos) { grid[pos.row - 1][pos.col - 1].push(emp); } });
                let html = '';
                for (let i = 2; i >= 0; i--) { for (let j = 0; j < 3; j++) { const employeesInCell = grid[i][j]; html += `<div class="border-b-2 border-r-2 border-gray-200 min-h-[80px] p-1 flex flex-wrap items-start justify-center gap-1">${employeesInCell.map(emp => `<div class="w-8 h-8 rounded-full border-2 border-white shadow-sm overflow-hidden shrink-0 bg-gray-200"><img src="${emp.avatar}" alt="${emp.name}" title="${emp.name}" class="w-full h-full object-cover"></div>`).join('')}</div>`; } }
                container.innerHTML = html;
            };

            const setupSkillGapFinder = () => {
                const findBtn = document.getElementById('find-skill-gap-btn');
                const teamSelect = document.getElementById('skill-team-select');
                const skillInput = document.getElementById('skill-search-input');
                const resultsContainer = document.getElementById('skill-gap-results');
                if (!findBtn) return;
                findBtn.addEventListener('click', () => {
                    const teamId = teamSelect.value;
                    const skillName = skillInput.value.trim().toLowerCase();
                    if (!skillName) { resultsContainer.innerHTML = '<p class="text-sm text-red-500">لطفا نام یک مهارت را وارد کنید.</p>'; return; }
                    let targetEmployees = state.employees;
                    if (teamId !== 'all') { const team = state.teams.find(t => t.firestoreId === teamId); if (team) { targetEmployees = state.employees.filter(emp => team.memberIds.includes(emp.id)); } }
                    const skillAnalysis = { expert: [], intermediate: [], beginner: [], none: [] };
                    targetEmployees.forEach(emp => {
                        const skills = emp.skills || {};
                        const skillKeys = Object.keys(skills).map(k => k.toLowerCase());
                        const skillIndex = skillKeys.findIndex(k => k.includes(skillName));
                        if (skillIndex > -1) {
                            const originalKey = Object.keys(skills)[skillIndex];
                            const level = skills[originalKey];
                            if (level >= 4) skillAnalysis.expert.push(emp);
                            else if (level >= 2) skillAnalysis.intermediate.push(emp);
                            else skillAnalysis.beginner.push(emp);
                        } else { skillAnalysis.none.push(emp); }
                    });
                    resultsContainer.innerHTML = `<h4 class="font-bold mb-2">نتایج برای مهارت: <span class="text-blue-600">${skillInput.value}</span></h4><div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center"><div><p class="font-semibold text-lg">${skillAnalysis.expert.length}</p><p class="text-xs text-gray-500">متخصص (4-5)</p></div><div><p class="font-semibold text-lg">${skillAnalysis.intermediate.length}</p><p class="text-xs text-gray-500">متوسط (2-3)</p></div><div><p class="font-semibold text-lg">${skillAnalysis.beginner.length}</p><p class="text-xs text-gray-500">مبتدی (1)</p></div><div><p class="font-semibold text-lg">${skillAnalysis.none.length}</p><p class="text-xs text-gray-500">فاقد مهارت</p></div></div><p class="text-xs text-gray-600 mt-4"><strong>متخصصین:</strong> ${skillAnalysis.expert.map(e => e.name).join(', ') || 'هیچ'}</p>`;
                });
            };

            renderAttritionHotspots();
            renderTeamHealth();
            renderNineBoxGrid();
            setupSkillGapFinder();
        };
        
        // --- [FIX START] ADDED EXPENSES PAGE LISTENERS AND HELPERS ---
  const setupExpensesPageListeners = () => {
        document.getElementById('add-card-btn')?.addEventListener('click', () => showPettyCashCardForm());
        document.getElementById('add-expense-btn')?.addEventListener('click', () => showExpenseForm());

        mainContent.addEventListener('click', (e) => {
            const deleteCardBtn = e.target.closest('.delete-card-btn');
            const deleteExpenseBtn = e.target.closest('.delete-expense-btn');
            const chargeCardBtn = e.target.closest('.charge-card-btn');
            const deleteChargeLogBtn = e.target.closest('.delete-charge-log-btn'); // <<-- خط جدید

            if (chargeCardBtn) {
                const cardId = chargeCardBtn.dataset.id;
                const cardName = chargeCardBtn.dataset.name;
                showChargeCardForm(cardId, cardName);
            }

            if (deleteChargeLogBtn) { // <<-- بلوک if جدید
                const logId = deleteChargeLogBtn.dataset.id;
                showConfirmationModal('حذف سابقه شارژ', 'آیا مطمئن هستید؟ مبلغ شارژ از موجودی کارت کسر خواهد شد.', async () => {
                    try {
                        const logToDelete = state.chargeHistory.find(log => log.firestoreId === logId);
                        if (!logToDelete) {
                            showToast("سابقه مورد نظر یافت نشد.", "error");
                            return;
                        }

                        const cardRef = doc(db, `artifacts/${appId}/public/data/pettyCashCards`, logToDelete.cardId);
                        const chargeLogRef = doc(db, `artifacts/${appId}/public/data/chargeHistory`, logId);
                        
                        const cardSnap = await getDoc(cardRef);
                        if (cardSnap.exists()) {
                            const batch = writeBatch(db);
                            const currentBalance = cardSnap.data().balance || 0;
                            // کم کردن مبلغ شارژ از موجودی فعلی
                            batch.update(cardRef, { balance: currentBalance - logToDelete.amount });
                            // حذف لاگ شارژ
                            batch.delete(chargeLogRef);
                            await batch.commit();
                            showToast('سابقه شارژ با موفقیت حذف شد.');
                        } else {
                             // اگر کارت حذف شده بود، فقط لاگ را پاک کن
                            await deleteDoc(chargeLogRef);
                            showToast('سابقه شارژ حذف شد (کارت یافت نشد).');
                        }
                    } catch (error) {
                        console.error("Error deleting charge log:", error);
                        showToast("خطا در حذف سابقه شارژ.", "error");
                    }
                });
            }

            if (deleteCardBtn) {
                const cardId = deleteCardBtn.dataset.id;
                showConfirmationModal('حذف کارت تنخواه', 'آیا از حذف این کارت مطمئن هستید؟ تمام تاریخچه آن باقی می‌ماند.', async () => {
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/pettyCashCards`, cardId));
                        showToast('کارت با موفقیت حذف شد.');
                    } catch (error) {
                        console.error("Error deleting card:", error);
                        showToast('خطا در حذف کارت.', 'error');
                    }
                });
            }

            if (deleteExpenseBtn) {
                const expenseId = deleteExpenseBtn.dataset.id;
                showConfirmationModal('حذف هزینه', 'آیا از حذف این هزینه مطمئن هستید؟ مبلغ آن به کارت بازگردانده می‌شود.', async () => {
                    try {
                        const expenseToDelete = state.expenses.find(ex => ex.firestoreId === expenseId);
                        if (expenseToDelete) {
                            const cardRef = doc(db, `artifacts/${appId}/public/data/pettyCashCards`, expenseToDelete.cardId);
                            const cardSnap = await getDoc(cardRef);
                            if (cardSnap.exists()) {
                                const currentBalance = cardSnap.data().balance || 0;
                                await updateDoc(cardRef, { balance: currentBalance + expenseToDelete.amount });
                            }
                        }
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/expenses`, expenseId));
                        showToast('هزینه با موفقیت حذف شد.');
                    } catch (error) {
                        console.error("Error deleting expense:", error);
                        showToast('خطا در حذف هزینه.', 'error');
                    }
                });
            }
        });
    };

        const showPettyCashCardForm = (cardId = null) => {
            const isEditing = cardId !== null;
            const card = isEditing ? state.pettyCashCards.find(c => c.firestoreId === cardId) : {};
            modalTitle.innerText = isEditing ? 'ویرایش کارت تنخواه' : 'افزودن کارت تنخواه';
            modalContent.innerHTML = `
                <form id="card-form" class="space-y-4">
                    <div><label class="block font-medium">نام کارت</label><input type="text" id="card-name" value="${card.name || ''}" class="w-full p-2 border rounded-md" required></div>
                    <div><label class="block font-medium">موجودی اولیه (تومان)</label><input type="number" id="card-balance" value="${card.balance || ''}" class="w-full p-2 border rounded-md" ${isEditing ? 'readonly' : ''} required></div>
                    <div class="pt-6 flex justify-end"><button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">ذخیره</button></div>
                </form>
            `;
            openModal(mainModal, mainModalContainer);
            document.getElementById('card-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = {
                    name: document.getElementById('card-name').value,
                    balance: Number(document.getElementById('card-balance').value)
                };
                try {
                    const collectionRef = collection(db, `artifacts/${appId}/public/data/pettyCashCards`);
                    await addDoc(collectionRef, formData);
                    closeModal(mainModal, mainModalContainer);
                    showToast('کارت با موفقیت اضافه شد.');
                } catch (error) {
                    console.error("Error saving card:", error);
                    showToast('خطا در ذخیره کارت.', 'error');
                }
            });
        };

const showExpenseForm = () => {
    modalTitle.innerText = 'افزودن هزینه جدید';
    const cardOptions = state.pettyCashCards.map(c => `<option value="${c.firestoreId}">${c.name}</option>`).join('');
    modalContent.innerHTML = `
        <form id="expense-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block font-medium">تاریخ</label><input type="text" id="expense-date" class="w-full p-2 border rounded-md" required></div>
                <div><label class="block font-medium">مبلغ (تومان)</label><input type="number" id="expense-amount" class="w-full p-2 border rounded-md" required></div>
                <div class="md:col-span-2"><label class="block font-medium">شرح هزینه</label><input type="text" id="expense-item" class="w-full p-2 border rounded-md" required></div>
                <div><label class="block font-medium">کارت تنخواه</label><select id="expense-card" class="w-full p-2 border rounded-md" required>${cardOptions}</select></div>
                <div>
                    <label class="block font-medium">آپلود فاکتور (اختیاری)</label>
                    <input type="file" id="expense-invoice-file" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                </div>
            </div>
            <div class="pt-6 flex justify-end"><button type="submit" id="submit-expense-btn" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">ذخیره</button></div>
        </form>
    `;
    openModal(mainModal, mainModalContainer);
    activatePersianDatePicker('expense-date', new Date());

    document.getElementById('expense-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = document.getElementById('submit-expense-btn');
        submitBtn.disabled = true;
        submitBtn.innerText = 'در حال ذخیره...';

        const amount = Number(document.getElementById('expense-amount').value);
        const cardId = document.getElementById('expense-card').value;
        const persianDate = document.getElementById('expense-date').value;
        const gregorianDate = persianToEnglishDate(persianDate);
        const invoiceFile = document.getElementById('expense-invoice-file').files[0];
        let invoiceUrl = '';

        if (!gregorianDate) {
            showToast("فرمت تاریخ شمسی صحیح نیست.", "error");
            submitBtn.disabled = false;
            submitBtn.innerText = 'ذخیره';
            return;
        }

        try {
            // اگر فایلی انتخاب شده بود، آن را آپلود کن
            if (invoiceFile) {
                const filePath = `invoices/${Date.now()}_${invoiceFile.name}`;
                const storageRef = ref(storage, filePath);
                const snapshot = await uploadBytes(storageRef, invoiceFile);
                invoiceUrl = await getDownloadURL(snapshot.ref);
            }

            const formData = {
                date: gregorianDate,
                amount: amount,
                item: document.getElementById('expense-item').value,
                cardId: cardId,
                invoiceUrl: invoiceUrl,
                createdAt: serverTimestamp()
            };

            // بقیه منطق ذخیره‌سازی
            const cardRef = doc(db, `artifacts/${appId}/public/data/pettyCashCards`, cardId);
            const cardSnap = await getDoc(cardRef);
            if (cardSnap.exists()) {
                const currentBalance = cardSnap.data().balance || 0;
                if (currentBalance < amount) {
                    showToast('موجودی کارت کافی نیست.', 'error');
                    submitBtn.disabled = false;
                    submitBtn.innerText = 'ذخیره';
                    return;
                }
                const expenseCollectionRef = collection(db, `artifacts/${appId}/public/data/expenses`);
                const batch = writeBatch(db);
                batch.set(doc(expenseCollectionRef), formData);
                batch.update(cardRef, { balance: currentBalance - amount });
                await batch.commit();
                closeModal(mainModal, mainModalContainer);
                showToast('هزینه با موفقیت ثبت شد.');
            } else {
                showToast('کارت تنخواه انتخاب شده معتبر نیست.', 'error');
            }

        } catch (error) {
            console.error("Error saving expense:", error);
            showToast('خطا در ذخیره هزینه.', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerText = 'ذخیره';
        }
    });
};
        const showChargeCardForm = (cardId, cardName) => {
        modalTitle.innerText = `شارژ کارت تنخواه: ${cardName}`;
        modalContent.innerHTML = `
            <form id="charge-card-form" class="space-y-4">
                <div>
                    <label class="block font-medium">مبلغ شارژ (تومان)</label>
                    <input type="number" id="charge-amount" class="w-full p-2 border rounded-md" required>
                </div>
                <div class="pt-6 flex justify-end">
                    <button type="submit" id="submit-charge-btn" class="bg-green-600 text-white py-2 px-6 rounded-md hover:bg-green-700">تایید و شارژ</button>
                </div>
            </form>
        `;
        openModal(mainModal, mainModalContainer);

        document.getElementById('charge-card-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-charge-btn');
            submitBtn.disabled = true;
            submitBtn.innerText = 'در حال پردازش...';

            const amount = Number(document.getElementById('charge-amount').value);
            if (amount <= 0) {
                showToast("مبلغ شارژ باید مثبت باشد.", "error");
                submitBtn.disabled = false;
                submitBtn.innerText = 'تایید و شارژ';
                return;
            }

            try {
                const cardRef = doc(db, `artifacts/${appId}/public/data/pettyCashCards`, cardId);
                const chargeHistoryRef = collection(db, `artifacts/${appId}/public/data/chargeHistory`);
                const cardSnap = await getDoc(cardRef);

                if (cardSnap.exists()) {
                    const currentBalance = cardSnap.data().balance || 0;
                    const newBalance = currentBalance + amount;

                    const batch = writeBatch(db);
                    
                    // 1. Update card balance
                    batch.update(cardRef, { balance: newBalance });

                    // 2. Log the transaction
                    batch.set(doc(chargeHistoryRef), {
                        cardId: cardId,
                        cardName: cardName,
                        amount: amount,
                        chargedAt: serverTimestamp(),
                        chargedBy: state.currentUser.email
                    });

                    await batch.commit();
                    closeModal(mainModal, mainModalContainer);
                    showToast(`کارت ${cardName} با موفقیت شارژ شد.`);
                } else {
                    showToast("کارت مورد نظر یافت نشد.", "error");
                }
            } catch (error) {
                console.error("Error charging card:", error);
                showToast("خطا در عملیات شارژ کارت.", "error");
            } finally {
                 if(document.getElementById('submit-charge-btn')) { // Check if modal is still open
                    submitBtn.disabled = false;
                    submitBtn.innerText = 'تایید و شارژ';
                 }
            }
        });
    };
        // --- [FIX END] ---

        // --- MODAL & FORM LOGIC ---
        const mainModal = document.getElementById('mainModal'); const modalTitle = document.getElementById('modalTitle'); const modalContent = document.getElementById('modalContent'); const mainModalContainer = mainModal.querySelector('div');
        
        const renderCompetencyBars = (competencies) => {
            if (!competencies || Object.keys(competencies).length === 0) {
                return '<p class="text-sm text-gray-500">شایستگی‌ای ثبت نشده است.</p>';
            }
            return Object.entries(competencies).map(([name, score]) => `
                <div>
                    <div class="flex justify-between items-center mb-1 text-sm">
                        <span class="text-gray-600">${name}</span>
                        <span class="font-medium text-blue-600">${score}/5</span>
                    </div>
                    <div class="progress-bar w-full">
                        <div class="progress-bar-fill" style="width: ${score * 20}%;"></div>
                    </div>
                </div>
            `).join('');
        };

        const imageUploadInput = document.getElementById('image-upload-input');
        let onImageResizedCallback = null;

        if (imageUploadInput) {
            imageUploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file || !onImageResizedCallback) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_DIMENSION = 256;
                        let { width, height } = img;

                        if (width > height) {
                            if (width > MAX_DIMENSION) {
                                height *= MAX_DIMENSION / width;
                                width = MAX_DIMENSION;
                            }
                        } else {
                            if (height > MAX_DIMENSION) {
                                width *= MAX_DIMENSION / height;
                                height = MAX_DIMENSION;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
                        if (onImageResizedCallback) {
                            onImageResizedCallback(dataUrl);
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
                event.target.value = '';
            });
        }

        function handleAvatarChange(updateFunction) {
            onImageResizedCallback = (newAvatarUrl) => {
                updateFunction(newAvatarUrl);
                onImageResizedCallback = null;
            };
            imageUploadInput.click();
        }

        const generateSmartAnalysis = (emp) => {
            const analysis = {};
            if (emp.performanceHistory && emp.performanceHistory.length > 1) {
                const last = emp.performanceHistory[emp.performanceHistory.length - 1].overallScore;
                const first = emp.performanceHistory[0].overallScore;
                if (last > first + 0.2) { analysis.performance = { text: 'روند عملکرد کاملاً صعودی است.', icon: 'trending-up', color: 'text-green-600' }; } 
                else if (first > last + 0.2) { analysis.performance = { text: 'روند عملکرد نیاز به بررسی دارد.', icon: 'trending-down', color: 'text-yellow-600' }; } 
                else { analysis.performance = { text: 'عملکرد پایدار و قابل اتکایی دارد.', icon: 'minus', color: 'text-gray-600' }; }
            }
            if (emp.attritionRisk?.score > 70) { analysis.risk = { text: 'ریسک خروج بالا. پیشنهاد می‌شود جلسه هم‌اندیشی برگزار شود.', icon: 'shield-alert', color: 'text-red-600' }; } 
            else if (emp.attritionRisk?.score > 40) { analysis.risk = { text: 'ریسک خروج متوسط. حفظ انگیزه و شفافیت در مسیر رشد توصیه می‌شود.', icon: 'shield-check', color: 'text-yellow-600' }; }
            if (emp.nineBox === 'ستاره' || emp.nineBox === 'پتانسیل بالا') { analysis.potential = { text: 'پتانسیل بالایی برای رشد و پذیرش مسئولیت‌های کلیدی دارد.', icon: 'sparkles', color: 'text-blue-600' }; } 
            else if (emp.nineBox === 'مهره کلیدی') { analysis.potential = { text: 'یک مهره کلیدی با عملکرد بالا در نقش فعلی است.', icon: 'key-round', color: 'text-teal-600' }; }
            const topSkill = Object.entries(emp.skills || {}).sort((a, b) => b[1] - a[1])[0];
            const topCompetency = Object.entries(emp.competencies || {}).sort((a, b) => b[1] - a[1])[0];
            if (topSkill || topCompetency) { analysis.strength = { text: `نقاط قوت کلیدی: <strong>${topSkill ? topSkill[0] : ''}</strong> و <strong>${topCompetency ? topCompetency[0] : ''}</strong>.`, icon: 'star', color: 'text-amber-500' }; }
            return analysis;
        };

        const generateTeamSmartAnalysis = (team) => {
            const analysis = {};
            const members = state.employees.filter(e => team.memberIds?.includes(e.id));
            if (members.length === 0) return analysis;
            const avgOkrProgress = (team.okrs || []).reduce((sum, okr) => sum + okr.progress, 0) / (team.okrs?.length || 1);
            if (avgOkrProgress > 70) { analysis.okr = { text: 'تیم در مسیر دستیابی به اهداف خود قرار دارد.', icon: 'trending-up', color: 'text-green-600' }; } 
            else if (avgOkrProgress < 40) { analysis.okr = { text: 'پیشرفت اهداف تیم نیاز به بازبینی و حمایت دارد.', icon: 'trending-down', color: 'text-yellow-600' }; }
            const highRiskMembers = members.filter(m => m.attritionRisk?.score > 70).length;
            if (highRiskMembers > 0) { analysis.risk = { text: `${highRiskMembers} نفر از اعضا ریسک خروج بالا دارند.`, icon: 'shield-alert', color: 'text-red-600' }; }
            return analysis;
        };

const showEmployeeForm = (employeeId = null) => {
        const isEditing = employeeId !== null;
        const emp = isEditing ? state.employees.find(e => e.firestoreId === employeeId) : {};

        const currentTeam = isEditing ? state.teams.find(t => t.memberIds?.includes(emp.id)) : null;

        const teamOptions = state.teams.map(team =>
            `<option value="${team.firestoreId}" ${currentTeam?.firestoreId === team.firestoreId ? 'selected' : ''}>${team.name}</option>`
        ).join('');

        modalTitle.innerText = isEditing ? 'ویرایش اطلاعات کارمند' : 'افزودن کارمند جدید';
        modalContent.innerHTML = `
            <form id="employee-form" class="space-y-4" data-old-team-id="${currentTeam?.firestoreId || ''}">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-slate-700">نام کامل</label>
                        <input type="text" id="name" value="${emp.name || ''}" class="mt-1 block w-full p-2 border border-slate-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="id" class="block text-sm font-medium text-slate-700">کد پرسنلی</label>
                        <input type="text" id="id" value="${emp.id || ''}" class="mt-1 block w-full p-2 border border-slate-300 rounded-lg" ${isEditing ? 'readonly' : ''} required>
                    </div>
                    <div>
                        <label for="jobTitle" class="block text-sm font-medium text-slate-700">عنوان شغلی</label>
                        <input type="text" id="jobTitle" value="${emp.jobTitle || ''}" placeholder="مثال: کارشناس بازاریابی دیجیتال" class="mt-1 block w-full p-2 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label for="level" class="block text-sm font-medium text-slate-700">سطح</label>
                        <select id="level" class="mt-1 block w-full p-2 border border-slate-300 rounded-lg">
                            <option value="Junior" ${emp.level === 'Junior' ? 'selected' : ''}>Junior (کارشناس)</option>
                            <option value="Mid-level" ${emp.level === 'Mid-level' ? 'selected' : ''}>Mid-level (کارشناس ارشد)</option>
                            <option value="Senior" ${emp.level === 'Senior' ? 'selected' : ''}>Senior (خبره)</option>
                            <option value="Lead" ${emp.level === 'Lead' ? 'selected' : ''}>Lead (راهبر)</option>
                            <option value="Manager" ${emp.level === 'Manager' ? 'selected' : ''}>Manager (مدیر)</option>
                        </select>
                    </div>
                    <div>
                        <label for="department-team-select" class="block text-sm font-medium text-slate-700">دپارتمان / تیم</label>
                        <select id="department-team-select" class="mt-1 block w-full p-2 border border-slate-300 rounded-lg">
                            <option value="">انتخاب کنید...</option>
                            ${teamOptions}
                        </select>
                    </div>
                     <div>
                        <label for="status" class="block text-sm font-medium text-slate-700">وضعیت</label>
                        <select id="status" class="mt-1 block w-full p-2 border border-slate-300 rounded-lg">
                            <option value="فعال" ${emp.status === 'فعال' ? 'selected' : ''}>فعال</option>
                            <option value="غیرفعال" ${emp.status === 'غیرفعال' ? 'selected' : ''}>غیرفعال</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                         <label for="startDate" class="block text-sm font-medium text-slate-700">تاریخ استخدام</label>
                         <input type="text" id="startDate" class="mt-1 block w-full p-2 border border-slate-300 rounded-lg">
                    </div>
                </div>
                <div class="pt-4 flex justify-end">
                    <button type="submit" class="bg-indigo-500 text-white py-2 px-6 rounded-lg hover:bg-indigo-600 shadow-md transition">ذخیره</button>
                </div>
            </form>
        `;
        openModal(mainModal, mainModalContainer);
        // فعال‌سازی تقویم شمسی برای فیلد تاریخ استخدام
        activatePersianDatePicker('startDate', emp.startDate);

        document.getElementById('employee-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const oldTeamId = form.dataset.oldTeamId;
            const newTeamId = document.getElementById('department-team-select').value;
            const name = document.getElementById('name').value;
            const employeeCode = document.getElementById('id').value;

            const selectedTeam = state.teams.find(t => t.firestoreId === newTeamId);
            const departmentName = selectedTeam ? selectedTeam.name : '';
            
            const gregorianStartDate = persianToEnglishDate(document.getElementById('startDate').value);

            const formData = {
                name: name,
                id: employeeCode,
                jobTitle: document.getElementById('jobTitle').value,
                level: document.getElementById('level').value,
                department: departmentName,
                status: document.getElementById('status').value,
                startDate: gregorianStartDate, // ذخیره تاریخ استخدام
                avatar: emp.avatar || `https://placehold.co/100x100/E2E8F0/4A5568?text=${name.substring(0, 2)}`,
                ...isEditing && {
                    personalInfo: emp.personalInfo || {},
                    skills: emp.skills || {},
                    performanceHistory: emp.performanceHistory || [],
                    competencies: emp.competencies || {},
                    careerPath: emp.careerPath || [],
                }
            };
            
            // اگر کارمند جدید است، اولین رویداد مسیر شغلی را به صورت خودکار بساز
            if (!isEditing) {
                formData.careerPath = [{
                    date: gregorianStartDate,
                    type: 'استخدام',
                    title: formData.jobTitle,
                    department: formData.department
                }];
            }

            try {
                const batch = writeBatch(db);
                const docRef = doc(db, `artifacts/${appId}/public/data/employees`, isEditing ? emp.firestoreId : employeeCode);
                batch.set(docRef, formData, { merge: true });

                if (oldTeamId !== newTeamId) {
                    if (oldTeamId) {
                        const oldTeamRef = doc(db, `artifacts/${appId}/public/data/teams`, oldTeamId);
                        const oldTeamData = state.teams.find(t => t.firestoreId === oldTeamId);
                        if(oldTeamData) {
                           const oldMembers = oldTeamData.memberIds || [];
                           batch.update(oldTeamRef, { memberIds: oldMembers.filter(id => id !== employeeCode) });
                        }
                    }
                    if (newTeamId) {
                        const newTeamRef = doc(db, `artifacts/${appId}/public/data/teams`, newTeamId);
                        const newTeamData = state.teams.find(t => t.firestoreId === newTeamId);
                        if (newTeamData) {
                            const newMembers = newTeamData.memberIds || [];
                            if (!newMembers.includes(employeeCode)) {
                                newMembers.push(employeeCode);
                            }
                            batch.update(newTeamRef, { memberIds: newMembers });
                        }
                    }
                }
                
                await batch.commit();
                closeModal(mainModal, mainModalContainer);
                showToast(isEditing ? "کارمند با موفقیت ویرایش شد." : "کارمند با موفقیت اضافه و مسیر شغلی او ثبت شد.");
            } catch (error) {
                console.error("Error saving employee and updating team:", error);
                showToast("خطا در ذخیره اطلاعات.", "error");
            }
        });
    };
const viewEmployeeProfile = (employeeId) => {
        const emp = state.employees.find(e => e.firestoreId === employeeId); if (!emp) return;
        const analysis = generateSmartAnalysis(emp);
        const team = state.teams.find(t => t.memberIds?.includes(emp.id));
        const manager = team ? state.employees.find(e => e.id === team.leaderId) : null;
        const latestContract = emp.contractHistory && emp.contractHistory.length > 0 ? emp.contractHistory.slice().sort((a, b) => new Date(b.startDate) - new Date(a.startDate))[0] : null;

        modalTitle.innerText = 'پروفایل ۳۶۰ درجه: ' + emp.name;
        modalContent.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 space-y-6">
                    <div class="card p-4 bg-gray-50 rounded-lg text-center relative group">
                        <div class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-white shadow-md overflow-hidden bg-gray-200 flex items-center justify-center">
                            <img src="${emp.avatar}" alt="${emp.name}" class="w-full h-full object-cover">
                        </div>
                        ${canEdit() ? `<div class="absolute top-2 left-2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button id="change-avatar-btn" class="bg-white p-1.5 rounded-full shadow-md"><i data-lucide="camera" class="w-4 h-4"></i></button>
                            <button id="delete-avatar-btn" class="bg-white p-1.5 rounded-full shadow-md"><i data-lucide="trash-2" class="w-4 h-4 text-red-600"></i></button>
                        </div>` : ''}
                        
                        <div class="flex items-center justify-center gap-2">
                            <h2 class="text-2xl font-bold text-slate-800">${emp.name}</h2>
                            ${canEdit() ? `<button id="main-edit-employee-btn" class="p-1.5 text-slate-500 hover:text-teal-600" title="ویرایش اطلاعات اصلی"><i data-lucide="edit" class="w-5 h-5"></i></button>` : ''}
                        </div>

                        <p class="text-teal-600 font-semibold">${emp.jobTitle || 'بدون عنوان شغلی'}</p>
                        <p class="text-sm text-slate-500">${emp.level || ''}</p>
                        <span class="mt-2 inline-block px-3 py-1 text-xs font-medium rounded-full ${emp.status === 'فعال' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${emp.status}</span>
                    </div>
                    <div class="card p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-semibold mb-3 text-slate-700 flex items-center"><i data-lucide="heart-pulse" class="ml-2 w-5 h-5 text-green-500"></i>امتیاز مشارکت (Engagement)</h4>
                        ${emp.engagementScore != null ? `
                        <div class="relative w-40 h-20 mx-auto mt-2">
                            <canvas id="engagementGaugeProfile"></canvas>
                            <div class="absolute inset-0 flex items-center justify-center -bottom-4">
                                <span class="text-3xl font-bold text-green-600">${emp.engagementScore}%</span>
                            </div>
                        </div>
                        ` : '<p class="text-sm text-slate-500 text-center">هنوز امتیازی ثبت نشده است.</p>'}
                    </div>
                    <div class="card p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-semibold mb-3 text-slate-700 flex items-center"><i data-lucide="brain-circuit" class="ml-2 w-5 h-5 text-purple-500"></i>تحلیل هوشمند</h4>
                        <div class="text-sm space-y-3">${Object.values(analysis).map(item => `<div class="flex items-start"><i data-lucide="${item.icon}" class="w-4 h-4 mt-1 ml-2 flex-shrink-0 ${item.color}"></i><div class="${item.color}">${item.text}</div></div>`).join('')}</div>
                    </div>
                </div>
                
                <div class="lg:col-span-2 space-y-6">
                  <div class="bg-white rounded-lg shadow-md">
                        <div class="border-b border-slate-200"><nav id="profile-tabs" class="flex -mb-px overflow-x-auto"><button data-tab="overview" class="profile-tab active shrink-0">نمای کلی</button><button data-tab="performance" class="profile-tab shrink-0">عملکرد</button><button data-tab="career" class="profile-tab shrink-0">مسیر شغلی</button><button data-tab="contracts" class="profile-tab shrink-0">قراردادها</button><button data-tab="personal" class="profile-tab shrink-0">اطلاعات پرسنلی</button></nav></div>
                        <div class="p-4">
                            <div id="tab-overview" class="profile-tab-content active"><div class="space-y-6"><div class="card p-4 bg-gray-50 rounded-lg"><div class="flex justify-between items-center mb-3"><h4 class="font-semibold text-slate-700 flex items-center"><i data-lucide="target" class="ml-2 w-5 h-5 text-blue-500"></i>اهداف و نتایج کلیدی (OKRs)</h4>${canEdit() ? `<button id="edit-okrs-btn" class="text-sm bg-indigo-500 text-white py-1 px-3 rounded-md hover:bg-indigo-600">افزودن/ویرایش</button>`:''}</div><div class="space-y-3">${(emp.okrs || []).map(okr => `<div><div class="flex justify-between items-center mb-1 text-sm"><span class="text-slate-600">${okr.title}</span><span class="font-medium text-indigo-600">${okr.progress}%</span></div><div class="progress-bar w-full"><div class="progress-bar-fill" style="width: ${okr.progress}%;"></div></div></div>`).join('')} ${!(emp.okrs && emp.okrs.length > 0) ? '<p class="text-sm text-slate-500">هدفی ثبت نشده است.</p>' : ''}</div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="card p-4 bg-gray-50 rounded-lg"><div class="flex justify-between items-center mb-3"><h4 class="font-semibold text-slate-700">ماتریس مهارت‌های فنی</h4>${canEdit() ? `<button id="edit-skills-btn" class="text-sm bg-indigo-500 text-white py-1 px-3 rounded-md hover:bg-indigo-600">ویرایش</button>`:''}</div><canvas id="skillRadarChart"></canvas></div><div class="card p-4 bg-gray-50 rounded-lg"><div class="flex justify-between items-center mb-3"><h4 class="font-semibold text-slate-700">شایستگی‌های اصلی</h4>${canEdit() ? `<button id="edit-competencies-btn" class="text-sm bg-indigo-500 text-white py-1 px-3 rounded-md hover:bg-indigo-600">ویرایش</button>`:''}</div><div id="competencyBarsContainer" class="space-y-4">${renderCompetencyBars(emp.competencies || {})}</div></div></div></div></div>
                            <div id="tab-performance" class="profile-tab-content"><div class="space-y-6"><div class="card p-4 bg-gray-50 rounded-lg"><div class="flex justify-between items-center mb-3"><h4 class="font-semibold text-slate-700">تاریخچه ارزیابی عملکرد</h4>${canEdit() ? `<button id="add-performance-btn" class="text-sm bg-indigo-500 text-white py-1 px-3 rounded-md hover:bg-indigo-600">افزودن ارزیابی</button>`:''}</div><div id="performance-history-list" class="space-y-3 text-sm">${(emp.performanceHistory || []).map((review, i) => `<div class="p-3 bg-slate-100 rounded-md border"><div class="flex justify-between items-center font-semibold"><p>دوره ارزیابی ${i+1} - ${toPersianDate(review.reviewDate)}</p><div class="flex items-center gap-2"><span class="font-bold text-teal-600">${review.overallScore}/5</span>${canEdit() ? `<button class="edit-performance-btn text-amber-600 hover:text-amber-800" data-index="${i}"><i data-lucide="edit" class="w-4 h-4"></i></button><button class="delete-performance-btn text-red-500 hover:text-red-700" data-index="${i}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`:''}</div></div><p class="text-xs text-slate-500 mt-1">ارزیاب: ${review.reviewer || 'نامشخص'}</p></div>`).join('') || '<p class="text-sm text-slate-500">سابقه‌ای ثبت نشده است.</p>'}</div></div><div class="card p-4 bg-gray-50 rounded-lg"><div class="flex justify-between items-center mb-3"><h4 class="font-semibold text-slate-700">سابقه انضباطی (تذکر/تشویق)</h4>${canEdit() ? `<button id="add-disciplinary-btn" class="text-sm bg-indigo-500 text-white py-1 px-3 rounded-md hover:bg-indigo-600">افزودن</button>`:''}</div><div id="disciplinary-list" class="space-y-2">${(emp.disciplinaryHistory || []).map((item, i) => `<div class="p-2 rounded-md ${item.type === 'تشویق' ? 'bg-green-100' : 'bg-red-100'} flex justify-between items-center"><div class="flex-grow"><p class="font-semibold">${item.type} - ${toPersianDate(item.date)}</p><p class="text-sm">${item.reason}</p></div>${canEdit() ? `<button class="delete-disciplinary-btn text-red-500 hover:text-red-700" data-index="${i}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`:''}</div>`).join('') || '<p class="text-sm text-slate-500">سابقه‌ای ثبت نشده است.</p>'}</div></div></div></div>
                            <div id="tab-career" class="profile-tab-content"><div class="card p-4 bg-gray-50 rounded-lg"><div class="flex justify-between items-center mb-3"><h4 class="font-semibold text-slate-700">تاریخچه مسیر شغلی</h4>${canEdit() ? `<button id="add-career-path-btn" class="text-sm bg-indigo-500 text-white py-1 px-3 rounded-md hover:bg-indigo-600">افزودن</button>`:''}</div><div id="career-path-list" class="space-y-3">${(emp.careerPath || []).map((entry, i) => `<div class="p-3 bg-slate-100 rounded-md border flex justify-between items-center"><div><p class="font-semibold">${entry.title} در دپارتمان ${entry.department}</p><p class="text-xs text-slate-500">${toPersianDate(entry.date)} - ${entry.type}</p></div>${canEdit() ? `<button class="delete-career-path-btn text-red-500 hover:text-red-700" data-index="${i}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`:''}</div>`).join('') || '<p class="text-sm text-slate-500">سابقه‌ای ثبت نشده است.</p>'}</div></div></div>
                            <div id="tab-contracts" class="profile-tab-content"><div class="card p-4 bg-gray-50 rounded-lg"><div class="flex justify-between items-center mb-3"><h4 class="font-semibold text-slate-700">تاریخچه تمدید قرارداد</h4>${canEdit() ? `<button id="add-contract-btn" class="text-sm bg-indigo-500 text-white py-1 px-3 rounded-md hover:bg-indigo-600">افزودن</button>`:''}</div><div id="contracts-list" class="space-y-3">${(emp.contractHistory || []).map((c, index) => `<div class="p-3 rounded-md bg-slate-100 border"><div class="flex justify-between items-center font-semibold"><p>قرارداد ${toPersianDate(c.startDate)}</p><div class="flex items-center gap-2">${c.fileName ? `<a href="#" class="text-xs text-blue-600 flex items-center"><i data-lucide="paperclip" class="w-3 h-3 ml-1"></i>${c.fileName}</a>`:''}${canEdit() ? `<button class="edit-contract-btn text-amber-600 hover:text-amber-800" data-index="${index}"><i data-lucide="edit" class="w-4 h-4"></i></button><button class="delete-contract-btn text-red-500 hover:text-red-700" data-index="${index}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`:''}</div></div><div class="grid grid-cols-2 gap-2 text-xs mt-2 border-t pt-2"><p>حقوق ناخالص: <span class="font-mono">${(c.grossSalary || 0).toLocaleString('fa-IR')}</span></p><p>حقوق خالص: <span class="font-mono">${(c.netSalary || 0).toLocaleString('fa-IR')}</span></p><p>مبلغ سفته: <span class="font-mono">${(c.promissoryNote || 0).toLocaleString('fa-IR')}</span></p><p>مدت: <span class="font-mono">${toPersianDate(c.startDate)} تا ${toPersianDate(c.endDate)}</span></p></div></div>`).join('') || '<p class="text-sm text-slate-500">سابقه‌ای ثبت نشده است.</p>'}</div></div></div>
                            <div id="tab-personal" class="profile-tab-content"><div class="card p-4 bg-gray-50 rounded-lg"><div class="flex justify-between items-center mb-3"><h4 class="font-semibold text-slate-700">اطلاعات پرسنلی</h4>${canEdit() ? `<button id="edit-personal-info-btn" class="text-sm bg-indigo-500 text-white py-1 px-3 rounded-md hover:bg-indigo-600">ویرایش</button>`:''}</div><div class="grid grid-cols-1 sm:grid-cols-2 gap-y-4 gap-x-6 text-sm"><div><strong class="text-slate-500 block">کد ملی</strong> <span>${emp.personalInfo?.nationalId || '-'}</span></div><div><strong class="text-slate-500 block">تاریخ تولد</strong> <span>${toPersianDate(emp.personalInfo?.birthDate) || '-'}</span></div><div><strong class="text-slate-500 block">جنسیت</strong> <span>${emp.gender || '-'}</span></div><div><strong class="text-slate-500 block">شماره موبایل</strong> <span class="font-mono">${emp.personalInfo?.phone || '-'}</span></div><div class="sm:col-span-2"><strong class="text-slate-500 block">آدرس</strong> <span>${emp.personalInfo?.address || '-'}</span></div><div><strong class="text-slate-500 block">وضعیت نظام وظیفه</strong> <span>${emp.personalInfo?.militaryStatus || '-'}</span></div></div><hr class="my-4"><h4 class="font-semibold text-slate-700 mb-3">اطلاعات سازمانی</h4><div class="grid grid-cols-1 sm:grid-cols-2 gap-y-4 gap-x-6 text-sm"><div><strong class="text-slate-500 block">عنوان شغلی</strong> <span>${emp.jobTitle || '-'}</span></div><div><strong class="text-slate-500 block">سطح</strong> <span>${emp.level || '-'}</span></div><div><strong class="text-slate-500 block">تاریخ استخدام</strong> <span>${toPersianDate(emp.startDate) || '-'}</span></div><div><strong class="text-slate-500 block">تاریخ اتمام قرارداد فعلی</strong> <span>${toPersianDate(latestContract?.endDate) || '-'}</span></div><div><strong class="text-slate-500 block">تیم</strong> <span>${team?.name || '-'}</span></div><div><strong class="text-slate-500 block">مدیر مستقیم</strong> <span>${manager?.name || '-'}</span></div></div><hr class="my-4"><div class="flex justify-between items-center mb-3"><h4 class="font-semibold text-slate-700">مدارک پرسنلی</h4>${canEdit() ? `<button id="add-document-btn" class="text-sm bg-indigo-500 text-white py-1 px-3 rounded-md hover:bg-indigo-600">افزودن مدرک</button>`:''}</div><div id="documents-list" class="space-y-2">${(emp.documents || []).map((doc, index) => `<div class="p-2 bg-slate-100 rounded-md flex justify-between items-center"><div><p class="font-semibold">${doc.name}</p><p class="text-xs text-slate-500">${toPersianDate(doc.date)}</p></div><div class="flex items-center gap-2">${doc.fileName ? `<a href="#" class="text-xs text-blue-600 flex items-center"><i data-lucide="paperclip" class="w-3 h-3 ml-1"></i>${doc.fileName}</a>`:''}${canEdit() ? `<button class="edit-document-btn text-amber-600 hover:text-amber-800" data-index="${index}"><i data-lucide="edit" class="w-4 h-4"></i></button><button class="delete-document-btn text-red-500 hover:text-red-700" data-index="${index}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`:''}</div></div>`).join('') || '<p class="text-sm text-slate-500">مدرکی ثبت نشده است.</p>'}</div></div></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        openModal(mainModal, mainModalContainer); 
        if (emp.engagementScore != null) {
            renderEngagementGauge('engagementGaugeProfile', emp.engagementScore);
        }
        setupProfileModalListeners(emp);
    };
        
        // --- [FIX START] ADDED TEAM HEALTH METRICS RENDERER ---
      const renderTeamHealthMetrics = (team) => {
        const metrics = team.healthMetrics || {};
        
        // اضافه کردن امتیاز مشارکت تیم به لیست معیارها
        if (team.engagementScore != null) {
            metrics['مشارکت کارکنان'] = team.engagementScore;
        }

        const metricsHtml = Object.keys(metrics).length > 0 ? Object.entries(metrics).map(([name, score]) => `
            <div>
                <div class="flex justify-between items-center mb-1 text-sm">
                    <span class="text-gray-600">${name}</span>
                    <span class="font-medium text-blue-600">${score}%</span>
                </div>
                <div class="progress-bar w-full">
                    <div class="progress-bar-fill" style="width: ${score}%;"></div>
                </div>
            </div>
        `).join('') : '<p class="text-sm text-gray-500">هنوز معیاری برای سلامت تیم ثبت نشده است.</p>';

        return `
            <div class="card p-4 bg-gray-50 rounded-lg">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-semibold text-gray-700">معیارهای کلیدی سلامت تیم</h4>
                    ${canEdit() ? `<button id="edit-team-health-btn" class="text-sm bg-blue-500 text-white py-1 px-3 rounded-md hover:bg-blue-600">ویرایش</button>` : ''}
                </div>
                <div class="space-y-4">
                    ${metricsHtml}
                </div>
            </div>
        `;
    };
        // --- [FIX END] ---
const viewTeamProfile = (teamId) => {
        const team = state.teams.find(t => t.firestoreId === teamId); if (!team) return;
        const leader = state.employees.find(e => e.id === team.leaderId);
        const members = state.employees.filter(e => team.memberIds?.includes(e.id));
        const basicAnalysis = generateTeamSmartAnalysis(team);
        const advancedAnalysis = analyzeTeamData(team, members); // اجرای تحلیلگر پیشرفته

        modalTitle.innerText = 'پروفایل تیم: ' + team.name;
        
        // نمایش نام افراد پرریسک در تحلیل هوشمند
        const highRiskNames = advancedAnalysis.highRiskMembers.map(e => e.name).join('، ');
        if(highRiskNames) {
            basicAnalysis.risk = { text: `اعضای پرریسک: <strong>${highRiskNames}</strong>`, icon: 'shield-alert', color: 'text-red-600' };
        }

        modalContent.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 space-y-6">
                    <div class="card p-4 bg-gray-50 rounded-lg text-center relative group">
                        <div class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-white shadow-md overflow-hidden bg-gray-200 flex items-center justify-center">
                            <img src="${team.avatar}" alt="${team.name}" class="w-full h-full object-cover">
                        </div>
                        ${canEdit() ? `<button id="change-team-avatar-btn" class="absolute top-2 left-2 bg-white p-1.5 rounded-full shadow-md opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="camera" class="w-4 h-4"></i></button>` : ''}
                        <h2 class="text-2xl font-bold text-gray-800">${team.name}</h2><p class="text-gray-500">رهبر تیم: ${leader?.name || 'نامشخص'}</p></div>
                    <div class="card p-4 bg-gray-50 rounded-lg"><h4 class="font-semibold mb-3 text-gray-700 flex items-center"><i data-lucide="brain-circuit" class="ml-2 w-5 h-5 text-purple-500"></i>تحلیل هوشمند</h4><div class="text-sm space-y-3">${Object.keys(basicAnalysis).length > 0 ? Object.values(basicAnalysis).map(item => `<div class="flex items-start"><i data-lucide="${item.icon}" class="w-4 h-4 mt-1 ml-2 flex-shrink-0 ${item.color}"></i><div class="${item.color}">${item.text}</div></div>`).join('') : '<p class="text-sm text-gray-500">داده کافی برای تحلیل وجود ندارد.</p>'}</div></div>
                </div>
                <div class="lg:col-span-2 space-y-6">
                     <div class="bg-white rounded-lg shadow-md">
                        <div class="border-b border-gray-200"><nav id="profile-tabs" class="flex -mb-px overflow-x-auto"><button data-tab="team-overview" class="profile-tab active shrink-0">نمای کلی</button><button data-tab="team-skills" class="profile-tab shrink-0">مهارت و مشارکت</button><button data-tab="team-talent" class="profile-tab shrink-0">ماتریس استعداد</button></nav></div>
                        <div class="p-4">
                            <div id="tab-team-overview" class="profile-tab-content active"><div class="space-y-4"><div class="card p-4 bg-gray-50 rounded-lg"><h4 class="font-semibold mb-3 text-gray-700">اعضای تیم (${members.length} نفر)</h4><div class="flex flex-wrap gap-4">${members.map(m => `<div class="text-center" title="${m.name}"><div class="w-12 h-12 rounded-full mx-auto overflow-hidden bg-gray-200"><img src="${m.avatar}" class="w-full h-full object-cover"></div><p class="text-xs mt-1 truncate w-16">${m.name}</p></div>`).join('')}</div></div><div class="card p-4 bg-gray-50 rounded-lg"><div class="flex justify-between items-center mb-3"><h4 class="font-semibold text-gray-700">اهداف تیم (OKRs)</h4>${canEdit() ? `<button id="edit-team-okrs-btn" class="text-sm bg-blue-500 text-white py-1 px-3 rounded-md hover:bg-blue-600">افزودن/ویرایش</button>`:''}</div><div class="space-y-3">${(team.okrs || []).length > 0 ? (team.okrs || []).map(okr => `<div><div class="flex justify-between items-center mb-1 text-sm"><span class="text-gray-600">${okr.title}</span><span class="font-medium text-blue-600">${okr.progress}%</span></div><div class="progress-bar w-full"><div class="progress-bar-fill" style="width: ${okr.progress}%;"></div></div></div>`).join('') : '<p class="text-sm text-gray-500">هدفی برای این تیم ثبت نشده است.</p>'}</div></div></div></div>
                            <div id="tab-team-skills" class="profile-tab-content">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="card p-4 bg-gray-50 rounded-lg">
                                        <h4 class="font-semibold mb-3 text-gray-700">نقاط قوت کلیدی تیم</h4>
                                        ${advancedAnalysis.topSkills.length > 0 ? advancedAnalysis.topSkills.map(skill => `<span class="inline-block bg-blue-100 text-blue-800 text-sm font-medium m-1 px-3 py-1 rounded-full">${skill}</span>`).join('') : '<p class="text-sm text-gray-500">مهارت کلیدی (سطح ۴ به بالا) یافت نشد.</p>'}
                                    </div>
                                    <div class="card p-4 bg-gray-50 rounded-lg">
                                        <h4 class="font-semibold mb-3 text-gray-700">تحلیل عمیق مشارکت</h4>
                                        <div class="space-y-3">${advancedAnalysis.engagementBreakdown.length > 0 ? advancedAnalysis.engagementBreakdown.map(cat => `<div><div class="flex justify-between items-center mb-1 text-sm"><span class="text-gray-600">${cat.name}</span><span class="font-medium text-blue-600">${cat.score}%</span></div><div class="progress-bar w-full"><div class="progress-bar-fill" style="width: ${cat.score}%;"></div></div></div>`).join('') : '<p class="text-sm text-gray-500">داده‌ای برای تحلیل مشارکت وجود ندارد.</p>'}</div>
                                    </div>
                                </div>
                             </div>
                            <div id="tab-team-talent" class="profile-tab-content"><div class="card p-4 bg-gray-50 rounded-lg"><h4 class="font-semibold mb-3 text-gray-700">توزیع استعداد در تیم</h4><div class="grid grid-cols-3 gap-1 text-center text-xs border-t-2 border-l-2 border-gray-300 mt-4 bg-white">${ generateTeamNineBoxGrid(members) }</div></div></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        openModal(mainModal, mainModalContainer);
        setupTeamProfileModalListeners(team);
    };

        const generateTeamNineBoxGrid = (members) => {
            const grid = Array(3).fill(null).map(() => Array(3).fill(null).map(() => []));
            const gridMap = {'معما': {r:0,c:0}, 'عملکرد قابل اتکا':{r:1,c:0}, 'مهره کلیدی':{r:2,c:0}, 'پتانسیل بالا':{r:1,c:2}, 'ستاره':{r:2,c:2}};
            members.forEach(emp => { const pos = gridMap[emp.nineBox]; if(pos) grid[pos.r][pos.c].push(emp); });
            let html = '';
            for (let i = 2; i >= 0; i--) { for (let j = 0; j < 3; j++) { html += `<div class="border-b-2 border-r-2 border-gray-200 min-h-[60px] p-1 flex flex-wrap items-center justify-center gap-1">${grid[i][j].map(e => `<div class="w-8 h-8 rounded-full border-2 border-white overflow-hidden shrink-0 bg-gray-200"><img src="${e.avatar}" title="${e.name}" class="w-full h-full object-cover"></div>`).join('')}</div>`; } }
            return html;
        };

        const setupTeamProfileModalListeners = (team) => {
             const tabs = document.querySelectorAll('#profile-tabs .profile-tab');
             const tabContents = document.querySelectorAll('.profile-tab-content');
             tabs.forEach(tab => { tab.addEventListener('click', () => { tabs.forEach(t => t.classList.remove('active')); tab.classList.add('active'); const target = tab.getAttribute('data-tab'); tabContents.forEach(content => { content.classList.toggle('active', content.id === `tab-${target}`); }); }); });
            if(canEdit()) {
                document.getElementById('edit-team-okrs-btn')?.addEventListener('click', () => showEditTeamOkrsForm(team));
                document.getElementById('edit-team-health-btn')?.addEventListener('click', () => showTeamHealthForm(team));
                document.getElementById('change-team-avatar-btn')?.addEventListener('click', () => {
                    handleAvatarChange(async (newAvatarUrl) => {
                        try {
                            const docRef = doc(db, `artifacts/${appId}/public/data/teams`, team.firestoreId);
                            await updateDoc(docRef, { avatar: newAvatarUrl });
                            showToast("عکس تیم با موفقیت به‌روزرسانی شد.");
                        } catch (error) {
                            console.error("Error updating team avatar:", error);
                            showToast("خطا در به‌روزرسانی عکس تیم.", "error");
                        }
                    });
                });
            }
            setTimeout(() => { lucide.createIcons(); }, 100);
        };

        const openModal = (modal, container) => { modal.classList.remove('hidden'); modal.classList.add('flex'); setTimeout(() => container.classList.remove('scale-95', 'opacity-0'), 50); };
        const closeModal = (modal, container) => { container.classList.add('scale-95', 'opacity-0'); setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); destroyCharts(); }, 300); };
        const confirmModal = document.getElementById('confirmModal'); const confirmModalContainer = confirmModal.querySelector('div'); let confirmCallback = () => {};
        const showConfirmationModal = (title, message, onConfirm, acceptText = "تایید") => { document.getElementById('confirmTitle').innerText = title; document.getElementById('confirmMessage').innerText = message; document.getElementById('confirmAccept').innerText = acceptText; confirmCallback = onConfirm; openModal(confirmModal, confirmModalContainer); };
        document.getElementById('confirmCancel').addEventListener('click', () => closeModal(confirmModal, confirmModalContainer)); document.getElementById('confirmAccept').addEventListener('click', () => { confirmCallback(); closeModal(confirmModal, confirmModalContainer); });
        
        const showTeamForm = (teamId = null) => {
            const isEditing = teamId !== null;
            const team = isEditing ? state.teams.find(t => t.firestoreId === teamId) : {};
            const employeeOptions = state.employees.map(emp => `<option value="${emp.id}" ${isEditing && team.leaderId === emp.id ? 'selected' : ''}>${emp.name}</option>`).join('');
            const memberCheckboxes = state.employees.map(emp => `<div class="flex items-center"><input type="checkbox" id="member-${emp.id}" value="${emp.id}" class="team-member-checkbox" ${isEditing && team.memberIds?.includes(emp.id) ? 'checked' : ''}><label for="member-${emp.id}" class="mr-2">${emp.name}</label></div>`).join('');
            modalTitle.innerText = isEditing ? 'ویرایش تیم' : 'افزودن تیم جدید';
            modalContent.innerHTML = `<form id="team-form" class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="team-name" class="block text-sm font-medium text-gray-700">نام تیم</label><input type="text" id="team-name" value="${team.name || ''}" class="mt-1 block w-full p-2 border rounded-md" required></div><div><label for="team-id" class="block text-sm font-medium text-gray-700">شناسه تیم (مثلا T-03)</label><input type="text" id="team-id" value="${team.id || ''}" class="mt-1 block w-full p-2 border rounded-md" ${isEditing ? 'readonly' : ''} required></div><div class="md:col-span-2"><label for="team-mission" class="block text-sm font-medium text-gray-700">ماموریت تیم</label><textarea id="team-mission" rows="3" class="mt-1 block w-full p-2 border rounded-md">${team.mission || ''}</textarea></div><div><label for="team-leader" class="block text-sm font-medium text-gray-700">رهبر تیم</label><select id="team-leader" class="mt-1 block w-full p-2 border rounded-md" required><option value="">انتخاب کنید...</option>${employeeOptions}</select></div><div><label class="block text-sm font-medium text-gray-700">اعضای تیم</label><div id="team-members" class="mt-1 grid grid-cols-2 gap-2 max-h-48 overflow-y-auto p-2 border rounded-md">${memberCheckboxes}</div></div></div><div class="pt-4 flex justify-end"><button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">ذخیره</button></div></form>`;
            openModal(mainModal, mainModalContainer);
            document.getElementById('team-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const selectedMembers = Array.from(document.querySelectorAll('.team-member-checkbox:checked')).map(cb => cb.value);
                const formData = { name: document.getElementById('team-name').value, id: document.getElementById('team-id').value, mission: document.getElementById('team-mission').value, leaderId: document.getElementById('team-leader').value, memberIds: selectedMembers, avatar: team.avatar || `https://placehold.co/200x200/dbeafe/4338ca?text=${document.getElementById('team-name').value.substring(0,2)}`, okrs: team.okrs || [], healthMetrics: team.healthMetrics || {} };
                try { const docRef = doc(db, `artifacts/${appId}/public/data/teams`, isEditing ? team.firestoreId : formData.id); await setDoc(docRef, formData, { merge: isEditing }); closeModal(mainModal, mainModalContainer); showToast(isEditing ? "تیم با موفقیت ویرایش شد." : "تیم با موفقیت اضافه شد."); } catch (error) { console.error("Error saving team:", error); showToast("خطا در ذخیره اطلاعات تیم.", "error"); }
            });
        };

        // --- EVENT LISTENERS & INITIALIZATION ---
        const setupEventListeners = () => {
            // Auth Listeners
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = e.target.email.value;
                const password = e.target.password.value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    showToast("ایمیل یا رمز عبور اشتباه است.", "error");
                    console.error("Login failed:", error);
                }
            });

            document.getElementById('signup-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = e.target.email.value;
                const password = e.target.password.value;
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    showToast("خطا در ثبت نام. ممکن است این ایمیل قبلا استفاده شده باشد.", "error");
                    console.error("Signup failed:", error);
                }
            });

            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); showSignupPage(); });
            document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); showLoginPage(); });


            // General App Listeners
            document.getElementById('closeModal').addEventListener('click', () => closeModal(mainModal, mainModalContainer));
            mainModal.addEventListener('click', (e) => { if (e.target === mainModal) closeModal(mainModal, mainModalContainer); });
            
            // Mobile Menu
            const menuBtn = document.getElementById('menu-btn'); const sidebar = document.getElementById('sidebar'); const overlay = document.getElementById('sidebar-overlay'); const toggleMenu = () => { sidebar.classList.toggle('translate-x-full'); overlay.classList.toggle('hidden'); };
            menuBtn.addEventListener('click', toggleMenu);
            overlay.addEventListener('click', toggleMenu);
            
            // Navigation
            const handleNavClick = (e) => { const link = e.target.closest('a'); if (link && (link.classList.contains('sidebar-item') || link.classList.contains('sidebar-logo'))) { e.preventDefault(); const pageName = link.getAttribute('href').substring(1); navigateTo(pageName); if (window.innerWidth < 768) toggleMenu(); } };
            document.getElementById('sidebar').addEventListener('click', handleNavClick);
            document.querySelector('header .sidebar-logo')?.addEventListener('click', handleNavClick);
            
            window.addEventListener('hashchange', router);
        };
const setupProfileModalListeners = (emp) => {
        const tabs = document.querySelectorAll('#profile-tabs .profile-tab');
        const tabContents = document.querySelectorAll('.profile-tab-content');
        tabs.forEach(tab => { tab.addEventListener('click', () => { tabs.forEach(t => t.classList.remove('active')); tab.classList.add('active'); const target = tab.getAttribute('data-tab'); tabContents.forEach(content => { content.classList.toggle('active', content.id === `tab-${target}`); }); }); });
        
        setTimeout(() => {
            renderSkillRadarChart('skillRadarChart', emp.skills || {});
            lucide.createIcons();
        }, 100);
        
        if(canEdit()) {
            document.getElementById('change-avatar-btn')?.addEventListener('click', () => { /* ... */ });
            document.getElementById('delete-avatar-btn')?.addEventListener('click', () => { /* ... */ });

            // --- منطق جدید برای دکمه ویرایش اصلی ---
            document.getElementById('main-edit-employee-btn')?.addEventListener('click', () => showEmployeeForm(emp.firestoreId));

            document.getElementById('edit-okrs-btn')?.addEventListener('click', () => showEditOkrsForm(emp));
            document.getElementById('edit-skills-btn')?.addEventListener('click', () => showEditSkillsForm(emp));
            document.getElementById('edit-competencies-btn')?.addEventListener('click', () => showEditCompetenciesForm(emp));
            document.getElementById('edit-personal-info-btn')?.addEventListener('click', () => showEditPersonalInfoForm(emp));
            document.getElementById('add-disciplinary-btn')?.addEventListener('click', () => showDisciplinaryForm(emp));
            document.getElementById('add-contract-btn')?.addEventListener('click', () => showContractForm(emp));
            document.getElementById('add-performance-btn')?.addEventListener('click', () => showPerformanceForm(emp));
            document.getElementById('add-career-path-btn')?.addEventListener('click', () => showCareerPathForm(emp));
            document.getElementById('add-document-btn')?.addEventListener('click', () => showDocumentForm(emp));

            modalContent.addEventListener('click', (e) => {
                const editPerfBtn = e.target.closest('.edit-performance-btn');
                const deletePerfBtn = e.target.closest('.delete-performance-btn');
                const deleteDisciplinaryBtn = e.target.closest('.delete-disciplinary-btn');
                const deleteCareerBtn = e.target.closest('.delete-career-path-btn');
                const editContractBtn = e.target.closest('.edit-contract-btn');
                const deleteContractBtn = e.target.closest('.delete-contract-btn');
                const editDocBtn = e.target.closest('.edit-document-btn');
                const deleteDocBtn = e.target.closest('.delete-document-btn');

                if (editPerfBtn) showPerformanceForm(emp, parseInt(editPerfBtn.dataset.index));
                if (deletePerfBtn) deletePerformanceReview(emp, parseInt(deletePerfBtn.dataset.index));
                if (deleteDisciplinaryBtn) deleteDisciplinaryRecord(emp, parseInt(deleteDisciplinaryBtn.dataset.index));
                if (deleteCareerBtn) deleteCareerPathEntry(emp, parseInt(deleteCareerBtn.dataset.index));
                if (editContractBtn) showContractForm(emp, parseInt(editContractBtn.dataset.index));
                if (deleteContractBtn) deleteContract(emp, parseInt(deleteContractBtn.dataset.index));
                if (editDocBtn) showDocumentForm(emp, parseInt(editDocBtn.dataset.index));
                if (deleteDocBtn) deleteDocument(emp, parseInt(deleteDocBtn.dataset.index));
            });
        }
    };
        
        // --- EDIT FORM FUNCTIONS ---
        const showAddUserForm = () => {
            modalTitle.innerText = 'افزودن کاربر جدید';
            modalContent.innerHTML = `
                <form id="add-user-form" class="space-y-4">
                    <div>
                        <label for="new-user-email" class="block text-sm font-medium text-gray-700">آدرس ایمیل</label>
                        <input id="new-user-email" type="email" required class="w-full px-3 py-2 mt-1 border rounded-md">
                    </div>
                    <div>
                        <label for="new-user-password" class="block text-sm font-medium text-gray-700">رمز عبور موقت</label>
                        <input id="new-user-password" type="password" required class="w-full px-3 py-2 mt-1 border rounded-md">
                    </div>
                    <div>
                        <label for="new-user-role" class="block text-sm font-medium text-gray-700">سطح دسترسی</label>
                        <select id="new-user-role" class="w-full p-2 mt-1 border rounded-md">
                            <option value="viewer">Viewer</option>
                            <option value="editor">Editor</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="pt-4 flex justify-end">
                        <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">افزودن کاربر</button>
                    </div>
                </form>
            `;
            openModal(mainModal, mainModalContainer);

            document.getElementById('add-user-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('new-user-email').value;
                const password = document.getElementById('new-user-password').value;
                const role = document.getElementById('new-user-role').value;
                
                showToast("در حال ایجاد کاربر... این کار ممکن است باعث خروج شما از سیستم شود.", "success");
                
                try {
                    // This is a simplified approach. In a real app, you'd use Firebase Functions to create users without logging out the admin.
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const newUser = userCredential.user;

                    const userRef = doc(db, `artifacts/${appId}/public/data/users`, newUser.uid);
                    await setDoc(userRef, {
                        email: newUser.email,
                        role: role,
                        createdAt: serverTimestamp()
                    });
                    
                    closeModal(mainModal, mainModalContainer);
                    showToast("کاربر جدید ایجاد شد. لطفا با حساب ادمین مجددا وارد شوید.");
                    
                    await signOut(auth);

                } catch (error) {
                    console.error("Error creating new user:", error);
                    showToast(`خطا در ایجاد کاربر: ${error.message}`, "error");
                }
            });
        };

        const showEditOkrsForm = (emp) => {
            modalTitle.innerText = `ویرایش OKR برای ${emp.name}`;
            const okrsHtml = (emp.okrs || []).map((okr) => `<div class="okr-item grid grid-cols-12 gap-2 items-center"><input type="text" value="${okr.title}" class="col-span-8 p-2 border rounded-md okr-title" placeholder="عنوان هدف"><input type="number" value="${okr.progress}" class="col-span-3 p-2 border rounded-md okr-progress" placeholder="پیشرفت %" min="0" max="100"><button type="button" class="col-span-1 remove-okr-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div>`).join('');
            modalContent.innerHTML = `<form id="edit-okrs-form"><div id="okrs-container" class="space-y-2">${okrsHtml}</div><button type="button" id="add-okr-btn" class="mt-4 text-sm bg-gray-200 py-2 px-4 rounded-md hover:bg-gray-300">افزودن هدف جدید</button><div class="pt-6 flex justify-end gap-4"><button type="button" id="back-to-profile-okr" class="bg-gray-500 text-white py-2 px-6 rounded-md hover:bg-gray-600">بازگشت</button><button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">ذخیره</button></div></form>`;
            lucide.createIcons();
            document.getElementById('back-to-profile-okr').addEventListener('click', () => viewEmployeeProfile(emp.firestoreId));
            const okrsContainer = document.getElementById('okrs-container');
            document.getElementById('add-okr-btn').addEventListener('click', () => { const newItem = document.createElement('div'); newItem.className = 'okr-item grid grid-cols-12 gap-2 items-center'; newItem.innerHTML = `<input type="text" class="col-span-8 p-2 border rounded-md okr-title" placeholder="عنوان هدف"><input type="number" class="col-span-3 p-2 border rounded-md okr-progress" placeholder="پیشرفت %" min="0" max="100" value="0"><button type="button" class="col-span-1 remove-okr-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5"></i></button>`; okrsContainer.appendChild(newItem); lucide.createIcons(); });
            okrsContainer.addEventListener('click', (e) => { if(e.target.closest('.remove-okr-btn')) { e.target.closest('.okr-item').remove(); } });
            document.getElementById('edit-okrs-form').addEventListener('submit', async (e) => { e.preventDefault(); const newOkrs = []; document.querySelectorAll('.okr-item').forEach(item => { const title = item.querySelector('.okr-title').value; const progress = parseInt(item.querySelector('.okr-progress').value) || 0; if (title) { newOkrs.push({ title, progress }); } }); try { const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId); await updateDoc(docRef, { okrs: newOkrs }); showToast("اهداف با موفقیت به‌روزرسانی شدند."); viewEmployeeProfile(emp.firestoreId); } catch (error) { console.error("Error updating OKRs:", error); showToast("خطا در به‌روزرسانی اهداف.", "error"); } });
        };

        const showEditSkillsForm = (emp) => {
            modalTitle.innerText = `ویرایش مهارت‌ها برای ${emp.name}`;
            const skillsHtml = Object.entries(emp.skills || {}).map(([skill, level]) => `<div class="skill-item grid grid-cols-12 gap-2 items-center"><input type="text" value="${skill}" class="col-span-8 p-2 border rounded-md skill-name" placeholder="نام مهارت"><input type="number" value="${level}" class="col-span-3 p-2 border rounded-md skill-level" placeholder="سطح (۱-۵)" min="1" max="5"><button type="button" class="col-span-1 remove-skill-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div>`).join('');
            modalContent.innerHTML = `<form id="edit-skills-form"><div id="skills-container" class="space-y-2">${skillsHtml}</div><button type="button" id="add-skill-btn" class="mt-4 text-sm bg-gray-200 py-2 px-4 rounded-md hover:bg-gray-300">افزودن مهارت جدید</button><div class="pt-6 flex justify-end gap-4"><button type="button" id="back-to-profile-skill" class="bg-gray-500 text-white py-2 px-6 rounded-md hover:bg-gray-600">بازگشت</button><button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">ذخیره</button></div></form>`;
            lucide.createIcons();
            document.getElementById('back-to-profile-skill').addEventListener('click', () => viewEmployeeProfile(emp.firestoreId));
            const skillsContainer = document.getElementById('skills-container');
            document.getElementById('add-skill-btn').addEventListener('click', () => { const newItem = document.createElement('div'); newItem.className = 'skill-item grid grid-cols-12 gap-2 items-center'; newItem.innerHTML = `<input type="text" class="col-span-8 p-2 border rounded-md skill-name" placeholder="نام مهارت"><input type="number" class="col-span-3 p-2 border rounded-md skill-level" placeholder="سطح (۱-۵)" min="1" max="5" value="1"><button type="button" class="col-span-1 remove-skill-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5"></i></button>`; skillsContainer.appendChild(newItem); lucide.createIcons(); });
            skillsContainer.addEventListener('click', (e) => { if(e.target.closest('.remove-skill-btn')) { e.target.closest('.skill-item').remove(); } });
            document.getElementById('edit-skills-form').addEventListener('submit', async (e) => { e.preventDefault(); const newSkills = {}; document.querySelectorAll('.skill-item').forEach(item => { const name = item.querySelector('.skill-name').value; const level = parseInt(item.querySelector('.skill-level').value) || 0; if (name) { newSkills[name] = level; } }); try { const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId); await updateDoc(docRef, { skills: newSkills }); showToast("مهارت‌ها با موفقیت به‌روزرسانی شدند."); viewEmployeeProfile(emp.firestoreId); } catch (error) { console.error("Error updating skills:", error); showToast("خطا در به‌روزرسانی مهارت‌ها.", "error"); } });
        };

        const showEditCompetenciesForm = (emp) => {
            modalTitle.innerText = `ویرایش شایستگی‌ها برای ${emp.name}`;
            const empCompetencies = emp.competencies || {};
            const competenciesHtml = state.competencies.map(comp => `
                <div class="competency-item grid grid-cols-12 gap-2 items-center">
                    <label class="col-span-8">${comp.name}</label>
                    <input type="number" value="${empCompetencies[comp.name] || 0}" data-name="${comp.name}" class="col-span-3 p-2 border rounded-md competency-level" placeholder="سطح (۱-۵)" min="0" max="5">
                </div>
            `).join('');
            modalContent.innerHTML = `
                <form id="edit-competencies-form">
                    <div id="competencies-container" class="space-y-2">${competenciesHtml || '<p>ابتدا شایستگی‌ها را در بخش تنظیمات تعریف کنید.</p>'}</div>
                    <div class="pt-6 flex justify-end gap-4">
                        <button type="button" id="back-to-profile-comp" class="bg-gray-500 text-white py-2 px-6 rounded-md hover:bg-gray-600">بازگشت</button>
                        <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">ذخیره</button>
                    </div>
                </form>
            `;
            document.getElementById('back-to-profile-comp').addEventListener('click', () => viewEmployeeProfile(emp.firestoreId));
            document.getElementById('edit-competencies-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newCompetencies = {};
                document.querySelectorAll('.competency-item').forEach(item => {
                    const name = item.querySelector('.competency-level').dataset.name;
                    const level = parseInt(item.querySelector('.competency-level').value) || 0;
                    if (name && level > 0) {
                        newCompetencies[name] = level;
                    }
                });
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId);
                    await updateDoc(docRef, { competencies: newCompetencies });
                    showToast("شایستگی‌ها با موفقیت به‌روزرسانی شدند.");
                    viewEmployeeProfile(emp.firestoreId);
                } catch (error) {
                    console.error("Error updating competencies:", error);
                    showToast("خطا در به‌روزرسانی شایستگی‌ها.", "error");
                }
            });
        };

        const showEditTeamOkrsForm = (team) => {
            modalTitle.innerText = `ویرایش OKR برای تیم ${team.name}`;
            const okrsHtml = (team.okrs || []).map((okr) => `<div class="okr-item grid grid-cols-12 gap-2 items-center"><input type="text" value="${okr.title}" class="col-span-8 p-2 border rounded-md okr-title" placeholder="عنوان هدف"><input type="number" value="${okr.progress}" class="col-span-3 p-2 border rounded-md okr-progress" placeholder="پیشرفت %" min="0" max="100"><button type="button" class="col-span-1 remove-okr-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div>`).join('');
            modalContent.innerHTML = `<form id="edit-team-okrs-form"><div id="okrs-container" class="space-y-2">${okrsHtml}</div><button type="button" id="add-okr-btn" class="mt-4 text-sm bg-gray-200 py-2 px-4 rounded-md hover:bg-gray-300">افزودن هدف جدید</button><div class="pt-6 flex justify-end gap-4"><button type="button" id="back-to-team-profile-okr" class="bg-gray-500 text-white py-2 px-6 rounded-md hover:bg-gray-600">بازگشت</button><button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">ذخیره</button></div></form>`;
            lucide.createIcons();
            document.getElementById('back-to-team-profile-okr').addEventListener('click', () => viewTeamProfile(team.firestoreId));
            const okrsContainer = document.getElementById('okrs-container');
            document.getElementById('add-okr-btn').addEventListener('click', () => { const newItem = document.createElement('div'); newItem.className = 'okr-item grid grid-cols-12 gap-2 items-center'; newItem.innerHTML = `<input type="text" class="col-span-8 p-2 border rounded-md okr-title" placeholder="عنوان هدف"><input type="number" class="col-span-3 p-2 border rounded-md okr-progress" placeholder="پیشرفت %" min="0" max="100" value="0"><button type="button" class="col-span-1 remove-okr-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5"></i></button>`; okrsContainer.appendChild(newItem); lucide.createIcons(); });
            okrsContainer.addEventListener('click', (e) => { if (e.target.closest('.remove-okr-btn')) { e.target.closest('.okr-item').remove(); } });
            document.getElementById('edit-team-okrs-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newOkrs = [];
                document.querySelectorAll('.okr-item').forEach(item => {
                    const title = item.querySelector('.okr-title').value;
                    const progress = parseInt(item.querySelector('.okr-progress').value) || 0;
                    if (title) { newOkrs.push({ title, progress }); }
                });
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/teams`, team.firestoreId);
                    await updateDoc(docRef, { okrs: newOkrs });
                    showToast("اهداف تیم با موفقیت به‌روزرسانی شدند.");
                    viewTeamProfile(team.firestoreId);
                } catch (error) {
                    console.error("Error updating team OKRs:", error);
                    showToast("خطا در به‌روزرسانی اهداف تیم.", "error");
                }
            });
        };
        
        // --- [FIX START] ADDED TEAM HEALTH FORM ---
        const showTeamHealthForm = (team) => {
            modalTitle.innerText = `ویرایش معیارهای سلامت تیم ${team.name}`;
            const metrics = team.healthMetrics || { 'مشارکت': 75, 'رضایت': 80, 'شفافیت': 70, 'کارایی': 85 };
            const metricsHtml = Object.entries(metrics).map(([name, score]) => `
                <div class="health-metric-item grid grid-cols-12 gap-2 items-center">
                    <input type="text" value="${name}" class="col-span-8 p-2 border rounded-md health-metric-name" placeholder="نام معیار">
                    <input type="number" value="${score}" class="col-span-3 p-2 border rounded-md health-metric-score" placeholder="امتیاز %" min="0" max="100">
                    <button type="button" class="col-span-1 remove-health-metric-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </div>
            `).join('');

            modalContent.innerHTML = `
                <form id="edit-team-health-form">
                    <div id="health-metrics-container" class="space-y-2">${metricsHtml}</div>
                    <button type="button" id="add-health-metric-btn" class="mt-4 text-sm bg-gray-200 py-2 px-4 rounded-md hover:bg-gray-300">افزودن معیار جدید</button>
                    <div class="pt-6 flex justify-end gap-4">
                        <button type="button" id="back-to-team-profile-health" class="bg-gray-500 text-white py-2 px-6 rounded-md hover:bg-gray-600">بازگشت</button>
                        <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">ذخیره</button>
                    </div>
                </form>
            `;
            lucide.createIcons();
            document.getElementById('back-to-team-profile-health').addEventListener('click', () => viewTeamProfile(team.firestoreId));
            
            const metricsContainer = document.getElementById('health-metrics-container');
            document.getElementById('add-health-metric-btn').addEventListener('click', () => {
                const newItem = document.createElement('div');
                newItem.className = 'health-metric-item grid grid-cols-12 gap-2 items-center';
                newItem.innerHTML = `
                    <input type="text" class="col-span-8 p-2 border rounded-md health-metric-name" placeholder="نام معیار">
                    <input type="number" class="col-span-3 p-2 border rounded-md health-metric-score" placeholder="امتیاز %" min="0" max="100" value="50">
                    <button type="button" class="col-span-1 remove-health-metric-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                `;
                metricsContainer.appendChild(newItem);
                lucide.createIcons();
            });

            metricsContainer.addEventListener('click', (e) => {
                if (e.target.closest('.remove-health-metric-btn')) {
                    e.target.closest('.health-metric-item').remove();
                }
            });

            document.getElementById('edit-team-health-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newMetrics = {};
                document.querySelectorAll('.health-metric-item').forEach(item => {
                    const name = item.querySelector('.health-metric-name').value;
                    const score = parseInt(item.querySelector('.health-metric-score').value) || 0;
                    if (name) {
                        newMetrics[name] = score;
                    }
                });
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/teams`, team.firestoreId);
                    await updateDoc(docRef, { healthMetrics: newMetrics });
                    showToast("معیارهای سلامت تیم به‌روزرسانی شدند.");
                    viewTeamProfile(team.firestoreId);
                } catch (error) {
                    console.error("Error updating team health metrics:", error);
                    showToast("خطا در به‌روزرسانی معیارها.", "error");
                }
            });
        };
        // --- [FIX END] ---

        const showEditPersonalInfoForm = (emp) => {
    modalTitle.innerText = `ویرایش اطلاعات پرسنلی برای ${emp.name}`;
    const info = emp.personalInfo || {};
    modalContent.innerHTML = `<form id="edit-personal-info-form" class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"><div><label class="block font-medium">کد ملی</label><input type="text" id="nationalId" value="${info.nationalId || ''}" class="w-full p-2 border rounded-md"></div><div><label class="block font-medium">تاریخ تولد</label><input type="text" id="birthDate" class="w-full p-2 border rounded-md"></div><div><label class="block font-medium">جنسیت</label><select id="gender" class="w-full p-2 border rounded-md"><option value="نامشخص" ${emp.gender === 'نامشخص' ? 'selected' : ''}>نامشخص</option><option value="مرد" ${emp.gender === 'مرد' ? 'selected' : ''}>مرد</option><option value="زن" ${emp.gender === 'زن' ? 'selected' : ''}>زن</option></select></div><div><label class="block font-medium">شماره موبایل</label><input type="tel" id="phone" value="${info.phone || ''}" class="w-full p-2 border rounded-md"></div><div class="md:col-span-2"><label class="block font-medium">آدرس</label><input type="text" id="address" value="${info.address || ''}" class="w-full p-2 border rounded-md"></div><div><label class="block font-medium">وضعیت نظام وظیفه</label><input type="text" id="militaryStatus" value="${info.militaryStatus || ''}" class="w-full p-2 border rounded-md"></div><hr class="md:col-span-2 my-2"><div><label class="block font-medium">نام مخاطب اضطراری</label><input type="text" id="emergencyContactName" value="${info.emergencyContactName || ''}" class="w-full p-2 border rounded-md"></div><div><label class="block font-medium">شماره مخاطب اضطراری</label><input type="tel" id="emergencyContactPhone" value="${info.emergencyContactPhone || ''}" class="w-full p-2 border rounded-md"></div></div><div class="pt-6 flex justify-end gap-4"><button type="button" id="back-to-profile-personal" class="bg-gray-500 text-white py-2 px-6 rounded-md hover:bg-gray-600">بازگشت</button><button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">ذخیره</button></div></form>`;

    activatePersianDatePicker('birthDate', info.birthDate); // فعال‌سازی تقویم شمسی

    document.getElementById('back-to-profile-personal').addEventListener('click', () => viewEmployeeProfile(emp.firestoreId));
    document.getElementById('edit-personal-info-form').addEventListener('submit', async (e) => { 
        e.preventDefault(); 
        const gregorianBirthDate = persianToEnglishDate(document.getElementById('birthDate').value);
        const updatedInfo = { 
            nationalId: document.getElementById('nationalId').value, 
            birthDate: gregorianBirthDate, 
            phone: document.getElementById('phone').value, 
            address: document.getElementById('address').value, 
            militaryStatus: document.getElementById('militaryStatus').value, 
            emergencyContactName: document.getElementById('emergencyContactName').value, 
            emergencyContactPhone: document.getElementById('emergencyContactPhone').value, 
        }; 
        const gender = document.getElementById('gender').value; 
        try { 
            const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId); 
            await updateDoc(docRef, { personalInfo: updatedInfo, gender: gender }); 
            showToast("اطلاعات پرسنلی به‌روزرسانی شد."); 
            viewEmployeeProfile(emp.firestoreId); 
        } catch (error) { 
            console.error("Error updating personal info:", error); 
            showToast("خطا در به‌روزرسانی اطلاعات.", "error"); 
        } 
    });
};
        
        const showDisciplinaryForm = (emp) => {
    modalTitle.innerText = `ثبت مورد انضباطی برای ${emp.name}`;
    modalContent.innerHTML = `<form id="disciplinary-form" class="space-y-4"><div><label class="block font-medium">نوع</label><select id="disciplinary-type" class="w-full p-2 border rounded-md"><option value="تشویق">تشویق</option><option value="تذکر">تذکر</option></select></div><div><label class="block font-medium">تاریخ</label><input type="text" id="disciplinary-date" class="w-full p-2 border rounded-md" required></div><div><label class="block font-medium">دلیل</label><textarea id="disciplinary-reason" rows="3" class="w-full p-2 border rounded-md" required></textarea></div><div class="pt-6 flex justify-end gap-4"><button type="button" id="back-to-profile-disciplinary" class="bg-gray-500 text-white py-2 px-6 rounded-md hover:bg-gray-600">بازگشت</button><button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">ثبت</button></div></form>`;

    activatePersianDatePicker('disciplinary-date', new Date()); // فعال‌سازی تقویم شمسی

    document.getElementById('back-to-profile-disciplinary').addEventListener('click', () => viewEmployeeProfile(emp.firestoreId));
    document.getElementById('disciplinary-form').addEventListener('submit', async (e) => { 
        e.preventDefault(); 
        const gregorianDate = persianToEnglishDate(document.getElementById('disciplinary-date').value);
        if (!gregorianDate) {
            showToast("فرمت تاریخ شمسی صحیح نیست.", "error");
            return;
        }
        const newRecord = { 
            type: document.getElementById('disciplinary-type').value, 
            date: gregorianDate, 
            reason: document.getElementById('disciplinary-reason').value, 
        }; 
        const updatedHistory = [...(emp.disciplinaryHistory || []), newRecord]; 
        try { 
            const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId); 
            await updateDoc(docRef, { disciplinaryHistory: updatedHistory }); 
            showToast("مورد انضباطی با موفقیت ثبت شد."); 
            viewEmployeeProfile(emp.firestoreId); 
        } catch (error) { 
            console.error("Error adding disciplinary record:", error); 
            showToast("خطا در ثبت مورد انضباطی.", "error"); 
        } 
    });
};

       const showContractForm = (emp, contractIndex = null) => {
    const isEditing = contractIndex !== null;
    const contract = isEditing ? emp.contractHistory[contractIndex] : {};
    modalTitle.innerText = isEditing ? `ویرایش قرارداد برای ${emp.name}` : `ثبت قرارداد جدید برای ${emp.name}`;
    modalContent.innerHTML = `<form id="contract-form" class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block font-medium">تاریخ شروع</label><input type="text" id="contract-start" class="w-full p-2 border rounded-md" required></div><div><label class="block font-medium">تاریخ پایان</label><input type="text" id="contract-end" class="w-full p-2 border rounded-md" required></div><div><label class="block font-medium">حقوق ناخالص (ریال)</label><input type="number" id="contract-gross" value="${contract.grossSalary || ''}" class="w-full p-2 border rounded-md"></div><div><label class="block font-medium">حقوق خالص (ریال)</label><input type="number" id="contract-net" value="${contract.netSalary || ''}" class="w-full p-2 border rounded-md"></div><div><label class="block font-medium">مبلغ سفته (ریال)</label><input type="number" id="contract-promissory" value="${contract.promissoryNote || ''}" class="w-full p-2 border rounded-md"></div><div><label class="block font-medium">فایل قرارداد (نام فایل)</label><input type="text" id="contract-file" value="${contract.fileName || ''}" class="w-full p-2 border rounded-md"></div></div><div class="pt-6 flex justify-end gap-4"><button type="button" id="back-to-profile-contract" class="bg-gray-500 text-white py-2 px-6 rounded-md hover:bg-gray-600">بازگشت</button><button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">ذخیره</button></div></form>`;

    activatePersianDatePicker('contract-start', contract.startDate);
    activatePersianDatePicker('contract-end', contract.endDate);

    document.getElementById('back-to-profile-contract').addEventListener('click', () => viewEmployeeProfile(emp.firestoreId));
    document.getElementById('contract-form').addEventListener('submit', async (e) => { 
        e.preventDefault(); 
        const gregorianStart = persianToEnglishDate(document.getElementById('contract-start').value);
        const gregorianEnd = persianToEnglishDate(document.getElementById('contract-end').value);

        if (!gregorianStart || !gregorianEnd) {
            showToast("فرمت تاریخ شمسی صحیح نیست.", "error");
            return;
        }

        const newContract = { 
            startDate: gregorianStart, 
            endDate: gregorianEnd, 
            grossSalary: Number(document.getElementById('contract-gross').value), 
            netSalary: Number(document.getElementById('contract-net').value), 
            promissoryNote: Number(document.getElementById('contract-promissory').value), 
            fileName: document.getElementById('contract-file').value, 
        }; 
        let updatedHistory = [...(emp.contractHistory || [])]; 
        if(isEditing) { 
            updatedHistory[contractIndex] = newContract; 
        } else { 
            updatedHistory.push(newContract); 
        } 
        updatedHistory.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
        const latestContractEndDate = updatedHistory[0]?.endDate || null;

        try { 
            const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId); 
            await updateDoc(docRef, { 
                contractHistory: updatedHistory,
                contractEndDate: latestContractEndDate
            }); 
            showToast("قرارداد با موفقیت ذخیره شد."); 
            viewEmployeeProfile(emp.firestoreId); 
        } catch (error) { 
            console.error("Error saving contract record:", error); 
            showToast("خطا در ثبت قرارداد.", "error"); 
        } 
    });
};
        
        const deleteContract = async (emp, index) => {
            showConfirmationModal("حذف قرارداد", "آیا از حذف این سابقه قرارداد مطمئن هستید؟", async () => {
                let updatedHistory = [...(emp.contractHistory || [])];
                updatedHistory.splice(index, 1);
                const latestContractEndDate = updatedHistory[0]?.endDate || null;
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId);
                    await updateDoc(docRef, { 
                        contractHistory: updatedHistory,
                        contractEndDate: latestContractEndDate
                    });
                    showToast("سابقه قرارداد حذف شد.");
                    viewEmployeeProfile(emp.firestoreId);
                } catch (error) {
                    console.error("Error deleting contract:", error);
                    showToast("خطا در حذف قرارداد.", "error");
                }
            });
        };

        const showDocumentForm = (emp, docIndex = null) => {
            const isEditing = docIndex !== null;
            const documentItem = isEditing ? emp.documents[docIndex] : {};
            modalTitle.innerText = isEditing ? `ویرایش مدرک برای ${emp.name}` : `افزودن مدرک جدید برای ${emp.name}`;
            modalContent.innerHTML = `<form id="document-form" class="space-y-4"><div><label class="block font-medium">نام مدرک</label><input type="text" id="doc-name" value="${documentItem.name || ''}" class="w-full p-2 border rounded-md" required></div><div><label class="block font-medium">تاریخ</label><input type="date" id="doc-date" value="${documentItem.date || ''}" class="w-full p-2 border rounded-md" required></div><div><label class="block font-medium">نام فایل (اختیاری)</label><input type="text" id="doc-file" value="${documentItem.fileName || ''}" class="w-full p-2 border rounded-md"></div><div class="pt-6 flex justify-end gap-4"><button type="button" id="back-to-profile-doc" class="bg-gray-500 text-white py-2 px-6 rounded-md hover:bg-gray-600">بازگشت</button><button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">ذخیره</button></div></form>`;
            document.getElementById('back-to-profile-doc').addEventListener('click', () => viewEmployeeProfile(emp.firestoreId));
            document.getElementById('document-form').addEventListener('submit', async (e) => { e.preventDefault(); const newDoc = { name: document.getElementById('doc-name').value, date: document.getElementById('doc-date').value, fileName: document.getElementById('doc-file').value }; let updatedDocs = [...(emp.documents || [])]; if(isEditing) { updatedDocs[docIndex] = newDoc; } else { updatedDocs.push(newDoc); } try { const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId); await updateDoc(docRef, { documents: updatedDocs }); showToast("مدرک با موفقیت ذخیره شد."); viewEmployeeProfile(emp.firestoreId); } catch (error) { console.error("Error saving document:", error); showToast("خطا در ثبت مدرک.", "error"); } });
        };
        
        const deleteDocument = async (emp, index) => {
            showConfirmationModal("حذف مدرک", "آیا از حذف این مدرک مطمئن هستید؟", async () => {
                let updatedDocs = [...(emp.documents || [])];
                updatedDocs.splice(index, 1);
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId);
                    await updateDoc(docRef, { documents: updatedDocs });
                    showToast("مدرک حذف شد.");
                    viewEmployeeProfile(emp.firestoreId);
                } catch (error) {
                    console.error("Error deleting document:", error);
                    showToast("خطا در حذف مدرک.", "error");
                }
            });
        };

       const showPerformanceForm = (emp, reviewIndex = null) => {
    const isEditing = reviewIndex !== null;
    const review = isEditing ? emp.performanceHistory[reviewIndex] : {};
    modalTitle.innerText = isEditing ? `ویرایش ارزیابی عملکرد برای ${emp.name}` : `ثبت ارزیابی عملکرد جدید`;
    modalContent.innerHTML = `
        <form id="performance-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block font-medium">تاریخ ارزیابی</label><input type="text" id="perf-date" class="w-full p-2 border rounded-md" required></div>
                <div><label class="block font-medium">نام ارزیاب</label><input type="text" id="perf-reviewer" value="${review.reviewer || ''}" class="w-full p-2 border rounded-md" required></div>
                <div class="md:col-span-2"><label class="block font-medium">امتیاز کلی (۱ تا ۵)</label><input type="number" step="0.1" min="0" max="5" id="perf-score" value="${review.overallScore || ''}" class="w-full p-2 border rounded-md" required></div>
                <div class="md:col-span-2"><label class="block font-medium">نقاط قوت</label><textarea id="perf-strengths" rows="3" class="w-full p-2 border rounded-md">${review.strengths || ''}</textarea></div>
                <div class="md:col-span-2"><label class="block font-medium">زمینه‌های قابل بهبود</label><textarea id="perf-improvements" rows="3" class="w-full p-2 border rounded-md">${review.areasForImprovement || ''}</textarea></div>
            </div>
            <div class="pt-6 flex justify-end gap-4">
                <button type="button" id="back-to-profile-perf" class="bg-gray-500 text-white py-2 px-6 rounded-md hover:bg-gray-600">بازگشت</button>
                <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">ذخیره</button>
            </div>
        </form>
    `;

    activatePersianDatePicker('perf-date', review.reviewDate || new Date());

    document.getElementById('back-to-profile-perf').addEventListener('click', () => viewEmployeeProfile(emp.firestoreId));
    document.getElementById('performance-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const gregorianDate = persianToEnglishDate(document.getElementById('perf-date').value);
        if (!gregorianDate) {
            showToast("فرمت تاریخ شمسی صحیح نیست.", "error");
            return;
        }
        const newReview = {
            reviewDate: gregorianDate,
            reviewer: document.getElementById('perf-reviewer').value,
            overallScore: parseFloat(document.getElementById('perf-score').value),
            strengths: document.getElementById('perf-strengths').value,
            areasForImprovement: document.getElementById('perf-improvements').value,
        };
        let updatedHistory = [...(emp.performanceHistory || [])];
        if (isEditing) {
            updatedHistory[reviewIndex] = newReview;
        } else {
            updatedHistory.push(newReview);
        }
        try {
            const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId);
            await updateDoc(docRef, { performanceHistory: updatedHistory });
            showToast("ارزیابی عملکرد با موفقیت ذخیره شد.");
            viewEmployeeProfile(emp.firestoreId);
        } catch (error) {
            console.error("Error saving performance review:", error);
            showToast("خطا در ذخیره ارزیابی.", "error");
        }
    });
};

      const showCareerPathForm = (emp) => {
    modalTitle.innerText = `ثبت رویداد شغلی برای ${emp.name}`;
    modalContent.innerHTML = `
        <form id="career-path-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block font-medium">تاریخ</label><input type="text" id="career-date" class="w-full p-2 border rounded-md" required></div>
                <div><label class="block font-medium">نوع رویداد</label><select id="career-type" class="w-full p-2 border rounded-md"><option value="ترفیع">ترفیع</option><option value="جابجایی افقی">جابجایی افقی</option><option value="تغییر سمت">تغییر سمت</option></select></div>
                <div><label class="block font-medium">سمت جدید</label><input type="text" id="career-title" class="w-full p-2 border rounded-md" required></div>
                <div><label class="block font-medium">دپارتمان جدید</label><input type="text" id="career-department" value="${emp.department}" class="w-full p-2 border rounded-md" required></div>
            </div>
            <div class="pt-6 flex justify-end gap-4">
                <button type="button" id="back-to-profile-career" class="bg-gray-500 text-white py-2 px-6 rounded-md hover:bg-gray-600">بازگشت</button>
                <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">ثبت</button>
            </div>
        </form>
    `;

    activatePersianDatePicker('career-date', new Date());

    document.getElementById('back-to-profile-career').addEventListener('click', () => viewEmployeeProfile(emp.firestoreId));
    document.getElementById('career-path-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const gregorianDate = persianToEnglishDate(document.getElementById('career-date').value);
         if (!gregorianDate) {
            showToast("فرمت تاریخ شمسی صحیح نیست.", "error");
            return;
        }
        const newEntry = {
            date: gregorianDate,
            type: document.getElementById('career-type').value,
            title: document.getElementById('career-title').value,
            department: document.getElementById('career-department').value,
        };
        const updatedPath = [...(emp.careerPath || []), newEntry];
        try {
            const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId);
            await updateDoc(docRef, { careerPath: updatedPath });
            showToast("رویداد شغلی با موفقیت ثبت شد.");
            viewEmployeeProfile(emp.firestoreId);
        } catch (error) {
            console.error("Error saving career path:", error);
            showToast("خطا در ثبت رویداد شغلی.", "error");
        }
    });
};
        const deletePerformanceReview = async (emp, index) => {
        showConfirmationModal("حذف سابقه عملکرد", "آیا از حذف این مورد مطمئن هستید؟", async () => {
            const updatedHistory = emp.performanceHistory.filter((_, i) => i !== index);
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId);
                await updateDoc(docRef, { performanceHistory: updatedHistory });
                showToast("سابقه عملکرد حذف شد.");
                viewEmployeeProfile(emp.firestoreId);
            } catch (error) {
                console.error("Error deleting performance review:", error);
                showToast("خطا در حذف سابقه عملکرد.", "error");
            }
        });
    };

    const deleteDisciplinaryRecord = async (emp, index) => {
        showConfirmationModal("حذف سابقه انضباطی", "آیا از حذف این مورد مطمئن هستید؟", async () => {
            const updatedHistory = emp.disciplinaryHistory.filter((_, i) => i !== index);
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId);
                await updateDoc(docRef, { disciplinaryHistory: updatedHistory });
                showToast("سابقه انضباطی حذف شد.");
                viewEmployeeProfile(emp.firestoreId);
            } catch (error) {
                console.error("Error deleting disciplinary record:", error);
                showToast("خطا در حذف سابقه انضباطی.", "error");
            }
        });
    };

    const deleteCareerPathEntry = async (emp, index) => {
        showConfirmationModal("حذف رویداد شغلی", "آیا از حذف این مورد مطمئن هستید؟", async () => {
            const updatedPath = emp.careerPath.filter((_, i) => i !== index);
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId);
                await updateDoc(docRef, { careerPath: updatedPath });
                showToast("رویداد شغلی حذف شد.");
                viewEmployeeProfile(emp.firestoreId);
            } catch (error) {
                console.error("Error deleting career path entry:", error);
                showToast("خطا در حذف رویداد شغلی.", "error");
            }
        });
    };

        const setupSurveysPageListeners = () => {
            document.querySelectorAll('.create-survey-link-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const surveyId = e.currentTarget.dataset.surveyId;
                    const surveyTemplate = surveyTemplates[surveyId];
                    if (surveyTemplate.requiresTarget) {
                        showSurveyTargetSelector(surveyId);
                    } else {
                        generateAndShowSurveyLink(surveyId);
                    }
                });
            });
        };

        const showSurveyTargetSelector = (surveyId) => {
            modalTitle.innerText = 'انتخاب فرد مورد نظر برای نظرسنجی';
            const employeeOptions = state.employees.map(emp => `<option value="${emp.id}">${emp.name} (${emp.id})</option>`).join('');
            modalContent.innerHTML = `
                <div class="p-4 space-y-4">
                    <p>این نظرسنجی (بازخورد ۳۶۰ درجه) نیازمند انتخاب یک فرد مشخص است.</p>
                    <div>
                        <label for="survey-target-employee" class="block text-sm font-medium text-gray-700">کارمند مورد نظر را انتخاب کنید:</label>
                        <select id="survey-target-employee" class="mt-1 block w-full p-2 border rounded-md">
                            ${employeeOptions}
                        </select>
                    </div>
                    <div class="flex justify-end">
                        <button id="generate-targeted-link-btn" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">ایجاد لینک</button>
                    </div>
                </div>
            `;
            openModal(mainModal, mainModalContainer);
            document.getElementById('generate-targeted-link-btn').addEventListener('click', () => {
                const targetEmployeeId = document.getElementById('survey-target-employee').value;
                if (targetEmployeeId) {
                    generateAndShowSurveyLink(surveyId, targetEmployeeId);
                }
            });
        };

        const generateAndShowSurveyLink = (surveyId, targetEmployeeId = null) => {
            let surveyLink = `${window.location.origin}${window.location.pathname}#survey-taker?id=${surveyId}`;
            if (targetEmployeeId) {
                surveyLink += `&target=${targetEmployeeId}`;
            }
            modalTitle.innerText = 'لینک نظرسنجی ایجاد شد';
            modalContent.innerHTML = `
                <div class="p-4 space-y-4">
                    <p>این لینک را برای شرکت‌کنندگان ارسال کنید:</p>
                    <div class="flex items-center bg-gray-100 p-2 rounded-md">
                        <input id="survey-link-input" type="text" readonly value="${surveyLink}" class="flex-grow bg-transparent outline-none font-mono text-sm">
                        <button id="copy-survey-link-btn" class="bg-blue-500 text-white py-1 px-3 rounded-md hover:bg-blue-600 ml-2">کپی</button>
                    </div>
                </div>
            `;
            if (!mainModal.classList.contains('flex')) {
                openModal(mainModal, mainModalContainer);
            }
            document.getElementById('copy-survey-link-btn').addEventListener('click', () => {
                const linkInput = document.getElementById('survey-link-input');
                linkInput.select();
                document.execCommand('copy');
                showToast("لینک با موفقیت کپی شد!");
            });
        };
        
        const renderSurveyTakerPage = (surveyId) => {
            document.getElementById('dashboard-container').classList.add('hidden');
            const surveyTakerContainer = document.getElementById('survey-taker-container');
            surveyTakerContainer.classList.remove('hidden');
            const survey = surveyTemplates[surveyId];
            if (!survey) {
                surveyTakerContainer.innerHTML = `<p>نظرسنجی یافت نشد.</p>`;
                return;
            }
            
            const urlParams = new URLSearchParams(window.location.hash.split('?')[1]);
            const targetEmployeeId = urlParams.get('target');
            const targetEmployee = targetEmployeeId ? state.employees.find(e => e.id === targetEmployeeId) : null;
            
            let title = survey.title;
            if (targetEmployee) {
                title += ` در مورد: ${targetEmployee.name}`;
            }

            const questionsHtml = survey.questions.map(q => {
                let inputHtml = '';
                switch (q.type) {
                    case 'rating_1_5':
                        inputHtml = `<div class="flex justify-center gap-2 flex-wrap">${[1, 2, 3, 4, 5].map(n => `<label class="cursor-pointer"><input type="radio" name="${q.id}" value="${n}" class="sr-only peer" required><div class="w-10 h-10 rounded-full flex items-center justify-center border-2 border-gray-300 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">${n}</div></label>`).join('')}</div>`;
                        break;
                    case 'yes_no':
                        inputHtml = `<div class="flex justify-center gap-4"><label class="cursor-pointer"><input type="radio" name="${q.id}" value="yes" class="sr-only peer" required><div class="px-6 py-2 rounded-md border-2 border-gray-300 peer-checked:bg-green-600 peer-checked:text-white peer-checked:border-green-600">بله</div></label><label class="cursor-pointer"><input type="radio" name="${q.id}" value="no" class="sr-only peer" required><div class="px-6 py-2 rounded-md border-2 border-gray-300 peer-checked:bg-red-600 peer-checked:text-white peer-checked:border-red-600">خیر</div></label></div>`;
                        break;
                    case 'choice':
                        inputHtml = `<div class="flex justify-center gap-4 flex-wrap">${(q.options || []).map(opt => `<label class="cursor-pointer"><input type="radio" name="${q.id}" value="${opt}" class="sr-only peer" required><div class="px-6 py-2 rounded-md border-2 border-gray-300 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">${opt}</div></label>`).join('')}</div>`;
                        break;
                    case 'open_text':
                        inputHtml = `<textarea name="${q.id}" rows="4" class="w-full p-2 border rounded-md" required></textarea>`;
                        break;
                }
                return `<div class="bg-white p-6 rounded-lg shadow-md"><p class="font-semibold mb-4 text-center">${q.text}</p>${inputHtml}</div>`;
            }).join('');

            surveyTakerContainer.innerHTML = `
                <div class="min-h-screen bg-gray-100 p-4 sm:p-8 flex items-center justify-center">
                    <div class="w-full max-w-2xl space-y-6">
                         <div class="text-center">
                            <i data-lucide="shield-check" class="mx-auto w-12 h-12 text-blue-800"></i>
                            <h1 class="text-2xl font-bold mt-2">${title}</h1>
                            <p class="text-gray-600 mt-1">${survey.description}</p>
                        </div>
                        <form id="survey-form" class="space-y-6">
                            ${questionsHtml}
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <label for="employeeId" class="block text-sm font-medium text-gray-700 mb-2">کد پرسنلی (اختیاری)</label>
                                <p class="text-xs text-gray-500 mb-2">برای ثبت پاسخ به صورت ناشناس، این فیلد را خالی بگذارید.</p>
                                <input type="text" name="employeeId" class="w-full p-2 border rounded-md">
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-md font-semibold hover:bg-blue-700">ارسال پاسخ‌ها</button>
                        </form>
                    </div>
                </div>
            `;
            lucide.createIcons();
            
            document.getElementById('survey-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const answers = {};
                survey.questions.forEach(q => {
                    answers[q.id] = formData.get(q.id);
                });
                const employeeId = formData.get('employeeId').trim() || 'anonymous';
                
                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/surveyResponses`), {
                        surveyId,
                        employeeId,
                        targetEmployeeId,
                        answers,
                        submittedAt: serverTimestamp()
                    });
                    surveyTakerContainer.innerHTML = `<div class="min-h-screen flex items-center justify-center text-center"><div class="bg-white p-10 rounded-lg shadow-xl"><i data-lucide="check-circle" class="mx-auto w-16 h-16 text-green-500"></i><h2 class="mt-4 text-2xl font-bold">از شما متشکریم!</h2><p class="mt-2 text-gray-600">پاسخ‌های شما با موفقیت ثبت شد.</p></div></div>`;
                    lucide.createIcons();
                } catch (error) {
                    console.error("Error submitting survey:", error);
                    showToast("خطا در ارسال نظرسنجی.", "error");
                }
            });
        };
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            setupEventListeners();
            lucide.createIcons();
        });

    </script>
</body>
</html>
