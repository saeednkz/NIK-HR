
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ù†Ø§Ø¨Ø¹ Ø§Ù†Ø³Ø§Ù†ÛŒ NikHR</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.js"></script>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
    <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
    
    <script type="text/javascript">
        $(function() {
            if ($.fn.pDatepicker) {
                $.fn.pDatepicker.defaults.observer = false;
            }
        });
    </script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css">
    
<style>
    /* ğŸ¨ NEW MODERN UI DESIGN LANGUAGE */
    :root {
        --color-primary: #5E5DF0;        /* A vibrant, modern purple-blue */
        --color-primary-light: #F2F2FF;  /* A very light, complementary lavender */
        --color-accent: #22D3EE;         /* A bright cyan for accents */
        --color-text-primary: #111827;   /* Almost black for high contrast text */
        --color-text-secondary: #6B7280; /* Muted gray for supporting text */
        --color-bg: #F9FAFB;             /* A very light, clean gray background */
        --color-surface: #FFFFFF;         /* Pure white for cards and elements */
        --color-border: #E5E7EB;         /* Light gray border for inputs etc. */
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        --border-radius: 1rem; /* 16px */
    }

    body {
        font-family: 'Vazirmatn', sans-serif;
        background-color: var(--color-bg);
        color: var(--color-text-primary);
        line-height: 1.6;
        font-size: 16px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    .sidebar {
        background-color: var(--color-surface);
        border-left: 1px solid var(--color-border);
    }

    .sidebar-item {
        color: var(--color-text-secondary);
        transition: all 0.2s ease-in-out;
        border-right: 4px solid transparent;
        margin-right: -8px; /* Adjust based on padding */
        padding-right: 12px;
    }

    .sidebar-item.active, .sidebar-item:hover {
        color: var(--color-primary);
        background-color: var(--color-primary-light);
        border-right-color: var(--color-primary);
        font-weight: 600;
    }
    
    .card {
        background-color: var(--color-surface);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--color-border);
        transition: box-shadow 0.2s ease-in-out, transform 0.2s ease;
        padding: 1.5rem; /* 24px */
    }

    .card:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-4px);
    }

    .metric-card {
        background-color: var(--color-surface);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--color-border);
        padding: 1.5rem;
        transition: all 0.2s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--color-primary);
    }
    
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    #loading-overlay { position: fixed; inset: 0; background-color: rgba(249, 250, 251, 0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .spinner { width: 56px; height: 56px; border: 6px solid var(--color-primary-light); border-top: 6px solid var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* Toast & Modal styles remain largely the same, but can be updated if needed */
    #toast-container { position: fixed; bottom: 20px; left: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
    .toast { display: flex; align-items: center; padding: 12px 20px; border-radius: 8px; box-shadow: var(--shadow-lg); color: white; opacity: 0; transform: translateY(20px); animation: slideUp 0.5s forwards, fadeOutToast 0.5s 4.5s forwards; }
    .toast.success { background: linear-gradient(to right, #10b981, #22c55e); }
    .toast.error { background: linear-gradient(to right, #f43f5e, #e11d48); }
    @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeOutToast { from { opacity: 1; } to { opacity: 0; transform: scale(0.9); } }
</style>
<body class="bg-slate-50">

    <div id="login-container" class="hidden min-h-screen flex items-center justify-center bg-slate-100">
         <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-md">
            <div class="text-center">
                <i data-lucide="shield-check" class="mx-auto w-12 h-12 text-teal-500"></i>
                <h2 class="mt-4 text-2xl font-bold text-slate-800">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ… NikHR</h2>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="text-sm font-medium text-slate-700">Ø¢Ø¯Ø±Ø³ Ø§ÛŒÙ…ÛŒÙ„</label>
                    <input id="email" name="email" type="email" autocomplete="email" required class="w-full px-3 py-2 mt-1 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-slate-700">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                    <input id="password" name="password" type="password" autocomplete="current-password" required class="w-full px-3 py-2 mt-1 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                </div>
                <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-teal-600 rounded-lg hover:bg-teal-700 shadow-md transition-all">ÙˆØ±ÙˆØ¯</button>
            </form>
            <p class="text-sm text-center text-slate-600">Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯ØŸ <a href="#" id="show-signup" class="font-medium text-teal-600 hover:underline">Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ù†ÛŒØ¯</a></p>
        </div>
    </div>
    <div id="signup-container" class="hidden min-h-screen flex items-center justify-center bg-slate-100">
         <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <div class="text-center">
                <i data-lucide="user-plus" class="mx-auto w-12 h-12 text-teal-500"></i>
                <h2 class="mt-4 text-2xl font-bold text-gray-900">Ø§ÛŒØ¬Ø§Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¬Ø¯ÛŒØ¯</h2>
            </div>
            <form id="signup-form" class="space-y-6">
                <div>
                    <label for="signup-email" class="text-sm font-medium text-gray-700">Ø¢Ø¯Ø±Ø³ Ø§ÛŒÙ…ÛŒÙ„</label>
                    <input id="signup-email" name="email" type="email" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="signup-password" class="text-sm font-medium text-gray-700">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                    <input id="signup-password" name="password" type="password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500">
                </div>
                <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-teal-600 rounded-md hover:bg-teal-700">Ø«Ø¨Øª Ù†Ø§Ù…</button>
            </form>
            <p class="text-sm text-center text-gray-600">Ù‚Ø¨Ù„Ø§ Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯ØŸ <a href="#" id="show-login" class="font-medium text-teal-600 hover:underline">ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</a></p>
        </div>
    </div>

    <div id="dashboard-container" class="hidden h-screen">
        <aside id="sidebar" class="sidebar w-64 space-y-6 py-7 px-2 fixed inset-y-0 right-0 transform translate-x-full md:relative md:translate-x-0 transition duration-300 ease-in-out z-30 flex flex-col">
            <div>
                <a href="#dashboard" class="sidebar-logo text-slate-800 text-2xl font-bold px-4 flex items-center space-x-2 space-x-reverse">
                    <i data-lucide="shield-check" class="text-teal-500"></i>
                    <span>NikHR</span>
                </a>
                <nav id="sidebar-nav" class="mt-10">
                    <a href="#dashboard" class="sidebar-item block py-3 px-4 rounded-r-lg flex items-center space-x-3 space-x-reverse"><i data-lucide="layout-dashboard"></i><span>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span></a>
                    <a href="#talent" class="sidebar-item block py-3 px-4 rounded-r-lg flex items-center space-x-3 space-x-reverse"><i data-lucide="users"></i><span>Ø§Ø³ØªØ¹Ø¯Ø§Ø¯Ù‡Ø§</span></a>
                    <a href="#organization" class="sidebar-item block py-3 px-4 rounded-r-lg flex items-center space-x-3 space-x-reverse"><i data-lucide="building-2"></i><span>Ø³Ø§Ø²Ù…Ø§Ù†</span></a>
                    <a href="#surveys" class="sidebar-item block py-3 px-4 rounded-r-lg flex items-center space-x-3 space-x-reverse"><i data-lucide="clipboard-list"></i><span>Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒâ€ŒÙ‡Ø§</span></a>
                    <a href="#expenses" class="sidebar-item block py-3 px-4 rounded-r-lg flex items-center space-x-3 space-x-reverse"><i data-lucide="wallet"></i><span>Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</span></a>
                    <a href="#analytics" class="sidebar-item block py-3 px-4 rounded-r-lg flex items-center space-x-3 space-x-reverse"><i data-lucide="bar-chart-3"></i><span>ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯</span></a>
                    <a href="#settings" id="settings-nav-link" class="sidebar-item block py-3 px-4 rounded-r-lg flex items-center space-x-3 space-x-reverse"><i data-lucide="settings"></i><span>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</span></a>
                </nav>
            </div>
            <div class="mt-auto">
                 <a href="#" id="logout-btn" class="sidebar-item block py-3 px-4 rounded-r-lg flex items-center space-x-3 space-x-reverse !text-red-500 hover:!bg-red-50 hover:!border-red-500"><i data-lucide="log-out"></i><span>Ø®Ø±ÙˆØ¬ Ø§Ø² Ø³ÛŒØ³ØªÙ…</span></a>
            </div>
        </aside>
        <div class="flex-1 flex flex-col h-screen overflow-y-hidden">
            <header class="flex justify-between items-center p-4 bg-white border-b border-slate-200 md:hidden">
                <a href="#dashboard" class="sidebar-logo text-slate-800 text-xl font-bold flex items-center space-x-2 space-x-reverse"><i data-lucide="shield-check" class="text-teal-500"></i><span>NikHR</span></a>
                <button id="menu-btn" class="text-slate-600 z-40"><i data-lucide="menu" class="w-6 h-6"></i></button>
            </header>
            <main id="main-content" class="flex-1 p-6 sm:p-10 overflow-y-auto"></main>
        </div>
    </div>
    
    <div id="survey-taker-container" class="hidden"></div>
    <div id="loading-overlay"><div class="spinner"></div></div>
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

    <div id="mainModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-4/5 max-w-6xl h-5/6 transform transition-all duration-300 scale-95 opacity-0">
            <div class="flex justify-between items-center p-4 border-b border-slate-200">
                <h3 id="modalTitle" class="text-xl font-semibold text-slate-800"></h3>
                <button id="closeModal" class="text-slate-500 hover:text-slate-800"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="modalContent" class="p-6 overflow-y-auto h-[calc(100%-65px)]"></div>
        </div>
    </div>
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-sm p-6 transform transition-all duration-300 scale-95 opacity-0">
            <h3 id="confirmTitle" class="text-lg font-bold text-slate-800 mb-4">Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ</h3>
            <p id="confirmMessage" class="text-slate-600 mb-6"></p>
            <div class="flex justify-end gap-4">
                <button id="confirmCancel" class="bg-slate-200 text-slate-800 py-2 px-4 rounded-md hover:bg-slate-300">Ø§Ù†ØµØ±Ø§Ù</button>
                <button id="confirmAccept" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">ØªØ§ÛŒÛŒØ¯</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>
    <input type="file" id="image-upload-input" class="hidden" accept="image/*">

    <script type="module">
        // --- ALL JAVASCRIPT CODE STARTS HERE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, onSnapshot, collection, 
            addDoc, getDocs, writeBatch, deleteDoc, updateDoc, query, serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
        
        // --- SURVEY TEMPLATES (COMPREHENSIVE & STANDARD) ---
        const surveyTemplates = {
            'engagement': {
                id: 'engagement',
                title: 'Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ Ø¬Ø§Ù…Ø¹ Ù…Ø´Ø§Ø±Ú©Øª Ú©Ø§Ø±Ú©Ù†Ø§Ù† (Engagement)',
                description: 'Ø³Ù†Ø¬Ø´ Ø¹Ù…ÛŒÙ‚ Ø³Ø·Ø­ ØªØ¹Ù‡Ø¯ØŒ Ø§Ù†Ú¯ÛŒØ²Ù‡ Ùˆ Ø±Ø¶Ø§ÛŒØª Ø´ØºÙ„ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ Ø¬Ù‡Ø§Ù†ÛŒ.',
                categories: { alignment: 'Ù‡Ù…â€ŒØ±Ø§Ø³ØªØ§ÛŒÛŒ Ùˆ Ø§Ù‡Ø¯Ø§Ù', growth: 'Ø±Ø´Ø¯ Ùˆ ØªÙˆØ³Ø¹Ù‡', management: 'Ù…Ø¯ÛŒØ±ÛŒØª Ùˆ Ø±Ø§Ù‡Ø¨Ø±ÛŒ', recognition: 'Ù‚Ø¯Ø±Ø¯Ø§Ù†ÛŒ Ùˆ Ø§Ø±Ø²Ø´â€ŒÚ¯Ø°Ø§Ø±ÛŒ', wellbeing: 'Ø³Ù„Ø§Ù…Øª Ùˆ ØªØ¹Ø§Ø¯Ù„ Ú©Ø§Ø± Ùˆ Ø²Ù†Ø¯Ú¯ÛŒ', culture: 'ÙØ±Ù‡Ù†Ú¯ Ùˆ ØªØ¹Ù„Ù‚ Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ' },
                questions: [
                    { id: 'eng_q1', category: 'alignment', text: 'Ù…Ù† Ø¨Ù‡ ÙˆØ¶ÙˆØ­ Ù…ÛŒâ€ŒØ¯Ø§Ù†Ù… Ú©Ù‡ Ú©Ø§Ø± Ù…Ù† Ú†Ú¯ÙˆÙ†Ù‡ Ø¨Ù‡ Ø§Ù‡Ø¯Ø§Ù Ú©Ù„ÛŒ Ø´Ø±Ú©Øª Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯.', type: 'rating_1_5' },
                    { id: 'eng_q2', category: 'alignment', text: 'Ù…Ù† Ø¨Ù‡ Ù…Ø§Ù…ÙˆØ±ÛŒØª Ùˆ Ú†Ø´Ù…â€ŒØ§Ù†Ø¯Ø§Ø² Ø´Ø±Ú©Øª Ø¨Ø§ÙˆØ± Ø¯Ø§Ø±Ù….', type: 'rating_1_5' },
                    { id: 'eng_q3', category: 'growth', text: 'Ø¯Ø± Ø´ØºÙ„ ÙØ¹Ù„ÛŒâ€ŒØ§Ù… ÙØ±ØµØªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ùˆ Ø±Ø´Ø¯ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¯Ø§Ø±Ù….', type: 'rating_1_5' },
                    { id: 'eng_q4', category: 'growth', text: 'Ø´Ø±Ú©Øª Ø¯Ø± ØªÙˆØ³Ø¹Ù‡ Ù…Ù‡Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù† Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.', type: 'rating_1_5' },
                    { id: 'eng_q5', category: 'management', text: 'Ù…Ø¯ÛŒØ± Ù…Ø³ØªÙ‚ÛŒÙ… Ù…Ù† Ø¨Ù‡ Ø·ÙˆØ± Ù…Ù†Ø¸Ù… Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ø³Ø§Ø²Ù†Ø¯Ù‡ Ùˆ Ù…ÙÛŒØ¯ÛŒ Ø¨Ù‡ Ù…Ù† Ø§Ø±Ø§Ø¦Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.', type: 'rating_1_5' },
                    { id: 'eng_q6', category: 'management', text: 'Ù…Ù† Ø¨Ø±Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ú©Ø§Ø±Ù… Ø§Ø² Ø§Ø³ØªÙ‚Ù„Ø§Ù„ Ùˆ Ø§Ø®ØªÛŒØ§Ø± Ú©Ø§ÙÛŒ Ø¨Ø±Ø®ÙˆØ±Ø¯Ø§Ø±Ù….', type: 'rating_1_5' },
                    { id: 'eng_q7', category: 'management', text: 'Ù…Ø¯ÛŒØ± Ù…Ù† Ø¨Ù‡ Ù…Ù† Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ÛŒÚ© ÙØ±Ø¯ Ø§Ù‡Ù…ÛŒØª Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ùˆ Ø­Ø§Ù…ÛŒ Ù…Ù† Ø§Ø³Øª.', type: 'rating_1_5' },
                    { id: 'eng_q8', category: 'recognition', text: 'ÙˆÙ‚ØªÛŒ Ú©Ø§Ø±Ù… Ø±Ø§ Ø¨Ù‡ Ø®ÙˆØ¨ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ù…ØŒ Ø§Ø­Ø³Ø§Ø³ Ù…ÛŒâ€ŒÚ©Ù†Ù… Ø§Ø² Ù…Ù† Ù‚Ø¯Ø±Ø¯Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.', type: 'rating_1_5' },
                    { id: 'eng_q9', category: 'recognition', text: 'ÙØ±Ø¢ÛŒÙ†Ø¯Ù‡Ø§ÛŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ùˆ ØªØ±ÙÛŒØ¹ Ø¯Ø± Ø´Ø±Ú©Øª Ù…Ù†ØµÙØ§Ù†Ù‡ Ù‡Ø³ØªÙ†Ø¯.', type: 'rating_1_5' },
                    { id: 'eng_q10', category: 'culture', text: 'Ù…Ù† Ø§Ø­Ø³Ø§Ø³ ØªØ¹Ù„Ù‚ Ø¨Ù‡ ØªÛŒÙ… Ùˆ Ø³Ø§Ø²Ù…Ø§Ù† Ø®ÙˆØ¯ Ø¯Ø§Ø±Ù….', type: 'rating_1_5' },
                    { id: 'eng_q11', category: 'culture', text: 'Ø¯Ø± Ù…Ø­ÛŒØ· Ú©Ø§Ø±ØŒ Ù†Ø¸Ø±Ø§Øª Ùˆ Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù† Ø´Ù†ÛŒØ¯Ù‡ Ùˆ Ù…ÙˆØ±Ø¯ Ø§Ø­ØªØ±Ø§Ù… Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù†Ø¯.', type: 'rating_1_5' },
                    { id: 'eng_q12', category: 'wellbeing', text: 'Ø­Ø¬Ù… Ú©Ø§Ø±ÛŒ Ù…Ù† Ù‚Ø§Ø¨Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø³Øª Ùˆ Ø¨Ø§Ø¹Ø« ÙØ±Ø³ÙˆØ¯Ú¯ÛŒ Ø´ØºÙ„ÛŒâ€ŒØ§Ù… Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.', type: 'rating_1_5' },
                    { id: 'eng_q13', category: 'wellbeing', text: 'Ù…Ù† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… ØªØ¹Ø§Ø¯Ù„ Ù…Ù†Ø§Ø³Ø¨ÛŒ Ø¨ÛŒÙ† Ú©Ø§Ø± Ùˆ Ø²Ù†Ø¯Ú¯ÛŒ Ø´Ø®ØµÛŒâ€ŒØ§Ù… Ø¨Ø±Ù‚Ø±Ø§Ø± Ú©Ù†Ù….', type: 'rating_1_5' },
                    { id: 'eng_q14', category: 'overall', text: 'Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ Ù‡Ù…Ù‡ Ø¬ÙˆØ§Ù†Ø¨ØŒ Ø§ÛŒÙ† Ø´Ø±Ú©Øª Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ÛŒÚ© Ù…Ø­ÛŒØ· Ú©Ø§Ø±ÛŒ Ø¹Ø§Ù„ÛŒ Ø¨Ù‡ Ø¯ÛŒÚ¯Ø±Ø§Ù† ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒÚ©Ù†Ù… (eNPS).', type: 'rating_1_10' },
                    { id: 'eng_q15', category: 'overall', text: 'Ú†Ù‡ Ú†ÛŒØ²ÛŒ Ø±Ø§ Ø¯Ø± ÙØ±Ù‡Ù†Ú¯ Ø´Ø±Ú©Øª Ø¨ÛŒØ´ØªØ± Ø§Ø² Ù‡Ù…Ù‡ Ø¯ÙˆØ³Øª Ø¯Ø§Ø±ÛŒØ¯ØŸ', type: 'open_text' },
                    { id: 'eng_q16', category: 'overall', text: 'Ø§Ú¯Ø± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø³ØªÛŒØ¯ ÛŒÚ© Ú†ÛŒØ² Ø±Ø§ Ø¯Ø± Ø´Ø±Ú©Øª ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ØŒ Ø¢Ù† Ú†Ù‡ Ø¨ÙˆØ¯ØŸ', type: 'open_text' },
                ]
            },
            'pulse': { id: 'pulse', title: 'Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ Ù¾Ø§Ù„Ø³ Ù‡ÙØªÚ¯ÛŒ', description: 'ÛŒÚ© Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ Ø³Ø±ÛŒØ¹ Ø¨Ø±Ø§ÛŒ Ø³Ù†Ø¬Ø´ Ù†Ø¨Ø¶ Ø³Ø§Ø²Ù…Ø§Ù† Ùˆ Ø­Ø§Ù„ Ùˆ Ù‡ÙˆØ§ÛŒ Ú©Ø§Ø±Ú©Ù†Ø§Ù† Ø¯Ø± Ù‡ÙØªÙ‡ Ú¯Ø°Ø´ØªÙ‡.', questions: [ { id: 'pls_q1', text: 'Ø¯Ø± Ù…Ù‚ÛŒØ§Ø³ Û± ØªØ§ ÛµØŒ Ø§Ø² Ù‡ÙØªÙ‡ Ú©Ø§Ø±ÛŒ Ø®ÙˆØ¯ Ú†Ù‚Ø¯Ø± Ø±Ø¶Ø§ÛŒØª Ø¯Ø§Ø´ØªÛŒØ¯ØŸ', type: 'rating_1_5' }, { id: 'pls_q2', text: 'Ø­Ø¬Ù… Ú©Ø§Ø±ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ø§ÛŒÙ† Ù‡ÙØªÙ‡ Ú†Ú¯ÙˆÙ†Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŸ', type: 'choice', options: ['Ø¨Ø³ÛŒØ§Ø± Ú©Ù…', 'Ú©Ù…', 'Ù…Ù†Ø§Ø³Ø¨', 'Ø²ÛŒØ§Ø¯', 'Ø¨Ø³ÛŒØ§Ø± Ø²ÛŒØ§Ø¯'] }, { id: 'pls_q3', text: 'Ø¢ÛŒØ§ Ø¯Ø± Ù‡ÙØªÙ‡ Ú¯Ø°Ø´ØªÙ‡ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ Ù…ÙÛŒØ¯ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯ÛŒØ¯ Ú©Ù‡ Ø¨Ù‡ Ø´Ù…Ø§ Ø¯Ø± Ú©Ø§Ø±ØªØ§Ù† Ú©Ù…Ú© Ú©Ù†Ø¯ØŸ', type: 'yes_no' }, { id: 'pls_q4', text: 'Ø¨Ø²Ø±Ú¯ØªØ±ÛŒÙ† Ù…Ø§Ù†Ø¹ ÛŒØ§ Ú†Ø§Ù„Ø´ÛŒ Ú©Ù‡ Ø§ÛŒÙ† Ù‡ÙØªÙ‡ Ø¨Ø§ Ø¢Ù† Ø±ÙˆØ¨Ø±Ùˆ Ø¨ÙˆØ¯ÛŒØ¯ Ú†Ù‡ Ø¨ÙˆØ¯ØŸ', type: 'open_text' }, { id: 'pls_q5', text: 'ÛŒÚ© Ø§ØªÙØ§Ù‚ Ù…Ø«Ø¨Øª ÛŒØ§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø² Ø§ÛŒÙ† Ù‡ÙØªÙ‡ Ø±Ø§ Ù†Ø§Ù… Ø¨Ø¨Ø±ÛŒØ¯.', type: 'open_text' }, ] },
            'onboarding': { id: 'onboarding', title: 'Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ ØªØ¬Ø±Ø¨Ù‡ Ø¬Ø°Ø¨ Ùˆ Ø¢Ù†Ø¨ÙˆØ±Ø¯ÛŒÙ†Ú¯', description: 'Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ Ø§Ø² Ù†ÛŒØ±ÙˆÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯ ÙØ±Ø¢ÛŒÙ†Ø¯ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³Ø§Ø²Ù…Ø§Ù†.', questions: [ { id: 'onb_q1', text: 'ÙØ±Ø¢ÛŒÙ†Ø¯ Ù…ØµØ§Ø­Ø¨Ù‡ Ùˆ Ø¬Ø°Ø¨ Ú†Ù‚Ø¯Ø± Ø´ÙØ§ÙØŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ùˆ Ù…Ø­ØªØ±Ù…Ø§Ù†Ù‡ Ø¨ÙˆØ¯ØŸ', type: 'rating_1_5' }, { id: 'onb_q2', text: 'Ø¢ÛŒØ§ Ø´Ø±Ø­ Ø´ØºÙ„ÛŒ Ú©Ù‡ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ø±Ø¯ÛŒØ¯ØŒ Ø¨Ø§ ÙˆØ¸Ø§ÛŒÙ ÙˆØ§Ù‚Ø¹ÛŒ Ø´Ù…Ø§ Ù…Ø·Ø§Ø¨Ù‚Øª Ø¯Ø§Ø±Ø¯ØŸ', type: 'yes_no_somewhat' }, { id: 'onb_q3', text: 'Ø¢ÛŒØ§ Ù‚Ø¨Ù„ Ø§Ø² Ø±ÙˆØ² Ø§ÙˆÙ„ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§ÙÛŒ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ú©Ø§Ø±ØªØ§Ù† Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯ÛŒØ¯ØŸ', type: 'yes_no' }, { id: 'onb_q4', text: 'Ø¯Ø± Ù‡ÙØªÙ‡ Ø§ÙˆÙ„ Ú©Ø§Ø±ÛŒØŒ ØªÙ…Ø§Ù… Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ØŒ Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø±Ù‡Ø§ Ùˆ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ù„Ø§Ø²Ù… Ø±Ø§ Ø¯Ø± Ø§Ø®ØªÛŒØ§Ø± Ø¯Ø§Ø´ØªÛŒØ¯ØŸ', type: 'yes_no' }, { id: 'onb_q5', text: 'Ù…Ø¹Ø±ÙÛŒ Ø´Ù…Ø§ Ø¨Ù‡ ØªÛŒÙ… Ùˆ Ù‡Ù…Ú©Ø§Ø±Ø§Ù† Ú†Ú¯ÙˆÙ†Ù‡ Ø¨ÙˆØ¯ Ùˆ Ú†Ù‚Ø¯Ø± Ø§Ø­Ø³Ø§Ø³ Ø±Ø§Ø­ØªÛŒ Ú©Ø±Ø¯ÛŒØ¯ØŸ', type: 'rating_1_5' }, { id: 'onb_q6', text: 'Ø¢ÛŒØ§ Ø´Ø±Ø­ ÙˆØ¸Ø§ÛŒÙ Ùˆ Ø§Ù†ØªØ¸Ø§Ø±Ø§Øª Ø§Ø² Ø´Ù…Ø§ Ø¯Ø± Ù…Ø§Ù‡ Ø§ÙˆÙ„ Ú©Ø§Ø±ÛŒ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø±ÙˆØ´Ù† Ùˆ Ø´ÙØ§Ù Ø¨ÙˆØ¯ØŸ', type: 'rating_1_5' }, { id: 'onb_q7', text: 'Ø¢ÛŒØ§ Ù…Ø¯ÛŒØ±ØªØ§Ù† Ø¯Ø± Ù‡ÙØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø§ÙˆÙ„ Ø¨Ù‡ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ ÙˆÙ‚Øª Ú¯Ø°Ø§Ø´ØªØŸ', type: 'yes_no' }, { id: 'onb_q8', text: 'Ú†Ù‡ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯ ØªØ¬Ø±Ø¨Ù‡ Ø¢Ù†Ø¨ÙˆØ±Ø¯ÛŒÙ†Ú¯ Ù†ÛŒØ±ÙˆÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¯Ø§Ø±ÛŒØ¯ØŸ', type: 'open_text' }, ] },
            'feedback_360': { id: 'feedback_360', title: 'Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ Û³Û¶Û° Ø¯Ø±Ø¬Ù‡', description: 'Ø§Ø±Ø§Ø¦Ù‡ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ Ø³Ø§Ø²Ù†Ø¯Ù‡ Ø¨Ù‡ Ù‡Ù…Ú©Ø§Ø±Ø§Ù† Ø¨Ø±Ø§ÛŒ Ú©Ù…Ú© Ø¨Ù‡ Ø±Ø´Ø¯ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¢Ù†â€ŒÙ‡Ø§.', requiresTarget: true, questions: [ { id: '360_q1', text: 'Ø§ÛŒÙ† Ù‡Ù…Ú©Ø§Ø± Ú†Ù‚Ø¯Ø± Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª Ø®ÙˆØ¯ (Ú¯ÙØªØ§Ø±ÛŒ Ùˆ Ù†ÙˆØ´ØªØ§Ø±ÛŒ) Ø´ÙØ§ÙØŒ Ù…Ø­ØªØ±Ù…Ø§Ù†Ù‡ Ùˆ Ù…ÙˆØ«Ø± Ø§Ø³ØªØŸ', type: 'rating_1_5' }, { id: '360_q2', text: 'Ø§ÛŒÙ† Ù‡Ù…Ú©Ø§Ø± ØªØ§ Ú†Ù‡ Ø­Ø¯ Ø¯Ø± Ú©Ø§Ø± ØªÛŒÙ…ÛŒ Ù…Ø´Ø§Ø±Ú©Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŒ Ø¨Ù‡ Ø¯ÛŒÚ¯Ø±Ø§Ù† Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ø¯Ø§Ù†Ø´ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ Ø§Ø´ØªØ±Ø§Ú© Ù…ÛŒâ€ŒÚ¯Ø°Ø§Ø±Ø¯ØŸ', type: 'rating_1_5' }, { id: '360_q3', text: 'Ø§ÛŒÙ† Ù‡Ù…Ú©Ø§Ø± Ø¯Ø± Ø­Ù„ Ù…Ø³Ø§Ø¦Ù„ Ùˆ Ø±ÙˆÛŒØ§Ø±ÙˆÛŒÛŒ Ø¨Ø§ Ú†Ø§Ù„Ø´â€ŒÙ‡Ø§ Ú†Ù‚Ø¯Ø± Ø®Ù„Ø§Ù‚ØŒ Ú©Ø§Ø±Ø¢Ù…Ø¯ Ùˆ Ù…Ø³Ø¦ÙˆÙ„ÛŒØªâ€ŒÙ¾Ø°ÛŒØ± Ø§Ø³ØªØŸ', type: 'rating_1_5' }, { id: '360_q4', text: 'Ø§ÛŒÙ† Ù‡Ù…Ú©Ø§Ø± ØªØ§ Ú†Ù‡ Ø­Ø¯ Ø¨Ù‡ Ø§Ù‡Ø¯Ø§Ù Ùˆ Ù†ØªØ§ÛŒØ¬ Ù…ØªØ¹Ù‡Ø¯ Ø§Ø³Øª Ùˆ Ú©Ø§Ø±Ù‡Ø§ Ø±Ø§ Ø¨Ø§ Ú©ÛŒÙÛŒØª Ø¨Ø§Ù„Ø§ Ø¨Ù‡ Ø§ØªÙ…Ø§Ù… Ù…ÛŒâ€ŒØ±Ø³Ø§Ù†Ø¯ØŸ', type: 'rating_1_5' }, { id: '360_q5', text: 'Ø¨Ø²Ø±Ú¯ØªØ±ÛŒÙ† Ù†Ù‚Ø·Ù‡ Ù‚ÙˆØª Ø§ÛŒÙ† Ù‡Ù…Ú©Ø§Ø± Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ø¢Ù† Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ù‡Ø¯ Ú†ÛŒØ³ØªØŸ', type: 'open_text' }, { id: '360_q6', text: 'Ú†Ù‡ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…Ø´Ø®ØµÛŒ Ø¨Ø±Ø§ÛŒ Ø±Ø´Ø¯ Ùˆ Ù¾ÛŒØ´Ø±ÙØª Ø§ÛŒÙ† Ù‡Ù…Ú©Ø§Ø± Ø¯Ø§Ø±ÛŒØ¯ØŸ (Ú†Ù‡ Ú©Ø§Ø±ÛŒ Ø±Ø§ Ø¨Ø§ÛŒØ¯ Ø´Ø±ÙˆØ¹ Ú©Ù†Ø¯ØŒ Ù…ØªÙˆÙ‚Ù Ú©Ù†Ø¯ ÛŒØ§ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ù‡Ø¯ØŸ)', type: 'open_text' }, ] },
            'exit': { id: 'exit', title: 'Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ Ø®Ø±ÙˆØ¬ Ø§Ø² Ø³Ø§Ø²Ù…Ø§Ù†', description: 'Ø¯Ø±Ú© Ø¯Ù„Ø§ÛŒÙ„ ØªØ±Ú© Ø³Ø§Ø²Ù…Ø§Ù† Ø¨Ø±Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯ Ù…Ø­ÛŒØ· Ú©Ø§Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† Ø¢ÛŒÙ†Ø¯Ù‡.', questions: [ { id: 'ext_q1', text: 'Ù„Ø·ÙØ§Ù‹ Ø¯Ù„ÛŒÙ„ ÛŒØ§ Ø¯Ù„Ø§ÛŒÙ„ Ø§ØµÙ„ÛŒ Ø®ÙˆØ¯ Ø¨Ø±Ø§ÛŒ ØªØ±Ú© Ø³Ø§Ø²Ù…Ø§Ù† Ø±Ø§ Ø¨ÛŒØ§Ù† Ú©Ù†ÛŒØ¯.', type: 'open_text' }, { id: 'ext_q2', text: 'Ø§Ø² ØªØ¬Ø±Ø¨Ù‡ Ú©Ø§Ø±ÛŒ Ø®ÙˆØ¯ Ø¯Ø± Ø§ÛŒÙ† Ø´Ø±Ú©Øª Ø¨Ù‡ Ø·ÙˆØ± Ú©Ù„ÛŒ Ú†Ù‚Ø¯Ø± Ø±Ø¶Ø§ÛŒØª Ø¯Ø§Ø´ØªÛŒØ¯ØŸ', type: 'rating_1_5' }, { id: 'ext_q3', text: 'Ø¢ÛŒØ§ Ø§Ø­Ø³Ø§Ø³ Ù…ÛŒâ€ŒÚ©Ø±Ø¯ÛŒØ¯ Ø´ØºÙ„ Ø´Ù…Ø§ Ø§Ø² Ù…Ù‡Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒØªØ§Ù† Ø¨Ù‡ Ø®ÙˆØ¨ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŸ', type: 'rating_1_5' }, { id: 'ext_q4', text: 'Ø±Ø§Ø¨Ø·Ù‡ Ùˆ Ú©ÛŒÙÛŒØª Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø¯ÛŒØ± Ù…Ø³ØªÙ‚ÛŒÙ… Ø®ÙˆØ¯ Ø±Ø§ Ú†Ú¯ÙˆÙ†Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŸ', type: 'rating_1_5' }, { id: 'ext_q5', text: 'Ø¢ÛŒØ§ ÙØ±ØµØªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø±Ø´Ø¯ Ùˆ Ù¾ÛŒØ´Ø±ÙØª Ø´ØºÙ„ÛŒ Ø¯Ø± Ø§Ø®ØªÛŒØ§Ø± Ø´Ù…Ø§ Ù‚Ø±Ø§Ø± Ú¯Ø±ÙØªØŸ', type: 'rating_1_5' }, { id: 'ext_q6', text: 'ÙØ±Ù‡Ù†Ú¯ Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ Ø´Ø±Ú©Øª Ø±Ø§ Ú†Ú¯ÙˆÙ†Ù‡ ØªÙˆØµÛŒÙ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŸ', type: 'open_text' }, { id: 'ext_q7', text: 'Ø¢ÛŒØ§ Ø¨Ø³ØªÙ‡ Ø­Ù‚ÙˆÙ‚ Ùˆ Ù…Ø²Ø§ÛŒØ§ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ù…Ù†ØµÙØ§Ù†Ù‡ Ùˆ Ø±Ù‚Ø§Ø¨ØªÛŒ Ù…ÛŒâ€ŒØ¯Ø§Ù†Ø³ØªÛŒØ¯ØŸ', type: 'yes_no' }, { id: 'ext_q8', text: 'Ø¢ÛŒØ§ Ø§ÛŒÙ† Ø´Ø±Ú©Øª Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ÛŒÚ© Ù…Ø­ÛŒØ· Ú©Ø§Ø±ÛŒ Ø¨Ù‡ Ø¯ÛŒÚ¯Ø±Ø§Ù† ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŸ', type: 'yes_no' }, { id: 'ext_q9', text: 'Ø§Ú¯Ø± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø³ØªÛŒØ¯ ÛŒÚ© Ú†ÛŒØ² Ø±Ø§ Ø¯Ø± Ø´Ø±Ú©Øª ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ØŒ Ø¢Ù† Ú†Ù‡ Ø¨ÙˆØ¯ØŸ', type: 'open_text' }, ] }
        };

        const state = { employees: [], teams: [], reminders: [], surveyResponses: [], users: [], competencies: [], expenses: [], pettyCashCards: [], chargeHistory: [], dashboardMetrics: {}, orgAnalytics: {}, currentPage: 'dashboard', currentPageTalent: 1, currentUser: null, };
        let charts = {};
        // Ø§ÛŒÙ† Ú©Ø¯ Ø±Ø§ Ù†Ø²Ø¯ÛŒÚ© Ø¨Ù‡ ØªØ¹Ø±ÛŒÙ state Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯
// Ù¾Ø§Ù„Øª Ø±Ù†Ú¯ÛŒ Ù‚Ø¨Ù„ÛŒ Ø±Ø§ Ø¨Ø§ Ø§ÛŒÙ† Ù¾Ø§Ù„Øª Ø¬Ø¯ÛŒØ¯ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯
// Ø§ÛŒÙ† Ù¾Ø§Ù„Øª Ø±Ù†Ú¯ÛŒ Ø±Ø§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù¾Ø§Ù„Øª Ù‚Ø¨Ù„ÛŒ Ú©Ù†ÛŒØ¯
const teamColorPalette = [
    'border-sky-500',
    'border-green-500',
    'border-violet-500',
    'border-amber-500',
    'border-pink-500',
    'border-teal-500'
];
        const surveyVisualsPalette = [
    { icon: 'clipboard-list', color: 'text-sky-500', bg: 'bg-sky-100' },
    { icon: 'zap', color: 'text-amber-500', bg: 'bg-amber-100' },
    { icon: 'rocket', color: 'text-rose-500', bg: 'bg-rose-100' },
    { icon: 'users', color: 'text-green-500', bg: 'bg-green-100' },
    { icon: 'log-out', color: 'text-slate-500', bg: 'bg-slate-100' }
];
        // Ø§ÛŒÙ† Ù¾Ø§Ù„Øª Ø±Ù†Ú¯ÛŒ Ø±Ø§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù¾Ø§Ù„Øª Ù‚Ø¨Ù„ÛŒ Ú©Ù†ÛŒØ¯
const teamVisualsPalette = [
    { icon: 'users', color: 'text-sky-500', bg: 'bg-sky-100' },
    { icon: 'briefcase', color: 'text-amber-500', bg: 'bg-amber-100' },
    { icon: 'megaphone', color: 'text-rose-500', bg: 'bg-rose-100' },
    { icon: 'bar-chart-3', color: 'text-green-500', bg: 'bg-green-100' },
    { icon: 'pen-tool', color: 'text-indigo-500', bg: 'bg-indigo-100' },
    { icon: 'settings-2', color: 'text-slate-500', bg: 'bg-slate-100' }
];
        const appId = 'hr-nik-prod';
        const firebaseConfig = { apiKey: "AIzaSyCCfPmxQy1uAKu0lPGSe3bc-P15iLYLHJo", authDomain: "nik-hr.firebaseapp.com", projectId: "nik-hr", storageBucket: "nik-hr.firebasestorage.app", messagingSenderId: "731265316127", appId: "1:731265316127:web:6fda02cb2c7d4adfc92c2a" };
        let app, auth, db, storage;
        
        const showLoginPage = () => {
            document.getElementById('login-container').classList.remove('hidden');
            document.getElementById('signup-container').classList.add('hidden');
            document.getElementById('dashboard-container').classList.add('hidden');
            document.getElementById('loading-overlay').style.display = 'none';
        };
        const showSignupPage = () => {
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('signup-container').classList.remove('hidden');
            document.getElementById('dashboard-container').classList.add('hidden');
        };
        const showDashboard = () => {
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('signup-container').classList.add('hidden');
            document.getElementById('dashboard-container').classList.remove('hidden');
            document.getElementById('dashboard-container').classList.add('flex');
        };

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        await fetchUserRole(user);
                        listenToData();
                    } else {
                        state.currentUser = null;
                        showLoginPage();
                    }
                });
            } catch (error) { console.error("Firebase Init Error:", error); }
        }

        async function fetchUserRole(user) {
            const userRef = doc(db, `artifacts/${appId}/public/data/users`, user.uid);
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) {
                state.currentUser = { uid: user.uid, email: user.email, ...userSnap.data() };
            } else {
                const usersCol = collection(db, `artifacts/${appId}/public/data/users`);
                const usersSnapshot = await getDocs(usersCol);
                const isFirstUser = usersSnapshot.empty;
                const newUserRole = isFirstUser ? 'admin' : 'viewer';
                const newUser = { email: user.email, role: newUserRole, createdAt: serverTimestamp() };
                await setDoc(userRef, newUser);
                state.currentUser = { uid: user.uid, ...newUser };
            }
        }

        function listenToData() {
            const collectionsToListen = ['employees', 'teams', 'reminders', 'surveyResponses', 'users', 'competencies', 'expenses', 'pettyCashCards', 'chargeHistory'];
            let initialLoads = collectionsToListen.length;
            const onDataLoaded = () => {
                initialLoads--;
                if (initialLoads === 0) {
                    calculateAndApplyAnalytics();
                    showDashboard();
                    router(); 
                    document.getElementById('loading-overlay').style.display = 'none';
                }
            };
            collectionsToListen.forEach(colName => {
                const colRef = collection(db, `artifacts/${appId}/public/data/${colName}`);
                onSnapshot(colRef, (snapshot) => {
                    state[colName] = snapshot.docs.map(doc => ({ firestoreId: doc.id, ...doc.data() }));
                    if (initialLoads > 0) {
                        onDataLoaded();
                    } else {
                        calculateAndApplyAnalytics();
                        if (!window.location.hash.startsWith('#survey-taker')) {
                            renderPage(state.currentPage);
                        }
                    }
                }, (error) => {
                    console.error(`Error listening to ${colName}:`, error);
                    if (['competencies', 'expenses', 'pettyCashCards', 'chargeHistory'].includes(colName)) {
                        state[colName] = [];
                        if (initialLoads > 0) onDataLoaded();
                    }
                });
            });
        }
        // --- UTILITY & HELPER FUNCTIONS ---
        // --- ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø¨Ù‡ Ø´Ù…Ø³ÛŒ ---
        // --- ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ø§Ø¹Ø¯Ø§Ø¯ ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ ---
    const convertPersianNumbersToEnglish = (str) => {
        if (!str) return '';
        return str.toString()
            .replace(/Û±/g, '1')
            .replace(/Û²/g, '2')
            .replace(/Û³/g, '3')
            .replace(/Û´/g, '4')
            .replace(/Ûµ/g, '5')
            .replace(/Û¶/g, '6')
            .replace(/Û·/g, '7')
            .replace(/Û¸/g, '8')
            .replace(/Û¹/g, '9')
            .replace(/Û°/g, '0');
    };
const toPersianDate = (dateInput) => {
    if (!dateInput) return 'Ù†Ø§Ù…Ø´Ø®Øµ';
    try {
        let date;
        if (dateInput.toDate) { // Handle Firebase Timestamps
            date = dateInput.toDate();
        } else {
            date = new Date(dateInput);
        }

        // Check if the date is valid
        if (isNaN(date.getTime())) {
            return 'ØªØ§Ø±ÛŒØ® Ù†Ø§Ù…Ø¹ØªØ¨Ø±';
        }

        const gYear = date.getFullYear();
        const gMonth = date.getMonth() + 1; // JS month is 0-indexed
        const gDay = date.getDate();

        const jalaaliDate = jalaali.toJalaali(gYear, gMonth, gDay);

        // Add leading zero to month and day if needed
        const jm = String(jalaaliDate.jm).padStart(2, '0');
        const jd = String(jalaaliDate.jd).padStart(2, '0');

        return `${jalaaliDate.jy}/${jm}/${jd}`;
    } catch (error) {
        console.error("Error converting date:", dateInput, error);
        return 'Ù†Ø§Ù…Ø´Ø®Øµ';
    }
};
// --- ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ ÙˆØ±ÙˆØ¯ÛŒ Ø¨Ù‡ ÙØ±Ù…Øª Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ ---
// --- Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ø¨Ø³ÛŒØ§Ø± Ù‚ÙˆÛŒâ€ŒØªØ± Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ ---
const persianToEnglishDate = (persianDateStr) => {
    // Ø§Ú¯Ø± ÙˆØ±ÙˆØ¯ÛŒ Ø®Ø§Ù„ÛŒ ÛŒØ§ null Ø§Ø³ØªØŒ null Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†
    if (!persianDateStr) return null;

    // Ú¯Ø§Ù‡ÛŒ Ø§ÙˆÙ‚Ø§Øª Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ ØªÙ‚ÙˆÛŒÙ… Ù…Ù…Ú©Ù† Ø§Ø³Øª ÛŒÚ© timestamp Ø¹Ø¯Ø¯ÛŒ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯
    // Ø§Ú¯Ø± ÙˆØ±ÙˆØ¯ÛŒ ÛŒÚ© Ø¹Ø¯Ø¯ Ø§Ø³ØªØŒ Ø¢Ù† Ø±Ø§ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø¨Ù‡ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ú©Ù†
    if (!isNaN(persianDateStr) && typeof persianDateStr !== 'string') {
        const date = new persianDate(parseInt(persianDateStr));
        const formatted = date.format('YYYY-MM-DD');
        console.log(`ÙˆØ±ÙˆØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯ØŒ ØªØ¨Ø¯ÛŒÙ„ Ø´Ø¯Ù‡ Ø¨Ù‡: ${formatted}`);
        return formatted;
    }
    
    // Ø§Ø¹Ø¯Ø§Ø¯ ÙØ§Ø±Ø³ÛŒ Ø±Ø§ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ú©Ù†
    let englishDateStr = convertPersianNumbersToEnglish(persianDateStr);

    // Ú†Ú© Ú©Ù† Ú©Ù‡ ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® YYYY/MM/DD Ø¨Ø§Ø´Ø¯
    if (!/^\d{4}\/\d{2}\/\d{2}$/.test(englishDateStr)) {
        console.error("ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. ÙØ±Ù…Øª Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø± YYYY/MM/DD Ø§Ø³Øª Ø§Ù…Ø§ ÙˆØ±ÙˆØ¯ÛŒ:", englishDateStr);
        // Ø§Ú¯Ø± ÙØ±Ù…Øª Ø§Ø´ØªØ¨Ø§Ù‡ Ø¨ÙˆØ¯ØŒ null Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù† ØªØ§ Ø¯ÛŒØªØ§ÛŒ Ø§Ø´ØªØ¨Ø§Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´ÙˆØ¯
        return null;
    }

    try {
        const [jy, jm, jd] = englishDateStr.split('/').map(Number);
        // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯Ù† Ø§Ø¹Ø¯Ø§Ø¯ Ø³Ø§Ù„ØŒ Ù…Ø§Ù‡ Ùˆ Ø±ÙˆØ²
        if (jy < 1000 || jm < 1 || jm > 12 || jd < 1 || jd > 31) {
             console.error("Ø§Ø¹Ø¯Ø§Ø¯ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª:", { jy, jm, jd });
             return null;
        }
        const gregorian = jalaali.toGregorian(jy, jm, jd);
        // Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø±Ø§ Ø¨Ø§ ÙØ±Ù…Øª YYYY-MM-DD Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†
        return `${gregorian.gy}-${String(gregorian.gm).padStart(2, '0')}-${String(gregorian.gd).padStart(2, '0')}`;
    } catch (error) {
        console.error("Ø®Ø·Ø§ Ø¯Ø± ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ:", error);
        return null;
    }
};
// --- Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø§ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Lazy Initialization (Ø³Ø§Ø®Øª ØªÙ‚ÙˆÛŒÙ… ÙÙ‚Ø· Ø¯Ø± Ø²Ù…Ø§Ù† Ú©Ù„ÛŒÚ©) ---
const activatePersianDatePicker = (elementId, initialValue = null) => {
    const input = $(`#${elementId}`);
    if (!input.length) return;

    // Û±. Ù‡Ø± Ù†Ù…ÙˆÙ†Ù‡â€ŒÛŒ Ù‚Ø¨Ù„ÛŒ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Û±Û°Û°Ùª Ù¾Ø§Ú© Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    try {
        if (input.data('datepicker')) {
            input.persianDatepicker('destroy');
        }
    } catch (e) { /* Ignore */ }
    // Ù‡Ø± event listener Ú©Ù„ÛŒÚ© Ù‚Ø¨Ù„ÛŒ Ø±Ø§ Ù‡Ù… Ø­Ø°Ù Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    input.off('click');

    // Û². ÙÛŒÙ„Ø¯ Ø±Ø§ ÙÙ‚Ø· Ø®ÙˆØ§Ù†Ø¯Ù†ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ù…Ù‚Ø¯Ø§Ø± ØµØ­ÛŒØ­ Ø±Ø§ Ù…Ø«Ù„ ÛŒÚ© Ù…ØªÙ† Ø³Ø§Ø¯Ù‡ Ø¯Ø± Ø¢Ù† Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
    input.attr('readonly', true).css('background-color', '#fff').val('');
    if (initialValue) {
        const persianDateString = toPersianDate(initialValue);
        if (persianDateString && persianDateString !== 'Ù†Ø§Ù…Ø´Ø®Øµ' && persianDateString !== 'ØªØ§Ø±ÛŒØ® Ù†Ø§Ù…Ø¹ØªØ¨Ø±') {
            input.val(persianDateString);
        }
    }
    
    // Û³. *** ØªØºÛŒÛŒØ± Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ø­ÛŒØ§ØªÛŒ: ØªÙ‚ÙˆÛŒÙ… Ø±Ø§ Ø§Ù„Ø§Ù† Ù†Ù…ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ…! ***
    // Ø¨Ù‡ Ø¬Ø§ÛŒ Ø¢Ù†ØŒ Ù…Ù†ØªØ¸Ø± Ù…ÛŒâ€ŒÙ…Ø§Ù†ÛŒÙ… ØªØ§ Ú©Ø§Ø±Ø¨Ø± Ø±ÙˆÛŒ ÙÛŒÙ„Ø¯ Ú©Ù„ÛŒÚ© Ú©Ù†Ø¯.
    // Ø§Ø² .one() Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ø§ÛŒÙ† Ú©Ø¯ ÙÙ‚Ø· "ÛŒÚ© Ø¨Ø§Ø±" Ø¨Ø±Ø§ÛŒ Ù‡Ø± ÙÛŒÙ„Ø¯ Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯.
    input.one('click', function() {
        // Ø¯Ø± Ù„Ø­Ø¸Ù‡ Ú©Ù„ÛŒÚ©ØŒ ØªÙ‚ÙˆÛŒÙ… Ø³Ø§Ø®ØªÙ‡ Ùˆ Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡ Ø¨Ø§Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯
        $(this).persianDatepicker({
            format: 'YYYY/MM/DD',
            autoClose: true,
            observer: false,
            // Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ø±Ø§ Ø§Ø² Ø®ÙˆØ¯ ÙÛŒÙ„Ø¯ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù†Ø¯ Ú©Ù‡ Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø±Ø³Øª ØªÙ†Ø¸ÛŒÙ… Ú©Ø±Ø¯ÛŒÙ…
        }).pdp.show(); 
    });
};
        // --- ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ ---
    const renderPagination = (containerId, currentPage, totalItems, itemsPerPage) => {
        const container = document.getElementById(containerId);
        if (!container) return;

        const totalPages = Math.ceil(totalItems / itemsPerPage);
        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        let paginationHtml = '<div class="flex items-center justify-center space-x-1 space-x-reverse">';
        
        // Ø¯Ú©Ù…Ù‡ Ù‚Ø¨Ù„ÛŒ
        paginationHtml += `<button data-page="${currentPage - 1}" class="pagination-btn px-4 py-2 text-gray-500 bg-white rounded-md hover:bg-blue-500 hover:text-white" ${currentPage === 1 ? 'disabled' : ''}>Ù‚Ø¨Ù„ÛŒ</button>`;
        
        // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§Ø±Ù‡ ØµÙØ­Ù‡
        for (let i = 1; i <= totalPages; i++) {
            const isActive = i === currentPage ? 'bg-blue-600 text-white' : 'bg-white text-gray-700';
            paginationHtml += `<button data-page="${i}" class="pagination-btn px-4 py-2 rounded-md hover:bg-blue-500 hover:text-white ${isActive}">${i}</button>`;
        }

        // Ø¯Ú©Ù…Ù‡ Ø¨Ø¹Ø¯ÛŒ
        paginationHtml += `<button data-page="${currentPage + 1}" class="pagination-btn px-4 py-2 text-gray-500 bg-white rounded-md hover:bg-blue-500 hover:text-white" ${currentPage === totalPages ? 'disabled' : ''}>Ø¨Ø¹Ø¯ÛŒ</button>`;

        paginationHtml += '</div>';
        container.innerHTML = paginationHtml;
    };
        // --- ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ Ùˆ Ø§Ø¹Ù…Ø§Ù„ Ù†ØªØ§ÛŒØ¬ ---
const calculateAndApplyAnalytics = () => {
        if (!state.surveyResponses) return;
        console.log("Running survey and risk analytics...");
        
        // --- ØªØ­Ù„ÛŒÙ„ Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ Ù…Ø´Ø§Ø±Ú©Øª Ú©Ø§Ø±Ú©Ù†Ø§Ù† ---
        const engagementResponses = state.surveyResponses.filter(r => r.surveyId === 'engagement');
        const employeeScores = {};
        
        engagementResponses.forEach(res => {
            if (res.employeeId && res.employeeId !== 'anonymous') {
                if (!employeeScores[res.employeeId]) {
                    employeeScores[res.employeeId] = { totalScore: 0, questionCount: 0 };
                }
                Object.values(res.answers).forEach(ans => {
                    const score = parseInt(ans);
                    if (!isNaN(score)) {
                        employeeScores[res.employeeId].totalScore += score;
                        employeeScores[res.employeeId].questionCount++;
                    }
                });
            }
        });

        state.employees.forEach(emp => {
            if (employeeScores[emp.id]) {
                const data = employeeScores[emp.id];
                emp.engagementScore = Math.round(((data.totalScore / data.questionCount) / 5) * 100);
            } else {
                emp.engagementScore = null;
            }
        });

        state.teams.forEach(team => {
            let teamTotalScore = 0;
            let teamQuestionCount = 0;
            team.memberIds?.forEach(memberId => {
                const memberData = employeeScores[memberId];
                if (memberData) {
                    teamTotalScore += memberData.totalScore;
                    teamQuestionCount += memberData.questionCount;
                }
            });
            team.engagementScore = teamQuestionCount > 0 ? Math.round(((teamTotalScore / teamQuestionCount) / 5) * 100) : null;
        });

        // --- Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯: ØªØ­Ù„ÛŒÙ„ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ù„ Ø³Ø§Ø²Ù…Ø§Ù† ---
        const orgEngagementByCategory = {};
        const engagementTemplate = surveyTemplates['engagement'];
        engagementResponses.forEach(res => {
            engagementTemplate.questions.forEach(q => {
                if (q.type.startsWith('rating_') && res.answers[q.id]) {
                    const score = parseInt(res.answers[q.id]);
                    if (!isNaN(score)) {
                        if (!orgEngagementByCategory[q.category]) {
                            orgEngagementByCategory[q.category] = { totalScore: 0, count: 0, maxScore: q.type === 'rating_1_10' ? 10 : 5 };
                        }
                        orgEngagementByCategory[q.category].totalScore += score;
                        orgEngagementByCategory[q.category].count++;
                    }
                }
            });
        });
        state.orgAnalytics = {
            engagementBreakdown: Object.entries(orgEngagementByCategory).map(([category, data]) => ({
                name: engagementTemplate.categories[category] || category,
                score: data.count > 0 ? Math.round(((data.totalScore / data.count) / data.maxScore) * 100) : 0
            }))
        };

        state.employees.forEach(emp => {
            emp.attritionRisk = calculateAttritionRisk(emp, state.teams);
            emp.nineBox = determineNineBoxCategory(emp);
        });

        console.log("Analytics applied to state.");
    };
        // --- ØªØ§Ø¨Ø¹ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒØ³Ú© Ø®Ø±ÙˆØ¬ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø¯Ù„ Ø§Ù…ØªÛŒØ§Ø²Ø¨Ù†Ø¯ÛŒ ---
    const calculateAttritionRisk = (employee, allTeams) => {
        let riskScore = 0;
        const reasons = [];

        // Ù…Ø¹ÛŒØ§Ø± Û±: Ø§Ù…ØªÛŒØ§Ø² Ù…Ø´Ø§Ø±Ú©Øª (ØªØ§ Û´Û° Ø§Ù…ØªÛŒØ§Ø²)
        if (employee.engagementScore != null) {
            if (employee.engagementScore < 50) {
                riskScore += 40;
                reasons.push('Ù…Ø´Ø§Ø±Ú©Øª Ø¨Ø³ÛŒØ§Ø± Ù¾Ø§ÛŒÛŒÙ†');
            } else if (employee.engagementScore < 70) {
                riskScore += 20;
                reasons.push('Ù…Ø´Ø§Ø±Ú©Øª Ù¾Ø§ÛŒÛŒÙ†');
            }
        } else {
            riskScore += 10; // Ø§Ù…ØªÙŠØ§Ø² Ù…Ù†ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ø±Ú©Øª Ù†Ú©Ø±Ø¯Ù† Ø¯Ø± Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ
            reasons.push('Ø¹Ø¯Ù… Ù…Ø´Ø§Ø±Ú©Øª Ø¯Ø± Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ');
        }

        // Ù…Ø¹ÛŒØ§Ø± Û²: Ø±ÙˆÙ†Ø¯ Ø¹Ù…Ù„Ú©Ø±Ø¯ (ØªØ§ Û²Ûµ Ø§Ù…ØªÛŒØ§Ø²)
        if (employee.performanceHistory && employee.performanceHistory.length >= 2) {
            const lastTwoReviews = employee.performanceHistory.slice(-2);
            const latestScore = lastTwoReviews[1].overallScore;
            const previousScore = lastTwoReviews[0].overallScore;
            if (previousScore - latestScore >= 1) {
                riskScore += 25;
                reasons.push('Ø§ÙØª Ø´Ø¯ÛŒØ¯ Ø¹Ù…Ù„Ú©Ø±Ø¯');
            } else if (previousScore - latestScore >= 0.5) {
                riskScore += 15;
                reasons.push('Ø§ÙØª Ø¹Ù…Ù„Ú©Ø±Ø¯');
            }
        }

        // Ù…Ø¹ÛŒØ§Ø± Û³: Ø±Ú©ÙˆØ¯ Ø´ØºÙ„ÛŒ (ØªØ§ Û²Ûµ Ø§Ù…ØªÛŒØ§Ø²)
        const isHighPerformer = (employee.performanceHistory && employee.performanceHistory.slice(-1)[0]?.overallScore > 4) || ['Ø³ØªØ§Ø±Ù‡', 'Ù…Ù‡Ø±Ù‡ Ú©Ù„ÛŒØ¯ÛŒ'].includes(employee.nineBox);
        if (isHighPerformer && employee.careerPath && employee.careerPath.length > 0) {
            const lastMoveDate = new Date(employee.careerPath.slice(-1)[0].date);
            const monthsSinceLastMove = (new Date() - lastMoveDate) / (1000 * 60 * 60 * 24 * 30);
            if (monthsSinceLastMove > 24) { // Ø¨ÛŒØ´ØªØ± Ø§Ø² Û² Ø³Ø§Ù„ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±
                riskScore += 25;
                reasons.push('Ø±Ú©ÙˆØ¯ Ø´ØºÙ„ÛŒ (Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ÛŒØ¯ÛŒ)');
            }
        }

        // Ù…Ø¹ÛŒØ§Ø± Û´: Ø³Ù„Ø§Ù…Øª ØªÛŒÙ… (ØªØ§ Û±Û° Ø§Ù…ØªÛŒØ§Ø²)
        const team = allTeams.find(t => t.memberIds?.includes(employee.id));
        if (team && team.engagementScore != null && team.engagementScore < 60) {
            riskScore += 10;
            reasons.push('Ø¹Ø¶Ùˆ ØªÛŒÙ…ÛŒ Ø¨Ø§ Ù…Ø´Ø§Ø±Ú©Øª Ù¾Ø§ÛŒÛŒÙ†');
        }

        return {
            score: Math.min(100, riskScore), // Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ Ø¨ÛŒÙ† Û° ØªØ§ Û±Û°Û°
            reasons: reasons.length > 0 ? reasons : ['Ø±ÛŒØ³Ú© Ù¾Ø§ÛŒÛŒÙ†']
        };
    };
        // --- ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ØªØ¹ÛŒÛŒÙ† Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¬Ø¹Ø¨Ù‡ Ø¯Ø± Ù…Ø§ØªØ±ÛŒØ³ Û¹ Ø¬Ø¹Ø¨Ù‡â€ŒØ§ÛŒ ---
    const determineNineBoxCategory = (employee) => {
        // Û±. Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ø¹Ù…Ù„Ú©Ø±Ø¯ (Performance)
        let performanceScore = 0;
        if (employee.performanceHistory && employee.performanceHistory.length > 0) {
            performanceScore = employee.performanceHistory.slice(-1)[0].overallScore;
        }

        let performanceCategory; // Low, Medium, High
        if (performanceScore >= 4.2) {
            performanceCategory = 'High';
        } else if (performanceScore >= 3.5) {
            performanceCategory = 'Medium';
        } else {
            performanceCategory = 'Low';
        }

        // Û². Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ù¾ØªØ§Ù†Ø³ÛŒÙ„ (Potential) - Ù…Ø§ Ø§Ø² Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø² Ø´Ø§ÛŒØ³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ÛŒÚ© Ø´Ø§Ø®Øµ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        let potentialScore = 0;
        if (employee.competencies) {
            const scores = Object.values(employee.competencies);
            if (scores.length > 0) {
                potentialScore = scores.reduce((a, b) => a + b, 0) / scores.length;
            }
        }

        let potentialCategory; // Low, Medium, High
        if (potentialScore >= 4.2) {
            potentialCategory = 'High';
        } else if (potentialScore >= 3.5) {
            potentialCategory = 'Medium';
        } else {
            potentialCategory = 'Low';
        }

        // Û³. ØªØ®ØµÛŒØµ Ø¬Ø¹Ø¨Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ùˆ Ù¾ØªØ§Ù†Ø³ÛŒÙ„
        if (performanceCategory === 'High' && potentialCategory === 'High') return 'Ø³ØªØ§Ø±Ù‡ (Star)';
        if (performanceCategory === 'High' && potentialCategory === 'Medium') return 'Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ÛŒØ¯ÛŒ (Core Talent)';
        if (performanceCategory === 'High' && potentialCategory === 'Low') return 'Ù…Ù‡Ø±Ù‡ Ú©Ù„ÛŒØ¯ÛŒ (Key Player)';

        if (performanceCategory === 'Medium' && potentialCategory === 'High') return 'Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ø¨Ø§Ù„Ø§ (High Potential)';
        if (performanceCategory === 'Medium' && potentialCategory === 'Medium') return 'Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù‚Ø§Ø¨Ù„ Ø§ØªÚ©Ø§ (Solid Performer)';
        if (performanceCategory === 'Medium' && potentialCategory === 'Low') return 'Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù…ØªÙˆØ³Ø· (Average Performer)';

        if (performanceCategory === 'Low' && potentialCategory === 'High') return 'Ù…Ø¹Ù…Ø§ (Enigma/Puzzle)';
        if (performanceCategory === 'Low' && potentialCategory === 'Medium') return 'Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ø¨Ù‡Ø¨ÙˆØ¯ (Needs Improvement)';
        if (performanceCategory === 'Low' && potentialCategory === 'Low') return 'Ø±ÛŒØ³Ú© (Risk)';
        
        return 'Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù‚Ø§Ø¨Ù„ Ø§ØªÚ©Ø§ (Solid Performer)'; // Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    };
        // --- ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ Ø¹Ù…ÛŒÙ‚ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÛŒÚ© ØªÛŒÙ… ---
    const analyzeTeamData = (team, members) => {
        const analysis = {};

        // Û±. ØªØ­Ù„ÛŒÙ„ Ø¹Ù…ÛŒÙ‚ Ø§Ù…ØªÛŒØ§Ø² Ù…Ø´Ø§Ø±Ú©Øª Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ
        const engagementByCategory = {};
        const engagementTemplate = surveyTemplates['engagement'];
        let memberResponseCount = 0;

        members.forEach(member => {
            const responses = state.surveyResponses.filter(r => r.employeeId === member.id && r.surveyId === 'engagement');
            if (responses.length > 0) {
                memberResponseCount++;
                responses.forEach(res => {
                    engagementTemplate.questions.forEach(q => {
                        if (q.type === 'rating_1_5' && res.answers[q.id]) {
                            const score = parseInt(res.answers[q.id]);
                            if (!engagementByCategory[q.category]) {
                                engagementByCategory[q.category] = { totalScore: 0, count: 0 };
                            }
                            engagementByCategory[q.category].totalScore += score;
                            engagementByCategory[q.category].count++;
                        }
                    });
                });
            }
        });

        analysis.engagementBreakdown = Object.entries(engagementByCategory).map(([category, data]) => ({
            name: engagementTemplate.categories[category] || category,
            score: Math.round(((data.totalScore / data.count) / 5) * 100)
        }));

        // Û². Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ù‚Ø§Ø· Ù‚ÙˆØª Ú©Ù„ÛŒØ¯ÛŒ (Top Skills)
        const skillMap = new Map();
        members.forEach(member => {
            if (member.skills) {
                Object.entries(member.skills).forEach(([skill, level]) => {
                    if (level >= 4) { // ÙÙ‚Ø· Ù…Ù‡Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø³Ø·Ø­ Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø¯Ø± Ù†Ø¸Ø± Ø¨Ú¯ÛŒØ±
                        skillMap.set(skill, (skillMap.get(skill) || 0) + 1);
                    }
                });
            }
        });
        analysis.topSkills = [...skillMap.entries()]
            .sort((a, b) => b[1] - a[1]) // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ ØªÚ©Ø±Ø§Ø±
            .slice(0, 5) // Ûµ Ù…Ù‡Ø§Ø±Øª Ø¨Ø±ØªØ±
            .map(item => item[0]);

        // Û³. Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø§Ø¹Ø¶Ø§ÛŒ Ù¾Ø±Ø±ÛŒØ³Ú©
        analysis.highRiskMembers = members.filter(m => m.attritionRisk && m.attritionRisk.score > 70);

        return analysis;
    };
        
    
        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="ml-3"></i><span>${message}</span>`;
            container.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => toast.remove(), 5000);
        };
        
        const isAdmin = () => state.currentUser?.role === 'admin';
        const canEdit = () => state.currentUser?.role === 'admin' || state.currentUser?.role === 'editor';

        const calculateDashboardMetrics = () => {
            const totalEmployees = state.employees.length;
            if (totalEmployees === 0) {
                state.dashboardMetrics = {};
                return;
            }
            const activeEmployees = state.employees.filter(e => e.status === 'ÙØ¹Ø§Ù„');
            
            const retentionRate = totalEmployees > 0 ? ((activeEmployees.length / totalEmployees) * 100).toFixed(0) : 0;

            const totalTenureDays = activeEmployees.reduce((sum, emp) => {
                if (!emp.startDate) return sum;
                const start = new Date(emp.startDate);
                const now = new Date();
                return sum + Math.ceil(Math.abs(now - start) / (1000 * 60 * 60 * 24));
            }, 0);
            const averageTenureYears = activeEmployees.length > 0 ? (totalTenureDays / activeEmployees.length / 365).toFixed(1) : 0;
            
            const engagementResponses = state.surveyResponses.filter(r => r.surveyId === 'engagement');
            let totalScore = 0;
            let ratingCount = 0;
            engagementResponses.forEach(res => {
                Object.values(res.answers).forEach(ans => {
                    const score = parseInt(ans);
                    if (!isNaN(score)) {
                        totalScore += score;
                        ratingCount++;
                    }
                });
            });
            const engagementScore = ratingCount > 0 ? ((totalScore / ratingCount) / 5 * 100).toFixed(0) : 0;

            const mobileEmployees = state.employees.filter(e => e.careerPath && e.careerPath.length > 1).length;
            const internalMobilityRate = totalEmployees > 0 ? ((mobileEmployees / totalEmployees) * 100).toFixed(0) : 0;

            state.dashboardMetrics = {
                totalEmployees,
                retentionRate,
                averageTenure: averageTenureYears,
                engagementScore,
                internalMobilityRate,
                highImpactFlightRisk: activeEmployees.filter(e => e.attritionRisk?.score > 60).map(e => e.id),
                nineBoxDistribution: activeEmployees.reduce((acc, emp) => {
                    if (emp.nineBox) { acc[emp.nineBox] = (acc[emp.nineBox] || 0) + 1; }
                    return acc;
                }, {}),
                genderComposition: state.employees.reduce((acc, emp) => {
                    if (emp.gender) { acc[emp.gender] = (acc[emp.gender] || 0) + 1; }
                    return acc;
                }, {}),
                departmentDistribution: state.employees.reduce((acc, emp) => {
                    if (emp.department) { acc[emp.department] = (acc[emp.department] || 0) + 1; }
                    return acc;
                }, {}),
            };
        };

        // --- PAGE TEMPLATES & RENDERING ---
        const mainContent = document.getElementById('main-content');
        
const pages = {
dashboard: () => {
    calculateDashboardMetrics();
    const metrics = state.dashboardMetrics;
    if (Object.keys(metrics).length === 0) return `<div class="text-center p-10 card"><i data-lucide="inbox" class="mx-auto w-16 h-16 text-slate-400"></i><h2 class="mt-4 text-xl font-semibold text-slate-700">Ø¨Ù‡ NikHR Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!</h2><p class="mt-2 text-slate-500">Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ ÛŒÚ© Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.</p><button onclick="window.location.hash='#talent'" style="background-color: var(--color-primary);" class="mt-6 text-white py-2 px-5 rounded-lg hover:opacity-90 transition">Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ù…Ù†Ø¯</button></div>`;

    const highRiskEmployees = state.employees
        .filter(e => e.status === 'ÙØ¹Ø§Ù„' && e.attritionRisk && e.attritionRisk.score > 60)
        .sort((a, b) => b.attritionRisk.score - a.attritionRisk.score)
        .slice(0, 5);

    const highRiskHtml = highRiskEmployees.length > 0
        ? highRiskEmployees.map(emp => `
            <div class="flex items-center p-2 hover:bg-slate-50 rounded-lg transition-colors duration-200">
                <img src="${emp.avatar}" class="w-10 h-10 rounded-full object-cover ml-3 shrink-0">
                <div class="flex-grow">
                    <p class="font-semibold text-sm text-slate-800">${emp.name}</p>
                    <p class="text-xs text-slate-500">${emp.jobTitle || 'Ø¨Ø¯ÙˆÙ† Ø³Ù…Øª'}</p>
                </div>
                <div class="text-right">
                    <span class="font-bold text-sm text-red-500">${emp.attritionRisk.score}%</span>
                </div>
            </div>
        `).join('')
        : '<div class="text-center py-8"><i data-lucide="shield-check" class="mx-auto w-10 h-10 text-green-500"></i><p class="text-sm text-slate-500 mt-2">Ù…ÙˆØ±Ø¯ÛŒ Ø¨Ø§ Ø±ÛŒØ³Ú© Ø¨Ø§Ù„Ø§ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p></div>';

    return `
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</h1>
                <p class="text-sm text-slate-500 mt-1">Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯! Ø®Ù„Ø§ØµÙ‡â€ŒØ§ÛŒ Ø§Ø² ÙˆØ¶Ø¹ÛŒØª Ø³Ø§Ø²Ù…Ø§Ù† Ø´Ù…Ø§.</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2 space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="card p-5 text-center flex flex-col justify-center items-center bg-primary-light" style="background-color: var(--color-primary-light);">
                         <p class="text-sm font-semibold mb-2" style="color: var(--color-primary);">Ø§Ù…ØªÛŒØ§Ø² Ù…Ø´Ø§Ø±Ú©Øª</p>
                         <p class="text-4xl font-bold" style="color: var(--color-primary);">${metrics.engagementScore || 0}%</p>
                    </div>
                     <div class="metric-card p-5"><div class="flex items-center"><div class="bg-blue-100 p-3 rounded-xl mr-4"><i data-lucide="users" class="text-blue-600"></i></div><div><p class="text-slate-500 text-sm">Ù¾Ø±Ø³Ù†Ù„ ÙØ¹Ø§Ù„</p><p class="text-2xl font-bold text-slate-800">${metrics.totalEmployees}</p></div></div></div>
                     <div class="metric-card p-5"><div class="flex items-center"><div class="bg-green-100 p-3 rounded-xl mr-4"><i data-lucide="trending-up" class="text-green-600"></i></div><div><p class="text-slate-500 text-sm">Ù†Ø±Ø® Ù…Ø§Ù†Ø¯Ú¯Ø§Ø±ÛŒ</p><p class="text-2xl font-bold text-slate-800">${metrics.retentionRate}%</p></div></div></div>
                </div>

                <div class="card">
                     <h3 class="font-semibold text-lg mb-4 flex items-center">ØªØ­Ù„ÛŒÙ„ Ù†ÛŒØ±ÙˆÛŒ Ú©Ø§Ø±</h3>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-8 mt-4">
                        <div class="flex flex-col"><p class="text-slate-600 text-sm font-medium text-center mb-2">ØªÙˆØ²ÛŒØ¹ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†â€ŒÙ‡Ø§</p><div class="relative h-52"><canvas id="departmentDistributionChart"></canvas></div></div>
                        <div class="flex flex-col"><p class="text-slate-600 text-sm font-medium text-center mb-2">ØªØ±Ú©ÛŒØ¨ Ø¬Ù†Ø³ÛŒØªÛŒ</p><div class="relative h-52"><canvas id="genderCompositionChart"></canvas></div></div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-8">
                <div class="card p-6">
                    <h3 class="font-semibold text-lg mb-4 flex items-center">Ø§Ø³ØªØ¹Ø¯Ø§Ø¯Ù‡Ø§ÛŒ Ù¾Ø±Ø®Ø·Ø±</h3>
                    <div class="mt-2 space-y-2">${highRiskHtml}</div>
                </div>
                <div class="card p-6">
                    <h3 class="font-semibold text-lg mb-4 flex items-center">ÛŒØ§Ø¯Ø¢ÙˆØ± Ù‡ÙˆØ´Ù…Ù†Ø¯</h3>
                    <div id="remindersList" class="space-y-3 max-h-64 overflow-y-auto pr-2">${renderAllReminders()}</div>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mt-8">
            <div class="card"><h3 class="font-semibold text-center text-md mb-2">ØªÙˆØ²ÛŒØ¹ Ø³Ù†ÛŒ</h3><div class="relative h-52"><canvas id="ageDistributionChart"></canvas></div></div>
            <div class="card"><h3 class="font-semibold text-center text-md mb-2">Ø³Ø§Ø¨Ù‚Ù‡ Ú©Ø§Ø±</h3><div class="relative h-52"><canvas id="tenureDistributionChart"></canvas></div></div>
            <div class="card"><h3 class="font-semibold text-center text-md mb-2">ØªÙˆØ²ÛŒØ¹ Ø§Ø³ØªØ¹Ø¯Ø§Ø¯Ù‡Ø§</h3><div class="relative h-52"><canvas id="nineBoxChart"></canvas></div></div>
        </div>
    `;
},
talent: () => {
    return `
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">Ø§Ø³ØªØ¹Ø¯Ø§Ø¯Ù‡Ø§ÛŒ Ø³Ø§Ø²Ù…Ø§Ù†</h1>
                <p class="text-sm text-slate-500 mt-1">Ù…Ø¯ÛŒØ±ÛŒØª Ùˆ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†</p>
            </div>
            <div class="flex items-center gap-2 w-full md:w-auto">
                <button id="export-csv-btn" class="bg-green-600 text-white py-2 px-5 rounded-lg hover:bg-green-700 shadow-md transition flex items-center gap-2 w-full md:w-auto">
                    <i data-lucide="file-down"></i> Ø®Ø±ÙˆØ¬ÛŒ CSV
                </button>
                ${canEdit() ? `<button id="add-employee-btn" class="bg-blue-600 text-white py-2 px-5 rounded-lg hover:bg-blue-700 shadow-md transition flex items-center gap-2 w-full md:w-auto"><i data-lucide="plus"></i> Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ù…Ù†Ø¯</button>` : ''}
            </div>
        </div>
        
        <div class="card mb-6 p-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="w-full md:w-1/3 relative">
                    <input type="text" id="searchInput" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ù…Ù†Ø¯..." class="w-full p-2 pl-10 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                </div>
                <div class="w-full md:w-auto flex flex-wrap gap-2 justify-end">
                    <select id="departmentFilter" class="p-2 border border-slate-300 rounded-lg bg-white">
                        <option value="">Ù‡Ù…Ù‡ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†â€ŒÙ‡Ø§</option>
                        ${[...new Set(state.employees.map(e => e.department))].filter(Boolean).map(d => `<option value="${d}">${d}</option>`).join('')}
                    </select>
                    <select id="statusFilter" class="p-2 border border-slate-300 rounded-lg bg-white">
                        <option value="">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
                        <option value="ÙØ¹Ø§Ù„">ÙØ¹Ø§Ù„</option>
                        <option value="ØºÛŒØ±ÙØ¹Ø§Ù„">ØºÛŒØ±ÙØ¹Ø§Ù„</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="employee-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            </div>
        
        <div id="pagination-container" class="p-4 flex justify-center mt-6"></div>
    `;
},
organization: () => {
    if (state.teams.length === 0) return `<div class="text-center p-10 card"><i data-lucide="users-2" class="mx-auto w-16 h-16 text-slate-400"></i><h2 class="mt-4 text-xl font-semibold text-slate-700">Ù‡Ù†ÙˆØ² ØªÛŒÙ…ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</h2><p class="mt-2 text-slate-500">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ø§ÙˆÙ„ÛŒÙ† ØªÛŒÙ… Ø³Ø§Ø²Ù…Ø§Ù† Ø±Ø§ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.</p>${canEdit() ? `<button id="add-team-btn-empty" class="mt-6 bg-blue-600 text-white py-2 px-5 rounded-lg hover:bg-blue-700 shadow-md transition">Ø§ÙØ²ÙˆØ¯Ù† ØªÛŒÙ… Ø¬Ø¯ÛŒØ¯</button>` : ''}</div>`;

    const teamCardsHtml = state.teams.map((team, index) => {
        const leader = state.employees.find(e => e.id === team.leaderId);
        
        const personnelIds = new Set(team.memberIds || []);
        if (team.leaderId) {
            personnelIds.add(team.leaderId);
        }
        const memberCount = personnelIds.size;
        const engagementScore = team.engagementScore || 0;
        const okrProgress = (team.okrs && team.okrs.length > 0)
            ? Math.round(team.okrs.reduce((sum, okr) => sum + okr.progress, 0) / team.okrs.length)
            : 0;

        const borderColor = teamColorPalette[index % teamColorPalette.length];

        return `
            <div class="card bg-white rounded-xl flex flex-col text-center shadow-lg transform hover:-translate-y-1.5 transition-transform duration-300">
                
                <div class="py-6">
                    <img src="${team.avatar}" alt="${team.name}" class="w-24 h-24 rounded-full mx-auto object-cover border-4 ${borderColor} shadow-md">
                </div>

                <div class="px-6 pb-4">
                    <h3 class="text-xl font-bold text-slate-800">${team.name}</h3>
                    <p class="text-sm text-slate-500">${leader ? leader.name : 'Ù†Ø§Ù…Ø´Ø®Øµ'}</p>
                </div>

                <div class="px-6 py-4 grid grid-cols-3 gap-4 border-y border-slate-100">
                    <div>
                        <p class="text-2xl font-bold text-slate-700">${memberCount}</p>
                        <p class="text-xs text-slate-500 font-medium">Ø§Ø¹Ø¶Ø§</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-green-600">${engagementScore}%</p>
                        <p class="text-xs text-slate-500 font-medium">Ù…Ø´Ø§Ø±Ú©Øª</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-blue-600">${okrProgress}%</p>
                        <p class="text-xs text-slate-500 font-medium">Ø§Ù‡Ø¯Ø§Ù</p>
                    </div>
                </div>

                <div class="px-6 py-4 mt-auto flex justify-between items-center">
                    <div class="flex -space-x-2 overflow-hidden">
                        ${(Array.from(personnelIds).slice(0, 4)).map(memberId => {
                            const member = state.employees.find(e => e.id === memberId);
                            return member ? `<img class="inline-block h-8 w-8 rounded-full ring-2 ring-white object-cover" src="${member.avatar}" alt="${member.name}" title="${member.name}">` : '';
                        }).join('')}
                        ${memberCount > 4 ? `<div class="flex items-center justify-center h-8 w-8 rounded-full bg-slate-200 text-slate-600 text-xs font-medium ring-2 ring-white">+${memberCount - 4}</div>` : ''}
                    </div>
                    <div class="flex items-center gap-2">
                        ${isAdmin() ? `<button class="delete-team-btn p-2 text-slate-400 hover:text-rose-500 transition-colors" data-team-id="${team.firestoreId}" title="Ø­Ø°Ù ØªÛŒÙ…"><i data-lucide="trash-2" class="w-5 h-5"></i></button>` : ''}
                        <button class="view-team-profile-btn text-sm bg-slate-800 text-white py-2 px-4 rounded-lg hover:bg-slate-900 shadow-sm transition" data-team-id="${team.firestoreId}">
                            Ù…Ø´Ø§Ù‡Ø¯Ù‡
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    return `
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-slate-800">ØªÛŒÙ…â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø²Ù…Ø§Ù†</h1>
            ${canEdit() ? `<button id="add-team-btn" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 shadow-md transition flex items-center gap-2"><i data-lucide="plus"></i> Ø§ÙØ²ÙˆØ¯Ù† ØªÛŒÙ… Ø¬Ø¯ÛŒØ¯</button>` : ''}
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8" id="teams-container">
            ${teamCardsHtml}
        </div>
    `;
},
surveys: () => {
    // Ù‡Ø± Ù‚Ø§Ù„Ø¨ Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ Ø±Ø§ Ø¨Ù‡ ÛŒÚ© Ú©Ø§Ø±Øª Ù…Ø¯Ø±Ù† ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    const surveyCardsHtml = Object.values(surveyTemplates).map((survey, index) => {
        // Ø§Ù†ØªØ®Ø§Ø¨ Ø¢ÛŒÚ©ÙˆÙ† Ùˆ Ø±Ù†Ú¯ Ø§Ø² Ù¾Ø§Ù„Øª Ø¨Ù‡ ØµÙˆØ±Øª Ú†Ø±Ø®Ø´ÛŒ
        const visual = surveyVisualsPalette[index % surveyVisualsPalette.length];
        
        return `
            <div class="card bg-white p-6 flex flex-col items-center text-center rounded-xl shadow-lg transform hover:-translate-y-1.5 transition-transform duration-300">
                <div class="w-16 h-16 rounded-full ${visual.bg} flex items-center justify-center mb-4">
                    <i data-lucide="${visual.icon}" class="w-8 h-8 ${visual.color}"></i>
                </div>
                
                <h3 class="text-lg font-bold text-slate-800">${survey.title}</h3>
                <p class="text-sm text-slate-500 mt-2 flex-grow min-h-[60px]">${survey.description}</p>
                
                <button class="create-survey-link-btn mt-auto w-full text-sm bg-slate-800 text-white py-2.5 px-4 rounded-lg hover:bg-slate-900 transition-colors" data-survey-id="${survey.id}">
                    Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ
                </button>
            </div>
        `;
    }).join('');

    return `
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒâ€ŒÙ‡Ø§ Ùˆ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯Ù‡Ø§</h1>
                <p class="text-sm text-slate-500 mt-1">ÛŒÚ© Ù‚Ø§Ù„Ø¨ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            ${surveyCardsHtml}
        </div>
    `;
},
expenses: () => {
    // --- Û±. Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ ---
    const totalCharges = state.chargeHistory.reduce((sum, chg) => sum + chg.amount, 0);
    const totalExpenses = state.expenses.reduce((sum, exp) => sum + exp.amount, 0);
    const currentBalance = totalCharges - totalExpenses;

    // --- Û². ØªØ±Ú©ÛŒØ¨ Ùˆ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ ---
    const expensesWithDetails = state.expenses.map(exp => ({ ...exp, type: 'expense' }));
    const chargesWithDetails = state.chargeHistory.map(chg => ({ ...chg, type: 'charge', date: chg.chargedAt?.toDate(), item: `Ø´Ø§Ø±Ú˜ Ú©Ø§Ø±Øª ${chg.cardName}` }));
    
    const allTransactions = [...expensesWithDetails, ...chargesWithDetails]
        .filter(t => t.date)
        .sort((a, b) => new Date(b.date) - new Date(a.date));

    // --- Û³. Ø³Ø§Ø®Øª HTML ---
    const transactionsHtml = allTransactions.map(t => {
        const isExpense = t.type === 'expense';
        const cardName = isExpense ? (state.pettyCashCards.find(c => c.firestoreId === t.cardId)?.name || 'Ù†Ø§Ù…Ø´Ø®Øµ') : '';
        
        return `
            <div class="flex items-center gap-4 py-4 px-2 border-b border-slate-100">
                <div class="w-10 h-10 rounded-full ${isExpense ? 'bg-red-100' : 'bg-green-100'} flex items-center justify-center">
                    <i data-lucide="${isExpense ? 'arrow-down' : 'arrow-up'}" class="w-5 h-5 ${isExpense ? 'text-red-500' : 'text-green-500'}"></i>
                </div>
                <div class="flex-grow">
                    <p class="font-semibold text-slate-800">${t.item}</p>
                    <p class="text-xs text-slate-500">${toPersianDate(t.date)} ${isExpense ? ` - ${cardName}` : ''}</p>
                </div>
                <div class="flex items-center gap-2">
                    ${t.invoiceUrl ? `<a href="${t.invoiceUrl}" target="_blank" class="text-blue-500 hover:underline text-xs">Ø±Ø³ÛŒØ¯</a>` : ''}
                    <p class="w-28 text-left font-mono font-semibold ${isExpense ? 'text-red-600' : 'text-green-600'}">
                        ${isExpense ? '-' : '+'}${t.amount.toLocaleString('fa-IR')}
                    </p>
                </div>
            </div>
        `;
    }).join('');
    
    const cardsListHtml = state.pettyCashCards.map(card => `
        <div class="p-3 border-b border-slate-100">
            <div class="flex justify-between items-start">
                <div>
                    <p class="font-semibold text-slate-700">${card.name}</p>
                    <p class="text-xs text-slate-500 font-mono">${card.cardNumber || 'Ø¨Ø¯ÙˆÙ† Ø´Ù…Ø§Ø±Ù‡'}</p>
                </div>
                <div class="flex items-center gap-1 -mr-2">
                    ${canEdit() ? `<button class="edit-card-btn p-2 text-slate-400 hover:text-blue-500" data-id="${card.firestoreId}" title="ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Øª"><i data-lucide="edit" class="w-4 h-4"></i></button>` : ''}
                    ${isAdmin() ? `<button class="delete-card-btn p-2 text-slate-400 hover:text-rose-500" data-id="${card.firestoreId}" title="Ø­Ø°Ù Ú©Ø§Ø±Øª"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                </div>
            </div>
            <p class="font-mono font-bold text-slate-800 text-lg mt-1">${card.balance.toLocaleString('fa-IR')} <span class="font-sans text-xs">ØªÙˆÙ…Ø§Ù†</span></p>
        </div>
    `).join('');

    return `
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-slate-800">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø§Ù„ÛŒ</h1>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-6">
                <div class="flex items-center gap-2">
                    ${canEdit() ? `<button id="add-expense-btn" class="flex-1 bg-red-500 text-white py-3 px-4 rounded-lg hover:bg-red-600 shadow-md transition flex items-center justify-center gap-2"><i data-lucide="plus"></i> Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ø²ÛŒÙ†Ù‡</button>` : ''}
                    ${canEdit() ? `<button id="charge-card-btn" class="flex-1 bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 shadow-md transition flex items-center justify-center gap-2"><i data-lucide="zap"></i> Ø´Ø§Ø±Ú˜ Ú©Ø§Ø±Øª</button>` : ''}
                </div>
                <div class="card p-4">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <h3 class="font-bold text-lg">ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h3>
                        <div class="flex items-center gap-2">
                            <input type="text" id="start-date-filter" class="w-32 p-2 border rounded-md text-sm" placeholder="Ø§Ø² ØªØ§Ø±ÛŒØ®">
                            <input type="text" id="end-date-filter" class="w-32 p-2 border rounded-md text-sm" placeholder="ØªØ§ ØªØ§Ø±ÛŒØ®">
                            <button id="export-transactions-csv-btn" class="p-2 bg-green-600 text-white rounded-md hover:bg-green-700" title="Ø®Ø±ÙˆØ¬ÛŒ CSV">
                                <i data-lucide="file-down" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        ${transactionsHtml.length > 0 ? transactionsHtml : `<div class="text-center p-8 text-slate-500">Ù‡ÛŒÚ† ØªØ±Ø§Ú©Ù†Ø´ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>`}
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-6">
                <div class="card p-4 space-y-4">
                    <div class="p-3 rounded-lg bg-green-50">
                        <p class="text-sm text-green-800">Ù…Ø¬Ù…ÙˆØ¹ ÙˆØ§Ø±ÛŒØ²</p>
                        <p class="font-mono text-2xl font-bold text-green-700">${totalCharges.toLocaleString('fa-IR')} <span class="text-sm font-sans">ØªÙˆÙ…Ø§Ù†</span></p>
                    </div>
                    <div class="p-3 rounded-lg bg-red-50">
                        <p class="text-sm text-red-800">Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø±Ø¯Ø§Ø´Øª</p>
                        <p class="font-mono text-2xl font-bold text-red-700">${totalExpenses.toLocaleString('fa-IR')} <span class="text-sm font-sans">ØªÙˆÙ…Ø§Ù†</span></p>
                    </div>
                    <div class="p-3 rounded-lg bg-slate-100">
                        <p class="text-sm text-slate-800">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù†Ù‡Ø§ÛŒÛŒ</p>
                        <p class="font-mono text-2xl font-bold text-slate-900">${currentBalance.toLocaleString('fa-IR')} <span class="text-sm font-sans">ØªÙˆÙ…Ø§Ù†</span></p>
                    </div>
                </div>
                <div class="card p-0">
                    <div class="p-4 border-b border-slate-200 flex justify-between items-center">
                        <h3 class="font-bold text-lg">Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ ØªÙ†Ø®ÙˆØ§Ù‡</h3>
                        ${isAdmin() ? `<button id="add-card-btn" class="bg-slate-800 text-white text-xs py-1 px-3 rounded-md hover:bg-slate-900"><i data-lucide="plus" class="w-4 h-4"></i> Ø§ÙØ²ÙˆØ¯Ù†</button>` : ''}
                    </div>
                    <div id="cards-list-container">
                        ${cardsListHtml.length > 0 ? cardsListHtml : `<div class="p-4 text-center text-sm text-slate-500">Ú©Ø§Ø±ØªÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>`}
                    </div>
                </div>
            </div>
        </div>
    `;
},
analytics: () => {
    return `
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯</h1>
                <p class="text-sm text-slate-500 mt-1">Ù…Ø±Ú©Ø² ÙØ±Ù…Ø§Ù†Ø¯Ù‡ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªØ¹Ø¯Ø§Ø¯Ù‡Ø§ÛŒ Ø³Ø§Ø²Ù…Ø§Ù†</p>
            </div>
        </div>

        <div class="mb-6 border-b border-slate-200">
            <nav id="analytics-tabs" class="flex -mb-px space-x-6 space-x-reverse" aria-label="Tabs">
                <button data-tab="overview" class="analytics-tab shrink-0 border-b-2 font-semibold px-1 py-3 text-sm border-blue-600 text-blue-600">
                    Ù†Ù…Ø§ÛŒ Ú©Ù„ÛŒ Ø§Ø³ØªØ¹Ø¯Ø§Ø¯Ù‡Ø§
                </button>
                <button data-tab="health" class="analytics-tab shrink-0 border-b-2 font-semibold px-1 py-3 text-sm border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300">
                    Ø³Ù„Ø§Ù…Øª Ø³Ø§Ø²Ù…Ø§Ù†
                </button>
                <button data-tab="tools" class="analytics-tab shrink-0 border-b-2 font-semibold px-1 py-3 text-sm border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300">
                    Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ÛŒ
                </button>
            </nav>
        </div>

        <div id="analytics-tab-content">
            <div id="tab-overview" class="analytics-tab-pane space-y-8">
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                    <div class="xl:col-span-2 card p-6">
                        <h3 class="font-semibold text-lg mb-4 flex items-center"><i data-lucide="layout-grid" class="ml-2 text-indigo-500"></i>Ù…Ø§ØªØ±ÛŒØ³ Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ Û¹-Ø¬Ø¹Ø¨Ù‡â€ŒØ§ÛŒ</h3>
                        <div class="flex">
                             <div class="flex flex-col justify-between text-xs text-slate-500 font-medium py-4 -ml-4" style="writing-mode: vertical-rl; transform: rotate(180deg);">
                                <span>Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ú©Ù…</span>
                                <span>Ù…ØªÙˆØ³Ø·</span>
                                <span>Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ø¨Ø§Ù„Ø§</span>
                            </div>
                            <div id="nine-box-grid-container" class="w-full"></div>
                        </div>
                        <div class="flex justify-between text-xs text-slate-500 font-medium px-4 mt-2">
                                <span>Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù¾Ø§ÛŒÛŒÙ†</span>
                                <span>Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù…ØªÙˆØ³Ø·</span>
                                <span>Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¨Ø§Ù„Ø§</span>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="font-semibold text-lg mb-4 flex items-center"><i data-lucide="flame" class="ml-2 text-red-500"></i>Ù†Ù‚Ø§Ø· Ø¯Ø§Øº Ø±ÛŒØ³Ú© Ø®Ø±ÙˆØ¬</h3>
                        <div id="attrition-hotspot-list" class="space-y-4 max-h-[400px] overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </div>

            <div id="tab-health" class="analytics-tab-pane hidden space-y-8">
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card p-6">
                         <h3 class="font-semibold text-lg mb-4 flex items-center"><i data-lucide="pie-chart" class="ml-2 text-blue-500"></i>ØªØ­Ù„ÛŒÙ„ Ù…Ø´Ø§Ø±Ú©Øª Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ</h3>
                         <div class="relative h-80"><canvas id="engagementBreakdownChart"></canvas></div>
                    </div>
                    <div class="card p-6">
                         <h3 class="font-semibold text-lg mb-4 flex items-center"><i data-lucide="activity" class="ml-2 text-green-500"></i>Ù†Ù…Ø±Ù‡ Ø³Ù„Ø§Ù…Øª ØªÛŒÙ…â€ŒÙ‡Ø§</h3>
                         <div class="relative h-80"><canvas id="teamHealthChart"></canvas></div>
                    </div>
                 </div>
            </div>

            <div id="tab-tools" class="analytics-tab-pane hidden space-y-8">
                <div class="card p-6 max-w-2xl mx-auto">
                    <h3 class="font-semibold text-lg mb-4 flex items-center"><i data-lucide="file-search" class="ml-2 text-teal-500"></i>ØªØ­Ù„ÛŒÙ„ Ø´Ú©Ø§Ù Ù…Ù‡Ø§Ø±ØªÛŒ</h3>
                    <div class="flex flex-col gap-3">
                        <select id="skill-team-select" class="w-full p-2 border border-slate-300 rounded-lg bg-white">
                            <option value="all">Ú©Ù„ Ø³Ø§Ø²Ù…Ø§Ù†</option>
                            ${state.teams.map(t => `<option value="${t.firestoreId}">${t.name}</option>`).join('')}
                        </select>
                        <input type="text" id="skill-search-input" placeholder="Ù…Ù‡Ø§Ø±Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± (Ù…Ø«Ù„Ø§: Python)" class="w-full p-2 border border-slate-300 rounded-lg">
                        <button id="find-skill-gap-btn" class="bg-slate-800 text-white py-2 px-4 rounded-lg hover:bg-slate-900 w-full">Ø¬Ø³ØªØ¬Ùˆ</button>
                    </div>
                    <div id="skill-gap-results" class="mt-4 pt-4 border-t border-slate-200 min-h-[5rem]">
                        <p class="text-sm text-slate-500 text-center">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ ÛŒÚ© ØªÛŒÙ… Ùˆ Ù…Ù‡Ø§Ø±Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>
                    </div>
                </div>
            </div>
        </div>
    `;
},
settings: () => {
    if (!isAdmin()) {
        return `<div class="text-center p-10 card"><i data-lucide="lock" class="mx-auto w-16 h-16 text-red-500"></i><h2 class="mt-4 text-xl font-semibold text-slate-700">Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ± Ù…Ø¬Ø§Ø²</h2><p class="mt-2 text-slate-500">Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ù„Ø§Ø²Ù… Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.</p></div>`;
    }

    // Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§ Ø·Ø±Ø§Ø­ÛŒ Ø¬Ø¯ÛŒØ¯
    const usersHtml = state.users.map(user => {
        const userInitial = user.name ? user.name.substring(0, 1) : user.email.substring(0, 1).toUpperCase();
        const isCurrentUser = user.firestoreId === state.currentUser.uid;
        return `
            <div class="flex items-center justify-between p-4 border-b border-slate-100 last:border-b-0">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center font-bold text-sm ml-4 shrink-0">
                        ${userInitial}
                    </div>
                    <div>
                        <p class="font-semibold text-sm text-slate-800">${user.name || 'Ù†Ø§Ù…Ø´Ø®Øµ'} ${isCurrentUser ? '<span class="text-xs text-blue-600">(Ø´Ù…Ø§)</span>' : ''}</p>
                        <p class="text-xs text-slate-500">${user.email}</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <select data-uid="${user.firestoreId}" class="role-select p-2 border border-slate-300 rounded-lg bg-white text-sm" ${isCurrentUser ? 'disabled' : ''}>
                        <option value="viewer" ${user.role === 'viewer' ? 'selected' : ''}>Ù…Ø´Ø§Ù‡Ø¯Ù‡â€ŒÚ¯Ø±</option>
                        <option value="editor" ${user.role === 'editor' ? 'selected' : ''}>ÙˆÛŒØ±Ø§ÛŒØ´Ú¯Ø±</option>
                        <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Ù…Ø¯ÛŒØ±</option>
                    </select>
                     ${!isCurrentUser ? `
                    <button class="edit-user-btn p-2 text-slate-500 hover:text-blue-600" data-uid="${user.firestoreId}" title="ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±"><i data-lucide="edit" class="w-4 h-4"></i></button>
                    <button class="delete-user-btn p-2 text-slate-500 hover:text-red-600" data-uid="${user.firestoreId}" title="Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø±"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    ` : '<div class="w-16"></div>'}
                </div>
            </div>
        `;
    }).join('');

    // Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù„ÛŒØ³Øª Ø´Ø§ÛŒØ³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ Ø¨Ø§ Ø·Ø±Ø§Ø­ÛŒ Ø¬Ø¯ÛŒØ¯
    const competenciesHtml = state.competencies.map(c => `
        <div class="inline-flex items-center bg-slate-100 text-slate-700 text-sm font-medium px-3 py-1.5 rounded-full">
            <span>${c.name}</span>
            <button class="delete-competency-btn text-slate-400 hover:text-red-500 mr-2" data-id="${c.firestoreId}">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
    `).join('') || '<p class="text-sm text-slate-500">Ù‡Ù†ÙˆØ² Ø´Ø§ÛŒØ³ØªÚ¯ÛŒâ€ŒØ§ÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';

    return `
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…</h1>
                <p class="text-sm text-slate-500 mt-1">Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†ØŒ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ Ùˆ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø³Ø§Ø²Ù…Ø§Ù†</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
            <div class="card p-0">
                <div class="flex justify-between items-center p-5 border-b border-slate-200">
                    <h3 class="font-semibold text-lg flex items-center"><i data-lucide="users" class="ml-2 text-indigo-500"></i>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h3>
                    <button id="add-user-btn" class="bg-blue-600 text-white text-sm py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i> Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
                    </button>
                </div>
                <div id="users-list-container">
                    ${usersHtml}
                </div>
            </div>

            <div class="card p-6 space-y-8">
                <div>
                    <h3 class="font-semibold text-lg mb-4 flex items-center"><i data-lucide="star" class="ml-2 text-amber-500"></i>Ù…Ø¯ÛŒØ±ÛŒØª Ø´Ø§ÛŒØ³ØªÚ¯ÛŒâ€ŒÙ‡Ø§</h3>
                    <div id="competencies-list" class="flex flex-wrap gap-2 mb-4">
                        ${competenciesHtml}
                    </div>
                    <form id="add-competency-form" class="flex gap-2">
                        <input type="text" id="new-competency-name" placeholder="Ù†Ø§Ù… Ø´Ø§ÛŒØ³ØªÚ¯ÛŒ Ø¬Ø¯ÛŒØ¯..." class="w-full p-2 border border-slate-300 rounded-lg text-sm" required>
                        <button type="submit" class="bg-slate-800 text-white py-2 px-4 rounded-lg hover:bg-slate-900 shrink-0">Ø§ÙØ²ÙˆØ¯Ù†</button>
                    </form>
                </div>
            </div>
        </div>
    `;
}
}; // <<--- Ø¢Ø¨Ø¬Ú©Øª pages Ø§ÛŒÙ†Ø¬Ø§ ØªÙ…Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯

const showEditUserForm = (user) => {
    modalTitle.innerText = `ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±: ${user.name}`;
    modalContent.innerHTML = `
        <form id="edit-user-form" class="space-y-4">
            <input type="hidden" id="edit-user-uid" value="${user.firestoreId}">
            <div>
                <label for="edit-user-name" class="block text-sm font-medium text-gray-700">Ù†Ø§Ù… Ú©Ø§Ù…Ù„</label>
                <input id="edit-user-name" type="text" value="${user.name || ''}" required class="w-full px-3 py-2 mt-1 border rounded-md">
            </div>
             <div>
                <label for="edit-user-email" class="block text-sm font-medium text-gray-700">Ø¢Ø¯Ø±Ø³ Ø§ÛŒÙ…ÛŒÙ„</label>
                <input id="edit-user-email" type="email" value="${user.email}" disabled class="w-full px-3 py-2 mt-1 border rounded-md bg-slate-100">
            </div>
            <div>
                <label for="edit-user-role" class="block text-sm font-medium text-gray-700">Ø³Ø·Ø­ Ø¯Ø³ØªØ±Ø³ÛŒ</label>
                <select id="edit-user-role" class="w-full p-2 mt-1 border rounded-md" ${user.firestoreId === state.currentUser.uid ? 'disabled' : ''}>
                    <option value="viewer" ${user.role === 'viewer' ? 'selected' : ''}>Ù…Ø´Ø§Ù‡Ø¯Ù‡â€ŒÚ¯Ø± (Viewer)</option>
                    <option value="editor" ${user.role === 'editor' ? 'selected' : ''}>ÙˆÛŒØ±Ø§ÛŒØ´Ú¯Ø± (Editor)</option>
                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Ù…Ø¯ÛŒØ± (Admin)</option>
                </select>
            </div>
            <div class="pt-4 flex justify-end">
                <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
            </div>
        </form>
    `;
    openModal(mainModal, mainModalContainer);

    document.getElementById('edit-user-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const uid = document.getElementById('edit-user-uid').value;
        const name = document.getElementById('edit-user-name').value;
        const role = document.getElementById('edit-user-role').value;

        try {
            const userRef = doc(db, `artifacts/${appId}/public/data/users`, uid);
            await updateDoc(userRef, {
                name: name,
                role: role
            });
            closeModal(mainModal, mainModalContainer);
            showToast("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.");
        } catch (error) {
            console.error("Error updating user:", error);
            showToast("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±.", "error");
        }
    });
};
const viewEmployeeProfile = (employeeId) => {
    const emp = state.employees.find(e => e.firestoreId === employeeId);
    if (!emp) return;
    const analysis = generateSmartAnalysis(emp);
    const team = state.teams.find(t => t.memberIds?.includes(emp.id));
    const manager = team ? state.employees.find(e => e.id === team.leaderId) : null;

    modalTitle.innerText = 'Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Û³Û¶Û° Ø¯Ø±Ø¬Ù‡: ' + emp.name;
    modalContent.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 space-y-6">
                <div class="card p-6 bg-gray-50 rounded-xl text-center relative group">
                    <div class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-white shadow-md overflow-hidden bg-gray-200 flex items-center justify-center">
                        <img src="${emp.avatar}" alt="${emp.name}" class="w-full h-full object-cover">
                    </div>
                    ${canEdit() ? `<div class="absolute top-4 left-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button id="change-avatar-btn" class="bg-white p-2 rounded-full shadow-md text-slate-500 hover:text-blue-600"><i data-lucide="camera" class="w-4 h-4"></i></button>
                        <button id="delete-avatar-btn" class="bg-white p-2 rounded-full shadow-md text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>` : ''}
                    <div class="flex items-center justify-center gap-2">
                        <h2 class="text-2xl font-bold text-slate-800">${emp.name}</h2>
                        ${canEdit() ? `<button id="main-edit-employee-btn" class="p-1.5 text-slate-500 hover:text-blue-600" title="ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØµÙ„ÛŒ"><i data-lucide="edit" class="w-5 h-5"></i></button>` : ''}
                    </div>
                    <p class="text-blue-600 font-semibold">${emp.jobTitle || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù† Ø´ØºÙ„ÛŒ'}</p>
                    <p class="text-sm text-slate-500">${emp.level || ''}</p>
                    <span class="mt-2 inline-block px-3 py-1 text-xs font-medium rounded-full ${emp.status === 'ÙØ¹Ø§Ù„' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${emp.status}</span>
                </div>
                <div class="card p-6 bg-gray-50 rounded-xl">
                    <h4 class="font-semibold mb-4 text-slate-700 flex items-center"><i data-lucide="heart-pulse" class="ml-2 w-5 h-5 text-green-500"></i>Ø§Ù…ØªÛŒØ§Ø² Ù…Ø´Ø§Ø±Ú©Øª (Engagement)</h4>
                    ${emp.engagementScore != null ? `
                    <div class="relative w-40 h-20 mx-auto mt-2">
                        <canvas id="engagementGaugeProfile"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center -bottom-4">
                            <span class="text-3xl font-bold text-green-600">${emp.engagementScore}%</span>
                        </div>
                    </div>
                    ` : '<p class="text-sm text-slate-500 text-center">Ù‡Ù†ÙˆØ² Ø§Ù…ØªÛŒØ§Ø²ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>'}
                </div>
                <div class="card p-6 bg-gray-50 rounded-xl">
                    <h4 class="font-semibold mb-4 text-slate-700 flex items-center"><i data-lucide="brain-circuit" class="ml-2 w-5 h-5 text-purple-500"></i>ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯</h4>
                    <div class="text-sm space-y-3">${Object.values(analysis).map(item => `<div class="flex items-start"><i data-lucide="${item.icon}" class="w-4 h-4 mt-1 ml-2 flex-shrink-0 ${item.color}"></i><div class="${item.color}">${item.text}</div></div>`).join('')}</div>
                </div>
            </div>
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white rounded-xl shadow-md">
                    <div class="border-b border-slate-200"><nav id="profile-tabs" class="flex -mb-px overflow-x-auto"><button data-tab="overview" class="profile-tab active shrink-0">Ù†Ù…Ø§ÛŒ Ú©Ù„ÛŒ</button><button data-tab="performance" class="profile-tab shrink-0">Ø¹Ù…Ù„Ú©Ø±Ø¯</button><button data-tab="career" class="profile-tab shrink-0">Ù…Ø³ÛŒØ± Ø´ØºÙ„ÛŒ</button><button data-tab="contracts" class="profile-tab shrink-0">Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</button><button data-tab="personal" class="profile-tab shrink-0">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø³Ù†Ù„ÛŒ</button></nav></div>
                    <div class="p-4">
                        <div id="tab-overview" class="profile-tab-content active">
                            <div class="space-y-4">
                                <div class="card p-4 bg-white rounded-xl border border-slate-200">
                                    <h4 class="font-semibold mb-3 text-slate-700 flex items-center">
                                        <i data-lucide="info" class="ml-2 w-5 h-5 text-gray-500"></i>
                                        Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØµÙ„ÛŒ
                                    </h4>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-slate-600">
                                        <p><strong>Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ:</strong> ${emp.id}</p>
                                        <p><strong>Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†:</strong> ${emp.department || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</p>
                                        <p><strong>Ù…Ø¯ÛŒØ±:</strong> ${manager ? manager.name : 'Ù†Ø§Ù…Ø´Ø®Øµ'}</p>
                                        <p><strong>ØªØ§Ø±ÛŒØ® Ø§Ø³ØªØ®Ø¯Ø§Ù…:</strong> ${toPersianDate(emp.startDate)}</p>
                                        <p><strong>ÙˆØ¶Ø¹ÛŒØª:</strong> <span class="px-2 py-1 text-xs font-medium rounded-full ${emp.status === 'ÙØ¹Ø§Ù„' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${emp.status}</span></p>
                                    </div>
                                </div>
                                <div class="card p-4 bg-white rounded-xl border border-slate-200">
                                    <div class="flex justify-between items-center mb-3">
                                        <h4 class="font-semibold text-slate-700">
                                            <i data-lucide="star" class="ml-2 w-5 h-5 text-amber-500"></i>
                                            Ø´Ø§ÛŒØ³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ
                                        </h4>
                                        ${canEdit() ? `<button id="edit-competencies-btn" class="text-sm bg-blue-500 text-white py-1 px-3 rounded-md hover:bg-blue-600">ÙˆÛŒØ±Ø§ÛŒØ´</button>` : ''}
                                    </div>
                                    <div class="space-y-4">
                                        ${renderCompetencyBars(emp.competencies)}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="tab-performance" class="profile-tab-content">
                            <div class="space-y-4">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-semibold text-slate-700">
                                        <i data-lucide="clipboard-check" class="ml-2 w-5 h-5 text-green-600"></i>
                                        Ø³Ø§Ø¨Ù‚Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯
                                    </h4>
                                    ${canEdit() ? `<button id="add-performance-btn" class="text-sm bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700">Ø§ÙØ²ÙˆØ¯Ù†</button>` : ''}
                                </div>
                                <div class="space-y-4">
                                    ${(emp.performanceHistory && emp.performanceHistory.length > 0) ? emp.performanceHistory.sort((a,b) => new Date(b.reviewDate) - new Date(a.reviewDate)).map((review, index) => `
                                    <div class="card p-4 bg-white rounded-xl border border-slate-200">
                                        <div class="flex justify-between items-center mb-2">
                                            <p class="font-bold text-slate-800">Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„ÛŒ: <span class="text-lg text-green-600">${review.overallScore}/5</span></p>
                                            ${canEdit() ? `<div class="flex gap-2">
                                                <button class="edit-performance-btn text-blue-500" data-index="${index}"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                                <button class="delete-performance-btn text-red-500" data-index="${index}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                            </div>` : ''}
                                        </div>
                                        <p class="text-sm text-slate-500">ØªØ§Ø±ÛŒØ®: ${toPersianDate(review.reviewDate)} | Ø§Ø±Ø²ÛŒØ§Ø¨: ${review.reviewer}</p>
                                        <div class="mt-4 border-t border-dashed pt-4">
                                            <p class="text-xs text-slate-700"><strong>Ù†Ù‚Ø§Ø· Ù‚ÙˆØª:</strong> ${review.strengths || '-'}</p>
                                            <p class="text-xs text-slate-700 mt-2"><strong>Ø²Ù…ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯:</strong> ${review.areasForImprovement || '-'}</p>
                                        </div>
                                    </div>`).join('') : '<p class="text-sm text-slate-500">Ù‡Ù†ÙˆØ² Ø³Ø§Ø¨Ù‚Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>'}
                                </div>
                            </div>
                        </div>
                        <div id="tab-career" class="profile-tab-content">
                            <div class="space-y-4">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-semibold text-slate-700">
                                        <i data-lucide="briefcase" class="ml-2 w-5 h-5 text-indigo-600"></i>
                                        Ù…Ø³ÛŒØ± Ø´ØºÙ„ÛŒ Ùˆ Ø³Ø§Ø¨Ù‚Ù‡ Ø§Ù†Ø¶Ø¨Ø§Ø·ÛŒ
                                    </h4>
                                    <div class="flex gap-2">
                                        ${canEdit() ? `<button id="add-career-path-btn" class="text-sm bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700">Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø´ØºÙ„ÛŒ</button>` : ''}
                                        ${canEdit() ? `<button id="add-disciplinary-btn" class="text-sm bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700">Ø§Ù†Ø¶Ø¨Ø§Ø·ÛŒ</button>` : ''}
                                    </div>
                                </div>
                                <div class="relative space-y-6 after:absolute after:inset-y-0 after:w-px after:bg-slate-300 after:right-4 after:top-2 after:-bottom-2">
                                    ${(emp.careerPath && emp.careerPath.length > 0) ? emp.careerPath.sort((a,b) => new Date(a.date) - new Date(b.date)).map((item, index) => `
                                    <div class="flex items-center space-x-3 space-x-reverse relative">
                                        <div class="z-10 w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-white shrink-0"><i data-lucide="trending-up" class="w-4 h-4"></i></div>
                                        <div class="flex-grow card p-4 border-r-4 border-indigo-500 shadow-sm relative">
                                            <p class="font-semibold text-sm">${item.title}</p>
                                            <p class="text-xs text-slate-500">${item.type} Ø¯Ø± ${item.department}</p>
                                            <p class="text-xs text-slate-400 mt-1">${toPersianDate(item.date)}</p>
                                            ${canEdit() ? `<button class="delete-career-path-btn absolute top-2 left-2 text-red-500 hover:text-red-700" data-index="${index}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                                        </div>
                                    </div>`).join('') : '<p class="text-sm text-slate-500">Ù‡Ù†ÙˆØ² Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø´ØºÙ„ÛŒâ€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>'}
                                    ${(emp.disciplinaryHistory && emp.disciplinaryHistory.length > 0) ? emp.disciplinaryHistory.sort((a,b) => new Date(a.date) - new Date(b.date)).map((item, index) => `
                                    <div class="flex items-center space-x-3 space-x-reverse relative">
                                        <div class="z-10 w-8 h-8 rounded-full ${item.type === 'ØªØ´ÙˆÛŒÙ‚' ? 'bg-green-500' : 'bg-red-500'} flex items-center justify-center text-white shrink-0"><i data-lucide="${item.type === 'ØªØ´ÙˆÛŒÙ‚' ? 'star' : 'alert-circle'}" class="w-4 h-4"></i></div>
                                        <div class="flex-grow card p-4 border-r-4 ${item.type === 'ØªØ´ÙˆÛŒÙ‚' ? 'border-green-500' : 'border-red-500'} shadow-sm relative">
                                            <p class="font-semibold text-sm">${item.type}</p>
                                            <p class="text-xs text-slate-500">${item.reason}</p>
                                            <p class="text-xs text-slate-400 mt-1">${toPersianDate(item.date)}</p>
                                            ${canEdit() ? `<button class="delete-disciplinary-btn absolute top-2 left-2 text-red-500 hover:text-red-700" data-index="${index}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                                        </div>
                                    </div>`).join('') : ''}
                                </div>
                            </div>
                        </div>
                        <div id="tab-contracts" class="profile-tab-content">
                            <div class="space-y-4">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-semibold text-slate-700">
                                        <i data-lucide="clipboard-list" class="ml-2 w-5 h-5 text-purple-600"></i>
                                        Ø³Ø§Ø¨Ù‚Ù‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ùˆ Ù…Ø¯Ø§Ø±Ú©
                                    </h4>
                                    <div class="flex gap-2">
                                        ${canEdit() ? `<button id="add-contract-btn" class="text-sm bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700">Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</button>` : ''}
                                        ${canEdit() ? `<button id="add-document-btn" class="text-sm bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700">Ù…Ø¯Ø§Ø±Ú©</button>` : ''}
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <div class="card p-4 bg-white rounded-xl border border-slate-200">
                                        <h5 class="font-semibold mb-2">Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</h5>
                                        <div class="overflow-x-auto">
                                            <table class="w-full text-sm text-right">
                                                <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                                                    <tr>
                                                        <th class="px-3 py-2">Ø´Ø±ÙˆØ¹</th>
                                                        <th class="px-3 py-2">Ù¾Ø§ÛŒØ§Ù†</th>
                                                        <th class="px-3 py-2">Ø­Ù‚ÙˆÙ‚ Ø®Ø§Ù„Øµ</th>
                                                        <th class="px-3 py-2">Ø³ÙØªÙ‡</th>
                                                        <th class="px-3 py-2">ÙØ§ÛŒÙ„</th>
                                                        <th class="px-3 py-2">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${(emp.contractHistory && emp.contractHistory.length > 0) ? emp.contractHistory.map((contract, index) => `
                                                    <tr class="border-b">
                                                        <td class="px-3 py-2">${toPersianDate(contract.startDate)}</td>
                                                        <td class="px-3 py-2">${toPersianDate(contract.endDate)}</td>
                                                        <td class="px-3 py-2">${contract.netSalary ? contract.netSalary.toLocaleString('fa-IR') : '-'}</td>
                                                        <td class="px-3 py-2">${contract.promissoryNote ? contract.promissoryNote.toLocaleString('fa-IR') : '-'}</td>
                                                        <td class="px-3 py-2">
                                                            ${contract.fileUrl ? `<a href="${contract.fileUrl}" target="_blank" class="text-blue-600 hover:underline">Ù…Ø´Ø§Ù‡Ø¯Ù‡</a>` : '-'}
                                                        </td>
                                                        <td class="px-3 py-2">
                                                            ${canEdit() ? `<div class="flex gap-2"><button class="edit-contract-btn text-blue-500" data-index="${index}"><i data-lucide="edit" class="w-4 h-4"></i></button><button class="delete-contract-btn text-red-500" data-index="${index}"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>` : ''}
                                                        </td>
                                                    </tr>`).join('') : `<tr><td colspan="6" class="text-center py-4 text-slate-500">Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</td></tr>`}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="card p-4 bg-white rounded-xl border border-slate-200">
                                        <h5 class="font-semibold mb-2">Ù…Ø¯Ø§Ø±Ú©</h5>
                                        <div class="overflow-x-auto">
                                            <table class="w-full text-sm text-right">
                                                <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                                                    <tr>
                                                        <th class="px-3 py-2">Ù†Ø§Ù… Ù…Ø¯Ø±Ú©</th>
                                                        <th class="px-3 py-2">ØªØ§Ø±ÛŒØ®</th>
                                                        <th class="px-3 py-2">ÙØ§ÛŒÙ„</th>
                                                        <th class="px-3 py-2">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${(emp.documents && emp.documents.length > 0) ? emp.documents.map((doc, index) => `
                                                    <tr class="border-b">
                                                        <td class="px-3 py-2">${doc.name || '-'}</td>
                                                        <td class="px-3 py-2">${toPersianDate(doc.date)}</td>
                                                        <td class="px-3 py-2">
                                                            ${doc.fileUrl ? `<a href="${doc.fileUrl}" target="_blank" class="text-blue-600 hover:underline">Ù…Ø´Ø§Ù‡Ø¯Ù‡</a>` : '-'}
                                                        </td>
                                                        <td class="px-3 py-2">
                                                            ${canEdit() ? `<div class="flex gap-2"><button class="edit-document-btn text-blue-500" data-index="${index}"><i data-lucide="edit" class="w-4 h-4"></i></button><button class="delete-document-btn text-red-500" data-index="${index}"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>` : ''}
                                                        </td>
                                                    </tr>`).join('') : `<tr><td colspan="4" class="text-center py-4 text-slate-500">Ù…Ø¯Ø±Ú©ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</td></tr>`}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="tab-personal" class="profile-tab-content">
                            <div class="space-y-4">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-semibold text-slate-700">
                                        <i data-lucide="user-cog" class="ml-2 w-5 h-5 text-gray-600"></i>
                                        Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø³Ù†Ù„ÛŒ
                                    </h4>
                                    ${canEdit() ? `<button id="edit-personal-info-btn" class="text-sm bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700">ÙˆÛŒØ±Ø§ÛŒØ´</button>` : ''}
                                </div>
                                <div class="card p-4 bg-white rounded-xl border border-slate-200">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-slate-700">
                                        <p><strong>Ø¬Ù†Ø³ÛŒØª:</strong> ${emp.gender || '-'}</p>
                                         <p><strong>Ø§ÛŒÙ…ÛŒÙ„:</strong> ${emp.personalInfo?.email || '-'}</p>
                                         <p><strong>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³:</strong> ${emp.personalInfo?.phone || '-'}</p>
                                        <p><strong>ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯:</strong> ${emp.personalInfo?.birthDate ? toPersianDate(emp.personalInfo.birthDate) : '-'}</p>
                                        <p><strong>Ú©Ø¯ Ù…Ù„ÛŒ:</strong> ${emp.personalInfo?.nationalId || '-'}</p>
                                        <p class="md:col-span-2"><strong>Ø¢Ø¯Ø±Ø³:</strong> ${emp.personalInfo?.address || '-'}</p>
                                          <p><strong>Ú©Ø¯ Ù¾Ø³ØªÛŒ:</strong> ${emp.personalInfo?.postalCode || '-'}</p>
                                            <p><strong>Ø´Ù…Ø§Ø±Ù‡ Ø«Ø§Ø¨Øª:</strong> ${emp.personalInfo?.landline || '-'}</p>
                                          <p class="md:col-span-2"><strong>Ù…Ø¯Ø±Ú© ØªØ­ØµÛŒÙ„ÛŒ:</strong> ${emp.personalInfo?.education || '-'}</p>
                                        <p><strong>ÙˆØ¶Ø¹ÛŒØª Ù†Ø¸Ø§Ù… ÙˆØ¸ÛŒÙÙ‡:</strong> ${emp.personalInfo?.militaryStatus || '-'}</p>
                                          <p><strong>ÙˆØ¶Ø¹ÛŒØª ØªØ§Ù‡Ù„:</strong> ${emp.personalInfo?.maritalStatus || '-'}</p>
                                        <p><strong>Ù…Ø®Ø§Ø·Ø¨ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ:</strong> ${emp.personalInfo?.emergencyContactName || '-'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    openModal(mainModal, mainModalContainer);
    setupProfileModalListeners(emp);
};

const viewTeamProfile = (teamId) => {
    const team = state.teams.find(t => t.firestoreId === teamId);
    if (!team) return;
    const leader = state.employees.find(e => e.id === team.leaderId);
    const members = state.employees.filter(e => team.memberIds?.includes(e.id));
    const basicAnalysis = generateTeamSmartAnalysis(team);
    const advancedAnalysis = analyzeTeamData(team, members);

    const highRiskNames = advancedAnalysis.highRiskMembers.map(e => e.name).join('ØŒ ');
    if(highRiskNames) {
        basicAnalysis.risk = { text: `Ø§Ø¹Ø¶Ø§ÛŒ Ù¾Ø±Ø±ÛŒØ³Ú©: <strong>${highRiskNames}</strong>`, icon: 'shield-alert', color: 'text-red-600' };
    }

    modalTitle.innerText = 'Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ØªÛŒÙ…: ' + team.name;
    modalContent.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 space-y-6">
                <div class="card p-6 bg-gray-50 rounded-xl text-center relative group">
                    <div class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-white shadow-md overflow-hidden bg-gray-200 flex items-center justify-center">
                        <img src="${team.avatar}" alt="${team.name}" class="w-full h-full object-cover">
                    </div>
                    ${canEdit() ? `<button id="change-team-avatar-btn" class="absolute top-4 left-4 bg-white p-2 rounded-full shadow-md opacity-0 group-hover:opacity-100 transition-opacity text-slate-500 hover:text-blue-600"><i data-lucide="camera" class="w-4 h-4"></i></button>` : ''}
                    <h2 class="text-2xl font-bold text-gray-800">${team.name}</h2>
                    <p class="text-gray-500">Ø±Ù‡Ø¨Ø± ØªÛŒÙ…: ${leader?.name || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</p>
                </div>
                <div class="card p-6 bg-gray-50 rounded-xl">
                    <h4 class="font-semibold mb-4 text-gray-700 flex items-center"><i data-lucide="brain-circuit" class="ml-2 w-5 h-5 text-purple-500"></i>ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯</h4>
                    <div class="text-sm space-y-3">${Object.keys(basicAnalysis).length > 0 ? Object.values(basicAnalysis).map(item => `<div class="flex items-start"><i data-lucide="${item.icon}" class="w-4 h-4 mt-1 ml-2 flex-shrink-0 ${item.color}"></i><div class="${item.color}">${item.text}</div></div>`).join('') : '<p class="text-sm text-gray-500">Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>'}</div>
                </div>
            </div>
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white rounded-xl shadow-md">
                    <div class="border-b border-gray-200"><nav id="profile-tabs" class="flex -mb-px overflow-x-auto"><button data-tab="team-overview" class="profile-tab active shrink-0">Ù†Ù…Ø§ÛŒ Ú©Ù„ÛŒ</button><button data-tab="team-health" class="profile-tab shrink-0">Ø³Ù„Ø§Ù…Øª ØªÛŒÙ…</button><button data-tab="team-talent" class="profile-tab shrink-0">Ù…Ø§ØªØ±ÛŒØ³ Ø§Ø³ØªØ¹Ø¯Ø§Ø¯</button></nav></div>
                    <div class="p-4">
                        <div id="tab-team-overview" class="profile-tab-content active">
                            <div class="space-y-4">
                                <div class="card p-4 bg-white rounded-xl border border-slate-200">
                                    <div class="flex justify-between items-center mb-3">
                                        <h4 class="font-semibold text-gray-700">Ø§Ø¹Ø¶Ø§ÛŒ ØªÛŒÙ… (${members.length} Ù†ÙØ±)</h4>
                                        <button id="edit-team-members-btn" class="text-sm bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                                    </div>
                                    <div class="flex flex-wrap gap-4">${members.map(m => `<div class="text-center" title="${m.name}"><div class="w-12 h-12 rounded-full mx-auto overflow-hidden bg-gray-200"><img src="${m.avatar}" class="w-full h-full object-cover"></div><p class="text-xs mt-1 truncate w-16">${m.name}</p></div>`).join('')}</div>
                                </div>
                                <div class="card p-4 bg-white rounded-xl border border-slate-200">
                                    <div class="flex justify-between items-center mb-3">
                                        <h4 class="font-semibold text-gray-700">Ø§Ù‡Ø¯Ø§Ù ØªÛŒÙ… (OKRs)</h4>
                                        ${canEdit() ? `<button id="edit-team-okrs-btn" class="text-sm bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700">Ø§ÙØ²ÙˆØ¯Ù†/ÙˆÛŒØ±Ø§ÛŒØ´</button>`:''}
                                    </div>
                                    <div class="space-y-3">${(team.okrs || []).length > 0 ? (team.okrs || []).map(okr => `<div><div class="flex justify-between items-center mb-1 text-sm"><span class="text-gray-600">${okr.title}</span><span class="font-medium text-blue-600">${okr.progress}%</span></div><div class="progress-bar w-full"><div class="progress-bar-fill" style="width: ${okr.progress}%;"></div></div></div>`).join('') : '<p class="text-sm text-gray-500">Ù‡Ø¯ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ØªÛŒÙ… Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>'}</div>
                                </div>
                            </div>
                        </div>
                        <div id="tab-team-health" class="profile-tab-content">
                            ${renderTeamHealthMetrics(team)}
                        </div>
                        <div id="tab-team-talent" class="profile-tab-content">
                            <div class="card p-6 bg-white rounded-xl border border-slate-200">
                                <h4 class="font-semibold mb-3 text-gray-700">ØªÙˆØ²ÛŒØ¹ Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø± ØªÛŒÙ…</h4>
                                <div class="grid grid-cols-3 gap-1 text-center text-xs border-t-2 border-l-2 border-gray-300 mt-4 bg-white">${ generateTeamNineBoxGrid(members) }</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    openModal(mainModal, mainModalContainer);
    setupTeamProfileModalListeners(team);
};
        // --- NAVIGATION & ROUTING ---
        const navigateTo = (pageName) => {
            state.currentPage = pageName;
            window.location.hash = pageName;
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.toggle('active', item.getAttribute('href') === `#${pageName}`);
            });
            renderPage(pageName);
        };

        const router = () => {
            const hash = window.location.hash;
            if (hash.startsWith('#survey-taker')) {
                const urlParams = new URLSearchParams(hash.split('?')[1]);
                const surveyId = urlParams.get('id');
                renderSurveyTakerPage(surveyId);
            } else {
                const pageName = hash.substring(1) || 'dashboard';
                navigateTo(pageName);
            }
        };

        const renderPage = (pageName) => {
            try {
                if (!state.currentUser) {
                    showLoginPage();
                    return;
                }
                
                document.getElementById('settings-nav-link').style.display = isAdmin() ? 'flex' : 'none';

                mainContent.innerHTML = pages[pageName]();
                
                if (pageName === 'dashboard') { renderDashboardCharts(); setupDashboardListeners(); }
                if (pageName === 'talent') { renderEmployeeTable(); setupTalentPageListeners(); }
                if (pageName === 'organization') { setupOrganizationPageListeners(); }
                if (pageName === 'surveys') { setupSurveysPageListeners(); }
                if (pageName === 'expenses') { setupExpensesPageListeners(); }
                if (pageName === 'analytics') { setupAnalyticsPage(); }
                if (pageName === 'settings') {
                    if(isAdmin()) {
                        setupSettingsPageListeners();
                    }
                }
                lucide.createIcons();
            } catch (error) {
                console.error("Failed to render page:", pageName, error);
                mainContent.innerHTML = `<div class="text-red-600 text-center p-8"><h1>Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡</h1><p>${error.message}</p></div>`;
            }
        };

        // --- CHART RENDERING FUNCTIONS ---
        const destroyCharts = () => { Object.values(charts).forEach(chart => chart?.destroy()); charts = {}; };
const renderDashboardCharts = () => {
    destroyCharts();
    const metrics = state.dashboardMetrics;
    if (Object.keys(metrics).length === 0) return;

    // --- Ù†Ù…ÙˆØ¯Ø§Ø± Ø¬Ø¯ÛŒØ¯ Ùˆ Ø²ÛŒØ¨Ø§ÛŒ Ø§Ù…ØªÛŒØ§Ø² Ù…Ø´Ø§Ø±Ú©Øª ---
    const engagementFocusCtx = document.getElementById('engagementFocusChart')?.getContext('2d');
    if (engagementFocusCtx) {
        const score = metrics.engagementScore || 0;
        const engagementText = document.getElementById('engagement-focus-text');
        if (engagementText) {
            if (score >= 85) engagementText.innerText = "ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡! Ú©Ø§Ø±Ú©Ù†Ø§Ù† Ø´Ù…Ø§ Ø¨Ø³ÛŒØ§Ø± Ù…Ø´Ø§Ø±Ú©Øª Ø¯Ø§Ø±Ù†Ø¯.";
            else if (score >= 70) engagementText.innerText = "ÙˆØ¶Ø¹ÛŒØª Ø®ÙˆØ¨ Ø§Ø³ØªØŒ Ø¬Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØª ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯.";
            else if (score >= 50) engagementText.innerText = "Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙˆØ¬Ù‡ Ùˆ Ø¨Ù‡Ø¨ÙˆØ¯ ÙØ±Ø¢ÛŒÙ†Ø¯Ù‡Ø§.";
            else engagementText.innerText = "Ù‡Ø´Ø¯Ø§Ø±! Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ù‚Ø¯Ø§Ù… ÙÙˆØ±ÛŒ.";
        }
        
        charts.engagementFocus = new Chart(engagementFocusCtx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [score, 100 - score],
                    backgroundColor: ['#ffffff', 'rgba(255, 255, 255, 0.2)'],
                    borderWidth: 0,
                    borderRadius: 20,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '80%',
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                animation: { animateRotate: true, animateScale: false }
            }
        });
    }

    // --- 4 Ù†Ù…ÙˆØ¯Ø§Ø± ØªØ­Ù„ÛŒÙ„ Ù†ÛŒØ±ÙˆÛŒ Ú©Ø§Ø± ---
    const genderCtx = document.getElementById('genderCompositionChart')?.getContext('2d');
    if (genderCtx && metrics.genderComposition) {
        charts.gender = new Chart(genderCtx, { type: 'pie', data: { labels: Object.keys(metrics.genderComposition), datasets: [{ data: Object.values(metrics.genderComposition), backgroundColor: ['#3b82f6', '#f43f5e', '#94a3b8'], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels:{font:{size: 10}} } } } });
    }

    const departmentCtx = document.getElementById('departmentDistributionChart')?.getContext('2d');
    if (departmentCtx) {
        charts.department = new Chart(departmentCtx, { type: 'bar', data: { labels: Object.keys(metrics.departmentDistribution), datasets: [{ label: 'ØªØ¹Ø¯Ø§Ø¯', data: Object.values(metrics.departmentDistribution), backgroundColor: '#10b981', borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } } });
    }
    
    const tenureCtx = document.getElementById('tenureDistributionChart')?.getContext('2d');
    const tenureData = state.employees.reduce((acc, emp) => { if (!emp.startDate) return acc; const years = (new Date() - new Date(emp.startDate)) / (1000 * 60 * 60 * 24 * 365); if (years < 2) acc['Ú©Ù…ØªØ± Ø§Ø² Û² Ø³Ø§Ù„'] = (acc['Ú©Ù…ØªØ± Ø§Ø² Û² Ø³Ø§Ù„'] || 0) + 1; else if (years < 5) acc['Û² ØªØ§ Ûµ Ø³Ø§Ù„'] = (acc['Û² ØªØ§ Ûµ Ø³Ø§Ù„'] || 0) + 1; else acc['Ø¨ÛŒØ´ Ø§Ø² Ûµ Ø³Ø§Ù„'] = (acc['Ø¨ÛŒØ´ Ø§Ø² Ûµ Ø³Ø§Ù„'] || 0) + 1; return acc; }, {});
    if (tenureCtx) {
        charts.tenure = new Chart(tenureCtx, { type: 'pie', data: { labels: Object.keys(tenureData), datasets: [{ data: Object.values(tenureData), backgroundColor: ['#facc15', '#f97316', '#ef4444'], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels:{font:{size: 10}} } } } });
    }

    const ageCtx = document.getElementById('ageDistributionChart')?.getContext('2d');
    const ageData = state.employees.reduce((acc, emp) => { if (!emp.personalInfo?.birthDate) return acc; const age = new Date().getFullYear() - new Date(emp.personalInfo.birthDate).getFullYear(); if (age < 30) acc['Ø²ÛŒØ± Û³Û° Ø³Ø§Ù„'] = (acc['Ø²ÛŒØ± Û³Û° Ø³Ø§Ù„'] || 0) + 1; else if (age <= 45) acc['Û³Û±-Û´Ûµ Ø³Ø§Ù„'] = (acc['Û³Û±-Û´Ûµ Ø³Ø§Ù„'] || 0) + 1; else acc['Ø¨Ø§Ù„Ø§ÛŒ Û´Ûµ Ø³Ø§Ù„'] = (acc['Ø¨Ø§Ù„Ø§ÛŒ Û´Ûµ Ø³Ø§Ù„'] || 0) + 1; return acc; }, {});
    if (ageCtx) {
        charts.age = new Chart(ageCtx, { type: 'bar', data: { labels: Object.keys(ageData), datasets: [{ label: 'ØªØ¹Ø¯Ø§Ø¯', data: Object.values(ageData), backgroundColor: '#e879f9', borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } } });
    }

    // --- Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† 2 Ù†Ù…ÙˆØ¯Ø§Ø± Ø­Ø°Ù Ø´Ø¯Ù‡ ---
    const nineBoxCtx = document.getElementById('nineBoxChart')?.getContext('2d');
    if (nineBoxCtx && metrics.nineBoxDistribution) {
        charts.nineBox = new Chart(nineBoxCtx, { type: 'bar', data: { labels: Object.keys(metrics.nineBoxDistribution), datasets: [{ label: 'ØªØ¹Ø¯Ø§Ø¯', data: Object.values(metrics.nineBoxDistribution), backgroundColor: '#6366f1', borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { ticks: { font: { size: 9 } } } } } });
    }

    const teamCompetencyCtx = document.getElementById('teamCompetencyRadarChart')?.getContext('2d');
    const competencyScores = {};
    state.teams.forEach(team => { team.memberIds?.forEach(memberId => { const member = state.employees.find(e => e.id === memberId); if (member && member.competencies) { Object.entries(member.competencies).forEach(([name, score]) => { if (!competencyScores[name]) { competencyScores[name] = { total: 0, count: 0 }; } competencyScores[name].total += score; competencyScores[name].count++; }); } }); });
    const avgCompetencies = Object.entries(competencyScores).reduce((acc, [name, data]) => { acc[name] = data.count > 0 ? (data.total / data.count).toFixed(1) : 0; return acc; }, {});
    if (teamCompetencyCtx && Object.keys(avgCompetencies).length > 0) {
        charts.teamCompetency = new Chart(teamCompetencyCtx, { type: 'radar', data: { labels: Object.keys(avgCompetencies), datasets: [{ label: 'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²', data: Object.values(avgCompetencies), fill: true, backgroundColor: 'rgba(22, 163, 74, 0.2)', borderColor: '#16a34a', pointBackgroundColor: '#16a34a' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { r: { suggestedMin: 0, suggestedMax: 5, ticks: { stepSize: 1, display: false } } }, plugins: { legend: { display: false } } } });
    }
};

const renderEngagementGauge = (canvasId, score) => {
    const gaugeCtx = document.getElementById(canvasId)?.getContext('2d');
    if(gaugeCtx) { 
        if(charts[canvasId]) charts[canvasId].destroy();
        charts[canvasId] = new Chart(gaugeCtx, { 
            type: 'doughnut', 
            data: { 
                datasets: [{ 
                    data: [score, 100 - score], 
                    backgroundColor: ['#22c55e', '#e5e7eb'], 
                    borderWidth: 0, 
                    circumference: 180, 
                    rotation: 270, 
                }] 
            }, 
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { 
                    legend: { display: false }, 
                    tooltip: { enabled: false } 
                }, 
                cutout: '80%'
            } 
        }); 
    }
};
       
        const renderSkillRadarChart = (canvasId, skills) => {
            const skillCtx = document.getElementById(canvasId)?.getContext('2d');
            if (skillCtx) { if(charts[canvasId]) charts[canvasId].destroy(); charts[canvasId] = new Chart(skillCtx, { type: 'radar', data: { labels: Object.keys(skills), datasets: [{ label: 'Ø³Ø·Ø­ Ù…Ù‡Ø§Ø±Øª', data: Object.values(skills), fill: true, backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: 'rgb(59, 130, 246)' }] }, options: { scales: { r: { suggestedMin: 0, suggestedMax: 5, ticks: { stepSize: 1 } } } } }); }
        };

        // --- PAGE-SPECIFIC LOGIC ---
const renderAllReminders = () => {
    const allReminders = [];
    const now = new Date();
    // Ø¨Ø±Ø§ÛŒ Ø¯Ù‚Øª Ø¨ÛŒØ´ØªØ±ØŒ Ø³Ø§Ø¹Øª Ø±Ø§ ØµÙØ± Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ ÙÙ‚Ø· Ø±ÙˆØ²Ù‡Ø§ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø´ÙˆÙ†Ø¯
    now.setHours(0, 0, 0, 0); 
    const oneDay = 1000 * 60 * 60 * 24;

    // --- Ø¨Ø®Ø´ Û±: ÛŒØ§Ø¯Ø¢ÙˆØ±Ù‡Ø§ÛŒ Ø¯Ø³ØªÛŒ Ùˆ ÙÛŒÙ„ØªØ± Ø´Ø¯Ù‡ ---
    state.reminders.forEach(reminder => {
        const eventDate = new Date(reminder.date);
        eventDate.setHours(0, 0, 0, 0);

        const daysUntilEvent = Math.round((eventDate - now) / oneDay);
        // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ù…Ù‚Ø¯Ø§Ø±ÛŒ ØªØ¹ÛŒÛŒÙ† Ù†Ú©Ø±Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Û³Û° Ø±ÙˆØ² Ø¯Ø± Ù†Ø¸Ø± Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        const daysBefore = reminder.daysBefore ?? 30; 

        // Ø´Ø±Ø· Ø¬Ø¯ÛŒØ¯: ÙÙ‚Ø· Ø§Ú¯Ø± Ø²Ù…Ø§Ù† Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¯Ø± Ø¨Ø§Ø²Ù‡ ØªØ¹ÛŒÛŒÙ† Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
        if (daysUntilEvent >= 0 && daysUntilEvent <= daysBefore) {
            allReminders.push({
                date: eventDate,
                text: reminder.text,
                subtext: daysUntilEvent === 0 ? 'Ø§Ù…Ø±ÙˆØ²' : `Ø¯Ø± ${daysUntilEvent} Ø±ÙˆØ² Ø¯ÛŒÚ¯Ø±`,
                icon: 'calendar-plus',
                color: 'indigo'
            });
        }
    });

    // --- Ø¨Ø®Ø´ Û²: Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ùˆ Ø®ÙˆØ¯Ú©Ø§Ø± ---
    const reminderWindowDays = 30;
    state.employees.forEach(emp => {
        if (emp.status !== 'ÙØ¹Ø§Ù„') return;

        // Ø±ÙˆÛŒØ¯Ø§Ø¯: Ø§ØªÙ…Ø§Ù… Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ (Ø¯Ø± Û¹Û° Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡)
        if (emp.contractEndDate) {
            const endDate = new Date(emp.contractEndDate);
            const daysUntilEnd = Math.round((endDate - now) / oneDay);
            if (daysUntilEnd >= 0 && daysUntilEnd <= 90) {
                allReminders.push({
                    date: endDate,
                    text: `ØªÙ…Ø¯ÛŒØ¯ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯: ${emp.name}`,
                    subtext: `ØªØ§Ø±ÛŒØ® Ø§ØªÙ…Ø§Ù…: ${toPersianDate(endDate)}`,
                    icon: 'file-clock',
                    color: 'yellow'
                });
            }
        }

        // Ø±ÙˆÛŒØ¯Ø§Ø¯: ØªÙˆÙ„Ø¯ (Ø¯Ø± Û³ Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡)
        if (emp.personalInfo?.birthDate) {
            const birthDate = new Date(emp.personalInfo.birthDate);
            const nextBirthday = new Date(now.getFullYear(), birthDate.getMonth(), birthDate.getDate());
            if (nextBirthday < now) {
                nextBirthday.setFullYear(now.getFullYear() + 1);
            }
            const daysUntilBirthday = Math.round((nextBirthday - now) / oneDay);
            if (daysUntilBirthday >= 0 && daysUntilBirthday <= 3) {
                allReminders.push({
                    date: nextBirthday,
                    text: `ØªÙˆÙ„Ø¯: ${emp.name}`,
                    subtext: `ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯: ${toPersianDate(nextBirthday)}`,
                    icon: 'cake',
                    color: 'pink'
                });
            }
        }

        // Ø±ÙˆÛŒØ¯Ø§Ø¯: Ø³Ø§Ù„Ú¯Ø±Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… (Ø¯Ø± Û³Û° Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡)
        if (emp.startDate) {
            const startDate = new Date(emp.startDate);
            const yearsOfWork = now.getFullYear() - startDate.getFullYear();
            const nextAnniversary = new Date(now.getFullYear(), startDate.getMonth(), startDate.getDate());
            if (nextAnniversary < now) {
                nextAnniversary.setFullYear(now.getFullYear() + 1);
            }
            const daysUntilAnniversary = Math.round((nextAnniversary - now) / oneDay);
            if (daysUntilAnniversary >= 0 && daysUntilAnniversary <= reminderWindowDays && yearsOfWork > 0) {
                allReminders.push({
                    date: nextAnniversary,
                    text: `${yearsOfWork + 1}Ù…ÛŒÙ† Ø³Ø§Ù„Ú¯Ø±Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù…: ${emp.name}`,
                    subtext: `ØªØ§Ø±ÛŒØ® Ø§Ø³ØªØ®Ø¯Ø§Ù…: ${toPersianDate(emp.startDate)}`,
                    icon: 'award',
                    color: 'blue'
                });
            }
        }

        // Ø±ÙˆÛŒØ¯Ø§Ø¯: Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù…Ø¹ÙˆÙ‚ (Ø¨ÛŒØ´ Ø§Ø² Û¶ Ù…Ø§Ù‡ Ú¯Ø°Ø´ØªÙ‡)
        if (emp.performanceHistory && emp.performanceHistory.length > 0) {
            const lastReviewDate = new Date(emp.performanceHistory.slice(-1)[0].reviewDate);
            const monthsSinceReview = (now - lastReviewDate) / (oneDay * 30.44);
            if (monthsSinceReview > 6) {
                allReminders.push({
                    date: new Date(now.getTime() + oneDay), // ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ ÙØ±Ø¯Ø§ Ø¯Ø± Ù†Ø¸Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯
                    text: `Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù…Ø¹ÙˆÙ‚: ${emp.name}`,
                    subtext: `Ø¢Ø®Ø±ÛŒÙ† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ: ${toPersianDate(lastReviewDate)}`,
                    icon: 'clipboard-x',
                    color: 'teal'
                });
            }
        }
        
        // Ø±ÙˆÛŒØ¯Ø§Ø¯: Ù¾ÛŒÚ¯ÛŒØ±ÛŒ ØªØ°Ú©Ø± Ø§Ù†Ø¶Ø¨Ø§Ø·ÛŒ
        if (emp.disciplinaryHistory && emp.disciplinaryHistory.length > 0) {
            const lastAction = emp.disciplinaryHistory.slice(-1)[0];
            if (lastAction.type === 'ØªØ°Ú©Ø±') {
                const actionDate = new Date(lastAction.date);
                const followupDate = new Date(actionDate.setDate(actionDate.getDate() + 30));
                const daysUntilFollowup = (followupDate - now) / oneDay;
                if (daysUntilFollowup >= 0 && daysUntilFollowup <= reminderWindowDays) {
                    allReminders.push({
                        date: followupDate,
                        text: `Ù¾ÛŒÚ¯ÛŒØ±ÛŒ ØªØ°Ú©Ø± Ø§Ù†Ø¶Ø¨Ø§Ø·ÛŒ: ${emp.name}`,
                        subtext: `ØªØ§Ø±ÛŒØ® Ù¾ÛŒÚ¯ÛŒØ±ÛŒ: ${toPersianDate(followupDate)}`,
                        icon: 'message-square-plus',
                        color: 'gray'
                    });
                }
            }
        }
    });

    // --- Ø¨Ø®Ø´ Û³: Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ù†Ù‡Ø§ÛŒÛŒ ---
    allReminders.sort((a, b) => a.date - b.date);

    if (allReminders.length === 0) {
        return '<p class="text-sm text-gray-500 text-center">Ù‡ÛŒÚ† ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ ÙØ¹Ø§Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>';
    }

    const colorClasses = {
        yellow: { bg: 'bg-yellow-50', text: 'text-yellow-600' },
        indigo: { bg: 'bg-indigo-50', text: 'text-indigo-600' },
        pink: { bg: 'bg-pink-50', text: 'text-pink-600' },
        blue: { bg: 'bg-blue-50', text: 'text-blue-600' },
        teal: { bg: 'bg-teal-50', text: 'text-teal-600' },
        gray: { bg: 'bg-gray-100', text: 'text-gray-600' }
    };

    return allReminders.map(r => {
        const colors = colorClasses[r.color] || colorClasses.indigo;
        return `<div class="flex items-start p-3 ${colors.bg} rounded-xl border border-transparent hover:border-blue-200 transition">
            <i data-lucide="${r.icon}" class="w-5 h-5 ${colors.text} ml-3 mt-1 flex-shrink-0"></i>
            <div>
                <p class="font-medium text-sm">${r.text}</p>
                <p class="text-xs text-gray-500 mt-0.5">${r.subtext || `ØªØ§Ø±ÛŒØ®: ${toPersianDate(r.date)}`}</p>
            </div>
        </div>`;
    }).join('');
};
        const setupDashboardListeners = () => {
    // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† ØªÙ‚ÙˆÛŒÙ… Ø´Ù…Ø³ÛŒ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„Ø¯ ÛŒØ§Ø¯Ø¢ÙˆØ± Ø¯Ø± Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
    activatePersianDatePicker('reminderDate');

document.getElementById('addReminderBtn')?.addEventListener('click', async () => {
    const textInput = document.getElementById('reminderText');
    const dateInput = document.getElementById('reminderDate');
    const daysBeforeInput = document.getElementById('reminderDaysBefore');

    if (textInput.value && dateInput.value) {
        try {
            const gregorianDate = persianToEnglishDate(dateInput.value);
            if (!gregorianDate) {
                showToast("ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª.", "error");
                return;
            }

            // Ù…Ù‚Ø¯Ø§Ø± Ø±ÙˆØ² Ø±Ø§ Ø§Ø² ÙÛŒÙ„Ø¯ Ø¬Ø¯ÛŒØ¯ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù†ÛŒÙ…
            const daysBefore = parseInt(daysBeforeInput.value) || 7; // Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Û· Ø±ÙˆØ² Ø§Ø³Øª

            await addDoc(collection(db, `artifacts/${appId}/public/data/reminders`), {
                text: textInput.value,
                date: gregorianDate,
                daysBefore: daysBefore // ÙÛŒÙ„Ø¯ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            });

            textInput.value = '';
            dateInput.value = '';
            daysBeforeInput.value = '7'; // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶
            showToast("ÛŒØ§Ø¯Ø¢ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.");
        } catch (error) {
            console.error("Error adding reminder:", error);
            showToast("Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† ÛŒØ§Ø¯Ø¢ÙˆØ±.", "error");
        }
    }
});
};
const renderEmployeeTable = () => {
    const TALENT_PAGE_SIZE = 12;
    const searchInput = document.getElementById('searchInput')?.value.toLowerCase() || '';
    const departmentFilter = document.getElementById('departmentFilter')?.value || '';
    const statusFilter = document.getElementById('statusFilter')?.value || '';
    
    const filteredEmployees = state.employees.filter(emp =>
        (emp.name.toLowerCase().includes(searchInput) || emp.id.toLowerCase().includes(searchInput)) &&
        (!departmentFilter || emp.department === departmentFilter) &&
        (!statusFilter || emp.status === statusFilter)
    );

    const startIndex = (state.currentPageTalent - 1) * TALENT_PAGE_SIZE;
    const endIndex = startIndex + TALENT_PAGE_SIZE;
    const paginatedEmployees = filteredEmployees.slice(startIndex, endIndex);
    
    const container = document.getElementById('employee-cards-container');
    if (container) {
        if (paginatedEmployees.length === 0) {
            container.innerHTML = `<div class="col-span-full text-center py-10"><i data-lucide="user-x" class="mx-auto w-12 h-12 text-slate-400"></i><p class="mt-2 text-slate-500">Ù‡ÛŒÚ† Ú©Ø§Ø±Ù…Ù†Ø¯ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ù…Ø´Ø®ØµØ§Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.</p></div>`;
            lucide.createIcons();
        } else {
            container.innerHTML = paginatedEmployees.map(emp => {
                const isComplete = isProfileComplete(emp);
                const riskScore = emp.attritionRisk?.score || 0;
                let riskColorClass = 'bg-green-500';
                if (riskScore > 70) riskColorClass = 'bg-red-500';
                else if (riskScore > 40) riskColorClass = 'bg-yellow-500';

                return `
                    <div class="card bg-white p-4 flex flex-col text-center items-center rounded-xl shadow-lg transform hover:-translate-y-1 transition-transform duration-300">
                        <div class="absolute top-3 right-3 w-3 h-3 rounded-full ${riskColorClass}" title="Ø±ÛŒØ³Ú© Ø®Ø±ÙˆØ¬: ${riskScore}%"></div>

                        <img src="${emp.avatar}" alt="${emp.name}" class="w-24 h-24 rounded-full object-cover border-4 border-slate-100 mt-4">
                        
                        <h3 class="font-bold text-lg mt-3 text-slate-800">${emp.name}</h3>
                        <p class="text-sm text-slate-500">${emp.jobTitle || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù† Ø´ØºÙ„ÛŒ'}</p>
                        
                        <div class="mt-4 flex items-center gap-2 text-xs">
                            <span class="px-2 py-1 font-medium rounded-full ${emp.status === 'ÙØ¹Ø§Ù„' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${emp.status}</span>
                            <span class="px-2 py-1 font-medium rounded-full ${isComplete ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${isComplete ? 'Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ù…Ù„' : 'Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù†Ø§Ù‚Øµ'}
                            </span>
                        </div>

                        <div class="mt-auto pt-4 w-full flex items-center justify-end gap-2 border-t border-slate-100">
                            <button class="view-employee-profile-btn flex-grow text-sm bg-slate-800 text-white py-2 px-4 rounded-lg hover:bg-slate-900 transition" data-employee-id="${emp.firestoreId}">
                                Ù…Ø´Ø§Ù‡Ø¯Ù‡
                            </button>
                            ${canEdit() ? `<button class="edit-employee-btn p-2 text-slate-400 hover:text-blue-500 transition-colors" data-employee-id="${emp.firestoreId}" title="ÙˆÛŒØ±Ø§ÛŒØ´"><i data-lucide="edit" class="w-5 h-5"></i></button>` : ''}
                            ${isAdmin() ? `<button class="delete-employee-btn p-2 text-slate-400 hover:text-rose-500 transition-colors" data-employee-id="${emp.firestoreId}" title="Ø­Ø°Ù"><i data-lucide="trash-2" class="w-5 h-5"></i></button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
    }

    renderPagination('pagination-container', state.currentPageTalent, filteredEmployees.length, TALENT_PAGE_SIZE);
};
        const exportToCSV = () => {
    // Û±. Ù‡Ù…Ø§Ù† Ù…Ù†Ø·Ù‚ ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù† Ø±Ø§ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ù„ÛŒØ³Øª ÙØ¹Ù„ÛŒ Ø±Ø§ Ø¨Ú¯ÛŒØ±ÛŒÙ…
    const searchInput = document.getElementById('searchInput')?.value.toLowerCase() || '';
    const departmentFilter = document.getElementById('departmentFilter')?.value || '';
    const statusFilter = document.getElementById('statusFilter')?.value || '';
    
    const filteredEmployees = state.employees.filter(emp =>
        (emp.name.toLowerCase().includes(searchInput) || emp.id.toLowerCase().includes(searchInput)) &&
        (!departmentFilter || emp.department === departmentFilter) &&
        (!statusFilter || emp.status === statusFilter)
    );

    if (filteredEmployees.length === 0) {
        showToast("Ù‡ÛŒÚ† Ú©Ø§Ø±Ù…Ù†Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ† ÛŒØ§ÙØª Ù†Ø´Ø¯.", "error");
        return;
    }

    // Û². Ø³Ø±ØªÛŒØªØ±Ù‡Ø§ÛŒ ÙØ§ÛŒÙ„ CSV Ø±Ø§ ØªØ¹Ø±ÛŒÙ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    const headers = [
        "Ù†Ø§Ù…", "Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ", "Ø¹Ù†ÙˆØ§Ù† Ø´ØºÙ„ÛŒ", "Ø§ÛŒÙ…ÛŒÙ„", "Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„",
        "Ø´Ù…Ø§Ø±Ù‡ Ø«Ø§Ø¨Øª", "Ú©Ø¯ Ù…Ù„ÛŒ", "ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯", "ÙˆØ¶Ø¹ÛŒØª ØªØ§Ù‡Ù„", "Ù…Ø¯Ø±Ú© ØªØ­ØµÛŒÙ„ÛŒ",
        "Ø¢Ø¯Ø±Ø³", "Ú©Ø¯ Ù¾Ø³ØªÛŒ"
    ];
    
    // Û³. Ù‡Ø± Ú©Ø§Ø±Ù…Ù†Ø¯ Ø±Ø§ Ø¨Ù‡ ÛŒÚ© Ø±Ø¯ÛŒÙ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    const rows = filteredEmployees.map(emp => {
        const info = emp.personalInfo || {};
        // Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¨Ù‡ Ù‡Ù… Ø±ÛŒØ®ØªÙ† CSV Ø¨Ø§ Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ Ø®Ø§ØµØŒ Ù‡Ø± Ù…Ù‚Ø¯Ø§Ø± Ø±Ø§ Ø¯Ø§Ø®Ù„ "" Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
        const cleanValue = (val) => `"${(val || '').toString().replace(/"/g, '""')}"`;

        return [
            cleanValue(emp.name),
            cleanValue(emp.id),
            cleanValue(emp.jobTitle),
            cleanValue(info.email),
            cleanValue(info.phone),
            cleanValue(info.landline),
            cleanValue(info.nationalId),
            info.birthDate ? cleanValue(toPersianDate(info.birthDate)) : '""',
            cleanValue(info.maritalStatus),
            cleanValue(info.education),
            cleanValue(info.address), 
            cleanValue(info.postalCode)
        ].join(','); // Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø§ ÙˆÛŒØ±Ú¯ÙˆÙ„ Ø¬Ø¯Ø§ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    });

    // Û´. Ù…Ø­ØªÙˆØ§ÛŒ Ú©Ø§Ù…Ù„ ÙØ§ÛŒÙ„ CSV Ø±Ø§ Ù…ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ…
    const csvContent = "data:text/csv;charset=utf-8,\uFEFF" // \uFEFF Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ø¯Ø± Ø§Ú©Ø³Ù„
        + headers.join(',') + '\n'
        + rows.join('\n');

    // Ûµ. ÙØ§ÛŒÙ„ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¢Ù…Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "employees_export.csv");
    document.body.appendChild(link);

    link.click(); // Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„
    document.body.removeChild(link);
};
        const exportTransactionsToCSV = () => {
    const startDateStr = persianToEnglishDate(document.getElementById('start-date-filter').value);
    const endDateStr = persianToEnglishDate(document.getElementById('end-date-filter').value);

    const startDate = startDateStr ? new Date(startDateStr) : null;
    if(startDate) startDate.setHours(0, 0, 0, 0);

    const endDate = endDateStr ? new Date(endDateStr) : null;
    if(endDate) endDate.setHours(23, 59, 59, 999);

    const expensesWithDetails = state.expenses.map(exp => ({ ...exp, type: 'Ù‡Ø²ÛŒÙ†Ù‡' }));
    const chargesWithDetails = state.chargeHistory.map(chg => ({ ...chg, type: 'Ø´Ø§Ø±Ú˜', date: chg.chargedAt?.toDate(), item: `Ø´Ø§Ø±Ú˜ Ú©Ø§Ø±Øª ${chg.cardName}` }));
    const allTransactions = [...expensesWithDetails, ...chargesWithDetails]
        .filter(t => t.date)
        .sort((a, b) => new Date(b.date) - new Date(a.date));

    const filteredTransactions = allTransactions.filter(t => {
        const transactionDate = new Date(t.date);
        if (startDate && endDate) {
            return transactionDate >= startDate && transactionDate <= endDate;
        }
        if (startDate) {
            return transactionDate >= startDate;
        }
        if (endDate) {
            return transactionDate <= endDate;
        }
        return true;
    });

    if (filteredTransactions.length === 0) {
        showToast("Ù‡ÛŒÚ† ØªØ±Ø§Ú©Ù†Ø´ÛŒ Ø¯Ø± Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.", "error");
        return;
    }

    const headers = ["ØªØ§Ø±ÛŒØ®", "Ù†ÙˆØ¹", "Ø´Ø±Ø­", "Ú©Ø§Ø±Øª", "Ù…Ø¨Ù„Øº"];
    const rows = filteredTransactions.map(t => {
        const cardName = t.type === 'Ù‡Ø²ÛŒÙ†Ù‡' ? (state.pettyCashCards.find(c => c.firestoreId === t.cardId)?.name || '') : t.cardName;
        const amount = t.type === 'Ù‡Ø²ÛŒÙ†Ù‡' ? -t.amount : t.amount;
        const cleanValue = val => `"${(val || '').toString().replace(/"/g, '""')}"`;
        return [
            cleanValue(toPersianDate(t.date)),
            cleanValue(t.type),
            cleanValue(t.item),
            cleanValue(cardName),
            amount
        ].join(',');
    });

    const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + headers.join(',') + '\n' + rows.join('\n');
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "transactions_export.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};
const setupTalentPageListeners = () => {
    // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† ØµÙØ­Ù‡ Ø¨Ù‡ Û± Ù‡Ù†Ú¯Ø§Ù… Ø¬Ø³ØªØ¬Ùˆ ÛŒØ§ ÙÛŒÙ„ØªØ±
    const resetToFirstPage = () => {
        state.currentPageTalent = 1;
        renderEmployeeTable();
    };

    document.getElementById('searchInput')?.addEventListener('input', resetToFirstPage);
    document.getElementById('departmentFilter')?.addEventListener('change', resetToFirstPage);
    document.getElementById('statusFilter')?.addEventListener('change', resetToFirstPage);
    
    // Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡ Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¨Ù‡ ØªØ§Ø¨Ø¹ Ù…Ø±Ø¨ÙˆØ·Ù‡
    document.getElementById('add-employee-btn')?.addEventListener('click', () => showEmployeeForm());
    
    // Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡ Ø®Ø±ÙˆØ¬ÛŒ CSV Ø¨Ù‡ ØªØ§Ø¨Ø¹ Ù…Ø±Ø¨ÙˆØ·Ù‡
    document.getElementById('export-csv-btn')?.addEventListener('click', exportToCSV);

    // Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ (Ù…Ø´Ø§Ù‡Ø¯Ù‡ØŒ ÙˆÛŒØ±Ø§ÛŒØ´ØŒ Ø­Ø°Ù)
    const mainContentArea = document.getElementById('main-content');
    
    mainContentArea.addEventListener('click', (e) => {
        const viewEmpBtn = e.target.closest('.view-employee-profile-btn');
        const editEmpBtn = e.target.closest('.edit-employee-btn');
        const deleteEmpBtn = e.target.closest('.delete-employee-btn');
        const paginationBtn = e.target.closest('.pagination-btn');

        if (paginationBtn && !paginationBtn.disabled) {
            state.currentPageTalent = Number(paginationBtn.dataset.page);
            renderEmployeeTable();
        }

        if (viewEmpBtn) {
            viewEmployeeProfile(viewEmpBtn.dataset.employeeId);
        } else if (editEmpBtn) {
            showEmployeeForm(editEmpBtn.dataset.employeeId);
        } else if (deleteEmpBtn) {
            showConfirmationModal("Ø­Ø°Ù Ú©Ø§Ø±Ù…Ù†Ø¯", "Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ú©Ø§Ø±Ù…Ù†Ø¯ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ", async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/employees`, deleteEmpBtn.dataset.employeeId));
                    showToast("Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.");
                } catch (error) {
                    console.error("Error deleting employee:", error);
                    showToast("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú©Ø§Ø±Ù…Ù†Ø¯.", "error");
                }
            });
        }
    });
};
// Ú©Ù„ Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø±Ø§ Ø¨Ø§ Ù†Ø³Ø®Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯
const setupOrganizationPageListeners = () => {
    document.getElementById('add-team-btn')?.addEventListener('click', () => showTeamForm());
    document.getElementById('add-team-btn-empty')?.addEventListener('click', () => showTeamForm());

    // Ø§Ø² Ø´Ù†Ø§Ø³Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    const teamsContainer = document.getElementById('teams-container');
    if(teamsContainer) {
        teamsContainer.addEventListener('click', (e) => {
            const viewTeamBtn = e.target.closest('.view-team-profile-btn');
            const deleteTeamBtn = e.target.closest('.delete-team-btn');

            if (viewTeamBtn) {
                viewTeamProfile(viewTeamBtn.dataset.teamId);
            } else if (deleteTeamBtn) {
                showConfirmationModal("Ø­Ø°Ù ØªÛŒÙ…", "Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ØªÛŒÙ… Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ", async () => { 
                    try { 
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/teams`, deleteTeamBtn.dataset.teamId)); 
                        showToast("ØªÛŒÙ… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯."); 
                    } catch (error) { 
                        console.error("Error deleting team:", error); 
                        showToast("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ØªÛŒÙ….", "error"); 
                    } 
                });
            }
        });
    }
};
const setupSettingsPageListeners = () => {
    const mainContentArea = document.getElementById('main-content');
    if (!mainContentArea) return;

    // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ú©Ù„ÛŒÚ© Ø¯Ø± Ú©Ù„ ØµÙØ­Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ---
    mainContentArea.addEventListener('click', (e) => {
        const addUserBtn = e.target.closest('#add-user-btn');
        const editUserBtn = e.target.closest('.edit-user-btn');
        const deleteUserBtn = e.target.closest('.delete-user-btn');
        const deleteCompetencyBtn = e.target.closest('.delete-competency-btn');
        
        if (addUserBtn) {
            showAddUserForm();
        }

        if (editUserBtn) {
            const user = state.users.find(u => u.firestoreId === editUserBtn.dataset.uid);
            if(user) showEditUserForm(user);
        }

        if (deleteUserBtn) {
            const userToDelete = state.users.find(u => u.firestoreId === deleteUserBtn.dataset.uid);
            showConfirmationModal('Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø±', `Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø± "${userToDelete.name || userToDelete.email}" Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.`, async () => {
                showToast("Ø¯Ø± Ø­Ø§Ù„ Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø±... Ø§ÛŒÙ† Ø¹Ù…Ù„ Ø¯Ø± Firebase Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù…Ø¬Ø¯Ø¯ Ø§Ø³Øª Ùˆ Ø¯Ø± Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø³Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª.", "error");
                // Ù†Ú©ØªÙ‡: Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯Ø± ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ø¨Ù‡ Ø¯Ù„Ø§ÛŒÙ„ Ø§Ù…Ù†ÛŒØªÛŒ Ù¾ÛŒÚ†ÛŒØ¯Ù‡ Ø§Ø³Øª Ùˆ Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ø§Ø² Ø·Ø±ÛŒÙ‚ Cloud Functions Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯.
                // Ø¯Ø± Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ØŒ Ù…Ø§ ÙÙ‚Ø· Ø¯Ø§Ú©ÛŒÙˆÙ…Ù†Øª Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø§Ø² Firestore Ù¾Ø§Ú© Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…ØŒ Ø§Ù…Ø§ Ø®ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Authentication Ù¾Ø§Ú© Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/users`, userToDelete.firestoreId));
                    showToast("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ø³ÛŒØ³ØªÙ… Ø­Ø°Ù Ø´Ø¯.");
                } catch (error) {
                    console.error("Error deleting user document:", error);
                    showToast("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±.", "error");
                }
            });
        }

        if (deleteCompetencyBtn) {
            const competencyId = deleteCompetencyBtn.dataset.id;
            showConfirmationModal('Ø­Ø°Ù Ø´Ø§ÛŒØ³ØªÚ¯ÛŒ', 'Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø´Ø§ÛŒØ³ØªÚ¯ÛŒ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ Ø¨Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† ØªØ§Ø«ÛŒØ± Ø®ÙˆØ§Ù‡Ø¯ Ú¯Ø°Ø§Ø´Øª.', async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/competencies`, competencyId));
                    showToast("Ø´Ø§ÛŒØ³ØªÚ¯ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.");
                } catch (error) {
                    console.error("Error deleting competency:", error);
                    showToast("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø´Ø§ÛŒØ³ØªÚ¯ÛŒ.", "error");
                }
            });
        }
    });

    // --- Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±Ù…â€ŒÙ‡Ø§ ---
    const addCompetencyForm = document.getElementById('add-competency-form');
    if (addCompetencyForm) {
        addCompetencyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nameInput = document.getElementById('new-competency-name');
            const competencyName = nameInput.value.trim();
            if (competencyName) {
                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/competencies`), { name: competencyName });
                    showToast("Ø´Ø§ÛŒØ³ØªÚ¯ÛŒ Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.");
                    nameInput.value = '';
                } catch (error) {
                    console.error("Error adding competency:", error);
                    showToast("Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø´Ø§ÛŒØ³ØªÚ¯ÛŒ.", "error");
                }
            }
        });
    }
    
    // --- Ù…Ø¯ÛŒØ±ÛŒØª ØªØºÛŒÛŒØ± Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø± ---
    document.querySelectorAll('.role-select').forEach(select => {
        select.addEventListener('change', async (e) => {
            const uid = e.target.dataset.uid;
            const newRole = e.target.value;
            try {
                const userRef = doc(db, `artifacts/${appId}/public/data/users`, uid);
                await updateDoc(userRef, { role: newRole });
                showToast("Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯.");
            } catch (error) {
                console.error("Error updating role:", error);
                showToast("Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø±.", "error");
            }
        });
    });
};
const setupAnalyticsPage = () => {
    // --- Ù…Ù†Ø·Ù‚ ØªØ¨â€ŒÙ‡Ø§ ---
    const tabs = document.querySelectorAll('.analytics-tab');
    const panes = document.querySelectorAll('.analytics-tab-pane');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => {
                t.classList.remove('border-blue-600', 'text-blue-600');
                t.classList.add('border-transparent', 'text-slate-500', 'hover:text-slate-700', 'hover:border-slate-300');
            });
            tab.classList.add('border-blue-600', 'text-blue-600');
            tab.classList.remove('border-transparent', 'text-slate-500', 'hover:text-slate-700', 'hover:border-slate-300');

            panes.forEach(pane => {
                pane.classList.toggle('hidden', pane.id !== `tab-${tab.dataset.tab}`);
            });
            // Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø±Ù†Ø¯Ø± Ø´Ø¯Ù† ØµØ­ÛŒØ­ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ Ù‡Ù†Ú¯Ø§Ù… Ù†Ù…Ø§ÛŒØ´ ØªØ¨
            window.dispatchEvent(new Event('resize'));
        });
    });

    // --- ØªÙˆØ§Ø¨Ø¹ Ø±Ù†Ø¯Ø± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ---
    const renderAttritionHotspots = () => {
        const container = document.getElementById('attrition-hotspot-list');
        if (!container) return;
        const highRiskEmployees = state.employees.filter(emp => emp.attritionRisk && emp.attritionRisk.score > 60).sort((a, b) => b.attritionRisk.score - a.attritionRisk.score).slice(0, 10);
        if (highRiskEmployees.length === 0) {
            container.innerHTML = '<p class="text-sm text-slate-500 text-center">Ù…ÙˆØ±Ø¯ÛŒ Ø¨Ø§ Ø±ÛŒØ³Ú© Ø¨Ø§Ù„Ø§ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>';
            return;
        }
        container.innerHTML = highRiskEmployees.map(emp => `
            <div class="flex items-center">
                <img src="${emp.avatar}" class="w-9 h-9 rounded-full object-cover ml-3">
                <div class="flex-grow">
                    <p class="font-semibold text-sm text-slate-800">${emp.name}</p>
                    <p class="text-xs text-slate-500">${emp.jobTitle || ''}</p>
                </div>
                <span class="font-bold text-sm text-red-500">${emp.attritionRisk.score}%</span>
            </div>
        `).join('');
    };

    const renderNineBoxGrid = () => {
        const container = document.getElementById('nine-box-grid-container');
        if (!container) return;

        const nineBoxData = [
            { id: 'enigma', title: 'Ù…Ø¹Ù…Ø§', color: 'bg-yellow-100', textColor: 'text-yellow-800' },
            { id: 'needs-improvement', title: 'Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ø¨Ù‡Ø¨ÙˆØ¯', color: 'bg-yellow-100', textColor: 'text-yellow-800' },
            { id: 'high-potential', title: 'Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ø¨Ø§Ù„Ø§', color: 'bg-green-100', textColor: 'text-green-800' },
            { id: 'average-performer', title: 'Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù…ØªÙˆØ³Ø·', color: 'bg-slate-100', textColor: 'text-slate-800' },
            { id: 'solid-performer', title: 'Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù‚Ø§Ø¨Ù„ Ø§ØªÚ©Ø§', color: 'bg-blue-100', textColor: 'text-blue-800' },
            { id: 'core-talent', title: 'Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ÛŒØ¯ÛŒ', color: 'bg-green-100', textColor: 'text-green-800' },
            { id: 'risk', title: 'Ø±ÛŒØ³Ú©', color: 'bg-red-100', textColor: 'text-red-800' },
            { id: 'key-player', title: 'Ù…Ù‡Ø±Ù‡ Ú©Ù„ÛŒØ¯ÛŒ', color: 'bg-blue-100', textColor: 'text-blue-800' },
            { id: 'star', title: 'Ø³ØªØ§Ø±Ù‡', color: 'bg-green-100', textColor: 'text-green-800' },
        ];
        
        const distribution = state.dashboardMetrics.nineBoxDistribution || {};
        
        container.innerHTML = `<div class="grid grid-cols-3 gap-1 h-full">
            ${nineBoxData.map(box => {
                const count = distribution[box.title + ' (Solid Performer)'] || distribution[box.title] || 0;
                return `<div class="nine-box-cell ${box.color} ${box.textColor} rounded-lg p-3 flex flex-col justify-center items-center text-center">
                    <span class="text-2xl font-bold">${count}</span>
                    <span class="text-xs mt-1">${box.title}</span>
                </div>`
            }).reverse().join('')}
        </div>`;
    };

    const renderEngagementBreakdownChart = () => {
        const ctx = document.getElementById('engagementBreakdownChart')?.getContext('2d');
        if (!ctx || !state.orgAnalytics?.engagementBreakdown) return;

        const data = state.orgAnalytics.engagementBreakdown;
        charts.engagementBreakdown = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.map(d => d.name),
                datasets: [{
                    label: 'Ø§Ù…ØªÛŒØ§Ø² Ù…Ø´Ø§Ø±Ú©Øª',
                    data: data.map(d => d.score),
                    backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#f97316', '#ef4444', '#64748b'],
                    hoverOffset: 4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    };
    
    const renderTeamHealthChart = () => {
        const ctx = document.getElementById('teamHealthChart')?.getContext('2d');
        if (!ctx || state.teams.length === 0) return;

        const teamData = state.teams.map(team => {
            const scores = Object.values(team.healthMetrics || {});
            const avgHealth = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
            return { name: team.name, health: avgHealth };
        }).sort((a,b) => b.health - a.health);

        charts.teamHealth = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: teamData.map(t => t.name),
                datasets: [{
                    label: 'Ù†Ù…Ø±Ù‡ Ø³Ù„Ø§Ù…Øª',
                    data: teamData.map(t => t.health),
                    backgroundColor: '#22c55e',
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y', // for horizontal bar chart
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true, max: 100 } }
            }
        });
    };

    const setupSkillGapFinder = () => {
        const findBtn = document.getElementById('find-skill-gap-btn');
        const resultsContainer = document.getElementById('skill-gap-results');
        if (!findBtn) return;
        findBtn.addEventListener('click', () => {
            const teamId = document.getElementById('skill-team-select').value;
            const skillName = document.getElementById('skill-search-input').value.trim().toLowerCase();
            if (!skillName) {
                resultsContainer.innerHTML = '<p class="text-sm text-center text-red-500">Ù„Ø·ÙØ§ Ù†Ø§Ù… ÛŒÚ© Ù…Ù‡Ø§Ø±Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</p>';
                return;
            }
            let targetEmployees = state.employees.filter(e => e.status === 'ÙØ¹Ø§Ù„');
            if (teamId !== 'all') {
                const team = state.teams.find(t => t.firestoreId === teamId);
                if (team) targetEmployees = state.employees.filter(emp => team.memberIds?.includes(emp.id));
            }
            const skillAnalysis = { expert: [], intermediate: [], beginner: [], none: [] };
            targetEmployees.forEach(emp => {
                const skills = emp.skills || {};
                const skillKeys = Object.keys(skills).map(k => k.toLowerCase());
                const skillIndex = skillKeys.findIndex(k => k.includes(skillName));
                if (skillIndex > -1) {
                    const originalKey = Object.keys(skills)[skillIndex];
                    const level = skills[originalKey];
                    if (level >= 4) skillAnalysis.expert.push(emp.name);
                    else if (level >= 2) skillAnalysis.intermediate.push(emp.name);
                    else skillAnalysis.beginner.push(emp.name);
                } else {
                    skillAnalysis.none.push(emp.name);
                }
            });
            resultsContainer.innerHTML = `
                <h4 class="font-bold mb-3">Ù†ØªØ§ÛŒØ¬ Ø¨Ø±Ø§ÛŒ: <span class="text-teal-600">${skillName}</span></h4>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="bg-slate-100 p-2 rounded-md"><p class="font-semibold text-lg">${skillAnalysis.expert.length}</p><p class="text-xs text-slate-500">Ù…ØªØ®ØµØµ (Û´-Ûµ)</p></div>
                    <div class="bg-slate-100 p-2 rounded-md"><p class="font-semibold text-lg">${skillAnalysis.intermediate.length}</p><p class="text-xs text-slate-500">Ù…ØªÙˆØ³Ø· (Û²-Û³)</p></div>
                    <div class="bg-slate-100 p-2 rounded-md"><p class="font-semibold text-lg">${skillAnalysis.beginner.length}</p><p class="text-xs text-slate-500">Ù…Ø¨ØªØ¯ÛŒ (Û±)</p></div>
                    <div class="bg-slate-100 p-2 rounded-md"><p class="font-semibold text-lg">${skillAnalysis.none.length}</p><p class="text-xs text-slate-500">ÙØ§Ù‚Ø¯ Ù…Ù‡Ø§Ø±Øª</p></div>
                </div>
                <div class="mt-3 text-xs text-slate-600"><strong class="font-semibold">Ù…ØªØ®ØµØµÛŒÙ†:</strong> ${skillAnalysis.expert.join(', ') || 'Ù‡ÛŒÚ†'}</div>
            `;
        });
    };
    
    // --- Ø§Ø¬Ø±Ø§ÛŒ ØªÙˆØ§Ø¨Ø¹ ---
    destroyCharts(); // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
    renderAttritionHotspots();
    renderNineBoxGrid();
    renderEngagementBreakdownChart();
    renderTeamHealthChart();
    setupSkillGapFinder();
};
        
        // --- [FIX START] ADDED EXPENSES PAGE LISTENERS AND HELPERS ---
const setupExpensesPageListeners = () => {
    // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† ØªÙ‚ÙˆÛŒÙ… Ø´Ù…Ø³ÛŒ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ±Ù‡Ø§
    activatePersianDatePicker('start-date-filter');
    activatePersianDatePicker('end-date-filter');

    mainContent.addEventListener('click', (e) => {
        const addExpenseBtn = e.target.closest('#add-expense-btn');
        const chargeCardBtn = e.target.closest('#charge-card-btn');
        const addCardBtn = e.target.closest('#add-card-btn');
        const editCardBtn = e.target.closest('.edit-card-btn');
        const deleteCardBtn = e.target.closest('.delete-card-btn');
        const exportCsvBtn = e.target.closest('#export-transactions-csv-btn');

        if (addExpenseBtn) showExpenseForm();
        if (chargeCardBtn) showNewChargeForm();
        if (addCardBtn) showPettyCashCardForm();
        if (exportCsvBtn) exportTransactionsToCSV();

        if (editCardBtn) {
            showPettyCashCardForm(editCardBtn.dataset.id);
        }
        if (deleteCardBtn) {
            const cardId = deleteCardBtn.dataset.id;
            showConfirmationModal('Ø­Ø°Ù Ú©Ø§Ø±Øª ØªÙ†Ø®ÙˆØ§Ù‡', 'Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ú©Ø§Ø±Øª Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ', async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/pettyCashCards`, cardId));
                    showToast('Ú©Ø§Ø±Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.');
                } catch (error) {
                    console.error("Error deleting card:", error);
                    showToast('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú©Ø§Ø±Øª.', 'error');
                }
            });
        }
    });
};

const showPettyCashCardForm = (cardId = null) => {
    const isEditing = cardId !== null;
    const card = isEditing ? state.pettyCashCards.find(c => c.firestoreId === cardId) : {};
    modalTitle.innerText = isEditing ? 'ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Øª ØªÙ†Ø®ÙˆØ§Ù‡' : 'Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Øª ØªÙ†Ø®ÙˆØ§Ù‡';
    modalContent.innerHTML = `
        <form id="card-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block font-medium">Ù†Ø§Ù… Ú©Ø§Ø±Øª (Ù…Ø«Ø§Ù„: Ú©Ø§Ø±Øª Ø¨Ø§Ù†Ú© Ù…Ù„Øª)</label><input type="text" id="card-name" value="${card.name || ''}" class="w-full p-2 border rounded-md" required></div>
                <div><label class="block font-medium">Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label><input type="text" id="card-number" value="${card.cardNumber || ''}" class="w-full p-2 border rounded-md"></div>
            </div>
            <div><label class="block font-medium">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ (ØªÙˆÙ…Ø§Ù†)</label><input type="number" id="card-balance" value="${card.balance || '0'}" class="w-full p-2 border rounded-md" ${isEditing ? 'readonly' : ''} required></div>
            <div class="pt-6 flex justify-end"><button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">Ø°Ø®ÛŒØ±Ù‡</button></div>
        </form>
    `;
    openModal(mainModal, mainModalContainer);

    document.getElementById('card-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const cardName = document.getElementById('card-name').value;
        const initialBalance = Number(document.getElementById('card-balance').value);
        const cardData = {
            name: cardName,
            cardNumber: document.getElementById('card-number').value,
            balance: initialBalance
        };

        try {
            const batch = writeBatch(db);
            const cardRef = doc(db, `artifacts/${appId}/public/data/pettyCashCards`, isEditing ? cardId : cardName.replace(/\s+/g, '-'));
            batch.set(cardRef, cardData, { merge: true });

            // Ø§Ú¯Ø± Ú©Ø§Ø±Øª Ø¬Ø¯ÛŒØ¯ Ø§Ø³Øª Ùˆ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¯Ø§Ø±Ø¯ØŒ Ø¢Ù† Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ÛŒÚ© ØªØ±Ø§Ú©Ù†Ø´ Ø´Ø§Ø±Ú˜ Ø«Ø¨Øª Ú©Ù†
            if (!isEditing && initialBalance > 0) {
                const chargeHistoryRef = collection(db, `artifacts/${appId}/public/data/chargeHistory`);
                batch.set(doc(chargeHistoryRef), {
                    cardId: cardRef.id,
                    cardName: cardName,
                    amount: initialBalance,
                    chargedAt: new Date(), // ØªØ§Ø±ÛŒØ® ÙØ¹Ù„ÛŒ
                    chargedBy: 'Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§ÙˆÙ„ÛŒÙ‡'
                });
            }

            await batch.commit();
            closeModal(mainModal, mainModalContainer);
            showToast('Ú©Ø§Ø±Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.');
        } catch (error) {
            console.error("Error saving card:", error);
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ø±Øª.', 'error');
        }
    });
};
const showNewChargeForm = () => {
    modalTitle.innerText = 'Ø´Ø§Ø±Ú˜ Ú©Ø§Ø±Øª ØªÙ†Ø®ÙˆØ§Ù‡';
    const cardOptions = state.pettyCashCards.map(c => `<option value="${c.firestoreId}">${c.name} (${c.cardNumber || ''})</option>`).join('');

    modalContent.innerHTML = `
        <form id="charge-card-form" class="space-y-4">
            <div><label class="block font-medium">Ú©Ø§Ø±Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±</label><select id="charge-card-select" class="w-full p-2 border rounded-md" required>${cardOptions}</select></div>
            <div><label class="block font-medium">ØªØ§Ø±ÛŒØ® Ø´Ø§Ø±Ú˜</label><input type="text" id="charge-date" class="w-full p-2 border rounded-md" required></div>
            <div><label class="block font-medium">Ù…Ø¨Ù„Øº Ø´Ø§Ø±Ú˜ (ØªÙˆÙ…Ø§Ù†)</label><input type="number" id="charge-amount" class="w-full p-2 border rounded-md" required></div>
            <div class="pt-6 flex justify-end">
                <button type="submit" id="submit-charge-btn" class="bg-green-600 text-white py-2 px-6 rounded-md hover:bg-green-700">ØªØ§ÛŒÛŒØ¯ Ùˆ Ø´Ø§Ø±Ú˜</button>
            </div>
        </form>
    `;
    openModal(mainModal, mainModalContainer);
    activatePersianDatePicker('charge-date', new Date());

    document.getElementById('charge-card-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = document.getElementById('submit-charge-btn');
        submitBtn.disabled = true;
        submitBtn.innerText = 'Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...';

        const cardId = document.getElementById('charge-card-select').value;
        const amount = Number(document.getElementById('charge-amount').value);
        const gregorianDate = persianToEnglishDate(document.getElementById('charge-date').value);

        try {
            const cardRef = doc(db, `artifacts/${appId}/public/data/pettyCashCards`, cardId);
            const cardSnap = await getDoc(cardRef);

            if (cardSnap.exists()) {
                const cardData = cardSnap.data();
                const batch = writeBatch(db);

                batch.update(cardRef, { balance: cardData.balance + amount });

                const chargeHistoryRef = collection(db, `artifacts/${appId}/public/data/chargeHistory`);
                batch.set(doc(chargeHistoryRef), {
                    cardId: cardId,
                    cardName: cardData.name,
                    amount: amount,
                    chargedAt: new Date(gregorianDate),
                    chargedBy: state.currentUser.email
                });

                await batch.commit();
                closeModal(mainModal, mainModalContainer);
                showToast(`Ú©Ø§Ø±Øª ${cardData.name} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø´Ø§Ø±Ú˜ Ø´Ø¯.`);
            }
        } catch (error) {
            console.error("Error charging card:", error);
            showToast("Ø®Ø·Ø§ Ø¯Ø± Ø¹Ù…Ù„ÛŒØ§Øª Ø´Ø§Ø±Ú˜.", "error");
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerText = 'ØªØ§ÛŒÛŒØ¯ Ùˆ Ø´Ø§Ø±Ú˜';
        }
    });
};
const showExpenseForm = () => {
        modalTitle.innerText = 'Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ø²ÛŒÙ†Ù‡ Ø¬Ø¯ÛŒØ¯';
        const cardOptions = state.pettyCashCards.map(c => `<option value="${c.firestoreId}">${c.name}</option>`).join('');
        modalContent.innerHTML = `
            <form id="expense-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block font-medium">ØªØ§Ø±ÛŒØ®</label><input type="text" id="expense-date" class="w-full p-2 border border-slate-300 rounded-lg" required></div>
                    <div><label class="block font-medium">Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label><input type="number" id="expense-amount" class="w-full p-2 border border-slate-300 rounded-lg" required></div>
                    <div class="md:col-span-2"><label class="block font-medium">Ø´Ø±Ø­ Ù‡Ø²ÛŒÙ†Ù‡</label><input type="text" id="expense-item" class="w-full p-2 border border-slate-300 rounded-lg" required></div>
                    <div><label class="block font-medium">Ú©Ø§Ø±Øª ØªÙ†Ø®ÙˆØ§Ù‡</label><select id="expense-card" class="w-full p-2 border border-slate-300 rounded-lg" required>${cardOptions}</select></div>
                    <div>
                        <label class="block font-medium">Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§Ú©ØªÙˆØ± (Ø­Ø¯Ø§Ú©Ø«Ø± Ûµ Ù…Ú¯Ø§Ø¨Ø§ÛŒØª)</label>
                        <input type="file" id="expense-invoice-file" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100"/>
                    </div>
                </div>
                <div class="pt-6 flex justify-end"><button type="submit" id="submit-expense-btn" class="bg-indigo-500 text-white py-2 px-6 rounded-lg hover:bg-indigo-600 shadow-md transition">Ø°Ø®ÛŒØ±Ù‡</button></div>
            </form>
        `;
        openModal(mainModal, mainModalContainer);
        activatePersianDatePicker('expense-date', new Date());

        document.getElementById('expense-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-expense-btn');
            submitBtn.disabled = true;
            submitBtn.innerText = 'Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...';

            const invoiceFile = document.getElementById('expense-invoice-file').files[0];
            let invoiceUrl = '';
            
            // --- Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯: Ø¨Ø±Ø±Ø³ÛŒ Ø­Ø¬Ù… ÙØ§ÛŒÙ„ ---
            if (invoiceFile && invoiceFile.size > 5 * 1024 * 1024) { // 5 MB
                showToast("Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ù†Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² Ûµ Ù…Ú¯Ø§Ø¨Ø§ÛŒØª Ø¨Ø§Ø´Ø¯.", "error");
                submitBtn.disabled = false;
                submitBtn.innerText = 'Ø°Ø®ÛŒØ±Ù‡';
                return;
            }

            // (Ø¨Ù‚ÛŒÙ‡ Ú©Ø¯ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯)
            const amount = Number(document.getElementById('expense-amount').value);
            const cardId = document.getElementById('expense-card').value;
            const persianDate = document.getElementById('expense-date').value;
            const gregorianDate = persianToEnglishDate(persianDate);

            if (!gregorianDate) {
                showToast("ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª.", "error");
                submitBtn.disabled = false;
                submitBtn.innerText = 'Ø°Ø®ÛŒØ±Ù‡';
                return;
            }

            try {
                if (invoiceFile) {
                    const filePath = `invoices/${Date.now()}_${invoiceFile.name}`;
                    const storageRef = ref(storage, filePath);
                    const snapshot = await uploadBytes(storageRef, invoiceFile);
                    invoiceUrl = await getDownloadURL(snapshot.ref);
                }
                const formData = {
                    date: gregorianDate, amount: amount, item: document.getElementById('expense-item').value, cardId: cardId, invoiceUrl: invoiceUrl, createdAt: serverTimestamp()
                };
                const cardRef = doc(db, `artifacts/${appId}/public/data/pettyCashCards`, cardId);
                const cardSnap = await getDoc(cardRef);
                if (cardSnap.exists()) {
                    const currentBalance = cardSnap.data().balance || 0;
                    if (currentBalance < amount) {
                        showToast('Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ø±Øª Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª.', 'error');
                        submitBtn.disabled = false;
                        submitBtn.innerText = 'Ø°Ø®ÛŒØ±Ù‡';
                        return;
                    }
                    const expenseCollectionRef = collection(db, `artifacts/${appId}/public/data/expenses`);
                    const batch = writeBatch(db);
                    batch.set(doc(expenseCollectionRef), formData);
                    batch.update(cardRef, { balance: currentBalance - amount });
                    await batch.commit();
                    closeModal(mainModal, mainModalContainer);
                    showToast('Ù‡Ø²ÛŒÙ†Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.');
                } else {
                    showToast('Ú©Ø§Ø±Øª ØªÙ†Ø®ÙˆØ§Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.', 'error');
                }

            } catch (error) {
                console.error("Error saving expense:", error);
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù‡Ø²ÛŒÙ†Ù‡.', 'error');
            } finally {
                if(submitBtn) {
                   submitBtn.disabled = false;
                   submitBtn.innerText = 'Ø°Ø®ÛŒØ±Ù‡';
                }
            }
        });
    };
        const showChargeCardForm = (cardId, cardName) => {
        modalTitle.innerText = `Ø´Ø§Ø±Ú˜ Ú©Ø§Ø±Øª ØªÙ†Ø®ÙˆØ§Ù‡: ${cardName}`;
        modalContent.innerHTML = `
            <form id="charge-card-form" class="space-y-4">
                <div>
                    <label class="block font-medium">Ù…Ø¨Ù„Øº Ø´Ø§Ø±Ú˜ (ØªÙˆÙ…Ø§Ù†)</label>
                    <input type="number" id="charge-amount" class="w-full p-2 border rounded-md" required>
                </div>
                <div class="pt-6 flex justify-end">
                    <button type="submit" id="submit-charge-btn" class="bg-green-600 text-white py-2 px-6 rounded-md hover:bg-green-700">ØªØ§ÛŒÛŒØ¯ Ùˆ Ø´Ø§Ø±Ú˜</button>
                </div>
            </form>
        `;
        openModal(mainModal, mainModalContainer);

        document.getElementById('charge-card-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-charge-btn');
            submitBtn.disabled = true;
            submitBtn.innerText = 'Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...';

            const amount = Number(document.getElementById('charge-amount').value);
            if (amount <= 0) {
                showToast("Ù…Ø¨Ù„Øº Ø´Ø§Ø±Ú˜ Ø¨Ø§ÛŒØ¯ Ù…Ø«Ø¨Øª Ø¨Ø§Ø´Ø¯.", "error");
                submitBtn.disabled = false;
                submitBtn.innerText = 'ØªØ§ÛŒÛŒØ¯ Ùˆ Ø´Ø§Ø±Ú˜';
                return;
            }

            try {
                const cardRef = doc(db, `artifacts/${appId}/public/data/pettyCashCards`, cardId);
                const chargeHistoryRef = collection(db, `artifacts/${appId}/public/data/chargeHistory`);
                const cardSnap = await getDoc(cardRef);

                if (cardSnap.exists()) {
                    const currentBalance = cardSnap.data().balance || 0;
                    const newBalance = currentBalance + amount;

                    const batch = writeBatch(db);
                    
                    // 1. Update card balance
                    batch.update(cardRef, { balance: newBalance });

                    // 2. Log the transaction
                    batch.set(doc(chargeHistoryRef), {
                        cardId: cardId,
                        cardName: cardName,
                        amount: amount,
                        chargedAt: serverTimestamp(),
                        chargedBy: state.currentUser.email
                    });

                    await batch.commit();
                    closeModal(mainModal, mainModalContainer);
                    showToast(`Ú©Ø§Ø±Øª ${cardName} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø´Ø§Ø±Ú˜ Ø´Ø¯.`);
                } else {
                    showToast("Ú©Ø§Ø±Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.", "error");
                }
            } catch (error) {
                console.error("Error charging card:", error);
                showToast("Ø®Ø·Ø§ Ø¯Ø± Ø¹Ù…Ù„ÛŒØ§Øª Ø´Ø§Ø±Ú˜ Ú©Ø§Ø±Øª.", "error");
            } finally {
                 if(document.getElementById('submit-charge-btn')) { // Check if modal is still open
                    submitBtn.disabled = false;
                    submitBtn.innerText = 'ØªØ§ÛŒÛŒØ¯ Ùˆ Ø´Ø§Ø±Ú˜';
                 }
            }
        });
    };
        // --- [FIX END] ---

        // --- MODAL & FORM LOGIC ---
        const mainModal = document.getElementById('mainModal'); const modalTitle = document.getElementById('modalTitle'); const modalContent = document.getElementById('modalContent'); const mainModalContainer = mainModal.querySelector('div');
        
        const renderCompetencyBars = (competencies) => {
            if (!competencies || Object.keys(competencies).length === 0) {
                return '<p class="text-sm text-gray-500">Ø´Ø§ÛŒØ³ØªÚ¯ÛŒâ€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
            }
            return Object.entries(competencies).map(([name, score]) => `
                <div>
                    <div class="flex justify-between items-center mb-1 text-sm">
                        <span class="text-gray-600">${name}</span>
                        <span class="font-medium text-blue-600">${score}/5</span>
                    </div>
                    <div class="progress-bar w-full">
                        <div class="progress-bar-fill" style="width: ${score * 20}%;"></div>
                    </div>
                </div>
            `).join('');
        };

        const imageUploadInput = document.getElementById('image-upload-input');
        let onImageResizedCallback = null;

if (imageUploadInput) {
    imageUploadInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file || !onImageResizedCallback) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_DIMENSION = 256;
                let { width, height } = img;

                if (width > height) {
                    if (width > MAX_DIMENSION) {
                        height *= MAX_DIMENSION / width;
                        width = MAX_DIMENSION;
                    }
                } else {
                    if (height > MAX_DIMENSION) {
                        width *= MAX_DIMENSION / height;
                        height = MAX_DIMENSION;
                    }
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                canvas.toBlob((blob) => {
                    if (onImageResizedCallback) {
                        onImageResizedCallback(blob);
                    }
                }, 'image/jpeg', 0.9);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
        event.target.value = '';
    });
}

        function handleAvatarChange(updateFunction) {
            onImageResizedCallback = (newAvatarUrl) => {
                updateFunction(newAvatarUrl);
                onImageResizedCallback = null;
            };
            imageUploadInput.click();
        }

        const generateSmartAnalysis = (emp) => {
            const analysis = {};
            if (emp.performanceHistory && emp.performanceHistory.length > 1) {
                const last = emp.performanceHistory[emp.performanceHistory.length - 1].overallScore;
                const first = emp.performanceHistory[0].overallScore;
                if (last > first + 0.2) { analysis.performance = { text: 'Ø±ÙˆÙ†Ø¯ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ú©Ø§Ù…Ù„Ø§Ù‹ ØµØ¹ÙˆØ¯ÛŒ Ø§Ø³Øª.', icon: 'trending-up', color: 'text-green-600' }; } 
                else if (first > last + 0.2) { analysis.performance = { text: 'Ø±ÙˆÙ†Ø¯ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø§Ø±Ø¯.', icon: 'trending-down', color: 'text-yellow-600' }; } 
                else { analysis.performance = { text: 'Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù¾Ø§ÛŒØ¯Ø§Ø± Ùˆ Ù‚Ø§Ø¨Ù„ Ø§ØªÚ©Ø§ÛŒÛŒ Ø¯Ø§Ø±Ø¯.', icon: 'minus', color: 'text-gray-600' }; }
            }
            if (emp.attritionRisk?.score > 70) { analysis.risk = { text: 'Ø±ÛŒØ³Ú© Ø®Ø±ÙˆØ¬ Ø¨Ø§Ù„Ø§. Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø¬Ù„Ø³Ù‡ Ù‡Ù…â€ŒØ§Ù†Ø¯ÛŒØ´ÛŒ Ø¨Ø±Ú¯Ø²Ø§Ø± Ø´ÙˆØ¯.', icon: 'shield-alert', color: 'text-red-600' }; } 
            else if (emp.attritionRisk?.score > 40) { analysis.risk = { text: 'Ø±ÛŒØ³Ú© Ø®Ø±ÙˆØ¬ Ù…ØªÙˆØ³Ø·. Ø­ÙØ¸ Ø§Ù†Ú¯ÛŒØ²Ù‡ Ùˆ Ø´ÙØ§ÙÛŒØª Ø¯Ø± Ù…Ø³ÛŒØ± Ø±Ø´Ø¯ ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.', icon: 'shield-check', color: 'text-yellow-600' }; }
            if (emp.nineBox === 'Ø³ØªØ§Ø±Ù‡' || emp.nineBox === 'Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ø¨Ø§Ù„Ø§') { analysis.potential = { text: 'Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ø¨Ø§Ù„Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ø±Ø´Ø¯ Ùˆ Ù¾Ø°ÛŒØ±Ø´ Ù…Ø³Ø¦ÙˆÙ„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ Ø¯Ø§Ø±Ø¯.', icon: 'sparkles', color: 'text-blue-600' }; } 
            else if (emp.nineBox === 'Ù…Ù‡Ø±Ù‡ Ú©Ù„ÛŒØ¯ÛŒ') { analysis.potential = { text: 'ÛŒÚ© Ù…Ù‡Ø±Ù‡ Ú©Ù„ÛŒØ¯ÛŒ Ø¨Ø§ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¨Ø§Ù„Ø§ Ø¯Ø± Ù†Ù‚Ø´ ÙØ¹Ù„ÛŒ Ø§Ø³Øª.', icon: 'key-round', color: 'text-teal-600' }; }
            const topSkill = Object.entries(emp.skills || {}).sort((a, b) => b[1] - a[1])[0];
            const topCompetency = Object.entries(emp.competencies || {}).sort((a, b) => b[1] - a[1])[0];
            if (topSkill || topCompetency) { analysis.strength = { text: `Ù†Ù‚Ø§Ø· Ù‚ÙˆØª Ú©Ù„ÛŒØ¯ÛŒ: <strong>${topSkill ? topSkill[0] : ''}</strong> Ùˆ <strong>${topCompetency ? topCompetency[0] : ''}</strong>.`, icon: 'star', color: 'text-amber-500' }; }
            return analysis;
        };
const isProfileComplete = (employee) => {
    if (!employee.personalInfo) return false;
    // Ù„ÛŒØ³Øª ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù…Ù„ Ø¨ÙˆØ¯Ù† Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¶Ø±ÙˆØ±ÛŒ Ù‡Ø³ØªÙ†Ø¯
    const requiredFields = [
        'nationalId', 'birthDate', 'phone', 'address', 'email',
        'maritalStatus', 'education'
    ];

    // Ú†Ú© Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ú©Ù‡ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù†Ø¯ Ùˆ Ø®Ø§Ù„ÛŒ Ù†Ø¨Ø§Ø´Ù†Ø¯
    return requiredFields.every(field => {
        const value = employee.personalInfo[field];
        return value && value.toString().trim() !== '';
    });
};

        const generateTeamSmartAnalysis = (team) => {
            const analysis = {};
            const members = state.employees.filter(e => team.memberIds?.includes(e.id));
            if (members.length === 0) return analysis;
            const avgOkrProgress = (team.okrs || []).reduce((sum, okr) => sum + okr.progress, 0) / (team.okrs?.length || 1);
            if (avgOkrProgress > 70) { analysis.okr = { text: 'ØªÛŒÙ… Ø¯Ø± Ù…Ø³ÛŒØ± Ø¯Ø³ØªÛŒØ§Ø¨ÛŒ Ø¨Ù‡ Ø§Ù‡Ø¯Ø§Ù Ø®ÙˆØ¯ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯.', icon: 'trending-up', color: 'text-green-600' }; } 
            else if (avgOkrProgress < 40) { analysis.okr = { text: 'Ù¾ÛŒØ´Ø±ÙØª Ø§Ù‡Ø¯Ø§Ù ØªÛŒÙ… Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø§Ø²Ø¨ÛŒÙ†ÛŒ Ùˆ Ø­Ù…Ø§ÛŒØª Ø¯Ø§Ø±Ø¯.', icon: 'trending-down', color: 'text-yellow-600' }; }
            const highRiskMembers = members.filter(m => m.attritionRisk?.score > 70).length;
            if (highRiskMembers > 0) { analysis.risk = { text: `${highRiskMembers} Ù†ÙØ± Ø§Ø² Ø§Ø¹Ø¶Ø§ Ø±ÛŒØ³Ú© Ø®Ø±ÙˆØ¬ Ø¨Ø§Ù„Ø§ Ø¯Ø§Ø±Ù†Ø¯.`, icon: 'shield-alert', color: 'text-red-600' }; }
            return analysis;
        };

const showEmployeeForm = (employeeId = null) => {
        const isEditing = employeeId !== null;
        const emp = isEditing ? state.employees.find(e => e.firestoreId === employeeId) : {};

        const currentTeam = isEditing ? state.teams.find(t => t.memberIds?.includes(emp.id)) : null;

        const teamOptions = state.teams.map(team =>
            `<option value="${team.firestoreId}" ${currentTeam?.firestoreId === team.firestoreId ? 'selected' : ''}>${team.name}</option>`
        ).join('');

        modalTitle.innerText = isEditing ? 'ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ù…Ù†Ø¯' : 'Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¬Ø¯ÛŒØ¯';
        modalContent.innerHTML = `
            <form id="employee-form" class="space-y-4" data-old-team-id="${currentTeam?.firestoreId || ''}">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-slate-700">Ù†Ø§Ù… Ú©Ø§Ù…Ù„</label>
                        <input type="text" id="name" value="${emp.name || ''}" class="mt-1 block w-full p-2 border border-slate-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="id" class="block text-sm font-medium text-slate-700">Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ</label>
                        <input type="text" id="id" value="${emp.id || ''}" class="mt-1 block w-full p-2 border border-slate-300 rounded-lg" ${isEditing ? 'readonly' : ''} required>
                    </div>
                    <div>
                        <label for="jobTitle" class="block text-sm font-medium text-slate-700">Ø¹Ù†ÙˆØ§Ù† Ø´ØºÙ„ÛŒ</label>
                        <input type="text" id="jobTitle" value="${emp.jobTitle || ''}" placeholder="Ù…Ø«Ø§Ù„: Ú©Ø§Ø±Ø´Ù†Ø§Ø³ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„" class="mt-1 block w-full p-2 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label for="level" class="block text-sm font-medium text-slate-700">Ø³Ø·Ø­</label>
                        <select id="level" class="mt-1 block w-full p-2 border border-slate-300 rounded-lg">
                            <option value="Junior" ${emp.level === 'Junior' ? 'selected' : ''}>Junior (Ú©Ø§Ø±Ø´Ù†Ø§Ø³)</option>
                            <option value="Mid-level" ${emp.level === 'Mid-level' ? 'selected' : ''}>Mid-level (Ú©Ø§Ø±Ø´Ù†Ø§Ø³ Ø§Ø±Ø´Ø¯)</option>
                            <option value="Senior" ${emp.level === 'Senior' ? 'selected' : ''}>Senior (Ø®Ø¨Ø±Ù‡)</option>
                            <option value="Lead" ${emp.level === 'Lead' ? 'selected' : ''}>Lead (Ø±Ø§Ù‡Ø¨Ø±)</option>
                            <option value="Manager" ${emp.level === 'Manager' ? 'selected' : ''}>Manager (Ù…Ø¯ÛŒØ±)</option>
                        </select>
                    </div>
                    <div>
                        <label for="department-team-select" class="block text-sm font-medium text-slate-700">Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† / ØªÛŒÙ…</label>
                        <select id="department-team-select" class="mt-1 block w-full p-2 border border-slate-300 rounded-lg">
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                            ${teamOptions}
                        </select>
                    </div>
                     <div>
                        <label for="status" class="block text-sm font-medium text-slate-700">ÙˆØ¶Ø¹ÛŒØª</label>
                        <select id="status" class="mt-1 block w-full p-2 border border-slate-300 rounded-lg">
                            <option value="ÙØ¹Ø§Ù„" ${emp.status === 'ÙØ¹Ø§Ù„' ? 'selected' : ''}>ÙØ¹Ø§Ù„</option>
                            <option value="ØºÛŒØ±ÙØ¹Ø§Ù„" ${emp.status === 'ØºÛŒØ±ÙØ¹Ø§Ù„' ? 'selected' : ''}>ØºÛŒØ±ÙØ¹Ø§Ù„</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                         <label for="startDate" class="block text-sm font-medium text-slate-700">ØªØ§Ø±ÛŒØ® Ø§Ø³ØªØ®Ø¯Ø§Ù…</label>
                         <input type="text" id="startDate" class="mt-1 block w-full p-2 border border-slate-300 rounded-lg">
                    </div>
                </div>
                <div class="pt-4 flex justify-end">
                    <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-indigo-600 shadow-md transition">Ø°Ø®ÛŒØ±Ù‡</button>
                </div>
            </form>
        `;
        openModal(mainModal, mainModalContainer);
        // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ØªÙ‚ÙˆÛŒÙ… Ø´Ù…Ø³ÛŒ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„Ø¯ ØªØ§Ø±ÛŒØ® Ø§Ø³ØªØ®Ø¯Ø§Ù…
        activatePersianDatePicker('startDate', emp.startDate);

        document.getElementById('employee-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const oldTeamId = form.dataset.oldTeamId;
            const newTeamId = document.getElementById('department-team-select').value;
            const name = document.getElementById('name').value;
            const employeeCode = document.getElementById('id').value;

            const selectedTeam = state.teams.find(t => t.firestoreId === newTeamId);
            const departmentName = selectedTeam ? selectedTeam.name : '';
            
            const gregorianStartDate = persianToEnglishDate(document.getElementById('startDate').value);

            const formData = {
                name: name,
                id: employeeCode,
                jobTitle: document.getElementById('jobTitle').value,
                level: document.getElementById('level').value,
                department: departmentName,
                status: document.getElementById('status').value,
                startDate: gregorianStartDate, // Ø°Ø®ÛŒØ±Ù‡ ØªØ§Ø±ÛŒØ® Ø§Ø³ØªØ®Ø¯Ø§Ù…
                avatar: emp.avatar || `https://placehold.co/100x100/E2E8F0/4A5568?text=${name.substring(0, 2)}`,
                ...isEditing && {
                    personalInfo: emp.personalInfo || {},
                    skills: emp.skills || {},
                    performanceHistory: emp.performanceHistory || [],
                    competencies: emp.competencies || {},
                    careerPath: emp.careerPath || [],
                }
            };
            
            // Ø§Ú¯Ø± Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¬Ø¯ÛŒØ¯ Ø§Ø³ØªØŒ Ø§ÙˆÙ„ÛŒÙ† Ø±ÙˆÛŒØ¯Ø§Ø¯ Ù…Ø³ÛŒØ± Ø´ØºÙ„ÛŒ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø³Ø§Ø²
            if (!isEditing) {
                formData.careerPath = [{
                    date: gregorianStartDate,
                    type: 'Ø§Ø³ØªØ®Ø¯Ø§Ù…',
                    title: formData.jobTitle,
                    department: formData.department
                }];
            }

            try {
                const batch = writeBatch(db);
                const docRef = doc(db, `artifacts/${appId}/public/data/employees`, isEditing ? emp.firestoreId : employeeCode);
                batch.set(docRef, formData, { merge: true });
                    if (formData.level === 'Manager' && newTeamId) {
        const teamRef = doc(db, `artifacts/${appId}/public/data/teams`, newTeamId);
        batch.update(teamRef, { leaderId: employeeCode });
    }

                if (oldTeamId !== newTeamId) {
                    if (oldTeamId) {
                        const oldTeamRef = doc(db, `artifacts/${appId}/public/data/teams`, oldTeamId);
                        const oldTeamData = state.teams.find(t => t.firestoreId === oldTeamId);
                        if(oldTeamData) {
                           const oldMembers = oldTeamData.memberIds || [];
                           batch.update(oldTeamRef, { memberIds: oldMembers.filter(id => id !== employeeCode) });
                        }
                    }
                    if (newTeamId) {
                        const newTeamRef = doc(db, `artifacts/${appId}/public/data/teams`, newTeamId);
                        const newTeamData = state.teams.find(t => t.firestoreId === newTeamId);
                        if (newTeamData) {
                            const newMembers = newTeamData.memberIds || [];
                            if (!newMembers.includes(employeeCode)) {
                                newMembers.push(employeeCode);
                            }
                            batch.update(newTeamRef, { memberIds: newMembers });
                        }
                    }
                }
                
                await batch.commit();
                closeModal(mainModal, mainModalContainer);
                showToast(isEditing ? "Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯." : "Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ùˆ Ù…Ø³ÛŒØ± Ø´ØºÙ„ÛŒ Ø§Ùˆ Ø«Ø¨Øª Ø´Ø¯.");
            } catch (error) {
                console.error("Error saving employee and updating team:", error);
                showToast("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª.", "error");
            }
        });
    };
        const showPettyCashManagementModal = () => {
    modalTitle.innerText = 'Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ ØªÙ†Ø®ÙˆØ§Ù‡';

    const cardsHtml = state.pettyCashCards.map(card => `
        <div class="flex justify-between items-center p-3 bg-slate-100 rounded-lg">
            <div>
                <p class="font-bold text-blue-800">${card.name}</p>
                <p class="text-sm text-slate-600 font-mono">${(card.balance || 0).toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†</p>
            </div>
            <div class="flex items-center gap-2">
                <button class="charge-card-btn text-green-600 hover:text-green-800" data-id="${card.firestoreId}" data-name="${card.name}" title="Ø´Ø§Ø±Ú˜ Ú©Ø§Ø±Øª">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                </button>
                ${isAdmin() ? `<button class="delete-card-btn text-rose-500 hover:text-rose-700" data-id="${card.firestoreId}" title="Ø­Ø°Ù Ú©Ø§Ø±Øª">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>` : ''}
            </div>
        </div>
    `).join('');

    modalContent.innerHTML = `
        <div class="space-y-4">
            <div id="cards-list" class="space-y-3 max-h-80 overflow-y-auto pr-2">
                ${cardsHtml || '<p class="text-sm text-slate-500">Ú©Ø§Ø±ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>'}
            </div>
            ${isAdmin() ? `
            <div class="border-t pt-4">
                 <button id="add-new-card-modal-btn" class="w-full bg-blue-600 text-white py-2.5 px-4 rounded-lg hover:bg-blue-700 shadow-md">
                    Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Øª Ø¬Ø¯ÛŒØ¯
                 </button>
            </div>
            ` : ''}
        </div>
    `;
    openModal(mainModal, mainModalContainer);
    lucide.createIcons();
};
        
        // --- [FIX START] ADDED TEAM HEALTH METRICS RENDERER ---
      const renderTeamHealthMetrics = (team) => {
        const metrics = team.healthMetrics || {};
        
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ù…ØªÛŒØ§Ø² Ù…Ø´Ø§Ø±Ú©Øª ØªÛŒÙ… Ø¨Ù‡ Ù„ÛŒØ³Øª Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§
        if (team.engagementScore != null) {
            metrics['Ù…Ø´Ø§Ø±Ú©Øª Ú©Ø§Ø±Ú©Ù†Ø§Ù†'] = team.engagementScore;
        }

        const metricsHtml = Object.keys(metrics).length > 0 ? Object.entries(metrics).map(([name, score]) => `
            <div>
                <div class="flex justify-between items-center mb-1 text-sm">
                    <span class="text-gray-600">${name}</span>
                    <span class="font-medium text-blue-600">${score}%</span>
                </div>
                <div class="progress-bar w-full">
                    <div class="progress-bar-fill" style="width: ${score}%;"></div>
                </div>
            </div>
        `).join('') : '<p class="text-sm text-gray-500">Ù‡Ù†ÙˆØ² Ù…Ø¹ÛŒØ§Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø³Ù„Ø§Ù…Øª ØªÛŒÙ… Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';

        return `
            <div class="card p-4 bg-gray-50 rounded-lg">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-semibold text-gray-700">Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ Ø³Ù„Ø§Ù…Øª ØªÛŒÙ…</h4>
                    ${canEdit() ? `<button id="edit-team-health-btn" class="text-sm bg-blue-500 text-white py-1 px-3 rounded-md hover:bg-blue-600">ÙˆÛŒØ±Ø§ÛŒØ´</button>` : ''}
                </div>
                <div class="space-y-4">
                    ${metricsHtml}
                </div>
            </div>
        `;
    };
        const generateTeamNineBoxGrid = (members) => {
            const grid = Array(3).fill(null).map(() => Array(3).fill(null).map(() => []));
            const gridMap = {'Ù…Ø¹Ù…Ø§': {r:0,c:0}, 'Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù‚Ø§Ø¨Ù„ Ø§ØªÚ©Ø§':{r:1,c:0}, 'Ù…Ù‡Ø±Ù‡ Ú©Ù„ÛŒØ¯ÛŒ':{r:2,c:0}, 'Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ø¨Ø§Ù„Ø§':{r:1,c:2}, 'Ø³ØªØ§Ø±Ù‡':{r:2,c:2}};
            members.forEach(emp => { const pos = gridMap[emp.nineBox]; if(pos) grid[pos.r][pos.c].push(emp); });
            let html = '';
            for (let i = 2; i >= 0; i--) { for (let j = 0; j < 3; j++) { html += `<div class="border-b-2 border-r-2 border-gray-200 min-h-[60px] p-1 flex flex-wrap items-center justify-center gap-1">${grid[i][j].map(e => `<div class="w-8 h-8 rounded-full border-2 border-white overflow-hidden shrink-0 bg-gray-200"><img src="${e.avatar}" title="${e.name}" class="w-full h-full object-cover"></div>`).join('')}</div>`; } }
            return html;
        };

const setupTeamProfileModalListeners = (team) => {
    // 1. Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¨â€ŒÙ‡Ø§ (Ù†Ù…Ø§ÛŒ Ú©Ù„ÛŒØŒ Ø³Ù„Ø§Ù…Øª ØªÛŒÙ… Ùˆ ...)
    const tabs = document.querySelectorAll('#profile-tabs .profile-tab');
    const tabContents = document.querySelectorAll('.profile-tab-content');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            const target = tab.getAttribute('data-tab');
            tabContents.forEach(content => {
                content.classList.toggle('active', content.id === `tab-${target}`);
            });
        });
    });

    // 2. Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´Ú¯Ø±)
    if (canEdit()) {
        const modalContentArea = document.getElementById('modalContent');
        if (!modalContentArea) return;

        // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Event Delegation: ÛŒÚ© listener Ø¨Ø±Ø§ÛŒ Ú©Ù„ Ù…Ø­ØªÙˆØ§ÛŒ Ù…ÙˆØ¯Ø§Ù„
        modalContentArea.addEventListener('click', (e) => {
            const target = e.target.closest('button'); // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ø¯Ú©Ù…Ù‡â€ŒØ§ÛŒ Ú©Ù‡ Ø±ÙˆÛŒ Ø¢Ù† Ú©Ù„ÛŒÚ© Ø´Ø¯Ù‡
            if (!target) return; // Ø§Ú¯Ø± Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ú©Ù„ÛŒÚ© Ù†Ø´Ø¯Ù‡ØŒ Ú©Ø§Ø±ÛŒ Ù†Ú©Ù†

            const id = target.id;

            // Ø¨Ø± Ø§Ø³Ø§Ø³ ID Ø¯Ú©Ù…Ù‡ØŒ ØªØ§Ø¨Ø¹ Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø±Ø§ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ú©Ù†
            switch (id) {
                case 'edit-team-members-btn':
                    showTeamForm(team.firestoreId);
                    break;
                case 'edit-team-okrs-btn':
                    showEditTeamOkrsForm(team);
                    break;
                case 'edit-team-health-btn':
                    showTeamHealthForm(team);
                    break;
                case 'change-team-avatar-btn':
                    // --- START: Ú©Ø¯ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ù„ÙˆØ¯ Ø¢ÙˆØ§ØªØ§Ø± ØªÛŒÙ… ---
                    handleAvatarChange(async (imageBlob) => {
                        if (!imageBlob) return;
                        showToast("Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³ ØªÛŒÙ…...", "success");
                        try {
                            // Û±. ÛŒÚ© Ù…Ø³ÛŒØ± Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯ Ø¯Ø± Storage Ø¨Ø±Ø§ÛŒ ÙØ§ÛŒÙ„ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                            const filePath = `team-avatars/${team.firestoreId}/${Date.now()}.jpg`;
                            const storageRef = ref(storage, filePath);
                            
                            // Û². ÙØ§ÛŒÙ„ Blob Ø±Ø§ Ø¯Ø± Storage Ø¢Ù¾Ù„ÙˆØ¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                            const snapshot = await uploadBytes(storageRef, imageBlob);
                            
                            // Û³. Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯Ù‡ Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…
                            const downloadURL = await getDownloadURL(snapshot.ref);
                            
                            // Û´. Ø­Ø§Ù„Ø§ Ù„ÛŒÙ†Ú© (Ú©Ù‡ ÛŒÚ© Ù…ØªÙ† Ø§Ø³Øª) Ø±Ø§ Ø¯Ø± Firestore Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                            const docRef = doc(db, `artifacts/${appId}/public/data/teams`, team.firestoreId);
                            await updateDoc(docRef, { avatar: downloadURL });
                            
                            showToast("Ø¹Ú©Ø³ ØªÛŒÙ… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.");
                            viewTeamProfile(team.firestoreId); // Ø±ÙØ±Ø´ Ú©Ø±Ø¯Ù† Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ØªÛŒÙ… Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¹Ú©Ø³ Ø¬Ø¯ÛŒØ¯
                        } catch (error) {
                            console.error("Error updating team avatar:", error);
                            showToast("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¹Ú©Ø³ ØªÛŒÙ….", "error");
                        }
                    });
                    // --- END: Ú©Ø¯ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ ---
                    break;
            }
        });
    }

    // 3. Ø§Ø¬Ø±Ø§ÛŒ Lucide Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§
    setTimeout(() => {
        lucide.createIcons();
    }, 100);
};

        const openModal = (modal, container) => { modal.classList.remove('hidden'); modal.classList.add('flex'); setTimeout(() => container.classList.remove('scale-95', 'opacity-0'), 50); };
        const closeModal = (modal, container) => { container.classList.add('scale-95', 'opacity-0'); setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); destroyCharts(); }, 300); };
        const confirmModal = document.getElementById('confirmModal'); const confirmModalContainer = confirmModal.querySelector('div'); let confirmCallback = () => {};
        const showConfirmationModal = (title, message, onConfirm, acceptText = "ØªØ§ÛŒÛŒØ¯") => { document.getElementById('confirmTitle').innerText = title; document.getElementById('confirmMessage').innerText = message; document.getElementById('confirmAccept').innerText = acceptText; confirmCallback = onConfirm; openModal(confirmModal, confirmModalContainer); };
        document.getElementById('confirmCancel').addEventListener('click', () => closeModal(confirmModal, confirmModalContainer)); document.getElementById('confirmAccept').addEventListener('click', () => { confirmCallback(); closeModal(confirmModal, confirmModalContainer); });
        
        const showTeamForm = (teamId = null) => {
            const isEditing = teamId !== null;
            const team = isEditing ? state.teams.find(t => t.firestoreId === teamId) : {};
            const employeeOptions = state.employees.map(emp => `<option value="${emp.id}" ${isEditing && team.leaderId === emp.id ? 'selected' : ''}>${emp.name}</option>`).join('');
            const memberCheckboxes = state.employees.map(emp => `<div class="flex items-center"><input type="checkbox" id="member-${emp.id}" value="${emp.id}" class="team-member-checkbox" ${isEditing && team.memberIds?.includes(emp.id) ? 'checked' : ''}><label for="member-${emp.id}" class="mr-2">${emp.name}</label></div>`).join('');
            modalTitle.innerText = isEditing ? 'ÙˆÛŒØ±Ø§ÛŒØ´ ØªÛŒÙ…' : 'Ø§ÙØ²ÙˆØ¯Ù† ØªÛŒÙ… Ø¬Ø¯ÛŒØ¯';
            modalContent.innerHTML = `<form id="team-form" class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="team-name" class="block text-sm font-medium text-gray-700">Ù†Ø§Ù… ØªÛŒÙ…</label><input type="text" id="team-name" value="${team.name || ''}" class="mt-1 block w-full p-2 border rounded-md" required></div><div><label for="team-id" class="block text-sm font-medium text-gray-700">Ø´Ù†Ø§Ø³Ù‡ ØªÛŒÙ… (Ù…Ø«Ù„Ø§ T-03)</label><input type="text" id="team-id" value="${team.id || ''}" class="mt-1 block w-full p-2 border rounded-md" ${isEditing ? 'readonly' : ''} required></div><div class="md:col-span-2"><label for="team-mission" class="block text-sm font-medium text-gray-700">Ù…Ø§Ù…ÙˆØ±ÛŒØª ØªÛŒÙ…</label><textarea id="team-mission" rows="3" class="mt-1 block w-full p-2 border rounded-md">${team.mission || ''}</textarea></div><div><label for="team-leader" class="block text-sm font-medium text-gray-700">Ø±Ù‡Ø¨Ø± ØªÛŒÙ…</label><select id="team-leader" class="mt-1 block w-full p-2 border rounded-md" required><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>${employeeOptions}</select></div><div><label class="block text-sm font-medium text-gray-700">Ø§Ø¹Ø¶Ø§ÛŒ ØªÛŒÙ…</label><div id="team-members" class="mt-1 grid grid-cols-2 gap-2 max-h-48 overflow-y-auto p-2 border rounded-md">${memberCheckboxes}</div></div></div><div class="pt-4 flex justify-end"><button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">Ø°Ø®ÛŒØ±Ù‡</button></div></form>`;
            openModal(mainModal, mainModalContainer);
            document.getElementById('team-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const selectedMembers = Array.from(document.querySelectorAll('.team-member-checkbox:checked')).map(cb => cb.value);
                const formData = { name: document.getElementById('team-name').value, id: document.getElementById('team-id').value, mission: document.getElementById('team-mission').value, leaderId: document.getElementById('team-leader').value, memberIds: selectedMembers, avatar: team.avatar || `https://placehold.co/200x200/dbeafe/4338ca?text=${document.getElementById('team-name').value.substring(0,2)}`, okrs: team.okrs || [], healthMetrics: team.healthMetrics || {} };
                try { const docRef = doc(db, `artifacts/${appId}/public/data/teams`, isEditing ? team.firestoreId : formData.id); await setDoc(docRef, formData, { merge: isEditing }); closeModal(mainModal, mainModalContainer); showToast(isEditing ? "ØªÛŒÙ… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯." : "ØªÛŒÙ… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯."); } catch (error) { console.error("Error saving team:", error); showToast("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÛŒÙ….", "error"); }
            });
        };

        // --- EVENT LISTENERS & INITIALIZATION ---
        const setupEventListeners = () => {
            // Auth Listeners
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = e.target.email.value;
                const password = e.target.password.value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    showToast("Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.", "error");
                    console.error("Login failed:", error);
                }
            });

            document.getElementById('signup-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = e.target.email.value;
                const password = e.target.password.value;
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    showToast("Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†Ø§Ù…. Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø§ÛŒÙ† Ø§ÛŒÙ…ÛŒÙ„ Ù‚Ø¨Ù„Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯.", "error");
                    console.error("Signup failed:", error);
                }
            });

            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); showSignupPage(); });
            document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); showLoginPage(); });


            // General App Listeners
            document.getElementById('closeModal').addEventListener('click', () => closeModal(mainModal, mainModalContainer));
            mainModal.addEventListener('click', (e) => { if (e.target === mainModal) closeModal(mainModal, mainModalContainer); });
            
            // Mobile Menu
            const menuBtn = document.getElementById('menu-btn'); const sidebar = document.getElementById('sidebar'); const overlay = document.getElementById('sidebar-overlay'); const toggleMenu = () => { sidebar.classList.toggle('translate-x-full'); overlay.classList.toggle('hidden'); };
            menuBtn.addEventListener('click', toggleMenu);
            overlay.addEventListener('click', toggleMenu);
            
            // Navigation
            const handleNavClick = (e) => { const link = e.target.closest('a'); if (link && (link.classList.contains('sidebar-item') || link.classList.contains('sidebar-logo'))) { e.preventDefault(); const pageName = link.getAttribute('href').substring(1); navigateTo(pageName); if (window.innerWidth < 768) toggleMenu(); } };
            document.getElementById('sidebar').addEventListener('click', handleNavClick);
            document.querySelector('header .sidebar-logo')?.addEventListener('click', handleNavClick);
            
            window.addEventListener('hashchange', router);
        };
// Ú©Ù„ ØªØ§Ø¨Ø¹ ÙØ¹Ù„ÛŒ Ø±Ø§ Ø¨Ø§ Ø§ÛŒÙ† Ú©Ø¯ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯
const setupProfileModalListeners = (emp) => {
    const tabs = document.querySelectorAll('#profile-tabs .profile-tab');
    const tabContents = document.querySelectorAll('.profile-tab-content');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            const target = tab.getAttribute('data-tab');
            tabContents.forEach(content => {
                content.classList.toggle('active', content.id === `tab-${target}`);
            });
        });
    });

    setTimeout(() => {
        renderSkillRadarChart('skillRadarChart', emp.skills || {});
        lucide.createIcons();
    }, 100);

    if(canEdit()) {
        const modalContentArea = document.getElementById('modalContent');
        if (!modalContentArea) return;

        modalContentArea.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const id = target.id;

            if (id === 'change-avatar-btn') {
                handleAvatarChange(async (imageBlob) => {
                    if (!imageBlob) return;
                    showToast("Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³...", "success");
                    try {
                        const filePath = `avatars/${emp.firestoreId}/${Date.now()}.jpg`;
                        const storageRef = ref(storage, filePath);
                        const snapshot = await uploadBytes(storageRef, imageBlob);
                        const downloadURL = await getDownloadURL(snapshot.ref);
                        const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId);
                        await updateDoc(docRef, { avatar: downloadURL });
                        showToast("Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.");
                        viewEmployeeProfile(emp.firestoreId);
                    } catch (error) {
                        console.error("Error uploading avatar:", error);
                        showToast("Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„.", "error");
                    }
                });
            } else if (id === 'delete-avatar-btn') {
                showConfirmationModal('Ø­Ø°Ù Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„', 'Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ', async () => {
                    try {
                        const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId);
                        const defaultAvatar = `https://placehold.co/100x100/E2E8F0/4A5568?text=${emp.name.substring(0,2)}`;
                        await updateDoc(docRef, { avatar: defaultAvatar });
                        showToast("Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø­Ø°Ù Ø´Ø¯.");
                        viewEmployeeProfile(emp.firestoreId);
                    } catch (error) {
                        console.error("Error deleting avatar:", error);
                        showToast("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„.", "error");
                    }
                });
            } else if (id === 'main-edit-employee-btn') {
                showEmployeeForm(emp.firestoreId);
            } else if (id === 'edit-competencies-btn') {
                showEditCompetenciesForm(emp);
            } else if (id === 'edit-personal-info-btn') {
                showEditPersonalInfoForm(emp);
            } else if (id === 'add-performance-btn') {
                showPerformanceForm(emp);
            } else if (id === 'add-career-path-btn') {
                showCareerPathForm(emp);
            } else if (id === 'add-disciplinary-btn') {
                showDisciplinaryForm(emp);
            } else if (id === 'add-contract-btn') {
                showContractForm(emp);
            } else if (id === 'add-document-btn') {
                showDocumentForm(emp);
            } else if (target.classList.contains('edit-performance-btn')) {
                showPerformanceForm(emp, parseInt(target.dataset.index));
            } else if (target.classList.contains('delete-performance-btn')) {
                deletePerformanceReview(emp, parseInt(target.dataset.index));
            } else if (target.classList.contains('delete-disciplinary-btn')) {
                deleteDisciplinaryRecord(emp, parseInt(target.dataset.index));
            } else if (target.classList.contains('delete-career-path-btn')) {
                deleteCareerPathEntry(emp, parseInt(target.dataset.index));
            } else if (target.classList.contains('edit-contract-btn')) {
                showContractForm(emp, parseInt(target.dataset.index));
            } else if (target.classList.contains('delete-contract-btn')) {
                deleteContract(emp, parseInt(target.dataset.index));
            } else if (target.classList.contains('edit-document-btn')) {
                showDocumentForm(emp, parseInt(target.dataset.index));
            } else if (target.classList.contains('delete-document-btn')) {
                deleteDocument(emp, parseInt(target.dataset.index));
            }
        });
    }
};
        
        // --- EDIT FORM FUNCTIONS ---
const showAddUserForm = () => {
    modalTitle.innerText = 'Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯';
    modalContent.innerHTML = `
        <form id="add-user-form" class="space-y-4">
            <div>
                <label for="new-user-name" class="block text-sm font-medium text-gray-700">Ù†Ø§Ù… Ú©Ø§Ù…Ù„</label>
                <input id="new-user-name" type="text" required class="w-full px-3 py-2 mt-1 border rounded-md">
            </div>
            <div>
                <label for="new-user-email" class="block text-sm font-medium text-gray-700">Ø¢Ø¯Ø±Ø³ Ø§ÛŒÙ…ÛŒÙ„</label>
                <input id="new-user-email" type="email" required class="w-full px-3 py-2 mt-1 border rounded-md">
            </div>
            <div>
                <label for="new-user-password" class="block text-sm font-medium text-gray-700">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù…ÙˆÙ‚Øª</label>
                <input id="new-user-password" type="password" required class="w-full px-3 py-2 mt-1 border rounded-md">
            </div>
            <div>
                <label for="new-user-role" class="block text-sm font-medium text-gray-700">Ø³Ø·Ø­ Ø¯Ø³ØªØ±Ø³ÛŒ</label>
                <select id="new-user-role" class="w-full p-2 mt-1 border rounded-md">
                    <option value="viewer">Ù…Ø´Ø§Ù‡Ø¯Ù‡â€ŒÚ¯Ø± (Viewer)</option>
                    <option value="editor">ÙˆÛŒØ±Ø§ÛŒØ´Ú¯Ø± (Editor)</option>
                    <option value="admin">Ù…Ø¯ÛŒØ± (Admin)</option>
                </select>
            </div>
            <div class="pt-4 flex justify-end">
                <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø±</button>
            </div>
        </form>
    `;
    openModal(mainModal, mainModalContainer);

    document.getElementById('add-user-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('new-user-name').value;
        const email = document.getElementById('new-user-email').value;
        const password = document.getElementById('new-user-password').value;
        const role = document.getElementById('new-user-role').value;
        
        showToast("Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±... Ø§ÛŒÙ† Ú©Ø§Ø± Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø§Ø¹Ø« Ø®Ø±ÙˆØ¬ Ø´Ù…Ø§ Ø§Ø² Ø³ÛŒØ³ØªÙ… Ø´ÙˆØ¯.", "success");
        
        try {
            // This is a simplified approach. In a real app, you'd use Firebase Functions to create users without logging out the admin.
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const newUser = userCredential.user;

            const userRef = doc(db, `artifacts/${appId}/public/data/users`, newUser.uid);
            await setDoc(userRef, {
                name: name, //  Ø°Ø®ÛŒØ±Ù‡ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±
                email: newUser.email,
                role: role,
                createdAt: serverTimestamp()
            });
            
            closeModal(mainModal, mainModalContainer);
            showToast("Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯. Ù„Ø·ÙØ§ Ø¨Ø§ Ø­Ø³Ø§Ø¨ Ø§Ø¯Ù…ÛŒÙ† Ù…Ø¬Ø¯Ø¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.");
            
            await signOut(auth);

        } catch (error) {
            console.error("Error creating new user:", error);
            showToast(`Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±: ${error.message}`, "error");
        }
    });
};

        const showEditOkrsForm = (emp) => {
            modalTitle.innerText = `ÙˆÛŒØ±Ø§ÛŒØ´ OKR Ø¨Ø±Ø§ÛŒ ${emp.name}`;
            const okrsHtml = (emp.okrs || []).map((okr) => `<div class="okr-item grid grid-cols-12 gap-2 items-center"><input type="text" value="${okr.title}" class="col-span-8 p-2 border rounded-md okr-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù‡Ø¯Ù"><input type="number" value="${okr.progress}" class="col-span-3 p-2 border rounded-md okr-progress" placeholder="Ù¾ÛŒØ´Ø±ÙØª %" min="0" max="100"><button type="button" class="col-span-1 remove-okr-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div>`).join('');
            modalContent.innerHTML = `<form id="edit-okrs-form"><div id="okrs-container" class="space-y-2">${okrsHtml}</div><button type="button" id="add-okr-btn" class="mt-4 text-sm bg-gray-200 py-2 px-4 rounded-md hover:bg-gray-300">Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ø¯Ù Ø¬Ø¯ÛŒØ¯</button><div class="pt-6 flex justify-end gap-4"><button type="button" id="back-to-profile-okr" class="bg-gray-500 text-white py-2 px-6 rounded-md hover:bg-gray-600">Ø¨Ø§Ø²Ú¯Ø´Øª</button><button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">Ø°Ø®ÛŒØ±Ù‡</button></div></form>`;
            lucide.createIcons();
            document.getElementById('back-to-profile-okr').addEventListener('click', () => viewEmployeeProfile(emp.firestoreId));
            const okrsContainer = document.getElementById('okrs-container');
            document.getElementById('add-okr-btn').addEventListener('click', () => { const newItem = document.createElement('div'); newItem.className = 'okr-item grid grid-cols-12 gap-2 items-center'; newItem.innerHTML = `<input type="text" class="col-span-8 p-2 border rounded-md okr-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù‡Ø¯Ù"><input type="number" class="col-span-3 p-2 border rounded-md okr-progress" placeholder="Ù¾ÛŒØ´Ø±ÙØª %" min="0" max="100" value="0"><button type="button" class="col-span-1 remove-okr-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5"></i></button>`; okrsContainer.appendChild(newItem); lucide.createIcons(); });
            okrsContainer.addEventListener('click', (e) => { if(e.target.closest('.remove-okr-btn')) { e.target.closest('.okr-item').remove(); } });
            document.getElementById('edit-okrs-form').addEventListener('submit', async (e) => { e.preventDefault(); const newOkrs = []; document.querySelectorAll('.okr-item').forEach(item => { const title = item.querySelector('.okr-title').value; const progress = parseInt(item.querySelector('.okr-progress').value) || 0; if (title) { newOkrs.push({ title, progress }); } }); try { const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId); await updateDoc(docRef, { okrs: newOkrs }); showToast("Ø§Ù‡Ø¯Ø§Ù Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯."); viewEmployeeProfile(emp.firestoreId); } catch (error) { console.error("Error updating OKRs:", error); showToast("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ù‡Ø¯Ø§Ù.", "error"); } });
        };

        const showEditSkillsForm = (emp) => {
            modalTitle.innerText = `ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ù‡Ø§Ø±Øªâ€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ ${emp.name}`;
            const skillsHtml = Object.entries(emp.skills || {}).map(([skill, level]) => `<div class="skill-item grid grid-cols-12 gap-2 items-center"><input type="text" value="${skill}" class="col-span-8 p-2 border rounded-md skill-name" placeholder="Ù†Ø§Ù… Ù…Ù‡Ø§Ø±Øª"><input type="number" value="${level}" class="col-span-3 p-2 border rounded-md skill-level" placeholder="Ø³Ø·Ø­ (Û±-Ûµ)" min="1" max="5"><button type="button" class="col-span-1 remove-skill-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div>`).join('');
            modalContent.innerHTML = `<form id="edit-skills-form"><div id="skills-container" class="space-y-2">${skillsHtml}</div><button type="button" id="add-skill-btn" class="mt-4 text-sm bg-gray-200 py-2 px-4 rounded-md hover:bg-gray-300">Ø§ÙØ²ÙˆØ¯Ù† Ù…Ù‡Ø§Ø±Øª Ø¬Ø¯ÛŒØ¯</button><div class="pt-6 flex justify-end gap-4"><button type="button" id="back-to-profile-skill" class="bg-gray-500 text-white py-2 px-6 rounded-md hover:bg-gray-600">Ø¨Ø§Ø²Ú¯Ø´Øª</button><button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">Ø°Ø®ÛŒØ±Ù‡</button></div></form>`;
            lucide.createIcons();
            document.getElementById('back-to-profile-skill').addEventListener('click', () => viewEmployeeProfile(emp.firestoreId));
            const skillsContainer = document.getElementById('skills-container');
            document.getElementById('add-skill-btn').addEventListener('click', () => { const newItem = document.createElement('div'); newItem.className = 'skill-item grid grid-cols-12 gap-2 items-center'; newItem.innerHTML = `<input type="text" class="col-span-8 p-2 border rounded-md skill-name" placeholder="Ù†Ø§Ù… Ù…Ù‡Ø§Ø±Øª"><input type="number" class="col-span-3 p-2 border rounded-md skill-level" placeholder="Ø³Ø·Ø­ (Û±-Ûµ)" min="1" max="5" value="1"><button type="button" class="col-span-1 remove-skill-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5"></i></button>`; skillsContainer.appendChild(newItem); lucide.createIcons(); });
            skillsContainer.addEventListener('click', (e) => { if(e.target.closest('.remove-skill-btn')) { e.target.closest('.skill-item').remove(); } });
            document.getElementById('edit-skills-form').addEventListener('submit', async (e) => { e.preventDefault(); const newSkills = {}; document.querySelectorAll('.skill-item').forEach(item => { const name = item.querySelector('.skill-name').value; const level = parseInt(item.querySelector('.skill-level').value) || 0; if (name) { newSkills[name] = level; } }); try { const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId); await updateDoc(docRef, { skills: newSkills }); showToast("Ù…Ù‡Ø§Ø±Øªâ€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯."); viewEmployeeProfile(emp.firestoreId); } catch (error) { console.error("Error updating skills:", error); showToast("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ù‡Ø§Ø±Øªâ€ŒÙ‡Ø§.", "error"); } });
        };

        const showEditCompetenciesForm = (emp) => {
            modalTitle.innerText = `ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø§ÛŒØ³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ ${emp.name}`;
            const empCompetencies = emp.competencies || {};
            const competenciesHtml = state.competencies.map(comp => `
                <div class="competency-item grid grid-cols-12 gap-2 items-center">
                    <label class="col-span-8">${comp.name}</label>
                    <input type="number" value="${empCompetencies[comp.name] || 0}" data-name="${comp.name}" class="col-span-3 p-2 border rounded-md competency-level" placeholder="Ø³Ø·Ø­ (Û±-Ûµ)" min="0" max="5">
                </div>
            `).join('');
            modalContent.innerHTML = `
                <form id="edit-competencies-form">
                    <div id="competencies-container" class="space-y-2">${competenciesHtml || '<p>Ø§Ø¨ØªØ¯Ø§ Ø´Ø§ÛŒØ³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ø± Ø¨Ø®Ø´ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªØ¹Ø±ÛŒÙ Ú©Ù†ÛŒØ¯.</p>'}</div>
                    <div class="pt-6 flex justify-end gap-4">
                        <button type="button" id="back-to-profile-comp" class="bg-gray-500 text-white py-2 px-6 rounded-md hover:bg-gray-600">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
                        <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">Ø°Ø®ÛŒØ±Ù‡</button>
                    </div>
                </form>
            `;
            document.getElementById('back-to-profile-comp').addEventListener('click', () => viewEmployeeProfile(emp.firestoreId));
            document.getElementById('edit-competencies-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newCompetencies = {};
                document.querySelectorAll('.competency-item').forEach(item => {
                    const name = item.querySelector('.competency-level').dataset.name;
                    const level = parseInt(item.querySelector('.competency-level').value) || 0;
                    if (name && level > 0) {
                        newCompetencies[name] = level;
                    }
                });
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId);
                    await updateDoc(docRef, { competencies: newCompetencies });
                    showToast("Ø´Ø§ÛŒØ³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯.");
                    viewEmployeeProfile(emp.firestoreId);
                } catch (error) {
                    console.error("Error updating competencies:", error);
                    showToast("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø§ÛŒØ³ØªÚ¯ÛŒâ€ŒÙ‡Ø§.", "error");
                }
            });
        };

        const showEditTeamOkrsForm = (team) => {
            modalTitle.innerText = `ÙˆÛŒØ±Ø§ÛŒØ´ OKR Ø¨Ø±Ø§ÛŒ ØªÛŒÙ… ${team.name}`;
            const okrsHtml = (team.okrs || []).map((okr) => `<div class="okr-item grid grid-cols-12 gap-2 items-center"><input type="text" value="${okr.title}" class="col-span-8 p-2 border rounded-md okr-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù‡Ø¯Ù"><input type="number" value="${okr.progress}" class="col-span-3 p-2 border rounded-md okr-progress" placeholder="Ù¾ÛŒØ´Ø±ÙØª %" min="0" max="100"><button type="button" class="col-span-1 remove-okr-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div>`).join('');
            modalContent.innerHTML = `<form id="edit-team-okrs-form"><div id="okrs-container" class="space-y-2">${okrsHtml}</div><button type="button" id="add-okr-btn" class="mt-4 text-sm bg-gray-200 py-2 px-4 rounded-md hover:bg-gray-300">Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ø¯Ù Ø¬Ø¯ÛŒØ¯</button><div class="pt-6 flex justify-end gap-4"><button type="button" id="back-to-team-profile-okr" class="bg-gray-500 text-white py-2 px-6 rounded-md hover:bg-gray-600">Ø¨Ø§Ø²Ú¯Ø´Øª</button><button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">Ø°Ø®ÛŒØ±Ù‡</button></div></form>`;
            lucide.createIcons();
            document.getElementById('back-to-team-profile-okr').addEventListener('click', () => viewTeamProfile(team.firestoreId));
            const okrsContainer = document.getElementById('okrs-container');
            document.getElementById('add-okr-btn').addEventListener('click', () => { const newItem = document.createElement('div'); newItem.className = 'okr-item grid grid-cols-12 gap-2 items-center'; newItem.innerHTML = `<input type="text" class="col-span-8 p-2 border rounded-md okr-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù‡Ø¯Ù"><input type="number" class="col-span-3 p-2 border rounded-md okr-progress" placeholder="Ù¾ÛŒØ´Ø±ÙØª %" min="0" max="100" value="0"><button type="button" class="col-span-1 remove-okr-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5"></i></button>`; okrsContainer.appendChild(newItem); lucide.createIcons(); });
            okrsContainer.addEventListener('click', (e) => { if (e.target.closest('.remove-okr-btn')) { e.target.closest('.okr-item').remove(); } });
            document.getElementById('edit-team-okrs-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newOkrs = [];
                document.querySelectorAll('.okr-item').forEach(item => {
                    const title = item.querySelector('.okr-title').value;
                    const progress = parseInt(item.querySelector('.okr-progress').value) || 0;
                    if (title) { newOkrs.push({ title, progress }); }
                });
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/teams`, team.firestoreId);
                    await updateDoc(docRef, { okrs: newOkrs });
                    showToast("Ø§Ù‡Ø¯Ø§Ù ØªÛŒÙ… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯.");
                    viewTeamProfile(team.firestoreId);
                } catch (error) {
                    console.error("Error updating team OKRs:", error);
                    showToast("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ù‡Ø¯Ø§Ù ØªÛŒÙ….", "error");
                }
            });
        };
        
        // --- [FIX START] ADDED TEAM HEALTH FORM ---
        const showTeamHealthForm = (team) => {
            modalTitle.innerText = `ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ø³Ù„Ø§Ù…Øª ØªÛŒÙ… ${team.name}`;
            const metrics = team.healthMetrics || { 'Ù…Ø´Ø§Ø±Ú©Øª': 75, 'Ø±Ø¶Ø§ÛŒØª': 80, 'Ø´ÙØ§ÙÛŒØª': 70, 'Ú©Ø§Ø±Ø§ÛŒÛŒ': 85 };
            const metricsHtml = Object.entries(metrics).map(([name, score]) => `
                <div class="health-metric-item grid grid-cols-12 gap-2 items-center">
                    <input type="text" value="${name}" class="col-span-8 p-2 border rounded-md health-metric-name" placeholder="Ù†Ø§Ù… Ù…Ø¹ÛŒØ§Ø±">
                    <input type="number" value="${score}" class="col-span-3 p-2 border rounded-md health-metric-score" placeholder="Ø§Ù…ØªÛŒØ§Ø² %" min="0" max="100">
                    <button type="button" class="col-span-1 remove-health-metric-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </div>
            `).join('');

            modalContent.innerHTML = `
                <form id="edit-team-health-form">
                    <div id="health-metrics-container" class="space-y-2">${metricsHtml}</div>
                    <button type="button" id="add-health-metric-btn" class="mt-4 text-sm bg-gray-200 py-2 px-4 rounded-md hover:bg-gray-300">Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø¹ÛŒØ§Ø± Ø¬Ø¯ÛŒØ¯</button>
                    <div class="pt-6 flex justify-end gap-4">
                        <button type="button" id="back-to-team-profile-health" class="bg-gray-500 text-white py-2 px-6 rounded-md hover:bg-gray-600">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
                        <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">Ø°Ø®ÛŒØ±Ù‡</button>
                    </div>
                </form>
            `;
            lucide.createIcons();
            document.getElementById('back-to-team-profile-health').addEventListener('click', () => viewTeamProfile(team.firestoreId));
            
            const metricsContainer = document.getElementById('health-metrics-container');
            document.getElementById('add-health-metric-btn').addEventListener('click', () => {
                const newItem = document.createElement('div');
                newItem.className = 'health-metric-item grid grid-cols-12 gap-2 items-center';
                newItem.innerHTML = `
                    <input type="text" class="col-span-8 p-2 border rounded-md health-metric-name" placeholder="Ù†Ø§Ù… Ù…Ø¹ÛŒØ§Ø±">
                    <input type="number" class="col-span-3 p-2 border rounded-md health-metric-score" placeholder="Ø§Ù…ØªÛŒØ§Ø² %" min="0" max="100" value="50">
                    <button type="button" class="col-span-1 remove-health-metric-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                `;
                metricsContainer.appendChild(newItem);
                lucide.createIcons();
            });

            metricsContainer.addEventListener('click', (e) => {
                if (e.target.closest('.remove-health-metric-btn')) {
                    e.target.closest('.health-metric-item').remove();
                }
            });

            document.getElementById('edit-team-health-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newMetrics = {};
                document.querySelectorAll('.health-metric-item').forEach(item => {
                    const name = item.querySelector('.health-metric-name').value;
                    const score = parseInt(item.querySelector('.health-metric-score').value) || 0;
                    if (name) {
                        newMetrics[name] = score;
                    }
                });
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/teams`, team.firestoreId);
                    await updateDoc(docRef, { healthMetrics: newMetrics });
                    showToast("Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ø³Ù„Ø§Ù…Øª ØªÛŒÙ… Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯.");
                    viewTeamProfile(team.firestoreId);
                } catch (error) {
                    console.error("Error updating team health metrics:", error);
                    showToast("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§.", "error");
                }
            });
        };
        // --- [FIX END] ---

const showEditPersonalInfoForm = (emp) => {
    modalTitle.innerText = `ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø³Ù†Ù„ÛŒ Ø¨Ø±Ø§ÛŒ ${emp.name}`;
    const info = emp.personalInfo || {};
    
    console.log(`[Ù…Ø±Ø­Ù„Ù‡ Û±] showEditPersonalInfoForm Ø¨Ø§Ø² Ø´Ø¯. ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯ Ù…ÙˆØ¬ÙˆØ¯:`, info.birthDate);
    
    modalContent.innerHTML = `<form id="edit-personal-info-form" class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
        <div><label class="block font-medium">Ø§ÛŒÙ…ÛŒÙ„</label><input type="email" id="personal-info-email" value="${info.email || ''}" class="w-full p-2 border rounded-md"></div>
        <div><label class="block font-medium">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„</label><input type="tel" id="phone" value="${info.phone || ''}" class="w-full p-2 border rounded-md"></div>
        <div><label class="block font-medium">Ø´Ù…Ø§Ø±Ù‡ Ø«Ø§Ø¨Øª</label><input type="tel" id="landline" value="${info.landline || ''}" class="w-full p-2 border rounded-md"></div>
        <div><label class="block font-medium">Ú©Ø¯ Ù…Ù„ÛŒ</label><input type="text" id="nationalId" value="${info.nationalId || ''}" class="w-full p-2 border rounded-md"></div>
        <div><label class="block font-medium">ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯</label><input type="text" id="birthDate" class="w-full p-2 border rounded-md"></div>
        <div><label class="block font-medium">ÙˆØ¶Ø¹ÛŒØª ØªØ§Ù‡Ù„</label><select id="maritalStatus" class="w-full p-2 border rounded-md"><option value="Ù…Ø¬Ø±Ø¯" ${info.maritalStatus === 'Ù…Ø¬Ø±Ø¯' ? 'selected' : ''}>Ù…Ø¬Ø±Ø¯</option><option value="Ù…ØªØ§Ù‡Ù„" ${info.maritalStatus === 'Ù…ØªØ§Ù‡Ù„' ? 'selected' : ''}>Ù…ØªØ§Ù‡Ù„</option></select></div>
        <div class="md:col-span-2"><label class="block font-medium">Ù…Ø¯Ø±Ú© ØªØ­ØµÛŒÙ„ÛŒ</label><input type="text" id="education" value="${info.education || ''}" class="w-full p-2 border rounded-md"></div>
        <div class="md:col-span-2"><label class="block font-medium">Ø¢Ø¯Ø±Ø³</label><input type="text" id="address" value="${info.address || ''}" class="w-full p-2 border rounded-md"></div>
        <div><label class="block font-medium">Ú©Ø¯ Ù¾Ø³ØªÛŒ</label><input type="text" id="postalCode" value="${info.postalCode || ''}" class="w-full p-2 border rounded-md"></div>
        <div><label class="block font-medium">ÙˆØ¶Ø¹ÛŒØª Ù†Ø¸Ø§Ù… ÙˆØ¸ÛŒÙÙ‡</label><input type="text" id="militaryStatus" value="${info.militaryStatus || ''}" class="w-full p-2 border rounded-md"></div>
        <hr class="md:col-span-2 my-2">
        <div><label class="block font-medium">Ù†Ø§Ù… Ù…Ø®Ø§Ø·Ø¨ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ</label><input type="text" id="emergencyContactName" value="${info.emergencyContactName || ''}" class="w-full p-2 border rounded-md"></div>
        <div><label class="block font-medium">Ø´Ù…Ø§Ø±Ù‡ Ù…Ø®Ø§Ø·Ø¨ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ</label><input type="tel" id="emergencyContactPhone" value="${info.emergencyContactPhone || ''}" class="w-full p-2 border rounded-md"></div>
    </div><div class="pt-6 flex justify-end gap-4"><button type="button" id="back-to-profile-personal" class="bg-gray-500 text-white py-2 px-6 rounded-md hover:bg-gray-600">Ø¨Ø§Ø²Ú¯Ø´Øª</button><button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">Ø°Ø®ÛŒØ±Ù‡</button></div></form>`;

    activatePersianDatePicker('birthDate', info.birthDate);

    document.getElementById('back-to-profile-personal').addEventListener('click', () => viewEmployeeProfile(emp.firestoreId));
    document.getElementById('edit-personal-info-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const birthDateValueFromInput = document.getElementById('birthDate').value;
        console.log(`[Ù…Ø±Ø­Ù„Ù‡ Û³] Ø¯Ú©Ù…Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù„ÛŒÚ© Ø´Ø¯. Ù…Ù‚Ø¯Ø§Ø± Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø² ÙÛŒÙ„Ø¯ ØªØ§Ø±ÛŒØ®: "${birthDateValueFromInput}"`);
        
        const gregorianBirthDate = persianToEnglishDate(birthDateValueFromInput);
        console.log(`[Ù…Ø±Ø­Ù„Ù‡ Û³] ØªØ§Ø±ÛŒØ® Ø¨Ø¹Ø¯ Ø§Ø² ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ:`, gregorianBirthDate);

        const updatedInfo = {
            email: document.getElementById('personal-info-email').value,
            phone: document.getElementById('phone').value,
            landline: document.getElementById('landline').value,
            nationalId: document.getElementById('nationalId').value,
            birthDate: gregorianBirthDate,
            maritalStatus: document.getElementById('maritalStatus').value,
            education: document.getElementById('education').value,
            address: document.getElementById('address').value,
            postalCode: document.getElementById('postalCode').value,
            militaryStatus: document.getElementById('militaryStatus').value,
            emergencyContactName: document.getElementById('emergencyContactName').value,
            emergencyContactPhone: document.getElementById('emergencyContactPhone').value,
        };
        try {
            const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId);
            await updateDoc(docRef, { personalInfo: updatedInfo });
            showToast("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø³Ù†Ù„ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.");
            viewEmployeeProfile(emp.firestoreId);
        } catch (error) {
            console.error("Error updating personal info:", error);
            showToast("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª.", "error");
        }
    });
};  
const showDisciplinaryForm = (emp) => {
        modalTitle.innerText = `Ø«Ø¨Øª Ù…ÙˆØ±Ø¯ Ø§Ù†Ø¶Ø¨Ø§Ø·ÛŒ Ø¨Ø±Ø§ÛŒ ${emp.name}`;
        modalContent.innerHTML = `
            <form id="disciplinary-form" class="space-y-4">
                <div><label class="block font-medium">Ù†ÙˆØ¹</label><select id="disciplinary-type" class="w-full p-2 border border-slate-300 rounded-lg"><option value="ØªØ´ÙˆÛŒÙ‚">ØªØ´ÙˆÛŒÙ‚</option><option value="ØªØ°Ú©Ø±">ØªØ°Ú©Ø±</option></select></div>
                <div><label class="block font-medium">ØªØ§Ø±ÛŒØ®</label><input type="text" id="disciplinary-date" class="w-full p-2 border border-slate-300 rounded-lg" required></div>
                <div><label class="block font-medium">Ø¯Ù„ÛŒÙ„</label><textarea id="disciplinary-reason" rows="3" class="w-full p-2 border border-slate-300 rounded-lg" required></textarea></div>
                <div>
                    <label class="block font-medium">Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø¶Ù…ÛŒÙ…Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ - Ø­Ø¯Ø§Ú©Ø«Ø± Ûµ Ù…Ú¯Ø§Ø¨Ø§ÛŒØª)</label>
                    <input type="file" id="disciplinary-file" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100"/>
                </div>
                <div class="pt-6 flex justify-end gap-4"><button type="button" id="back-to-profile-disciplinary" class="bg-slate-500 text-white py-2 px-6 rounded-lg hover:bg-slate-600">Ø¨Ø§Ø²Ú¯Ø´Øª</button><button type="submit" id="submit-disciplinary-btn" class="bg-indigo-500 text-white py-2 px-6 rounded-lg hover:bg-indigo-600">Ø«Ø¨Øª</button></div>
            </form>`;
        
        activatePersianDatePicker('disciplinary-date', new Date());

        document.getElementById('back-to-profile-disciplinary').addEventListener('click', () => viewEmployeeProfile(emp.firestoreId));
        
        document.getElementById('disciplinary-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-disciplinary-btn');
            submitBtn.disabled = true;
            submitBtn.innerText = 'Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª...';

            const file = document.getElementById('disciplinary-file').files[0];
            let fileUrl = '';
            let fileName = '';

            if (file && file.size > 5 * 1024 * 1024) { // 5 MB
                showToast("Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ù†Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² Ûµ Ù…Ú¯Ø§Ø¨Ø§ÛŒØª Ø¨Ø§Ø´Ø¯.", "error");
                submitBtn.disabled = false;
                submitBtn.innerText = 'Ø«Ø¨Øª';
                return;
            }

            try {
                if (file) {
                    const filePath = `disciplinary/${emp.id}/${Date.now()}_${file.name}`;
                    const storageRef = ref(storage, filePath);
                    const snapshot = await uploadBytes(storageRef, file);
                    fileUrl = await getDownloadURL(snapshot.ref);
                    fileName = file.name;
                }

                const gregorianDate = persianToEnglishDate(document.getElementById('disciplinary-date').value);
                if (!gregorianDate) {
                    showToast("ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª.", "error");
                    submitBtn.disabled = false;
                    submitBtn.innerText = 'Ø«Ø¨Øª';
                    return;
                }

                const newRecord = {
                    type: document.getElementById('disciplinary-type').value,
                    date: gregorianDate,
                    reason: document.getElementById('disciplinary-reason').value,
                    fileUrl: fileUrl,
                    fileName: fileName
                };
                const updatedHistory = [...(emp.disciplinaryHistory || []), newRecord];
                
                const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId);
                await updateDoc(docRef, { disciplinaryHistory: updatedHistory });
                
                closeModal(mainModal, mainModalContainer);
                showToast("Ù…ÙˆØ±Ø¯ Ø§Ù†Ø¶Ø¨Ø§Ø·ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.");
                viewEmployeeProfile(emp.firestoreId);
            } catch (error) {
                console.error("Error adding disciplinary record:", error);
                showToast("Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù…ÙˆØ±Ø¯ Ø§Ù†Ø¶Ø¨Ø§Ø·ÛŒ.", "error");
                if(submitBtn) {
                   submitBtn.disabled = false;
                   submitBtn.innerText = 'Ø«Ø¨Øª';
                }
            }
        });
    };

 const showContractForm = (emp, contractIndex = null) => {
        const isEditing = contractIndex !== null;
        const contract = isEditing ? emp.contractHistory[contractIndex] : {};
        modalTitle.innerText = isEditing ? `ÙˆÛŒØ±Ø§ÛŒØ´ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¨Ø±Ø§ÛŒ ${emp.name}` : `Ø«Ø¨Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ${emp.name}`;
        modalContent.innerHTML = `
            <form id="contract-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block font-medium">ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</label><input type="text" id="contract-start" class="w-full p-2 border border-slate-300 rounded-lg" required></div>
                    <div><label class="block font-medium">ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†</label><input type="text" id="contract-end" class="w-full p-2 border border-slate-300 rounded-lg" required></div>
                    <div><label class="block font-medium">Ø­Ù‚ÙˆÙ‚ Ù†Ø§Ø®Ø§Ù„Øµ (Ø±ÛŒØ§Ù„)</label><input type="number" id="contract-gross" value="${contract.grossSalary || ''}" class="w-full p-2 border border-slate-300 rounded-lg"></div>
                    <div><label class="block font-medium">Ø­Ù‚ÙˆÙ‚ Ø®Ø§Ù„Øµ (Ø±ÛŒØ§Ù„)</label><input type="number" id="contract-net" value="${contract.netSalary || ''}" class="w-full p-2 border border-slate-300 rounded-lg"></div>
                    <div class="md:col-span-2"><label class="block font-medium">Ù…Ø¨Ù„Øº Ø³ÙØªÙ‡ (Ø±ÛŒØ§Ù„)</label><input type="number" id="contract-promissory" value="${contract.promissoryNote || ''}" class="w-full p-2 border border-slate-300 rounded-lg"></div>
                    <div class="md:col-span-2">
                        <label class="block font-medium">Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ - Ø­Ø¯Ø§Ú©Ø«Ø± Ûµ Ù…Ú¯Ø§Ø¨Ø§ÛŒØª)</label>
                        <input type="file" id="contract-file-upload" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100"/>
                        ${contract.fileName ? `<p class="text-xs text-slate-500 mt-2">ÙØ§ÛŒÙ„ ÙØ¹Ù„ÛŒ: ${contract.fileName} (Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ±ØŒ ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯)</p>` : ''}
                    </div>
                </div>
                <div class="pt-6 flex justify-end gap-4"><button type="button" id="back-to-profile-contract" class="bg-slate-500 text-white py-2 px-6 rounded-lg hover:bg-slate-600">Ø¨Ø§Ø²Ú¯Ø´Øª</button><button type="submit" id="submit-contract-btn" class="bg-indigo-500 text-white py-2 px-6 rounded-lg hover:bg-indigo-600">Ø°Ø®ÛŒØ±Ù‡</button></div>
            </form>`;

        activatePersianDatePicker('contract-start', contract.startDate);
        activatePersianDatePicker('contract-end', contract.endDate);

        document.getElementById('back-to-profile-contract').addEventListener('click', () => viewEmployeeProfile(emp.firestoreId));
        
        document.getElementById('contract-form').addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const submitBtn = document.getElementById('submit-contract-btn');
            submitBtn.disabled = true;
            submitBtn.innerText = 'Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...';
            
            const file = document.getElementById('contract-file-upload').files[0];
            let fileUrl = contract.fileUrl || '';
            let fileName = contract.fileName || '';

            if (file && file.size > 5 * 1024 * 1024) { // 5 MB
                showToast("Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ù†Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² Ûµ Ù…Ú¯Ø§Ø¨Ø§ÛŒØª Ø¨Ø§Ø´Ø¯.", "error");
                submitBtn.disabled = false;
                submitBtn.innerText = 'Ø°Ø®ÛŒØ±Ù‡';
                return;
            }

            try {
                 if (file) {
                    const filePath = `contracts/${emp.id}/${Date.now()}_${file.name}`;
                    const storageRef = ref(storage, filePath);
                    const snapshot = await uploadBytes(storageRef, file);
                    fileUrl = await getDownloadURL(snapshot.ref);
                    fileName = file.name;
                }
                
                const gregorianStart = persianToEnglishDate(document.getElementById('contract-start').value);
                const gregorianEnd = persianToEnglishDate(document.getElementById('contract-end').value);

                if (!gregorianStart || !gregorianEnd) {
                    showToast("ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª.", "error");
                    submitBtn.disabled = false;
                    submitBtn.innerText = 'Ø°Ø®ÛŒØ±Ù‡';
                    return;
                }

                const newContract = { 
                    startDate: gregorianStart, 
                    endDate: gregorianEnd, 
                    grossSalary: Number(document.getElementById('contract-gross').value), 
                    netSalary: Number(document.getElementById('contract-net').value), 
                    promissoryNote: Number(document.getElementById('contract-promissory').value), 
                    fileName: fileName,
                    fileUrl: fileUrl
                }; 
                let updatedHistory = [...(emp.contractHistory || [])]; 
                if(isEditing) { 
                    updatedHistory[contractIndex] = newContract; 
                } else { 
                    updatedHistory.push(newContract); 
                } 
                updatedHistory.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
                const latestContractEndDate = updatedHistory[0]?.endDate || null;

                const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId); 
                await updateDoc(docRef, { 
                    contractHistory: updatedHistory,
                    contractEndDate: latestContractEndDate
                }); 
                
                closeModal(mainModal, mainModalContainer);
                showToast("Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯."); 
                viewEmployeeProfile(emp.firestoreId); 
            } catch (error) { 
                console.error("Error saving contract record:", error); 
                showToast("Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯.", "error"); 
                if(submitBtn) {
                   submitBtn.disabled = false;
                   submitBtn.innerText = 'Ø°Ø®ÛŒØ±Ù‡';
                }
            } 
        });
    };
        
        const deleteContract = async (emp, index) => {
            showConfirmationModal("Ø­Ø°Ù Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯", "Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø³Ø§Ø¨Ù‚Ù‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ", async () => {
                let updatedHistory = [...(emp.contractHistory || [])];
                updatedHistory.splice(index, 1);
                const latestContractEndDate = updatedHistory[0]?.endDate || null;
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId);
                    await updateDoc(docRef, { 
                        contractHistory: updatedHistory,
                        contractEndDate: latestContractEndDate
                    });
                    showToast("Ø³Ø§Ø¨Ù‚Ù‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø­Ø°Ù Ø´Ø¯.");
                    viewEmployeeProfile(emp.firestoreId);
                } catch (error) {
                    console.error("Error deleting contract:", error);
                    showToast("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯.", "error");
                }
            });
        };

const showDocumentForm = (emp, docIndex = null) => {
        const isEditing = docIndex !== null;
        const documentItem = isEditing ? emp.documents[docIndex] : {};
        modalTitle.innerText = isEditing ? `ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø¯Ø±Ú© Ø¨Ø±Ø§ÛŒ ${emp.name}` : `Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø¯Ø±Ú© Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ${emp.name}`;
        
        modalContent.innerHTML = `
            <form id="document-form" class="space-y-4">
                <div>
                    <label class="block font-medium">Ù†Ø§Ù… Ù…Ø¯Ø±Ú©</label>
                    <input type="text" id="doc-name" value="${documentItem.name || ''}" class="w-full p-2 border border-slate-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block font-medium">ØªØ§Ø±ÛŒØ®</label>
                    <input type="text" id="doc-date" class="w-full p-2 border border-slate-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block font-medium">Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ (Ø­Ø¯Ø§Ú©Ø«Ø± Ûµ Ù…Ú¯Ø§Ø¨Ø§ÛŒØª)</label>
                    <input type="file" id="doc-file-upload" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100"/>
                    ${documentItem.fileName ? `<p class="text-xs text-slate-500 mt-2">ÙØ§ÛŒÙ„ ÙØ¹Ù„ÛŒ: ${documentItem.fileName} (Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ±ØŒ ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯)</p>` : ''}
                </div>
                <div class="pt-6 flex justify-end gap-4">
                    <button type="button" id="back-to-profile-doc" class="bg-slate-500 text-white py-2 px-6 rounded-lg hover:bg-slate-600">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
                    <button type="submit" id="submit-doc-btn" class="bg-indigo-500 text-white py-2 px-6 rounded-lg hover:bg-indigo-600 shadow-md transition">Ø°Ø®ÛŒØ±Ù‡</button>
                </div>
            </form>`;
        
        activatePersianDatePicker('doc-date', documentItem.date || new Date());
        
        document.getElementById('back-to-profile-doc').addEventListener('click', () => viewEmployeeProfile(emp.firestoreId));
        
        document.getElementById('document-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-doc-btn');
            submitBtn.disabled = true;
            submitBtn.innerText = 'Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...';

            const file = document.getElementById('doc-file-upload').files[0];
            let fileUrl = documentItem.fileUrl || '';
            let fileName = documentItem.fileName || '';

            // --- Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯: Ø¨Ø±Ø±Ø³ÛŒ Ø­Ø¬Ù… ÙØ§ÛŒÙ„ ---
            if (file && file.size > 5 * 1024 * 1024) { // 5 MB
                showToast("Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ù†Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² Ûµ Ù…Ú¯Ø§Ø¨Ø§ÛŒØª Ø¨Ø§Ø´Ø¯.", "error");
                submitBtn.disabled = false;
                submitBtn.innerText = 'Ø°Ø®ÛŒØ±Ù‡';
                return;
            }

            try {
                if (file) {
                    const filePath = `documents/${emp.id}/${Date.now()}_${file.name}`;
                    const storageRef = ref(storage, filePath);
                    const snapshot = await uploadBytes(storageRef, file);
                    fileUrl = await getDownloadURL(snapshot.ref);
                    fileName = file.name;
                }

                const gregorianDate = persianToEnglishDate(document.getElementById('doc-date').value);
                if (!gregorianDate) {
                    showToast("ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª.", "error");
                    submitBtn.disabled = false;
                    submitBtn.innerText = 'Ø°Ø®ÛŒØ±Ù‡';
                    return;
                }

                const newDoc = { name: document.getElementById('doc-name').value, date: gregorianDate, fileName: fileName, fileUrl: fileUrl };

                let updatedDocs = [...(emp.documents || [])];
                if (isEditing) {
                    updatedDocs[docIndex] = newDoc;
                } else {
                    updatedDocs.push(newDoc);
                }

                const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId);
                await updateDoc(docRef, { documents: updatedDocs });
                
                closeModal(mainModal, mainModalContainer);
                showToast("Ù…Ø¯Ø±Ú© Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.");
                viewEmployeeProfile(emp.firestoreId);

            } catch (error) {
                console.error("Error saving document:", error);
                showToast("Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù…Ø¯Ø±Ú©.", "error");
                if (submitBtn) {
                   submitBtn.disabled = false;
                   submitBtn.innerText = 'Ø°Ø®ÛŒØ±Ù‡';
                }
            }
        });
    };
        
        const deleteDocument = async (emp, index) => {
            showConfirmationModal("Ø­Ø°Ù Ù…Ø¯Ø±Ú©", "Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù…Ø¯Ø±Ú© Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ", async () => {
                let updatedDocs = [...(emp.documents || [])];
                updatedDocs.splice(index, 1);
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId);
                    await updateDoc(docRef, { documents: updatedDocs });
                    showToast("Ù…Ø¯Ø±Ú© Ø­Ø°Ù Ø´Ø¯.");
                    viewEmployeeProfile(emp.firestoreId);
                } catch (error) {
                    console.error("Error deleting document:", error);
                    showToast("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù…Ø¯Ø±Ú©.", "error");
                }
            });
        };

       const showPerformanceForm = (emp, reviewIndex = null) => {
    const isEditing = reviewIndex !== null;
    const review = isEditing ? emp.performanceHistory[reviewIndex] : {};
    modalTitle.innerText = isEditing ? `ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¨Ø±Ø§ÛŒ ${emp.name}` : `Ø«Ø¨Øª Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¬Ø¯ÛŒØ¯`;
    modalContent.innerHTML = `
        <form id="performance-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block font-medium">ØªØ§Ø±ÛŒØ® Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</label><input type="text" id="perf-date" class="w-full p-2 border rounded-md" required></div>
                <div><label class="block font-medium">Ù†Ø§Ù… Ø§Ø±Ø²ÛŒØ§Ø¨</label><input type="text" id="perf-reviewer" value="${review.reviewer || ''}" class="w-full p-2 border rounded-md" required></div>
                <div class="md:col-span-2"><label class="block font-medium">Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„ÛŒ (Û± ØªØ§ Ûµ)</label><input type="number" step="0.1" min="0" max="5" id="perf-score" value="${review.overallScore || ''}" class="w-full p-2 border rounded-md" required></div>
                <div class="md:col-span-2"><label class="block font-medium">Ù†Ù‚Ø§Ø· Ù‚ÙˆØª</label><textarea id="perf-strengths" rows="3" class="w-full p-2 border rounded-md">${review.strengths || ''}</textarea></div>
                <div class="md:col-span-2"><label class="block font-medium">Ø²Ù…ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø§Ø¨Ù„ Ø¨Ù‡Ø¨ÙˆØ¯</label><textarea id="perf-improvements" rows="3" class="w-full p-2 border rounded-md">${review.areasForImprovement || ''}</textarea></div>
            </div>
            <div class="pt-6 flex justify-end gap-4">
                <button type="button" id="back-to-profile-perf" class="bg-gray-500 text-white py-2 px-6 rounded-md hover:bg-gray-600">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
                <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">Ø°Ø®ÛŒØ±Ù‡</button>
            </div>
        </form>
    `;

    activatePersianDatePicker('perf-date', review.reviewDate || new Date());

    document.getElementById('back-to-profile-perf').addEventListener('click', () => viewEmployeeProfile(emp.firestoreId));
    document.getElementById('performance-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const gregorianDate = persianToEnglishDate(document.getElementById('perf-date').value);
        if (!gregorianDate) {
            showToast("ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª.", "error");
            return;
        }
        const newReview = {
            reviewDate: gregorianDate,
            reviewer: document.getElementById('perf-reviewer').value,
            overallScore: parseFloat(document.getElementById('perf-score').value),
            strengths: document.getElementById('perf-strengths').value,
            areasForImprovement: document.getElementById('perf-improvements').value,
        };
        let updatedHistory = [...(emp.performanceHistory || [])];
        if (isEditing) {
            updatedHistory[reviewIndex] = newReview;
        } else {
            updatedHistory.push(newReview);
        }
        try {
            const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId);
            await updateDoc(docRef, { performanceHistory: updatedHistory });
            showToast("Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.");
            viewEmployeeProfile(emp.firestoreId);
        } catch (error) {
            console.error("Error saving performance review:", error);
            showToast("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ.", "error");
        }
    });
};

      const showCareerPathForm = (emp) => {
    modalTitle.innerText = `Ø«Ø¨Øª Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø´ØºÙ„ÛŒ Ø¨Ø±Ø§ÛŒ ${emp.name}`;
    modalContent.innerHTML = `
        <form id="career-path-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block font-medium">ØªØ§Ø±ÛŒØ®</label><input type="text" id="career-date" class="w-full p-2 border rounded-md" required></div>
                <div><label class="block font-medium">Ù†ÙˆØ¹ Ø±ÙˆÛŒØ¯Ø§Ø¯</label><select id="career-type" class="w-full p-2 border rounded-md"><option value="ØªØ±ÙÛŒØ¹">ØªØ±ÙÛŒØ¹</option><option value="Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ø§ÙÙ‚ÛŒ">Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ø§ÙÙ‚ÛŒ</option><option value="ØªØºÛŒÛŒØ± Ø³Ù…Øª">ØªØºÛŒÛŒØ± Ø³Ù…Øª</option></select></div>
                <div><label class="block font-medium">Ø³Ù…Øª Ø¬Ø¯ÛŒØ¯</label><input type="text" id="career-title" class="w-full p-2 border rounded-md" required></div>
                <div><label class="block font-medium">Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø¬Ø¯ÛŒØ¯</label><input type="text" id="career-department" value="${emp.department}" class="w-full p-2 border rounded-md" required></div>
            </div>
            <div class="pt-6 flex justify-end gap-4">
                <button type="button" id="back-to-profile-career" class="bg-gray-500 text-white py-2 px-6 rounded-md hover:bg-gray-600">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
                <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">Ø«Ø¨Øª</button>
            </div>
        </form>
    `;

    activatePersianDatePicker('career-date', new Date());

    document.getElementById('back-to-profile-career').addEventListener('click', () => viewEmployeeProfile(emp.firestoreId));
    document.getElementById('career-path-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const gregorianDate = persianToEnglishDate(document.getElementById('career-date').value);
         if (!gregorianDate) {
            showToast("ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª.", "error");
            return;
        }
        const newEntry = {
            date: gregorianDate,
            type: document.getElementById('career-type').value,
            title: document.getElementById('career-title').value,
            department: document.getElementById('career-department').value,
        };
        const updatedPath = [...(emp.careerPath || []), newEntry];
        try {
            const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId);
            await updateDoc(docRef, { careerPath: updatedPath });
            showToast("Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø´ØºÙ„ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.");
            viewEmployeeProfile(emp.firestoreId);
        } catch (error) {
            console.error("Error saving career path:", error);
            showToast("Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø´ØºÙ„ÛŒ.", "error");
        }
    });
};
        const deletePerformanceReview = async (emp, index) => {
        showConfirmationModal("Ø­Ø°Ù Ø³Ø§Ø¨Ù‚Ù‡ Ø¹Ù…Ù„Ú©Ø±Ø¯", "Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ", async () => {
            const updatedHistory = emp.performanceHistory.filter((_, i) => i !== index);
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId);
                await updateDoc(docRef, { performanceHistory: updatedHistory });
                showToast("Ø³Ø§Ø¨Ù‚Ù‡ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø­Ø°Ù Ø´Ø¯.");
                viewEmployeeProfile(emp.firestoreId);
            } catch (error) {
                console.error("Error deleting performance review:", error);
                showToast("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø³Ø§Ø¨Ù‚Ù‡ Ø¹Ù…Ù„Ú©Ø±Ø¯.", "error");
            }
        });
    };

    const deleteDisciplinaryRecord = async (emp, index) => {
        showConfirmationModal("Ø­Ø°Ù Ø³Ø§Ø¨Ù‚Ù‡ Ø§Ù†Ø¶Ø¨Ø§Ø·ÛŒ", "Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ", async () => {
            const updatedHistory = emp.disciplinaryHistory.filter((_, i) => i !== index);
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId);
                await updateDoc(docRef, { disciplinaryHistory: updatedHistory });
                showToast("Ø³Ø§Ø¨Ù‚Ù‡ Ø§Ù†Ø¶Ø¨Ø§Ø·ÛŒ Ø­Ø°Ù Ø´Ø¯.");
                viewEmployeeProfile(emp.firestoreId);
            } catch (error) {
                console.error("Error deleting disciplinary record:", error);
                showToast("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø³Ø§Ø¨Ù‚Ù‡ Ø§Ù†Ø¶Ø¨Ø§Ø·ÛŒ.", "error");
            }
        });
    };

    const deleteCareerPathEntry = async (emp, index) => {
        showConfirmationModal("Ø­Ø°Ù Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø´ØºÙ„ÛŒ", "Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ", async () => {
            const updatedPath = emp.careerPath.filter((_, i) => i !== index);
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/employees`, emp.firestoreId);
                await updateDoc(docRef, { careerPath: updatedPath });
                showToast("Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø´ØºÙ„ÛŒ Ø­Ø°Ù Ø´Ø¯.");
                viewEmployeeProfile(emp.firestoreId);
            } catch (error) {
                console.error("Error deleting career path entry:", error);
                showToast("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø´ØºÙ„ÛŒ.", "error");
            }
        });
    };

        const setupSurveysPageListeners = () => {
            document.querySelectorAll('.create-survey-link-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const surveyId = e.currentTarget.dataset.surveyId;
                    const surveyTemplate = surveyTemplates[surveyId];
                    if (surveyTemplate.requiresTarget) {
                        showSurveyTargetSelector(surveyId);
                    } else {
                        generateAndShowSurveyLink(surveyId);
                    }
                });
            });
        };

        const showSurveyTargetSelector = (surveyId) => {
            modalTitle.innerText = 'Ø§Ù†ØªØ®Ø§Ø¨ ÙØ±Ø¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø¨Ø±Ø§ÛŒ Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ';
            const employeeOptions = state.employees.map(emp => `<option value="${emp.id}">${emp.name} (${emp.id})</option>`).join('');
            modalContent.innerHTML = `
                <div class="p-4 space-y-4">
                    <p>Ø§ÛŒÙ† Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ (Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ Û³Û¶Û° Ø¯Ø±Ø¬Ù‡) Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ ÛŒÚ© ÙØ±Ø¯ Ù…Ø´Ø®Øµ Ø§Ø³Øª.</p>
                    <div>
                        <label for="survey-target-employee" class="block text-sm font-medium text-gray-700">Ú©Ø§Ø±Ù…Ù†Ø¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</label>
                        <select id="survey-target-employee" class="mt-1 block w-full p-2 border rounded-md">
                            ${employeeOptions}
                        </select>
                    </div>
                    <div class="flex justify-end">
                        <button id="generate-targeted-link-btn" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú©</button>
                    </div>
                </div>
            `;
            openModal(mainModal, mainModalContainer);
            document.getElementById('generate-targeted-link-btn').addEventListener('click', () => {
                const targetEmployeeId = document.getElementById('survey-target-employee').value;
                if (targetEmployeeId) {
                    generateAndShowSurveyLink(surveyId, targetEmployeeId);
                }
            });
        };

        const generateAndShowSurveyLink = (surveyId, targetEmployeeId = null) => {
            let surveyLink = `${window.location.origin}${window.location.pathname}#survey-taker?id=${surveyId}`;
            if (targetEmployeeId) {
                surveyLink += `&target=${targetEmployeeId}`;
            }
            modalTitle.innerText = 'Ù„ÛŒÙ†Ú© Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯';
            modalContent.innerHTML = `
                <div class="p-4 space-y-4">
                    <p>Ø§ÛŒÙ† Ù„ÛŒÙ†Ú© Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø´Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ú¯Ø§Ù† Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:</p>
                    <div class="flex items-center bg-gray-100 p-2 rounded-md">
                        <input id="survey-link-input" type="text" readonly value="${surveyLink}" class="flex-grow bg-transparent outline-none font-mono text-sm">
                        <button id="copy-survey-link-btn" class="bg-blue-500 text-white py-1 px-3 rounded-md hover:bg-blue-600 ml-2">Ú©Ù¾ÛŒ</button>
                    </div>
                </div>
            `;
            if (!mainModal.classList.contains('flex')) {
                openModal(mainModal, mainModalContainer);
            }
            document.getElementById('copy-survey-link-btn').addEventListener('click', () => {
                const linkInput = document.getElementById('survey-link-input');
                linkInput.select();
                document.execCommand('copy');
                showToast("Ù„ÛŒÙ†Ú© Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ú©Ù¾ÛŒ Ø´Ø¯!");
            });
        };
        
        const renderSurveyTakerPage = (surveyId) => {
            document.getElementById('dashboard-container').classList.add('hidden');
            const surveyTakerContainer = document.getElementById('survey-taker-container');
            surveyTakerContainer.classList.remove('hidden');
            const survey = surveyTemplates[surveyId];
            if (!survey) {
                surveyTakerContainer.innerHTML = `<p>Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>`;
                return;
            }
            
            const urlParams = new URLSearchParams(window.location.hash.split('?')[1]);
            const targetEmployeeId = urlParams.get('target');
            const targetEmployee = targetEmployeeId ? state.employees.find(e => e.id === targetEmployeeId) : null;
            
            let title = survey.title;
            if (targetEmployee) {
                title += ` Ø¯Ø± Ù…ÙˆØ±Ø¯: ${targetEmployee.name}`;
            }

            const questionsHtml = survey.questions.map(q => {
                let inputHtml = '';
                switch (q.type) {
                    case 'rating_1_5':
                        inputHtml = `<div class="flex justify-center gap-2 flex-wrap">${[1, 2, 3, 4, 5].map(n => `<label class="cursor-pointer"><input type="radio" name="${q.id}" value="${n}" class="sr-only peer" required><div class="w-10 h-10 rounded-full flex items-center justify-center border-2 border-gray-300 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">${n}</div></label>`).join('')}</div>`;
                        break;
                    case 'yes_no':
                        inputHtml = `<div class="flex justify-center gap-4"><label class="cursor-pointer"><input type="radio" name="${q.id}" value="yes" class="sr-only peer" required><div class="px-6 py-2 rounded-md border-2 border-gray-300 peer-checked:bg-green-600 peer-checked:text-white peer-checked:border-green-600">Ø¨Ù„Ù‡</div></label><label class="cursor-pointer"><input type="radio" name="${q.id}" value="no" class="sr-only peer" required><div class="px-6 py-2 rounded-md border-2 border-gray-300 peer-checked:bg-red-600 peer-checked:text-white peer-checked:border-red-600">Ø®ÛŒØ±</div></label></div>`;
                        break;
                    case 'choice':
                        inputHtml = `<div class="flex justify-center gap-4 flex-wrap">${(q.options || []).map(opt => `<label class="cursor-pointer"><input type="radio" name="${q.id}" value="${opt}" class="sr-only peer" required><div class="px-6 py-2 rounded-md border-2 border-gray-300 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">${opt}</div></label>`).join('')}</div>`;
                        break;
                    case 'open_text':
                        inputHtml = `<textarea name="${q.id}" rows="4" class="w-full p-2 border rounded-md" required></textarea>`;
                        break;
                }
                return `<div class="bg-white p-6 rounded-lg shadow-md"><p class="font-semibold mb-4 text-center">${q.text}</p>${inputHtml}</div>`;
            }).join('');

            surveyTakerContainer.innerHTML = `
                <div class="min-h-screen bg-gray-100 p-4 sm:p-8 flex items-center justify-center">
                    <div class="w-full max-w-2xl space-y-6">
                         <div class="text-center">
                            <i data-lucide="shield-check" class="mx-auto w-12 h-12 text-blue-800"></i>
                            <h1 class="text-2xl font-bold mt-2">${title}</h1>
                            <p class="text-gray-600 mt-1">${survey.description}</p>
                        </div>
                        <form id="survey-form" class="space-y-6">
                            ${questionsHtml}
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <label for="employeeId" class="block text-sm font-medium text-gray-700 mb-2">Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                                <p class="text-xs text-gray-500 mb-2">Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù¾Ø§Ø³Ø® Ø¨Ù‡ ØµÙˆØ±Øª Ù†Ø§Ø´Ù†Ø§Ø³ØŒ Ø§ÛŒÙ† ÙÛŒÙ„Ø¯ Ø±Ø§ Ø®Ø§Ù„ÛŒ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯.</p>
                                <input type="text" name="employeeId" class="w-full p-2 border rounded-md">
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-md font-semibold hover:bg-blue-700">Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§</button>
                        </form>
                    </div>
                </div>
            `;
            lucide.createIcons();
            
            document.getElementById('survey-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const answers = {};
                survey.questions.forEach(q => {
                    answers[q.id] = formData.get(q.id);
                });
                const employeeId = formData.get('employeeId').trim() || 'anonymous';
                
                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/surveyResponses`), {
                        surveyId,
                        employeeId,
                        targetEmployeeId,
                        answers,
                        submittedAt: serverTimestamp()
                    });
                    surveyTakerContainer.innerHTML = `<div class="min-h-screen flex items-center justify-center text-center"><div class="bg-white p-10 rounded-lg shadow-xl"><i data-lucide="check-circle" class="mx-auto w-16 h-16 text-green-500"></i><h2 class="mt-4 text-2xl font-bold">Ø§Ø² Ø´Ù…Ø§ Ù…ØªØ´Ú©Ø±ÛŒÙ…!</h2><p class="mt-2 text-gray-600">Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.</p></div></div>`;
                    lucide.createIcons();
                } catch (error) {
                    console.error("Error submitting survey:", error);
                    showToast("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ.", "error");
                }
            });
        };
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            setupEventListeners();
            lucide.createIcons();
        });

    </script>
</body>
</html>
